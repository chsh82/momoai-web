{% extends "base.html" %}

{% block title %}ì•Œë¦¼ ì„¼í„° - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">ğŸ”” ì•Œë¦¼ ì„¼í„°</h2>
                <p class="text-gray-600 mt-1">ì½ì§€ ì•Šì€ ì•Œë¦¼: <span class="font-bold text-blue-600">{{ unread_count }}ê°œ</span></p>
            </div>
            {% if unread_count > 0 %}
            <button onclick="markAllAsRead()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition duration-200">
                ëª¨ë‘ ì½ìŒ ì²˜ë¦¬
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- í•„í„° íƒ­ -->
    <div class="bg-white rounded-lg shadow-lg mb-6 overflow-hidden">
        <div class="flex border-b border-gray-200">
            <a href="{{ url_for('notifications.index', type='all') }}"
               class="flex-1 px-6 py-4 text-center font-medium transition duration-200 {% if filter_type == 'all' %}bg-blue-50 text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:bg-gray-50{% endif %}">
                ì „ì²´
            </a>
            <a href="{{ url_for('notifications.index', type='unread') }}"
               class="flex-1 px-6 py-4 text-center font-medium transition duration-200 {% if filter_type == 'unread' %}bg-blue-50 text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:bg-gray-50{% endif %}">
                ì½ì§€ ì•ŠìŒ
            </a>
            <a href="{{ url_for('notifications.index', type='comment') }}"
               class="flex-1 px-6 py-4 text-center font-medium transition duration-200 {% if filter_type == 'comment' %}bg-blue-50 text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:bg-gray-50{% endif %}">
                ğŸ’¬ ëŒ“ê¸€
            </a>
            <a href="{{ url_for('notifications.index', type='like') }}"
               class="flex-1 px-6 py-4 text-center font-medium transition duration-200 {% if filter_type == 'like' %}bg-blue-50 text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:bg-gray-50{% endif %}">
                â¤ï¸ ì¢‹ì•„ìš”
            </a>
            <a href="{{ url_for('notifications.index', type='essay_complete') }}"
               class="flex-1 px-6 py-4 text-center font-medium transition duration-200 {% if filter_type == 'essay_complete' %}bg-blue-50 text-blue-600 border-b-2 border-blue-600{% else %}text-gray-600 hover:bg-gray-50{% endif %}">
                âœ… ì²¨ì‚­ì™„ë£Œ
            </a>
        </div>
    </div>

    <!-- ì•Œë¦¼ ëª©ë¡ -->
    {% if notifications %}
    <div class="space-y-3">
        {% for notification in notifications %}
        <div id="notification-{{ notification.notification_id }}"
             class="bg-white rounded-lg shadow hover:shadow-md transition duration-200 {% if not notification.is_read %}border-l-4 border-blue-500{% endif %}">
            <div class="p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <!-- ì•„ì´ì½˜ -->
                            <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-xl
                                {% if notification.notification_type == 'comment' %}bg-blue-100
                                {% elif notification.notification_type == 'like' %}bg-red-100
                                {% elif notification.notification_type == 'essay_complete' %}bg-green-100
                                {% else %}bg-gray-100{% endif %}">
                                {% if notification.notification_type == 'comment' %}ğŸ’¬
                                {% elif notification.notification_type == 'like' %}â¤ï¸
                                {% elif notification.notification_type == 'essay_complete' %}âœ…
                                {% else %}ğŸ””{% endif %}
                            </div>

                            <!-- ë‚´ìš© -->
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800 {% if not notification.is_read %}text-blue-700{% endif %}">
                                    {{ notification.title }}
                                </h3>
                                <p class="text-gray-600 text-sm mt-1">{{ notification.message }}</p>
                                <div class="flex items-center gap-3 mt-2 text-xs text-gray-500">
                                    <span>{{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    {% if not notification.is_read %}
                                    <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full font-medium">NEW</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                    <div class="flex gap-2 ml-4">
                        {% if notification.link_url %}
                        <a href="{{ notification.link_url }}"
                           onclick="markAsRead('{{ notification.notification_id }}')"
                           class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded transition duration-200">
                            ë³´ê¸°
                        </a>
                        {% endif %}
                        {% if not notification.is_read %}
                        <button onclick="markAsRead('{{ notification.notification_id }}')"
                                class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium px-4 py-2 rounded transition duration-200">
                            ì½ìŒ
                        </button>
                        {% endif %}
                        <button onclick="deleteNotification('{{ notification.notification_id }}')"
                                class="text-gray-400 hover:text-red-600 transition duration-200">
                            âœ•
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-12 text-center">
        <div class="text-6xl mb-4">ğŸ””</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-600">
            {% if filter_type == 'unread' %}
            ì½ì§€ ì•Šì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
            {% else %}
            ìƒˆë¡œìš´ ì•Œë¦¼ì´ ë„ì°©í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

<script>
// ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
function markAsRead(notificationId) {
    fetch(`/notifications/${notificationId}/read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notificationElement = document.getElementById(`notification-${notificationId}`);
            if (notificationElement) {
                notificationElement.classList.remove('border-l-4', 'border-blue-500');
                const newBadge = notificationElement.querySelector('.bg-blue-100.text-blue-700');
                if (newBadge) {
                    newBadge.remove();
                }
            }
            updateUnreadCount(data.unread_count);
        }
    });
}

// ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œ
function markAllAsRead() {
    if (!confirm('ëª¨ë“  ì•Œë¦¼ì„ ì½ìŒìœ¼ë¡œ í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    fetch('/notifications/mark-all-read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// ì•Œë¦¼ ì‚­ì œ
function deleteNotification(notificationId) {
    if (!confirm('ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    fetch(`/notifications/${notificationId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notificationElement = document.getElementById(`notification-${notificationId}`);
            if (notificationElement) {
                notificationElement.remove();
            }
            updateUnreadCount(data.unread_count);
        }
    });
}

// ì½ì§€ ì•Šì€ ì•Œë¦¼ ìˆ˜ ì—…ë°ì´íŠ¸
function updateUnreadCount(count) {
    const badge = document.getElementById('notificationBadge');
    if (badge) {
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}
</script>
{% endblock %}
