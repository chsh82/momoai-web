{% extends "base.html" %}

{% block title %}{{ student.name }}ì˜ ACE í‰ê°€{% endblock %}

{% block page_title %}{{ student.name }}ì˜ ACE í‰ê°€{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">{{ student.grade }} Â· ì—­ëŸ‰ í‰ê°€ ìƒì„¸</span>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
.chart-wrap { position: relative; width: 100%; height: 280px; }
.timeline { position: relative; padding-left: 20px; }
.timeline-item { position: relative; padding-bottom: 18px; }
.timeline-item:last-child { padding-bottom: 0; }
.timeline-item::before {
    content: '';
    position: absolute;
    left: -26px;
    top: 4px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--purple);
    border: 2px solid #fff;
    box-shadow: var(--shadow);
}
.timeline-qtr { font-size: 13px; font-weight: 700; color: var(--text); }
.timeline-year { font-size: 11px; color: var(--text3); margin-left: 6px; }
.timeline-comment { font-size: 13px; color: var(--text2); margin-top: 4px; line-height: 1.7; }
.timeline-scores { font-size: 11px; color: var(--text3); margin-top: 4px; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- ë’¤ë¡œ ê°€ê¸° ë° ë¦¬í¬íŠ¸ ë²„íŠ¼ -->
    <div class="mb-4 flex justify-between items-center">
        <a href="{{ url_for('parent.ace_evaluation') }}" class="btn btn-outline btn-sm">
            <span>â† ìë…€ ëª©ë¡ìœ¼ë¡œ</span>
        </a>
        {% if ace_evals %}
        <a href="{{ url_for('parent.ace_report', student_id=student.student_id) }}"
           class="btn btn-primary btn-sm"
           target="_blank">
            <span>ğŸ–¨</span>
            <span>ë¦¬í¬íŠ¸ ì¶œë ¥</span>
        </a>
        {% endif %}
    </div>

    <!-- í•™ìƒ ì •ë³´ ì¹´ë“œ -->
    <div class="card-momo mb-4">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div>
                <div class="text-2xl font-extrabold">{{ student.name }}</div>
                <div class="text-sm text-gray-500 mt-1">
                    {{ student.grade }} Â· {{ student.school or 'í•™êµ ë¯¸ë“±ë¡' }}
                </div>
            </div>

            <div class="flex gap-4">
                <div class="bg-purple-50 rounded-xl px-6 py-3 text-center">
                    <div class="text-xs text-gray-500 mb-1">ACE í‰ê°€</div>
                    <div class="text-2xl font-bold text-purple-600 mono">{{ ace_evals|length }}<span class="text-sm text-gray-500">ê±´</span></div>
                </div>
                <div class="bg-blue-50 rounded-xl px-6 py-3 text-center">
                    <div class="text-xs text-gray-500 mb-1">ì£¼ì°¨ í‰ê°€</div>
                    <div class="text-2xl font-bold text-blue-600 mono">{{ weekly_evals|length }}<span class="text-sm text-gray-500">ê±´</span></div>
                </div>
                {% if latest_ace %}
                <div class="bg-green-50 rounded-xl px-6 py-3 text-center">
                    <div class="text-xs text-gray-500 mb-1">ìµœê·¼ ì´ì </div>
                    <div class="text-2xl font-bold text-green-600 mono">{{ latest_ace.get_total_score() }}<span class="text-sm text-gray-500">/75</span></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if not ace_evals and not weekly_evals %}
    <!-- í‰ê°€ê°€ ì—†ëŠ” ê²½ìš° -->
    <div class="card-momo">
        <div class="text-center py-12">
            <div class="text-5xl mb-4">ğŸ“‹</div>
            <h3 class="text-xl font-bold mb-2">ì•„ì§ í‰ê°€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-600">ì„ ìƒë‹˜ì´ í‰ê°€ë¥¼ ì…ë ¥í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    {% else %}

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <!-- ACE ì—­ëŸ‰ ë¶„ì„ -->
        {% if latest_ace %}
        <div class="card-momo">
            <h3 class="text-base font-bold mb-1">ğŸ¯ ACE ì—­ëŸ‰ ë¶„ì„</h3>
            <p class="text-xs text-gray-500 mb-3">ìµœì‹  ë¶„ê¸° ê¸°ì¤€ ({{ latest_ace.year }}ë…„ {{ latest_ace.quarter }})</p>
            <div class="chart-wrap">
                <canvas id="aceRadar"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„  -->
        {% if weekly_evals %}
        <div class="card-momo">
            <h3 class="text-base font-bold mb-1">ğŸ“ˆ ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„ </h3>
            <p class="text-xs text-gray-500 mb-3">ì²¨ì‚­ ì ìˆ˜ ì¶”ì´</p>
            <div class="chart-wrap">
                <canvas id="growthChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ACE ë¶„ê¸° í‰ê°€ ì´ë ¥ -->
    {% if ace_evals %}
    <div class="card-momo mb-4">
        <h3 class="text-card-title mb-4">ğŸ’¬ ACE ë¶„ê¸° í‰ê°€ ì½”ë©˜íŠ¸</h3>

        <div class="timeline">
            {% for eval in ace_evals|reverse %}
            <div class="timeline-item">
                <div class="timeline-qtr">
                    {{ eval.quarter }}
                    <span class="timeline-year">{{ eval.year }}ë…„ Â· {{ eval.teacher.name if eval.teacher else 'ê°•ì‚¬' }}</span>
                </div>
                <div class="timeline-comment">{{ eval.comment or 'ì½”ë©˜íŠ¸ ì—†ìŒ' }}</div>
                <div class="timeline-scores">
                    ì´ì  {{ eval.get_total_score() }}/75 Â·
                    {% for axis in ace_axes %}
                    <span style="color: {{ axis.color }}; font-weight: 600;">
                        {{ axis.name[:2] }} {{ "%.1f"|format(eval.get_axis_average(axis.item_names)) }}
                    </span>{{ ' Â· ' if not loop.last else '' }}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ìµœê·¼ ì£¼ì°¨ í‰ê°€ -->
    {% if weekly_evals %}
    <div class="card-momo">
        <h3 class="text-card-title mb-4">ğŸ“ ìµœê·¼ ì£¼ì°¨ í‰ê°€</h3>

        <table class="table-momo w-full">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ì£¼ì°¨</th>
                    <th>ë„ì„œ</th>
                    <th>ìœ í˜•</th>
                    <th>ì ìˆ˜</th>
                    <th>ë“±ê¸‰</th>
                    <th>ì½”ë©˜íŠ¸</th>
                </tr>
            </thead>
            <tbody>
                {% for eval in weekly_evals[:10] %}
                <tr>
                    <td>{{ eval.eval_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ eval.week_number }}ì£¼ì°¨</td>
                    <td>{{ eval.book_title or '-' }}</td>
                    <td>{{ eval.class_type or '-' }}</td>
                    <td class="mono font-bold" style="color: {{ '#10B981' if eval.score >= 80 else '#F59E0B' if eval.score >= 60 else '#EF4444' }}">{{ eval.score }}</td>
                    <td>
                        <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3B82F6;">{{ eval.grade }}</span>
                    </td>
                    <td class="text-sm text-gray-600 max-w-xs truncate">{{ eval.comment or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% endif %}

</div>

{% if latest_ace or weekly_evals %}
<script>
// ACE ì—­ëŸ‰ ë ˆì´ë” ì°¨íŠ¸
{% if latest_ace %}
const aceCtx = document.getElementById('aceRadar');
if (aceCtx) {
    new Chart(aceCtx, {
        type: 'radar',
        data: {
            labels: [{% for axis in ace_axes %}'{{ axis.name }}'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [{
                label: '{{ latest_ace.year }}ë…„ {{ latest_ace.quarter }}',
                data: [{% for axis in ace_axes %}{{ "%.1f"|format(latest_ace.get_axis_average(axis.item_names)) }}{{ ',' if not loop.last else '' }}{% endfor %}],
                backgroundColor: 'rgba(139, 92, 246, 0.15)',
                borderColor: '#8B5CF6',
                borderWidth: 2.5,
                pointBackgroundColor: '#8B5CF6',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                r: {
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        font: { size: 10 },
                        backdropColor: 'transparent'
                    },
                    grid: { color: '#E2E8F0' },
                    pointLabels: {
                        font: { size: 11, family: 'Noto Sans KR' }
                    }
                }
            }
        }
    });
}
{% endif %}

// ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„  ì°¨íŠ¸
{% if weekly_evals %}
const growthCtx = document.getElementById('growthChart');
if (growthCtx) {
    new Chart(growthCtx, {
        type: 'line',
        data: {
            labels: [{% for eval in weekly_evals|reverse %}'{{ eval.week_number }}ì£¼ì°¨'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [{
                label: 'ì²¨ì‚­ ì ìˆ˜',
                data: [{% for eval in weekly_evals|reverse %}{{ eval.score }}{{ ',' if not loop.last else '' }}{% endfor %}],
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#3B82F6',
                pointBorderWidth: 2.5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.raw + 'ì ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    grid: { color: '#F1F5F9' }
                },
                x: { grid: { display: false } }
            }
        }
    });
}
{% endif %}
</script>
{% endif %}

{% endblock %}
