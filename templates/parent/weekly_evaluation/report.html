{% extends "base.html" %}

{% block title %}{{ student.name }} ì£¼ê°„í‰ê°€ ë¦¬í¬íŠ¸{% endblock %}

{% block page_title %}ğŸ“Š {{ student.name }} ì£¼ê°„í‰ê°€ ë¦¬í¬íŠ¸{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ì„±ì¥ ì¶”ì´ ë¶„ì„</span>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- ìƒë‹¨ ë²„íŠ¼ -->
    <div class="flex justify-between items-center mb-6">
        <a href="{{ url_for('parent.weekly_evaluation') }}" class="btn btn-outline">
            â† ëŒì•„ê°€ê¸°
        </a>

        <!-- ê¸°ê°„ í•„í„° -->
        <div class="flex gap-2">
            <a href="{{ url_for('parent.weekly_evaluation_report', student_id=student.student_id, period='3months') }}"
               class="btn {{ 'btn-primary' if period == '3months' else 'btn-outline' }}">
                ìµœê·¼ 3ê°œì›”
            </a>
            <a href="{{ url_for('parent.weekly_evaluation_report', student_id=student.student_id, period='6months') }}"
               class="btn {{ 'btn-primary' if period == '6months' else 'btn-outline' }}">
                ìµœê·¼ 6ê°œì›”
            </a>
            <a href="{{ url_for('parent.weekly_evaluation_report', student_id=student.student_id, period='1year') }}"
               class="btn {{ 'btn-primary' if period == '1year' else 'btn-outline' }}">
                ìµœê·¼ 1ë…„
            </a>
            <a href="{{ url_for('parent.weekly_evaluation_report', student_id=student.student_id, period='all') }}"
               class="btn {{ 'btn-primary' if period == 'all' else 'btn-outline' }}">
                ì „ì²´
            </a>
        </div>
    </div>

    <!-- í•™ìƒ ì •ë³´ -->
    <div class="card-momo mb-6">
        <div class="flex items-center gap-4">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-full flex items-center justify-center font-bold text-3xl">
                {{ student.name[0] }}
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{{ student.name }}</h2>
                <p class="text-gray-600">{{ student.grade }} | {{ student.school or 'í•™êµ ë¯¸ë“±ë¡' }}</p>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- ì´ í‰ê°€ íšŸìˆ˜ -->
        <div class="card-momo text-center">
            <div class="text-3xl mb-2">ğŸ“</div>
            <div class="text-3xl font-bold text-blue-600">{{ total_count }}</div>
            <div class="text-sm text-gray-600 mt-1">ì´ í‰ê°€ íšŸìˆ˜</div>
        </div>

        <!-- í‰ê·  ê¸€ì“°ê¸° ì ìˆ˜ -->
        <div class="card-momo text-center">
            <div class="text-3xl mb-2">âœï¸</div>
            <div class="text-3xl font-bold text-green-600">{{ avg_score }}</div>
            <div class="text-sm text-gray-600 mt-1">í‰ê·  ê¸€ì“°ê¸° ì ìˆ˜</div>
            <div class="text-xs text-gray-500 mt-1">ìµœê³ : {{ max_score }} | ìµœì €: {{ min_score }}</div>
        </div>

        <!-- í‰ê·  ì°¸ì—¬ë„/ì´í•´ë„ -->
        <div class="card-momo text-center">
            <div class="text-3xl mb-2">â­</div>
            <div class="flex justify-center gap-3">
                <div>
                    <div class="text-2xl font-bold text-yellow-600">{{ avg_participation }}</div>
                    <div class="text-xs text-gray-600">ì°¸ì—¬ë„</div>
                </div>
                <div class="text-gray-300">/</div>
                <div>
                    <div class="text-2xl font-bold text-purple-600">{{ avg_understanding }}</div>
                    <div class="text-xs text-gray-600">ì´í•´ë„</div>
                </div>
            </div>
            <div class="text-sm text-gray-600 mt-1">í‰ê·  ë³„ì  (5ì  ë§Œì )</div>
        </div>

        <!-- ìµœê·¼ ì„±ì¥ë¥  -->
        <div class="card-momo text-center">
            <div class="text-3xl mb-2">ğŸ“ˆ</div>
            <div class="text-3xl font-bold {{ 'text-green-600' if growth_rate > 0 else 'text-red-600' if growth_rate < 0 else 'text-gray-600' }}">
                {{ growth_rate }}%
            </div>
            <div class="text-sm text-gray-600 mt-1">ìµœê·¼ ì„±ì¥ë¥ </div>
            <div class="text-xs text-gray-500 mt-1">
                {% if growth_rate > 0 %}â†‘ ìƒìŠ¹{% elif growth_rate < 0 %}â†“ í•˜ë½{% else %}â†’ ìœ ì§€{% endif %}
            </div>
        </div>
    </div>

    {% if evaluations %}
    <!-- í†µí•© ì‹œê³„ì—´ ê·¸ë˜í”„ -->
    <div class="card-momo mb-6">
        <h3 class="text-card-title mb-4">ğŸ“ˆ ì¢…í•© ì„±ì¥ ì¶”ì´</h3>
        <div style="height: 400px;">
            <canvas id="combinedChart"></canvas>
        </div>
        <div class="mt-4 flex justify-center gap-6 text-sm">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-blue-500 rounded"></div>
                <span>ê¸€ì“°ê¸° ì ìˆ˜</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                <span>ì°¸ì—¬ë„ (Ã—20)</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-green-500 rounded"></div>
                <span>ì´í•´ë„ (Ã—20)</span>
            </div>
        </div>
    </div>

    <!-- ê°œë³„ ê·¸ë˜í”„ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- ê¸€ì“°ê¸° ì ìˆ˜ ì¶”ì´ -->
        <div class="card-momo">
            <h3 class="text-lg font-bold text-gray-800 mb-4">âœï¸ ê¸€ì“°ê¸° ì ìˆ˜ ì¶”ì´</h3>
            <div style="height: 300px;">
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <!-- ë³„ì  ì¶”ì´ -->
        <div class="card-momo">
            <h3 class="text-lg font-bold text-gray-800 mb-4">â­ ì°¸ì—¬ë„/ì´í•´ë„ ì¶”ì´</h3>
            <div style="height: 300px;">
                <canvas id="ratingChart"></canvas>
            </div>
        </div>
    </div>

    <!-- í‰ê°€ ì´ë ¥ í…Œì´ë¸” -->
    <div class="card-momo">
        <h3 class="text-card-title mb-4">ğŸ“‹ í‰ê°€ ì´ë ¥</h3>
        <div class="overflow-x-auto">
            <table class="table-momo w-full">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì£¼ì°¨</th>
                        <th>ë„ì„œ</th>
                        <th>ì ìˆ˜</th>
                        <th>ë“±ê¸‰</th>
                        <th>ì°¸ì—¬ë„</th>
                        <th>ì´í•´ë„</th>
                        <th>ê°•ì‚¬ ì½”ë©˜íŠ¸</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eval in evaluations|reverse %}
                    <tr>
                        <td>{{ eval.eval_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ eval.week_number }}ì£¼</td>
                        <td>{{ eval.book_title or '-' }}</td>
                        <td class="font-bold" style="color: {{ '#10B981' if eval.score >= 80 else '#F59E0B' if eval.score >= 60 else '#EF4444' }}">
                            {{ eval.score }}
                        </td>
                        <td>
                            <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3B82F6;">
                                {{ eval.grade }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="text-yellow-500">{% for i in range(eval.participation_score) %}â˜…{% endfor %}{% for i in range(5 - eval.participation_score) %}â˜†{% endfor %}</span>
                            <div class="text-xs text-gray-600">{{ eval.participation_score }}ì </div>
                        </td>
                        <td class="text-center">
                            <span class="text-yellow-500">{% for i in range(eval.understanding_score) %}â˜…{% endfor %}{% for i in range(5 - eval.understanding_score) %}â˜†{% endfor %}</span>
                            <div class="text-xs text-gray-600">{{ eval.understanding_score }}ì </div>
                        </td>
                        <td class="text-sm text-gray-600 max-w-xs">
                            <div title="{{ eval.comment or '' }}">
                                {{ eval.comment or '-' }}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card-momo text-center py-12">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <p class="text-gray-600 text-lg">ì•„ì§ í‰ê°€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}

</div>

<script>
{% if evaluations %}
// ë°ì´í„° ì¤€ë¹„
const labels = [{% for eval in evaluations %}'{{ eval.eval_date.strftime("%m/%d") }} ({{ eval.week_number }}ì£¼)'{{ ',' if not loop.last else '' }}{% endfor %}];
const scores = [{% for eval in evaluations %}{{ eval.score }}{{ ',' if not loop.last else '' }}{% endfor %}];
const participation = [{% for eval in evaluations %}{{ eval.participation_score * 20 }}{{ ',' if not loop.last else '' }}{% endfor %}];
const understanding = [{% for eval in evaluations %}{{ eval.understanding_score * 20 }}{{ ',' if not loop.last else '' }}{% endfor %}];
const participationRaw = [{% for eval in evaluations %}{{ eval.participation_score }}{{ ',' if not loop.last else '' }}{% endfor %}];
const understandingRaw = [{% for eval in evaluations %}{{ eval.understanding_score }}{{ ',' if not loop.last else '' }}{% endfor %}];

// í†µí•© ì‹œê³„ì—´ ê·¸ë˜í”„
const combinedCtx = document.getElementById('combinedChart').getContext('2d');
new Chart(combinedCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'ê¸€ì“°ê¸° ì ìˆ˜',
                data: scores,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3,
                fill: true
            },
            {
                label: 'ì°¸ì—¬ë„ (Ã—20)',
                data: participation,
                borderColor: '#F59E0B',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.3,
                fill: true
            },
            {
                label: 'ì´í•´ë„ (Ã—20)',
                data: understanding,
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.3,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: 'ì ìˆ˜'
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        }
    }
});

// ê¸€ì“°ê¸° ì ìˆ˜ ì¶”ì´
const scoreCtx = document.getElementById('scoreChart').getContext('2d');
new Chart(scoreCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'ê¸€ì“°ê¸° ì ìˆ˜',
            data: scores,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// ë³„ì  ì¶”ì´
const ratingCtx = document.getElementById('ratingChart').getContext('2d');
new Chart(ratingCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'ì°¸ì—¬ë„',
                data: participationRaw,
                borderColor: '#F59E0B',
                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                tension: 0.3,
                fill: true
            },
            {
                label: 'ì´í•´ë„',
                data: understandingRaw,
                borderColor: '#8B5CF6',
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                tension: 0.3,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 5,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        }
    }
});
{% endif %}
</script>

{% endblock %}
