{% extends "base.html" %}

{% block title %}{{ student.name }} - MBTI ê²€ì‚¬{% endblock %}

{% block page_title %}ğŸ“ MBTI ê²€ì‚¬{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">{{ student.name }} í•™ìƒ ê²€ì‚¬ ì§„í–‰</span>
{% endblock %}


{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header with Progress -->
    <div class="sticky top-0 bg-white z-10 py-4 mb-6 border-b border-gray-200">
        <div class="flex items-center justify-between mb-2">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">ğŸ“š ë…ì„œ ë…¼ìˆ  MBTI ìê°€í‰ê°€</h2>
                <p class="text-sm text-purple-600 font-medium mt-0.5">
                    ğŸ‘¤ {{ student.name }} ({{ student.grade }}) í•™ìƒì„ ëŒ€ì‹ í•˜ì—¬ ê²€ì‚¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤
                </p>
            </div>
            <button onclick="confirmExit()" class="text-gray-600 hover:text-gray-800 text-sm font-medium">
                ì·¨ì†Œ
            </button>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex-1">
                <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-purple-500 to-indigo-600 transition-all duration-300"
                         style="width: 0%"></div>
                </div>
            </div>
            <div class="text-sm font-medium text-gray-600">
                <span id="progressText">0</span> / 50
            </div>
        </div>
    </div>

    <form id="mbtiForm" method="POST"
          action="{{ url_for('parent.parent_submit_reading_mbti', student_id=student.student_id, test_id=test.test_id) }}">

        <!-- Part 1: ì ˆëŒ€í‰ê°€ ì§ˆë¬¸ (45ë¬¸í•­) -->
        <div class="mb-12">
            <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-2">Part 1: ìê°€í‰ê°€ (45ë¬¸í•­)</h3>
                {% if test.version == 'elementary' %}
                <p class="text-purple-100">
                    ê° ë¬¸í•­ì„ ì½ê³  ìë…€ì—ê²Œ í•´ë‹¹í•˜ëŠ” ì ìˆ˜ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”!
                </p>
                <div class="grid grid-cols-5 gap-2 mt-4 text-sm">
                    <div class="text-center">1ì <br>ì „í˜€ ì•„ë‹ˆì•¼</div>
                    <div class="text-center">2ì <br>ì•„ë‹ˆì•¼</div>
                    <div class="text-center">3ì <br>ë³´í†µì´ì•¼</div>
                    <div class="text-center">4ì <br>ê·¸ë˜</div>
                    <div class="text-center">5ì <br>ì™„ì „ ê·¸ë˜!</div>
                </div>
                {% else %}
                <p class="text-purple-100">
                    ê° ë¬¸í•­ì„ ì½ê³  ìë…€ì—ê²Œ í•´ë‹¹í•˜ëŠ” ì •ë„ë¥¼ 1~5ì ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”.
                </p>
                <div class="grid grid-cols-5 gap-2 mt-4 text-sm">
                    <div class="text-center">1ì <br>ì „í˜€ ì•„ë‹ˆë‹¤</div>
                    <div class="text-center">2ì <br>ì•„ë‹ˆë‹¤</div>
                    <div class="text-center">3ì <br>ë³´í†µì´ë‹¤</div>
                    <div class="text-center">4ì <br>ê·¸ë ‡ë‹¤</div>
                    <div class="text-center">5ì <br>ë§¤ìš° ê·¸ë ‡ë‹¤</div>
                </div>
                {% endif %}
            </div>

            <!-- ë…í•´ ì˜ì—­ (15ë¬¸í•­) -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ“–</span>
                    ë…í•´ ì˜ì—­ (1-15ë²ˆ)
                </h4>
                <div class="space-y-4">
                    {% for question in absolute_questions[:15] %}
                    <div class="border-b border-gray-200 pb-4 last:border-0">
                        <div class="font-medium text-gray-800 mb-3">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="flex gap-2 justify-center">
                            {% for value in range(1, 6) %}
                            <label class="flex-1 relative">
                                <input type="radio" name="q{{ question.order }}" value="{{ value }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-3 text-center cursor-pointer hover:border-purple-400 transition">
                                    <div class="text-xl font-bold">{{ value }}</div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ë°œí‘œ/í† ë¡  ì˜ì—­ (15ë¬¸í•­) -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ’¬</span>
                    ë°œí‘œ/í† ë¡  ì˜ì—­ (16-30ë²ˆ)
                </h4>
                <div class="space-y-4">
                    {% for question in absolute_questions[15:30] %}
                    <div class="border-b border-gray-200 pb-4 last:border-0">
                        <div class="font-medium text-gray-800 mb-3">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="flex gap-2 justify-center">
                            {% for value in range(1, 6) %}
                            <label class="flex-1 relative">
                                <input type="radio" name="q{{ question.order }}" value="{{ value }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-3 text-center cursor-pointer hover:border-purple-400 transition">
                                    <div class="text-xl font-bold">{{ value }}</div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ì“°ê¸° ì˜ì—­ (15ë¬¸í•­) -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-2xl">âœï¸</span>
                    ì“°ê¸° ì˜ì—­ (31-45ë²ˆ)
                </h4>
                <div class="space-y-4">
                    {% for question in absolute_questions[30:45] %}
                    <div class="border-b border-gray-200 pb-4 last:border-0">
                        <div class="font-medium text-gray-800 mb-3">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="flex gap-2 justify-center">
                            {% for value in range(1, 6) %}
                            <label class="flex-1 relative">
                                <input type="radio" name="q{{ question.order }}" value="{{ value }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-3 text-center cursor-pointer hover:border-purple-400 transition">
                                    <div class="text-xl font-bold">{{ value }}</div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Part 2: ë¹„êµ ì„ íƒ ì§ˆë¬¸ (5ë¬¸í•­) -->
        <div class="mb-32">
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-2">Part 2: ìš°ì„ ìˆœìœ„ ì„ íƒ (5ë¬¸í•­)</h3>
                <p class="text-indigo-100">
                    ê° ì§ˆë¬¸ì—ì„œ ìë…€ì—ê²Œ ê°€ì¥ ì˜ ë§ëŠ” í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.
                </p>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="space-y-6">
                    {% for question in comparison_questions %}
                    {% set question_num = loop.index %}
                    <div class="border-b border-gray-200 pb-6 last:border-0">
                        <div class="font-bold text-gray-800 mb-4 text-lg">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="space-y-2">
                            {% for option in question.options %}
                            <label class="block relative">
                                <input type="radio" name="comp{{ question_num }}" value="{{ option.v }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition">
                                    {{ option.t }}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Submit Button (Fixed) -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-4 shadow-lg z-50">
            <div class="max-w-5xl mx-auto px-4 flex gap-4">
                <button type="button" onclick="confirmExit()"
                        class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 rounded-lg transition">
                    ì·¨ì†Œ
                </button>
                <button type="submit" id="submitBtn" disabled
                        class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700
                               text-white font-bold py-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submitText">ë‹µë³€ ì§„í–‰ ì¤‘... (0/50)</span>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function updateProgress() {
    const totalQuestions = 50;
    let answeredCount = 0;

    for (let i = 1; i <= 45; i++) {
        const radios = document.getElementsByName(`q${i}`);
        for (let radio of radios) {
            if (radio.checked) { answeredCount++; break; }
        }
    }
    for (let i = 1; i <= 5; i++) {
        const radios = document.getElementsByName(`comp${i}`);
        for (let radio of radios) {
            if (radio.checked) { answeredCount++; break; }
        }
    }

    const percentage = (answeredCount / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressText').textContent = answeredCount;

    const submitBtn = document.getElementById('submitBtn');
    if (answeredCount === totalQuestions) {
        submitBtn.disabled = false;
        document.getElementById('submitText').textContent = 'âœ… ê²°ê³¼ í™•ì¸í•˜ê¸° (ì™„ë£Œ!)';
    } else {
        submitBtn.disabled = true;
        document.getElementById('submitText').textContent = `ë‹µë³€ ì§„í–‰ ì¤‘... (${answeredCount}/50)`;
    }
}

function confirmExit() {
    if (confirm('ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì§€ê¸ˆê¹Œì§€ ì…ë ¥í•œ ë‹µë³€ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) {
        window.location.href = '{{ url_for("parent.child_mbti", student_id=student.student_id) }}';
    }
}

document.getElementById('mbtiForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn.disabled) {
        e.preventDefault();
        alert('ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”.');
        return;
    }
    submitBtn.disabled = true;
    document.getElementById('submitText').textContent = 'ê²°ê³¼ ê³„ì‚° ì¤‘...';
});

window.addEventListener('beforeunload', function(e) {
    const answeredCount = parseInt(document.getElementById('progressText').textContent);
    if (answeredCount > 0 && answeredCount < 50) {
        e.preventDefault();
        e.returnValue = '';
    }
});

document.addEventListener('DOMContentLoaded', updateProgress);
</script>
{% endblock %}
