{% extends "base.html" %}

{% block title %}ë¬¸ì ë°œì†¡ - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('admin.messages') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ë°œì†¡ ë‚´ì—­ìœ¼ë¡œ
        </a>
        <h2 class="text-3xl font-bold text-gray-800">ğŸ“± ë¬¸ì ë°œì†¡</h2>
        <p class="text-gray-600 mt-1">SMS/LMS ë¬¸ìë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.</p>
    </div>

    <!-- ë°œì†¡ í¼ -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <form method="POST" id="messageForm">
                <!-- ë©”ì‹œì§€ ìœ í˜• -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ë©”ì‹œì§€ ìœ í˜• <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="message_type" value="SMS" checked
                                   class="mr-2" onchange="toggleMessageType()">
                            <span class="px-4 py-2 border-2 border-blue-500 bg-blue-50 text-blue-700 rounded-lg font-medium">
                                SMS (ë‹¨ë¬¸ 90ë°”ì´íŠ¸)
                            </span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="message_type" value="LMS"
                                   class="mr-2" onchange="toggleMessageType()">
                            <span class="px-4 py-2 border-2 border-gray-300 text-gray-700 rounded-lg font-medium">
                                LMS (ì¥ë¬¸ 2000ë°”ì´íŠ¸)
                            </span>
                        </label>
                    </div>
                </div>

                <!-- ì œëª© (LMS only) -->
                <div class="mb-6" id="subjectField" style="display: none;">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">
                        ì œëª© <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="subject" name="subject"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="LMS ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <!-- ë‚´ìš© -->
                <div class="mb-6">
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                        ë‚´ìš© <span class="text-red-500">*</span>
                    </label>
                    <textarea id="content" name="content" rows="10" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                              oninput="updateCharCount()"></textarea>
                    <div class="mt-2 flex items-center justify-between text-sm">
                        <span id="charInfo" class="text-gray-600">0ì (0ë°”ì´íŠ¸)</span>
                        <span id="charLimit" class="text-gray-500">ìµœëŒ€: SMS 90ë°”ì´íŠ¸ / LMS 2000ë°”ì´íŠ¸</span>
                    </div>
                </div>

                <!-- ìˆ˜ì‹ ì ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ìˆ˜ì‹ ì <span class="text-red-500">*</span>
                    </label>

                    <!-- ìˆ˜ì‹ ì ìœ í˜• (ì „ì²´/ê°œë³„) -->
                    <div class="mb-4 flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="recipient_type" value="individual" checked
                                   class="mr-2" onchange="toggleRecipientType()">
                            <span class="font-medium text-gray-700">ê°œë³„ ì„ íƒ</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="recipient_type" value="all"
                                   class="mr-2" onchange="toggleRecipientType()">
                            <span class="font-medium text-gray-700">ì „ì²´ (í•„í„° ì ìš©)</span>
                        </label>
                    </div>

                    <!-- ê°œë³„ ì„ íƒ -->
                    <div id="recipientSelect">
                        <!-- í•™ìƒ/í•™ë¶€ëª¨ í† ê¸€ -->
                        <div class="mb-3 flex items-center gap-2">
                            <span class="text-sm text-gray-600 font-medium">ëŒ€ìƒ:</span>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="target_group" value="student" checked
                                       class="mr-1" onchange="switchTargetGroup()">
                                <span class="px-3 py-1 text-sm rounded border border-blue-500 bg-blue-50 text-blue-700 font-medium">í•™ìƒ</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="target_group" value="parent"
                                       class="mr-1" onchange="switchTargetGroup()">
                                <span class="px-3 py-1 text-sm rounded border border-gray-300 text-gray-700 font-medium">í•™ë¶€ëª¨</span>
                            </label>
                        </div>

                        <!-- í•„í„° (í•™ìƒìš©) -->
                        <div id="studentFilters" class="mb-3 flex flex-wrap gap-3">
                            <select id="gradeFilter" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onchange="filterRecipients()">
                                <option value="">ì „ì²´ í•™ë…„</option>
                                <option value="ì´ˆ1">ì´ˆ1</option>
                                <option value="ì´ˆ2">ì´ˆ2</option>
                                <option value="ì´ˆ3">ì´ˆ3</option>
                                <option value="ì´ˆ4">ì´ˆ4</option>
                                <option value="ì´ˆ5">ì´ˆ5</option>
                                <option value="ì´ˆ6">ì´ˆ6</option>
                                <option value="ì¤‘1">ì¤‘1</option>
                                <option value="ì¤‘2">ì¤‘2</option>
                                <option value="ì¤‘3">ì¤‘3</option>
                                <option value="ê³ 1">ê³ 1</option>
                                <option value="ê³ 2">ê³ 2</option>
                                <option value="ê³ 3">ê³ 3</option>
                            </select>
                            <input type="text" id="nameSearch" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-40"
                                   placeholder="ì´ë¦„ ê²€ìƒ‰..." oninput="filterRecipients()">
                        </div>

                        <!-- í•„í„° (í•™ë¶€ëª¨ìš© - ìë…€ ì´ë¦„/í•™ë…„ ê¸°ì¤€) -->
                        <div id="parentFilters" class="mb-3 flex flex-wrap gap-3" style="display:none;">
                            <select id="parentGradeFilter" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onchange="filterParents()">
                                <option value="">ìë…€ ì „ì²´ í•™ë…„</option>
                                <option value="ì´ˆ1">ì´ˆ1</option>
                                <option value="ì´ˆ2">ì´ˆ2</option>
                                <option value="ì´ˆ3">ì´ˆ3</option>
                                <option value="ì´ˆ4">ì´ˆ4</option>
                                <option value="ì´ˆ5">ì´ˆ5</option>
                                <option value="ì´ˆ6">ì´ˆ6</option>
                                <option value="ì¤‘1">ì¤‘1</option>
                                <option value="ì¤‘2">ì¤‘2</option>
                                <option value="ì¤‘3">ì¤‘3</option>
                                <option value="ê³ 1">ê³ 1</option>
                                <option value="ê³ 2">ê³ 2</option>
                                <option value="ê³ 3">ê³ 3</option>
                            </select>
                            <input type="text" id="childNameSearch" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-40"
                                   placeholder="ìë…€ ì´ë¦„ ê²€ìƒ‰..." oninput="filterParents()">
                        </div>

                        <!-- ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼ -->
                        <div class="mb-2">
                            <button type="button" onclick="selectAll()" class="text-blue-600 hover:text-blue-800 text-sm font-medium mr-3">
                                ì „ì²´ ì„ íƒ
                            </button>
                            <button type="button" onclick="deselectAll()" class="text-gray-600 hover:text-gray-800 text-sm font-medium">
                                ì „ì²´ í•´ì œ
                            </button>
                        </div>

                        <!-- í•™ìƒ ëª©ë¡ -->
                        <div id="studentList" class="border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto">
                            {% if students %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2" id="studentGrid">
                                {% for student in students %}
                                <label class="recipient-item flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"
                                       data-name="{{ student.name }}" data-grade="{{ student.grade }}">
                                    <input type="checkbox" name="recipients[]" value="{{ student.student_id }}"
                                           class="mr-2 recipient-checkbox" onchange="updateRecipientCount()">
                                    <span class="text-sm text-gray-800">
                                        {{ student.name }}
                                        <span class="text-gray-500">({{ student.grade }})</span>
                                        {% if student.phone %}
                                        <span class="text-gray-400 text-xs"> {{ student.phone }}</span>
                                        {% else %}
                                        <span class="text-red-400 text-xs"> ë²ˆí˜¸ì—†ìŒ</span>
                                        {% endif %}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-gray-500 text-center py-4">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            {% endif %}
                        </div>

                        <!-- í•™ë¶€ëª¨ ëª©ë¡ (ê¸°ë³¸ ìˆ¨ê¹€) -->
                        <div id="parentList" class="border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto" style="display:none;">
                            {% if parents_with_children %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2" id="parentGrid">
                                {% for item in parents_with_children %}
                                <label class="parent-item flex items-start p-2 hover:bg-gray-50 rounded cursor-pointer"
                                       data-child-names="{{ item.children | map(attribute='name') | join(',') }}"
                                       data-child-grades="{{ item.children | map(attribute='grade') | join(',') }}">
                                    <input type="checkbox" name="recipients[]" value="{{ item.parent.user_id }}"
                                           class="mr-2 mt-0.5 recipient-checkbox" onchange="updateRecipientCount()">
                                    <span class="text-sm text-gray-800">
                                        {{ item.parent.name }}
                                        {% if item.children %}
                                        <span class="text-gray-500 text-xs ml-1">
                                            (ìë…€:
                                            {% for child in item.children %}{{ child.name }}({{ child.grade }}){% if not loop.last %}, {% endif %}{% endfor %})
                                        </span>
                                        {% else %}
                                        <span class="text-gray-400 text-xs ml-1">(ìë…€ ë¯¸ë“±ë¡)</span>
                                        {% endif %}
                                        {% if item.parent.phone %}
                                        <span class="text-gray-400 text-xs"> {{ item.parent.phone }}</span>
                                        {% else %}
                                        <span class="text-red-400 text-xs"> ë²ˆí˜¸ì—†ìŒ</span>
                                        {% endif %}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-gray-500 text-center py-4">ë“±ë¡ëœ í•™ë¶€ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            {% endif %}
                        </div>

                        <p class="mt-2 text-sm text-gray-600">
                            ì„ íƒëœ ìˆ˜ì‹ ì: <span id="recipientCount" class="font-medium text-blue-600">0</span>ëª…
                        </p>
                    </div>
                </div>

                <!-- ì˜ˆì•½ ë°œì†¡ -->
                <div class="mb-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="isScheduled" name="is_scheduled"
                               class="mr-2" onchange="toggleSchedule()">
                        <span class="text-sm font-medium text-gray-700">ì˜ˆì•½ ë°œì†¡</span>
                    </label>
                    <div id="scheduleField" style="display: none;" class="mt-3">
                        <input type="datetime-local" id="scheduled_at" name="scheduled_at"
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- ë©”ëª¨ -->
                <div class="mb-6">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                        ë©”ëª¨
                    </label>
                    <textarea id="notes" name="notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ë°œì†¡ ê´€ë ¨ ë©”ëª¨ (ì„ íƒì‚¬í•­)"></textarea>
                </div>

                <!-- ì•ˆë‚´ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">ğŸ’¡</span>
                        <div>
                            <h4 class="font-medium text-blue-900 mb-1">ë°œì†¡ ì•ˆë‚´</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>â€¢ SMS: 90ë°”ì´íŠ¸(í•œê¸€ ì•½ 45ì)ê¹Œì§€ ë°œì†¡ ê°€ëŠ¥</li>
                                <li>â€¢ LMS: 2000ë°”ì´íŠ¸(í•œê¸€ ì•½ 1000ì)ê¹Œì§€ ë°œì†¡ ê°€ëŠ¥</li>
                                <li>â€¢ ì‹¤ì œ SMS ë°œì†¡ì„ ìœ„í•´ì„œëŠ” SMS API ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤</li>
                                <li>â€¢ í˜„ì¬ëŠ” ë°œì†¡ ë‚´ì—­ë§Œ ì €ì¥ë©ë‹ˆë‹¤</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex gap-3">
                    <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                        ë°œì†¡í•˜ê¸°
                    </button>
                    <a href="{{ url_for('admin.messages') }}"
                       class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 rounded-lg transition duration-200 text-center">
                        ì·¨ì†Œ
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleMessageType() {
    const messageType = document.querySelector('input[name="message_type"]:checked').value;
    const subjectField = document.getElementById('subjectField');

    if (messageType === 'LMS') {
        subjectField.style.display = 'block';
        document.getElementById('subject').required = true;
    } else {
        subjectField.style.display = 'none';
        document.getElementById('subject').required = false;
    }

    updateCharCount();
}

function updateCharCount() {
    const content = document.getElementById('content').value;
    const charCount = content.length;
    const byteCount = new Blob([content]).size;
    const messageType = document.querySelector('input[name="message_type"]:checked').value;

    const charInfo = document.getElementById('charInfo');
    charInfo.textContent = `${charCount}ì (${byteCount}ë°”ì´íŠ¸)`;

    // ì´ˆê³¼ ê²½ê³ 
    const maxBytes = messageType === 'SMS' ? 90 : 2000;
    if (byteCount > maxBytes) {
        charInfo.classList.add('text-red-600', 'font-bold');
        charInfo.textContent += ` - ì´ˆê³¼!`;
    } else {
        charInfo.classList.remove('text-red-600', 'font-bold');
        charInfo.classList.add('text-gray-600');
    }
}

function toggleRecipientType() {
    const recipientType = document.querySelector('input[name="recipient_type"]:checked').value;
    const recipientSelect = document.getElementById('recipientSelect');
    recipientSelect.style.display = (recipientType === 'all') ? 'none' : 'block';
}

function switchTargetGroup() {
    const group = document.querySelector('input[name="target_group"]:checked').value;
    const studentList = document.getElementById('studentList');
    const parentList = document.getElementById('parentList');
    const studentFilters = document.getElementById('studentFilters');
    const parentFilters = document.getElementById('parentFilters');

    // ì–¸ì²´í¬ ëª¨ë“  ì²´í¬ë°•ìŠ¤
    deselectAll();

    if (group === 'student') {
        studentList.style.display = 'block';
        parentList.style.display = 'none';
        studentFilters.style.display = 'flex';
        parentFilters.style.display = 'none';
    } else {
        studentList.style.display = 'none';
        parentList.style.display = 'block';
        studentFilters.style.display = 'none';
        parentFilters.style.display = 'flex';
    }

    // í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('input[name="target_group"]').forEach(radio => {
        const span = radio.nextElementSibling;
        if (radio.checked) {
            span.className = 'px-3 py-1 text-sm rounded border border-blue-500 bg-blue-50 text-blue-700 font-medium';
        } else {
            span.className = 'px-3 py-1 text-sm rounded border border-gray-300 text-gray-700 font-medium';
        }
    });
}

function filterRecipients() {
    const grade = document.getElementById('gradeFilter').value;
    const name = document.getElementById('nameSearch').value.toLowerCase();

    document.querySelectorAll('.recipient-item').forEach(item => {
        const itemName = item.dataset.name.toLowerCase();
        const itemGrade = item.dataset.grade;
        const matchGrade = !grade || itemGrade === grade;
        const matchName = !name || itemName.includes(name);
        item.style.display = (matchGrade && matchName) ? '' : 'none';
    });
}

function filterParents() {
    const grade = document.getElementById('parentGradeFilter').value;
    const name = document.getElementById('childNameSearch').value.toLowerCase();
    document.querySelectorAll('.parent-item').forEach(item => {
        const childNames = (item.dataset.childNames || '').toLowerCase();
        const childGrades = item.dataset.childGrades || '';
        const matchName = !name || childNames.includes(name);
        const matchGrade = !grade || childGrades.split(',').some(g => g.trim() === grade);
        item.style.display = (matchName && matchGrade) ? '' : 'none';
    });
}

function selectAll() {
    const group = document.querySelector('input[name="target_group"]:checked').value;
    if (group === 'student') {
        document.querySelectorAll('#studentList .recipient-item:not([style*="none"]) .recipient-checkbox').forEach(cb => cb.checked = true);
    } else {
        document.querySelectorAll('#parentList .parent-item:not([style*="none"]) .recipient-checkbox').forEach(cb => cb.checked = true);
    }
    updateRecipientCount();
}

function deselectAll() {
    document.querySelectorAll('.recipient-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateRecipientCount();
}

function updateRecipientCount() {
    const count = document.querySelectorAll('.recipient-checkbox:checked').length;
    document.getElementById('recipientCount').textContent = count;
}

function toggleSchedule() {
    const isScheduled = document.getElementById('isScheduled').checked;
    const scheduleField = document.getElementById('scheduleField');

    if (isScheduled) {
        scheduleField.style.display = 'block';
        document.getElementById('scheduled_at').required = true;
    } else {
        scheduleField.style.display = 'none';
        document.getElementById('scheduled_at').required = false;
    }
}

// í¼ ì œì¶œ ì „ ê²€ì¦
document.getElementById('messageForm').addEventListener('submit', function(e) {
    const recipientType = document.querySelector('input[name="recipient_type"]:checked').value;

    if (recipientType === 'individual') {
        const selectedCount = document.querySelectorAll('.recipient-checkbox:checked').length;
        if (selectedCount === 0) {
            e.preventDefault();
            alert('ìµœì†Œ 1ëª… ì´ìƒì˜ ìˆ˜ì‹ ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return false;
        }
    }
});
</script>
{% endblock %}
