{% extends "base.html" %}

{% block title %}ê²°ì œ ê´€ë¦¬ - MOMOAI v4.0{% endblock %}

{% block page_title %}ğŸ’° ìˆ˜ë‚© ê´€ë¦¬{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ì „ì²´ ê²°ì œ ë‚´ì—­</span>
{% endblock %}


{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">ğŸ’³ ê²°ì œ ê´€ë¦¬</h2>
            <p class="text-gray-600 mt-2">ì „ì²´ ê²°ì œ ë‚´ì—­ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
        <a href="{{ url_for('admin.create_payment') }}"
           class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition duration-200 flex items-center gap-2">
            <span class="text-xl">â•</span>
            <span>ê²°ì œ ìƒì„±</span>
        </a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border border-red-300{% elif category == 'success' %}bg-green-100 text-green-700 border border-green-300{% elif category == 'warning' %}bg-yellow-100 text-yellow-700 border border-yellow-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- í•„í„° -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <form method="GET" action="" class="flex items-center gap-4">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">ê²°ì œ ìƒíƒœ</label>
                <select name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="this.form.submit()">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>ëŒ€ê¸°</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>ì™„ë£Œ</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>ì·¨ì†Œ</option>
                    <option value="refunded" {% if status_filter == 'refunded' %}selected{% endif %}>í™˜ë¶ˆ</option>
                </select>
            </div>
            <div class="pt-7">
                <a href="{{ url_for('admin.payments') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2 rounded-lg transition duration-200">
                    ì´ˆê¸°í™”
                </a>
            </div>
        </form>
    </div>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        {% set total_count = payments|length %}
        {% set pending_count = payments|selectattr('status', 'equalto', 'pending')|list|length %}
        {% set completed_count = payments|selectattr('status', 'equalto', 'completed')|list|length %}
        {% set total_amount = payments|selectattr('status', 'equalto', 'completed')|sum(attribute='amount') %}

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">ì „ì²´ ê²°ì œ</p>
                    <p class="text-3xl font-bold text-gray-800">{{ total_count }}</p>
                </div>
                <div class="text-gray-600 text-4xl">ğŸ’³</div>
            </div>
        </div>

        <div class="bg-yellow-50 rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-yellow-600 mb-1">ëŒ€ê¸° ì¤‘</p>
                    <p class="text-3xl font-bold text-yellow-800">{{ pending_count }}</p>
                </div>
                <div class="text-yellow-600 text-4xl">â³</div>
            </div>
        </div>

        <div class="bg-green-50 rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-green-600 mb-1">ì™„ë£Œ</p>
                    <p class="text-3xl font-bold text-green-800">{{ completed_count }}</p>
                </div>
                <div class="text-green-600 text-4xl">âœ“</div>
            </div>
        </div>

        <div class="bg-blue-50 rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-blue-600 mb-1">ì´ ê¸ˆì•¡</p>
                    <p class="text-2xl font-bold text-blue-800">{{ "{:,}".format(total_amount) }}ì›</p>
                </div>
                <div class="text-blue-600 text-4xl">ğŸ’°</div>
            </div>
        </div>
    </div>

    <!-- ê²°ì œ ëª©ë¡ -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h3 class="text-xl font-bold text-gray-800">ê²°ì œ ë‚´ì—­</h3>
        </div>
        <div class="p-6">
            {% if payments %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê²°ì œì¼</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">í•™ìƒ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìˆ˜ì—…</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìœ í˜•</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ê¸ˆì•¡</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê²°ì œë°©ë²•</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">íšŒì°¨</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">ë©”ì‹œì§€</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for payment in payments %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {{ payment.created_at.strftime('%Y-%m-%d') if payment.created_at else '-' }}
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm font-medium text-gray-800">
                                    {{ payment.student.name if payment.student else '-' }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    {{ payment.student.grade if payment.student and payment.student.grade else '' }}
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm text-gray-700">
                                    {{ payment.course.course_name if payment.course else '-' }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {% if payment.payment_type == 'tuition' %}ìˆ˜ì—…ë£Œ
                                {% elif payment.payment_type == 'registration' %}ë“±ë¡ë¹„
                                {% elif payment.payment_type == 'material' %}êµì¬ë¹„
                                {% else %}{{ payment.payment_type }}
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right">
                                <div class="text-sm font-medium text-gray-800">
                                    {{ "{:,}".format(payment.amount) }}ì›
                                </div>
                                {% if payment.discount_amount and payment.discount_amount > 0 %}
                                <div class="text-xs text-red-600">
                                    ({{ "{:,}".format(payment.discount_amount) }}ì› í• ì¸)
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {% if payment.payment_method == 'card' %}ì¹´ë“œ
                                {% elif payment.payment_method == 'cash' %}í˜„ê¸ˆ
                                {% elif payment.payment_method == 'transfer' %}ê³„ì¢Œì´ì²´
                                {% else %}{{ payment.payment_method if payment.payment_method else '-' }}
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700 text-center">
                                {% if payment.sessions_covered %}
                                {{ payment.sessions_covered }}íšŒ
                                {% else %}-{% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if payment.status == 'completed' %}
                                <span class="px-2 py-1 text-xs font-medium rounded bg-green-100 text-green-800">ì™„ë£Œ</span>
                                {% elif payment.status == 'pending' %}
                                <span class="px-2 py-1 text-xs font-medium rounded bg-yellow-100 text-yellow-800">ëŒ€ê¸°</span>
                                {% elif payment.status == 'cancelled' %}
                                <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-800">ì·¨ì†Œ</span>
                                {% elif payment.status == 'refunded' %}
                                <span class="px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-800">í™˜ë¶ˆ</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-800">{{ payment.status }}</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex gap-1 justify-center">
                                    <button onclick="sendPaymentMessage('{{ payment.payment_id }}', 'sms')"
                                            class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded transition duration-200"
                                            title="ë¬¸ì ë°œì†¡">
                                        ğŸ“± SMS
                                    </button>
                                    <button onclick="sendPaymentMessage('{{ payment.payment_id }}', 'kakao')"
                                            class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 text-xs px-2 py-1 rounded transition duration-200"
                                            title="ì¹´ì¹´ì˜¤í†¡ ë°œì†¡">
                                        ğŸ’¬ ì¹´í†¡
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">ğŸ’³</div>
                <p class="text-gray-500 text-lg">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ë©”ì‹œì§€ ë°œì†¡ í™•ì¸ ëª¨ë‹¬ -->
<div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">ë©”ì‹œì§€ ë°œì†¡</h3>
                <button onclick="closeMessageModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="text-2xl">Ã—</span>
                </button>
            </div>

            <div class="space-y-4">
                <!-- ìˆ˜ì‹ ì ì •ë³´ -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-700 mb-2">ìˆ˜ì‹ ì ì •ë³´</h4>
                    <div class="text-sm text-gray-600" id="receiverInfo">
                        <p><strong>í•™ìƒ:</strong> <span id="studentName">-</span></p>
                        <p><strong>ì „í™”ë²ˆí˜¸:</strong> <span id="studentPhone">-</span></p>
                    </div>
                </div>

                <!-- ë©”ì‹œì§€ ë‚´ìš© -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">ë©”ì‹œì§€ ë‚´ìš©</h4>
                    <textarea id="messageContent"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                              rows="10"></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        <span id="messageLength">0</span>ì /
                        <span id="messageType">SMS</span>: <span id="messageLimit">90</span>ì ê¶Œì¥
                    </p>
                </div>

                <!-- ë°œì†¡ ì •ë³´ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <div class="text-blue-600 text-xl mr-3">â„¹ï¸</div>
                        <div class="text-sm text-blue-800">
                            <p class="font-medium mb-1">ë°œì†¡ ì•ˆë‚´</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li id="sendInfo">ë©”ì‹œì§€ê°€ ì¦‰ì‹œ ë°œì†¡ë©ë‹ˆë‹¤</li>
                                <li>ë°œì†¡ í›„ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>
                                <li>ìˆ˜ì‹ ì ì •ë³´ë¥¼ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex gap-3 pt-4">
                    <button onclick="confirmSendMessage()"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200"
                            id="sendButton">
                        ë°œì†¡í•˜ê¸°
                    </button>
                    <button onclick="closeMessageModal()"
                            class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-medium py-3 rounded-lg transition duration-200">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPaymentId = null;
let currentMessageType = null;

// ë©”ì‹œì§€ ë°œì†¡ ëª¨ë‹¬ ì—´ê¸°
function sendPaymentMessage(paymentId, messageType) {
    currentPaymentId = paymentId;
    currentMessageType = messageType;

    // ê²°ì œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    fetch(`/admin/api/payments/${paymentId}/message-info`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ìˆ˜ì‹ ì ì •ë³´ í‘œì‹œ
                document.getElementById('studentName').textContent = data.student_name;
                document.getElementById('studentPhone').textContent = data.phone || 'ì „í™”ë²ˆí˜¸ ì—†ìŒ';

                // ë©”ì‹œì§€ íƒ€ì… ì„¤ì •
                const modalTitle = messageType === 'sms' ? 'ğŸ“± SMS ë¬¸ì ë°œì†¡' : 'ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ë°œì†¡';
                document.getElementById('modalTitle').textContent = modalTitle;
                document.getElementById('messageType').textContent = messageType === 'sms' ? 'SMS' : 'ì¹´ì¹´ì˜¤í†¡';
                document.getElementById('messageLimit').textContent = messageType === 'sms' ? '90' : '1000';

                // ë°œì†¡ ì •ë³´ ì—…ë°ì´íŠ¸
                if (messageType === 'sms') {
                    document.getElementById('sendInfo').textContent = 'SMS ë¬¸ìê°€ ë°œì†¡ë©ë‹ˆë‹¤ (ë‹¨ë¬¸: 90ì ì´ë‚´ ê¶Œì¥)';
                    document.getElementById('sendButton').className = 'flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-lg transition duration-200';
                } else {
                    document.getElementById('sendInfo').textContent = 'ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ê°€ ë°œì†¡ë©ë‹ˆë‹¤ (ìµœëŒ€ 1000ì)';
                    document.getElementById('sendButton').className = 'flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 rounded-lg transition duration-200';
                }

                // ë©”ì‹œì§€ í…œí”Œë¦¿ ìƒì„±
                const message = generatePaymentMessage(data);
                document.getElementById('messageContent').value = message;
                updateMessageLength();

                // ì „í™”ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
                if (!data.phone) {
                    alert('âš ï¸ í•™ìƒì˜ ì „í™”ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                // ëª¨ë‹¬ ì—´ê¸°
                document.getElementById('messageModal').classList.remove('hidden');
            } else {
                alert('ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ê²°ì œ ë©”ì‹œì§€ í…œí”Œë¦¿ ìƒì„±
function generatePaymentMessage(data) {
    const amount = parseInt(data.amount).toLocaleString();
    const dueDate = data.due_date || '-';
    const paymentPeriod = data.payment_period === 'monthly' ? 'ì›”ë³„' : 'ë¶„ê¸°ë³„';
    const sessions = data.sessions_covered || '-';

    let message = `[MOMOAI ê²°ì œ ì•ˆë‚´]\n\n`;
    message += `í•™ìƒ: ${data.student_name}\n`;
    message += `ìˆ˜ì—…: ${data.course_name}\n`;
    message += `ê²°ì œ ìœ í˜•: ${paymentPeriod} (${sessions}íšŒ)\n`;
    message += `ê²°ì œ ê¸ˆì•¡: ${amount}ì›\n`;

    if (data.discount_amount > 0) {
        const discountAmount = parseInt(data.discount_amount).toLocaleString();
        message += `í• ì¸: ${discountAmount}ì›\n`;
    }

    message += `ë‚©ë¶€ ê¸°í•œ: ${dueDate}\n`;
    message += `ê²°ì œ ë°©ë²•: ${data.payment_method_text}\n\n`;
    message += `ê°ì‚¬í•©ë‹ˆë‹¤.`;

    return message;
}

// ë©”ì‹œì§€ ê¸¸ì´ ì—…ë°ì´íŠ¸
document.getElementById('messageContent')?.addEventListener('input', updateMessageLength);

function updateMessageLength() {
    const content = document.getElementById('messageContent').value;
    document.getElementById('messageLength').textContent = content.length;
}

// ë©”ì‹œì§€ ë°œì†¡ í™•ì¸
function confirmSendMessage() {
    const phone = document.getElementById('studentPhone').textContent;
    if (!phone || phone === 'ì „í™”ë²ˆí˜¸ ì—†ìŒ') {
        alert('ì „í™”ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šì•„ ë°œì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    const message = document.getElementById('messageContent').value.trim();
    if (!message) {
        alert('ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const messageTypeName = currentMessageType === 'sms' ? 'SMS ë¬¸ì' : 'ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€';
    if (!confirm(`${messageTypeName}ë¥¼ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìˆ˜ì‹ ì: ${document.getElementById('studentName').textContent}\nì „í™”ë²ˆí˜¸: ${phone}`)) {
        return;
    }

    // ë°œì†¡ ìš”ì²­
    fetch(`/admin/api/payments/${currentPaymentId}/send-message`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message_type: currentMessageType,
            message: message,
            phone: phone
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            closeMessageModal();
        } else {
            alert('âŒ ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeMessageModal() {
    document.getElementById('messageModal').classList.add('hidden');
    currentPaymentId = null;
    currentMessageType = null;
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('messageModal').classList.contains('hidden')) {
        closeMessageModal();
    }
});
</script>
{% endblock %}
