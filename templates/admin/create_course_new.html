{% extends "base.html" %}

{% block title %}ìƒˆ ìˆ˜ì—… ìƒì„± - MOMOAI v4.0{% endblock %}

{% block page_title %}â• ìƒˆ ìˆ˜ì—… ë§Œë“¤ê¸°{% endblock %}


{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('admin.courses') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ìˆ˜ì—… ëª©ë¡ìœ¼ë¡œ
        </a>
        <h2 class="text-3xl font-bold text-gray-800">ğŸ“š ìƒˆ ìˆ˜ì—… ìƒì„±</h2>
        <p class="text-gray-600 mt-1">ìˆ˜ì—… ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ìˆ˜ì—…ëª…ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</p>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border border-red-300{% elif category == 'success' %}bg-green-100 text-green-700 border border-green-300{% elif category == 'warning' %}bg-yellow-100 text-yellow-700 border border-yellow-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- í¼ -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <form method="POST" id="courseForm">
                {{ form.hidden_tag() }}

                <!-- Form-level errors -->
                {% if form.errors %}
                <div class="mb-6 p-4 bg-red-50 border border-red-300 rounded-lg">
                    <h4 class="text-red-800 font-medium mb-2">âš ï¸ ì…ë ¥ ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤:</h4>
                    <ul class="list-disc list-inside text-red-700 text-sm">
                        {% for field_name, errors in form.errors.items() %}
                            {% for error in errors %}
                            <li>{{ field_name }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- 1. í•™ë…„ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        1. í•™ë…„ <span class="text-red-500">*</span>
                    </label>
                    {{ form.grade(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", onchange="generateCourseName(); autoSetEndTime()") }}
                    {% if form.grade.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.grade.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 2. ìˆ˜ì—… íƒ€ì… ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        2. ìˆ˜ì—… íƒ€ì… <span class="text-red-500">*</span>
                    </label>
                    {{ form.course_type(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", onchange="generateCourseName(); autoSetEndTime()") }}
                    {% if form.course_type.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.course_type.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 3. êµì‚¬ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        3. ë‹´ë‹¹ ê°•ì‚¬ <span class="text-red-500">*</span>
                    </label>
                    {{ form.teacher_id(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", onchange="generateCourseName()") }}
                    {% if form.teacher_id.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.teacher_id.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 4. ì¢…ë£Œ ì—¬ë¶€ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        4. ì¢…ë£Œ ì—¬ë¶€ <span class="text-red-500">*</span>
                    </label>
                    {{ form.is_terminated(class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                    {% if form.is_terminated.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.is_terminated.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 5. ì‹œì‘ì¼ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        5. ì‹œì‘ì¼ <span class="text-red-500">*</span>
                    </label>
                    {{ form.start_date(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", onchange="autoSelectWeekday(); autoSetEndDate()") }}
                    {% if form.start_date.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.start_date.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 6. ì¢…ë£Œì¼ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        6. ì¢…ë£Œì¼ <span class="text-red-500">*</span>
                        <span class="text-gray-500 text-xs">(ì‹œì‘ì¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì„¤ì •ë˜ë©°, ìˆ˜ë™ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤)</span>
                    </label>
                    {{ form.end_date(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                    {% if form.end_date.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.end_date.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 7. ìš”ì¼ ì„ íƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        7. ìš”ì¼ <span class="text-red-500">*</span>
                        <span class="text-gray-500 text-xs">(ì‹œì‘ì¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì„ íƒë˜ë©°, ìˆ˜ë™ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤)</span>
                    </label>
                    {{ form.weekday(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", id="weekdaySelect", onchange="generateCourseName()") }}
                    {% if form.weekday.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.weekday.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 8. ì‹œì‘ ì‹œê°„ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        8. ì‹œì‘ ì‹œê°„ <span class="text-red-500">*</span>
                    </label>
                    {{ form.start_time(class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", onchange="autoSetEndTime(); generateCourseName()") }}
                    {% if form.start_time.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.start_time.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 9. ì¢…ë£Œ ì‹œê°„ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        9. ì¢…ë£Œ ì‹œê°„ <span class="text-red-500">*</span>
                        <span class="text-gray-500 text-xs">(ìˆ˜ì—… íƒ€ì…ê³¼ í•™ë…„ì— ë”°ë¼ ìë™ ì„¤ì •, ë³€ê²½ ê°€ëŠ¥)</span>
                    </label>
                    {{ form.end_time(class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                    <p class="text-xs text-gray-500 mt-1">
                        ë² ì´ì§: +30ë¶„ | í”„ë¦¬ë¯¸ì—„: +60ë¶„ | ì •ê·œë°˜: ì´ˆë“± +120ë¶„, ì¤‘ë“± +150ë¶„ | í•˜í¬ë‹ˆìŠ¤: +150ë¶„
                    </p>
                    {% if form.end_time.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.end_time.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 10. ì‚¬ìš© ì—¬ë¶€ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        10. ì‚¬ìš© ì—¬ë¶€ <span class="text-red-500">*</span>
                    </label>
                    {{ form.availability_status(class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                    {% if form.availability_status.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.availability_status.errors[0] }}</p>
                    {% endif %}
                </div>

                <!-- 11. ë³´ê°•ì‹ ì²­ ê°€ëŠ¥ì—¬ë¶€ -->
                <div class="mb-6">
                    <label class="flex items-center">
                        {{ form.makeup_class_allowed(class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded") }}
                        <span class="text-sm font-medium text-gray-700">11. ë³´ê°•ì‹ ì²­ ê°€ëŠ¥ (ê¸°ë³¸ê°’: ê°€ëŠ¥)</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-6">ì²´í¬í•˜ë©´ ë³´ê°•ìˆ˜ì—… ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                </div>

                <!-- ìˆ˜ì—…ëª… (ìë™ ìƒì„± + ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥) -->
                <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-900 mb-2">ğŸ“ ìˆ˜ì—…ëª… (ìë™ ìƒì„±, ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)</h4>
                    <input type="text" id="previewCourseName" name="course_name"
                           class="w-full px-3 py-2 text-base font-bold text-blue-800 bg-white border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ìˆ˜ì—…ëª…ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤">
                    <p class="text-xs text-blue-600 mt-1">* ìë™ ìƒì„±ëœ ìˆ˜ì—…ëª…ì„ ì§ì ‘ ìˆ˜ì •í•˜ì—¬ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>

                <!-- íšŒë‹¹ ìˆ˜ì—…ë£Œ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-medium text-green-900 mb-1">ğŸ’° íšŒë‹¹ ìˆ˜ì—…ë£Œ</h4>
                    <p id="previewPrice" class="text-lg font-bold text-green-800">ìˆ˜ì—… íƒ€ì…ì„ ì„ íƒí•˜ë©´ ìë™ ì„¤ì •ë©ë‹ˆë‹¤</p>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex gap-3">
                    <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                        âœ“ ë“±ë¡ (ì‹ ê·œ ìˆ˜ì—… ê°œì„¤)
                    </button>
                    <button type="reset"
                            onclick="resetForm()"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 rounded-lg transition duration-200">
                        â†º Reset
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ìš”ì¼ ìë™ ì„ íƒ (ì‹œì‘ì¼ ê¸°ì¤€)
function autoSelectWeekday() {
    const startDateInput = document.querySelector('input[name="start_date"]');
    const weekdaySelect = document.getElementById('weekdaySelect');

    if (startDateInput && startDateInput.value) {
        const date = new Date(startDateInput.value);
        const weekday = date.getDay();  // 0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼, ..., 6=í† ìš”ì¼

        // JavaScriptì˜ getDay()ëŠ” ì¼ìš”ì¼ì´ 0ì´ë¯€ë¡œ ë³€í™˜ í•„ìš”
        // ìš°ë¦¬ ì‹œìŠ¤í…œ: 0=ì›”ìš”ì¼, 6=ì¼ìš”ì¼
        let adjustedWeekday = weekday - 1;
        if (adjustedWeekday === -1) adjustedWeekday = 6;  // ì¼ìš”ì¼

        weekdaySelect.value = adjustedWeekday;
    }

    generateCourseName();
}

// ì¢…ë£Œì¼ ìë™ ì„¤ì • (ì‹œì‘ì¼ê³¼ ë™ì¼í•˜ê²Œ)
function autoSetEndDate() {
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');

    if (startDateInput && startDateInput.value) {
        // ì¢…ë£Œì¼ì„ ì‹œì‘ì¼ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
        endDateInput.value = startDateInput.value;
    }
}

// ì¢…ë£Œ ì‹œê°„ ìë™ ì„¤ì • (ìˆ˜ì—… íƒ€ì…ê³¼ í•™ë…„ì— ë”°ë¼)
function autoSetEndTime() {
    const startTimeInput = document.querySelector('input[name="start_time"]');
    const endTimeInput = document.querySelector('input[name="end_time"]');
    const courseTypeSelect = document.querySelector('select[name="course_type"]');
    const gradeSelect = document.querySelector('select[name="grade"]');

    if (!startTimeInput || !startTimeInput.value) return;

    const parts = startTimeInput.value.split(':');
    if (parts.length < 2) return;
    const startTotalMinutes = parseInt(parts[0]) * 60 + parseInt(parts[1]);

    const courseType = courseTypeSelect ? courseTypeSelect.value : '';
    const grade = gradeSelect ? gradeSelect.value : '';

    let minutesToAdd = 60;  // ê¸°ë³¸ê°’
    if (courseType === 'ë² ì´ì§') {
        minutesToAdd = 30;
    } else if (courseType === 'í”„ë¦¬ë¯¸ì—„') {
        minutesToAdd = 60;
    } else if (courseType === 'ì •ê·œë°˜') {
        minutesToAdd = grade.startsWith('ì´ˆ') ? 120 : 150;
    } else if (courseType === 'í•˜í¬ë‹ˆìŠ¤') {
        minutesToAdd = 150;
    }

    const endTotal = startTotalMinutes + minutesToAdd;
    const endHours = Math.floor(endTotal / 60) % 24;
    const endMins = endTotal % 60;
    endTimeInput.value = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
}

// ìˆ˜ì—… íƒ€ì…ë³„ ê°€ê²© ë¯¸ë¦¬ë³´ê¸°
const priceMap = {
    'í”„ë¦¬ë¯¸ì—„': 65000,
    'ì •ê·œë°˜': 60000,
    'í•˜í¬ë‹ˆìŠ¤': 65000,
    'ì‹œê·¸ë‹ˆì²˜': 75000,
};

function updatePricePreview() {
    const courseType = document.querySelector('select[name="course_type"]').value;
    const priceEl = document.getElementById('previewPrice');
    if (!priceEl) return;
    const price = priceMap[courseType];
    if (price !== undefined) {
        priceEl.textContent = price.toLocaleString() + 'ì› / íšŒ';
    } else if (courseType) {
        priceEl.textContent = '0ì› / íšŒ (í•´ë‹¹ ì—†ìŒ)';
    } else {
        priceEl.textContent = 'ìˆ˜ì—… íƒ€ì…ì„ ì„ íƒí•˜ë©´ ìë™ ì„¤ì •ë©ë‹ˆë‹¤';
    }
}

// ìˆ˜ì—…ëª… ìë™ ìƒì„±
let userEditedName = false;

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('previewCourseName').addEventListener('input', function() {
        userEditedName = true;
    });
    const courseTypeSelect = document.querySelector('select[name="course_type"]');
    if (courseTypeSelect) {
        courseTypeSelect.addEventListener('change', updatePricePreview);
    }
});

function generateCourseName() {
    if (userEditedName) return;  // ì‚¬ìš©ìê°€ ì§ì ‘ ìˆ˜ì •í•œ ê²½ìš° ìë™ ê°±ì‹  ì•ˆ í•¨

    const grade = document.querySelector('select[name="grade"]').value;
    const courseType = document.querySelector('select[name="course_type"]').value;
    const teacherId = document.querySelector('select[name="teacher_id"]');
    const teacherName = teacherId.options[teacherId.selectedIndex].text;
    const weekdaySelect = document.getElementById('weekdaySelect');
    const startTimeInput = document.querySelector('input[name="start_time"]');

    // ìš”ì¼ í•œê¸€ ë³€í™˜
    const weekdayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
    const weekdayText = weekdaySelect && weekdaySelect.value !== '' ? weekdayNames[parseInt(weekdaySelect.value)] : '';

    // ì‹œì‘ ì‹œê°„
    const startTime = startTimeInput ? startTimeInput.value : '';

    const nameInput = document.getElementById('previewCourseName');
    if (grade && courseType && teacherName && teacherName !== '-- ê°•ì‚¬ ì„ íƒ --') {
        let courseName = `${grade} ${courseType}`;
        if (weekdayText) courseName += ` ${weekdayText}`;
        if (startTime) courseName += ` ${startTime}`;
        courseName += ` - ${teacherName}`;
        nameInput.value = courseName;
    } else {
        nameInput.value = '';
    }
}

// í¼ ë¦¬ì…‹
function resetForm() {
    document.getElementById('courseForm').reset();
    userEditedName = false;
    document.getElementById('previewCourseName').value = '';
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ë‚ ì§œ ì„¤ì •
window.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.querySelector('input[name="start_date"]');
    if (!startDateInput.value) {
        startDateInput.value = today;
        autoSelectWeekday();
    }
});
</script>
{% endblock %}
