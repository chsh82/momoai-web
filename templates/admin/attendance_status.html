{% extends "base.html" %}

{% block title %}ì „ì²´ ì¶œì„ í˜„í™© - MOMOAI v4.0{% endblock %}

{% block page_title %}âœ… ì „ì²´ ì¶œê²° í˜„í™©{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ìˆ˜ì—…ë³„ ì¶œì„ í†µê³„</span>
{% endblock %}


{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">ğŸ“Š ì „ì²´ ì¶œì„ í˜„í™©</h2>
        <p class="text-gray-600 mt-2">ë°˜ë³„/ê°œì¸ë³„ ì¶œì„ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <form method="GET" action="" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- ë‚ ì§œ ë²”ìœ„ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‹œì‘ì¼</label>
                    <input type="date" name="date_from" value="{{ date_from }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ë£Œì¼</label>
                    <input type="date" name="date_to" value="{{ date_to }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- ìˆ˜ì—… ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ì—… (ë°˜)</label>
                    <select name="course_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ìˆ˜ì—…</option>
                        {% for course in courses %}
                        <option value="{{ course.course_id }}" {% if course_filter == course.course_id %}selected{% endif %}>
                            {{ course.course_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ê°•ì‚¬ ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê°•ì‚¬</label>
                    <select name="teacher_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ê°•ì‚¬</option>
                        {% for teacher in teachers %}
                        <option value="{{ teacher.user_id }}" {% if teacher_filter == teacher.user_id %}selected{% endif %}>
                            {{ teacher.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- í•™ìƒ ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ</label>
                    <select name="student_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ í•™ìƒ</option>
                        {% for student in students %}
                        <option value="{{ student.student_id }}" {% if student_filter == student.student_id %}selected{% endif %}>
                            {{ student.name }} {% if student.grade %}({{ student.grade }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ìƒíƒœ í•„í„° -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì¶œì„ ìƒíƒœ</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="present" {% if status_filter == 'present' %}selected{% endif %}>ì¶œì„</option>
                        <option value="late" {% if status_filter == 'late' %}selected{% endif %}>ì§€ê°</option>
                        <option value="absent" {% if status_filter == 'absent' %}selected{% endif %}>ê²°ì„</option>
                        <option value="excused" {% if status_filter == 'excused' %}selected{% endif %}>ì¸ì •ê²°ì„</option>
                    </select>
                </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="flex gap-3">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition duration-200">
                    ğŸ” ê²€ìƒ‰
                </button>
                <a href="{{ url_for('admin.attendance_status') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2 rounded-lg transition duration-200">
                    â†º ì´ˆê¸°í™”
                </a>
            </div>
        </form>
    </div>

    <!-- ì „ì²´ í†µê³„ -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-sm text-gray-600 mb-1">ì „ì²´</p>
            <p class="text-2xl font-bold text-gray-800">{{ total_count }}</p>
        </div>
        <div class="bg-green-50 rounded-lg shadow p-4">
            <p class="text-sm text-green-600 mb-1">ì¶œì„</p>
            <p class="text-2xl font-bold text-green-800">{{ present_count }}</p>
        </div>
        <div class="bg-yellow-50 rounded-lg shadow p-4">
            <p class="text-sm text-yellow-600 mb-1">ì§€ê°</p>
            <p class="text-2xl font-bold text-yellow-800">{{ late_count }}</p>
        </div>
        <div class="bg-red-50 rounded-lg shadow p-4">
            <p class="text-sm text-red-600 mb-1">ê²°ì„</p>
            <p class="text-2xl font-bold text-red-800">{{ absent_count }}</p>
        </div>
        <div class="bg-blue-50 rounded-lg shadow p-4">
            <p class="text-sm text-blue-600 mb-1">ì¸ì •ê²°ì„</p>
            <p class="text-2xl font-bold text-blue-800">{{ excused_count }}</p>
        </div>
        <div class="bg-purple-50 rounded-lg shadow p-4">
            <p class="text-sm text-purple-600 mb-1">ì¶œì„ë¥ </p>
            <p class="text-2xl font-bold text-purple-800">{{ "%.1f"|format(attendance_rate) }}%</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- ë°˜ë³„ í†µê³„ -->
        {% if not course_filter and not student_filter %}
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">ğŸ“š ë°˜ë³„ ì¶œì„ í˜„í™© (ìƒìœ„ 10ê°œ)</h3>
            </div>
            <div class="p-6">
                {% if course_stats %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">ìˆ˜ì—…ëª…</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì „ì²´</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì¶œì„</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì§€ê°</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ê²°ì„</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì¶œì„ë¥ </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for stat in course_stats %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2">
                                    <a href="{{ url_for('admin.attendance_status', course_id=stat.course_id, date_from=date_from, date_to=date_to) }}"
                                       class="text-blue-600 hover:text-blue-800 font-medium">
                                        {{ stat.course_name }}
                                    </a>
                                </td>
                                <td class="px-3 py-2 text-center font-medium">{{ stat.total }}</td>
                                <td class="px-3 py-2 text-center text-green-600">{{ stat.present }}</td>
                                <td class="px-3 py-2 text-center text-yellow-600">{{ stat.late }}</td>
                                <td class="px-3 py-2 text-center text-red-600">{{ stat.absent }}</td>
                                <td class="px-3 py-2 text-center">
                                    {% set rate = (stat.present / stat.total * 100) if stat.total > 0 else 0 %}
                                    <span class="font-medium {% if rate >= 80 %}text-green-600{% elif rate >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                        {{ "%.1f"|format(rate) }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- í•™ìƒë³„ í†µê³„ -->
        {% if not student_filter %}
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">ğŸ‘¥ í•™ìƒë³„ ì¶œì„ í˜„í™© (ìƒìœ„ 20ëª…)</h3>
            </div>
            <div class="p-6">
                {% if student_stats %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">í•™ìƒëª…</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">í•™ë…„</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì „ì²´</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì¶œì„</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì§€ê°</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ê²°ì„</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">ì¶œì„ë¥ </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for stat in student_stats %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2">
                                    <a href="{{ url_for('admin.attendance_status', student_id=stat.student_id, date_from=date_from, date_to=date_to) }}"
                                       class="text-blue-600 hover:text-blue-800 font-medium">
                                        {{ stat.name }}
                                    </a>
                                </td>
                                <td class="px-3 py-2 text-center text-gray-600">{{ stat.grade or '-' }}</td>
                                <td class="px-3 py-2 text-center font-medium">{{ stat.total }}</td>
                                <td class="px-3 py-2 text-center text-green-600">{{ stat.present }}</td>
                                <td class="px-3 py-2 text-center text-yellow-600">{{ stat.late }}</td>
                                <td class="px-3 py-2 text-center text-red-600">{{ stat.absent }}</td>
                                <td class="px-3 py-2 text-center">
                                    {% set rate = (stat.present / stat.total * 100) if stat.total > 0 else 0 %}
                                    <span class="font-medium {% if rate >= 80 %}text-green-600{% elif rate >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                        {{ "%.1f"|format(rate) }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ìƒì„¸ ì¶œì„ ê¸°ë¡ -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <div>
                <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ ìƒì„¸ ì¶œì„ ê¸°ë¡</h3>
                <p class="text-sm text-gray-600 mt-1">ìµœê·¼ 100ê°œ ë ˆì½”ë“œ</p>
            </div>
            {% if course_filter or student_filter %}
            <div class="text-sm">
                {% if course_filter %}
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full font-medium">
                    ìˆ˜ì—… í•„í„° ì ìš©ì¤‘
                </span>
                {% endif %}
                {% if student_filter %}
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full font-medium">
                    í•™ìƒ í•„í„° ì ìš©ì¤‘
                </span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="p-6">
            {% if attendances %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ë‚ ì§œ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ìˆ˜ì—…</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">í•™ìƒ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">í•™ë…„</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ì¶œì„ ìƒíƒœ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ì²´í¬ ì‹œê°„</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ë©”ëª¨</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for attendance in attendances %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {{ attendance.session.session_date.strftime('%Y-%m-%d') }}
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm font-medium text-gray-800">{{ attendance.session.course.course_name }}</div>
                                <div class="text-xs text-gray-500">ì„¸ì…˜ {{ attendance.session.session_number }}</div>
                            </td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-800">
                                {{ attendance.student.name }}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">
                                {{ attendance.student.grade or '-' }}
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs font-medium rounded
                                    {% if attendance.status == 'present' %}bg-green-100 text-green-800
                                    {% elif attendance.status == 'late' %}bg-yellow-100 text-yellow-800
                                    {% elif attendance.status == 'absent' %}bg-red-100 text-red-800
                                    {% elif attendance.status == 'excused' %}bg-blue-100 text-blue-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if attendance.status == 'present' %}âœ“ ì¶œì„
                                    {% elif attendance.status == 'late' %}â° ì§€ê°
                                    {% elif attendance.status == 'absent' %}âœ— ê²°ì„
                                    {% elif attendance.status == 'excused' %}ğŸ“ ì¸ì •ê²°ì„
                                    {% else %}{{ attendance.status }}{% endif %}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">
                                {% if attendance.checked_at %}
                                    {{ attendance.checked_at.strftime('%H:%M') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">
                                {{ attendance.notes or '-' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <p class="text-gray-500 text-lg">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-gray-400 text-sm mt-2">í•„í„° ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ì•ˆë‚´ -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 class="font-medium text-blue-900 mb-2">ğŸ’¡ ì‚¬ìš© ì•ˆë‚´</h4>
        <ul class="text-sm text-blue-800 space-y-1">
            <li>â€¢ <strong>ë‚ ì§œ ë²”ìœ„</strong>: ì›í•˜ëŠ” ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ì¶œì„ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš” (ê¸°ë³¸: ìµœê·¼ 30ì¼)</li>
            <li>â€¢ <strong>ë°˜ë³„ ê²€ìƒ‰</strong>: ìˆ˜ì—…ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ìˆ˜ì—…ì˜ ì¶œì„ í˜„í™©ë§Œ í‘œì‹œë©ë‹ˆë‹¤</li>
            <li>â€¢ <strong>ê°œì¸ë³„ ê²€ìƒ‰</strong>: í•™ìƒì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í•™ìƒì˜ ì „ì²´ ì¶œì„ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>â€¢ <strong>í†µê³„ í´ë¦­</strong>: ë°˜ë³„/í•™ìƒë³„ í†µê³„ì—ì„œ ì´ë¦„ì„ í´ë¦­í•˜ë©´ ìƒì„¸ í•„í„°ê°€ ì ìš©ë©ë‹ˆë‹¤</li>
            <li>â€¢ <strong>ì¶œì„ë¥ </strong>: 80% ì´ìƒ <span class="text-green-600">ì´ˆë¡ìƒ‰</span>, 60-79% <span class="text-yellow-600">ë…¸ë€ìƒ‰</span>, 60% ë¯¸ë§Œ <span class="text-red-600">ë¹¨ê°„ìƒ‰</span></li>
        </ul>
    </div>
</div>
{% endblock %}
