{% extends "base.html" %}

{% block title %}ì—°ê²° ì‹ ì²­ ê²€í†  - MOMOAI v4.0{% endblock %}

{% block page_title %}ğŸ”— ì—°ê²° ìš”ì²­ ìƒì„¸{% endblock %}


{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('admin.parent_link_requests') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
        <h2 class="text-3xl font-bold text-gray-800">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ë¶€ëª¨-ìë…€ ì—°ê²° ì‹ ì²­ ê²€í† </h2>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ì™¼ìª½: ì‹ ì²­ ì •ë³´ -->
        <div class="space-y-6">
            <!-- ìƒíƒœ ì¹´ë“œ -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-800">ì‹ ì²­ ìƒíƒœ</h3>
                        {% if link_request.status == 'pending' %}
                        <span class="px-3 py-1 text-sm font-medium rounded bg-yellow-100 text-yellow-800">
                            â³ ëŒ€ê¸° ì¤‘
                        </span>
                        {% elif link_request.status == 'approved' %}
                        <span class="px-3 py-1 text-sm font-medium rounded bg-green-100 text-green-800">
                            âœ“ ìŠ¹ì¸ë¨
                        </span>
                        {% elif link_request.status == 'rejected' %}
                        <span class="px-3 py-1 text-sm font-medium rounded bg-red-100 text-red-800">
                            âœ— ê±°ì ˆë¨
                        </span>
                        {% elif link_request.status == 'cancelled' %}
                        <span class="px-3 py-1 text-sm font-medium rounded bg-gray-100 text-gray-800">
                            ì·¨ì†Œë¨
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="p-6 space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">ì‹ ì²­ ID</p>
                        <p class="font-medium text-gray-800">{{ link_request.request_id[:8] }}...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ì‹ ì²­ì¼ì‹œ</p>
                        <p class="font-medium text-gray-800">{{ link_request.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    {% if link_request.reviewed_by_user %}
                    <div>
                        <p class="text-sm text-gray-600">ê²€í† ì</p>
                        <p class="font-medium text-gray-800">{{ link_request.reviewed_by_user.name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ê²€í† ì¼ì‹œ</p>
                        <p class="font-medium text-gray-800">{{ link_request.reviewed_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- í•™ë¶€ëª¨ ì •ë³´ -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 bg-blue-50">
                    <h3 class="text-xl font-bold text-blue-900">í•™ë¶€ëª¨ ì •ë³´</h3>
                </div>
                <div class="p-6 space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">ì´ë¦„</p>
                        <p class="text-lg font-bold text-gray-800">{{ link_request.parent.name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ì´ë©”ì¼</p>
                        <p class="font-medium text-gray-800">{{ link_request.parent.email }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ì „í™”ë²ˆí˜¸</p>
                        <p class="font-medium text-gray-800">{{ link_request.parent.phone if link_request.parent.phone else '-' }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">í˜„ì¬ ì—°ê²°ëœ ìë…€ ìˆ˜</p>
                        <p class="font-medium text-gray-800">{{ link_request.parent.linked_students|length }}ëª…</p>
                    </div>
                </div>
            </div>

            <!-- ì‹ ì²­í•œ í•™ìƒ ì •ë³´ -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 bg-purple-50">
                    <h3 class="text-xl font-bold text-purple-900">ì‹ ì²­í•œ í•™ìƒ ì •ë³´</h3>
                </div>
                <div class="p-6 space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">í•™ìƒ ì´ë¦„</p>
                        <p class="text-lg font-bold text-gray-800">{{ link_request.student_name }}</p>
                    </div>
                    {% if link_request.student_birth_date %}
                    <div>
                        <p class="text-sm text-gray-600">ìƒë…„ì›”ì¼</p>
                        <p class="font-medium text-gray-800">{{ link_request.student_birth_date.strftime('%Y-%m-%d') }}</p>
                    </div>
                    {% endif %}
                    {% if link_request.student_grade %}
                    <div>
                        <p class="text-sm text-gray-600">í•™ë…„</p>
                        <p class="font-medium text-gray-800">{{ link_request.student_grade }}</p>
                    </div>
                    {% endif %}
                    {% if link_request.student_school %}
                    <div>
                        <p class="text-sm text-gray-600">í•™êµëª…</p>
                        <p class="font-medium text-gray-800">{{ link_request.student_school }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-sm text-gray-600">ê´€ê³„</p>
                        <p class="font-medium text-gray-800">{{ link_request.relation_type if request.relation_type else '-' }}</p>
                    </div>
                    {% if link_request.additional_info %}
                    <div>
                        <p class="text-sm text-gray-600">ì¶”ê°€ ì •ë³´</p>
                        <p class="font-medium text-gray-800 whitespace-pre-wrap">{{ link_request.additional_info }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ë§¤ì¹­ëœ í•™ìƒ ì •ë³´ (ìŠ¹ì¸ëœ ê²½ìš°) -->
            {% if link_request.matched_student %}
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
                    <h3 class="text-xl font-bold text-green-900">ë§¤ì¹­ëœ í•™ìƒ ì •ë³´</h3>
                </div>
                <div class="p-6 space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">í•™ìƒ ì´ë¦„</p>
                        <p class="text-lg font-bold text-gray-800">{{ link_request.matched_student.name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">í•™ë…„</p>
                        <p class="font-medium text-gray-800">{{ link_request.matched_student.grade }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">í•™ìƒ ì½”ë“œ</p>
                        <p class="font-medium text-gray-800">{{ link_request.matched_student.student_code }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">í˜„ì¬ ì—°ê²°ëœ í•™ë¶€ëª¨ ìˆ˜</p>
                        <p class="font-medium text-gray-800">{{ link_request.matched_student.linked_parents|length }}ëª…</p>
                    </div>
                    <a href="{{ url_for('students.student_detail', student_id=request.matched_student_id) }}"
                       class="block text-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition duration-200">
                        í•™ìƒ ì •ë³´ ë³´ê¸°
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- ê´€ë¦¬ì ë©”ëª¨ -->
            {% if link_request.admin_notes %}
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-800">ê´€ë¦¬ì ë©”ëª¨</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-800 whitespace-pre-wrap">{{ link_request.admin_notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê²€í†  ì•¡ì…˜ -->
        <div>
            {% if link_request.status == 'pending' %}
            <!-- í•™ìƒ ê²€ìƒ‰ -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-4 border-b border-gray-200 bg-indigo-50">
                    <h3 class="text-xl font-bold text-indigo-900">í•™ìƒ ê²€ìƒ‰ ë° ë§¤ì¹­</h3>
                </div>
                <div class="p-6">
                    <div class="mb-4">
                        <label for="searchQuery" class="block text-sm font-medium text-gray-700 mb-2">
                            í•™ìƒ ì´ë¦„ ë˜ëŠ” í•™ìƒ ì½”ë“œ
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="searchQuery"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="{{ link_request.student_name }}">
                            <button onclick="searchStudents()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition duration-200">
                                ê²€ìƒ‰
                            </button>
                        </div>
                    </div>

                    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
                    <div id="searchResults" class="space-y-3">
                        <p class="text-sm text-gray-500 text-center py-4">
                            í•™ìƒì„ ê²€ìƒ‰í•˜ì—¬ ë§¤ì¹­í•˜ì„¸ìš”.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ìŠ¹ì¸ í¼ -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
                    <h3 class="text-xl font-bold text-green-900">âœ“ ìŠ¹ì¸</h3>
                </div>
                <div class="p-6">
                    <form id="approveForm" method="POST" action="{{ url_for('admin.approve_parent_link_request', request_id=link_request.request_id) }}">
                        <input type="hidden" name="student_id" id="approveStudentId" required>

                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">ì„ íƒëœ í•™ìƒ</p>
                            <div id="selectedStudentInfo" class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <p class="text-gray-500">ìœ„ì—ì„œ í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="approveNotes" class="block text-sm font-medium text-gray-700 mb-2">
                                ìŠ¹ì¸ ë©”ëª¨ (ì„ íƒ)
                            </label>
                            <textarea id="approveNotes" name="admin_notes" rows="3"
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                      placeholder="ìŠ¹ì¸ ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <button type="submit" id="approveButton" disabled
                                class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium py-3 rounded-lg transition duration-200">
                            ìŠ¹ì¸í•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>

            <!-- ê±°ì ˆ í¼ -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 bg-red-50">
                    <h3 class="text-xl font-bold text-red-900">âœ— ê±°ì ˆ</h3>
                </div>
                <div class="p-6">
                    <form method="POST" action="{{ url_for('admin.reject_parent_link_request', request_id=link_request.request_id) }}"
                          onsubmit="return confirm('ì´ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•™ë¶€ëª¨ì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.');">
                        <div class="mb-4">
                            <label for="rejectReason" class="block text-sm font-medium text-gray-700 mb-2">
                                ê±°ì ˆ ì‚¬ìœ  <span class="text-red-500">*</span>
                            </label>
                            <textarea id="rejectReason" name="admin_notes" rows="4" required
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                                      placeholder="ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í•™ë¶€ëª¨ì—ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤)"></textarea>
                        </div>

                        <button type="submit"
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 rounded-lg transition duration-200">
                            ê±°ì ˆí•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>

            {% else %}
            <!-- ì´ë¯¸ ì²˜ë¦¬ë¨ -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-800">ì²˜ë¦¬ ì™„ë£Œ</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">
                        ì´ ì‹ ì²­ì€ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </p>
                    <a href="{{ url_for('admin.parent_link_requests') }}"
                       class="block text-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                        ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let selectedStudentId = null;

async function searchStudents() {
    const query = document.getElementById('searchQuery').value.trim();
    if (!query) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }

    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '<p class="text-center text-gray-500 py-4">ê²€ìƒ‰ ì¤‘...</p>';

    try {
        const response = await fetch(`/admin/api/students/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.students && data.students.length > 0) {
            resultsDiv.innerHTML = data.students.map(student => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                     onclick="selectStudent('${student.student_id}', '${student.name}', '${student.grade}', '${student.student_code}', ${student.active_course_count}, ${student.parent_count})">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-gray-800">${student.name}</h4>
                        <span class="text-xs px-2 py-1 rounded ${student.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${student.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                        </span>
                    </div>
                    <div class="space-y-1 text-sm text-gray-600">
                        <p>ğŸ“š ${student.grade}</p>
                        <p>ğŸ†” ${student.student_code}</p>
                        <p>ğŸ‘¥ ìˆ˜ê°• ì¤‘: ${student.active_course_count}ê°œ</p>
                        <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ì—°ê²°ëœ í•™ë¶€ëª¨: ${student.parent_count}ëª…</p>
                    </div>
                    <button class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition duration-200">
                        ì´ í•™ìƒ ì„ íƒ
                    </button>
                </div>
            `).join('');
        } else {
            resultsDiv.innerHTML = '<p class="text-center text-gray-500 py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    } catch (error) {
        resultsDiv.innerHTML = '<p class="text-center text-red-500 py-4">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        console.error('Search error:', error);
    }
}

function selectStudent(studentId, name, grade, code, courseCount, parentCount) {
    selectedStudentId = studentId;

    // ìŠ¹ì¸ í¼ ì—…ë°ì´íŠ¸
    document.getElementById('approveStudentId').value = studentId;
    document.getElementById('selectedStudentInfo').innerHTML = `
        <p class="font-bold text-gray-800 mb-2">${name}</p>
        <div class="space-y-1 text-sm text-gray-600">
            <p>ğŸ“š ${grade}</p>
            <p>ğŸ†” ${code}</p>
            <p>ğŸ‘¥ ìˆ˜ê°• ì¤‘: ${courseCount}ê°œ</p>
            <p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ì—°ê²°ëœ í•™ë¶€ëª¨: ${parentCount}ëª…</p>
        </div>
    `;

    // ìŠ¹ì¸ ë²„íŠ¼ í™œì„±í™”
    document.getElementById('approveButton').disabled = false;
}

// ì—”í„° í‚¤ë¡œ ê²€ìƒ‰
document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchStudents();
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ê²€ìƒ‰ (í•™ìƒ ì´ë¦„ì´ ìˆëŠ” ê²½ìš°)
window.addEventListener('DOMContentLoaded', function() {
    const query = document.getElementById('searchQuery').value.trim();
    if (query) {
        searchStudents();
    }
});
</script>

{% endblock %}
