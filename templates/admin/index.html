{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - MOMOAI v4.0{% endblock %}

{% block page_title %}ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ì „ì²´ í˜„í™© ë° í†µê³„</span>
{% endblock %}


{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- í—¤ë” -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
            <p class="text-sm text-gray-600 mt-1">ì „ì²´ ìš´ì˜ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div class="text-sm text-gray-500">
            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {{ now().strftime('%Y-%m-%d %H:%M') }}
        </div>
    </div>

    <!-- ì£¼ê°„/ì›”ê°„ íƒ­ -->
    <div class="bg-white rounded-lg shadow mb-6" x-data="{ activeTab: 'weekly' }">
        <div class="border-b border-gray-200">
            <div class="flex">
                <button @click="activeTab = 'weekly'"
                        :class="activeTab === 'weekly' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-3 border-b-2 font-medium text-sm transition">
                    ğŸ“… ì£¼ê°„ ë·°
                </button>
                <button @click="activeTab = 'monthly'"
                        :class="activeTab === 'monthly' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-3 border-b-2 font-medium text-sm transition">
                    ğŸ“Š ì›”ê°„ ë·°
                </button>
            </div>
        </div>

        <!-- ì£¼ê°„ ë·° ì»¨í…ì¸  -->
        <div x-show="activeTab === 'weekly'" class="p-6">
            <!-- KPI ì¹´ë“œ (ì£¼ê°„) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—… -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">ğŸ“š</span>
                        <span class="text-xs font-medium text-blue-600 bg-blue-200 px-2 py-1 rounded">ì§„í–‰ì¤‘</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">ì§„í–‰ ì¤‘ì¸ ìˆ˜ì—…</p>
                    <p class="text-3xl font-bold text-blue-600">{{ total_courses }}</p>
                </div>

                <!-- ì „ì²´ í•™ìƒ -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">ğŸ‘¨â€ğŸ“</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">ì „ì²´ í•™ìƒ</p>
                    <p class="text-3xl font-bold text-green-600">{{ total_students }}</p>
                </div>

                <!-- ê°•ì‚¬ ìˆ˜ -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">ğŸ‘¨â€ğŸ«</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">ì „ì²´ ê°•ì‚¬</p>
                    <p class="text-3xl font-bold text-purple-600">{{ total_teachers }}</p>
                </div>

                <!-- ì´ë²ˆ ì£¼ ìˆ˜ì—… -->
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">â°</span>
                        <span class="text-xs font-medium text-orange-600 bg-orange-200 px-2 py-1 rounded">ì´ë²ˆì£¼</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">ì˜ˆì •ëœ ìˆ˜ì—…</p>
                    <p class="text-3xl font-bold text-orange-600">{{ weekly_sessions }}</p>
                </div>
            </div>

            <!-- ë‘ ë²ˆì§¸ ì¤„ KPI -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- í‰ê·  ì¶œì„ë¥  -->
                <div class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">ğŸ“Š</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">í‰ê·  ì¶œì„ë¥ </p>
                    <p class="text-3xl font-bold text-teal-600">{{ attendance_rate }}%</p>
                </div>

                <!-- ëŒ€ê¸° ì¤‘ ì•Œë¦¼ -->
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">ğŸ””</span>
                        {% if pending_notifications > 0 %}
                        <span class="text-xs font-medium text-red-600 bg-red-200 px-2 py-1 rounded animate-pulse">ìŠ¹ì¸í•„ìš”</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-gray-600 mb-1">ëŒ€ê¸° ì¤‘ ì•Œë¦¼</p>
                    <p class="text-3xl font-bold text-red-600">{{ pending_notifications }}</p>
                </div>

                <!-- í•™ë¶€ëª¨ ì—°ê²° -->
                <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">ğŸ‘ª</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">í•™ë¶€ëª¨ ì—°ê²°</p>
                    <p class="text-3xl font-bold text-pink-600">{{ total_parent_links }}</p>
                    {% if pending_parent_links %}
                    <p class="text-xs text-pink-700 mt-1">ëŒ€ê¸°: {{ pending_parent_links }}</p>
                    {% endif %}
                </div>

                <!-- ì²¨ì‚­ í˜„í™© -->
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg shadow p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-2xl">ğŸ“</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1">ì²¨ì‚­ í˜„í™©</p>
                    <div class="flex items-baseline gap-2">
                        <p class="text-2xl font-bold text-indigo-600">{{ essays_pending + essays_processing }}</p>
                        <p class="text-sm text-gray-500">/ {{ essays_completed }}</p>
                    </div>
                    <p class="text-xs text-indigo-700 mt-1">ëŒ€ê¸°Â·ì²˜ë¦¬ì¤‘ / ì™„ë£Œ</p>
                </div>
            </div>

            <div class="text-sm text-gray-500 text-center mb-6">
                ğŸ’¡ ì£¼ê°„ ë·°: ì´ë²ˆ ì£¼ ìš´ì˜ í˜„í™©ì„ ë³´ì—¬ì¤ë‹ˆë‹¤
            </div>
        </div>

        <!-- ì›”ê°„ ë·° ì»¨í…ì¸  -->
        <div x-show="activeTab === 'monthly'" class="p-6">
            <div class="text-center text-gray-500 mb-4">
                ğŸ“ˆ ì›”ê°„ í†µê³„ ë° íŠ¸ë Œë“œ
            </div>

            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ì°¨íŠ¸ 1: í•™ìƒ ìˆ˜ ì¦ê° ì¶”ì´ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ˆ í•™ìƒ ìˆ˜ ì¦ê° ì¶”ì´ (6ê°œì›”)</h3>
                    <canvas id="studentTrendChart"></canvas>
                </div>

                <!-- ì°¨íŠ¸ 2: ìˆ˜ì—…ë³„ ìˆ˜ê°•ìƒ ë¶„í¬ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ ìˆ˜ì—…ë³„ ìˆ˜ê°•ìƒ ë¶„í¬ (TOP 10)</h3>
                    <canvas id="enrollmentChart"></canvas>
                </div>

                <!-- ì°¨íŠ¸ 3: ì²¨ì‚­ í˜„í™© -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ ì²¨ì‚­ ìƒíƒœë³„ í˜„í™©</h3>
                    <div class="max-w-md mx-auto">
                        <canvas id="essayStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¹ ë¥¸ ì•¡ì…˜ & ìµœê·¼ ì•Œë¦¼ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">âš¡ ë¹ ë¥¸ ì•¡ì…˜</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <a href="{{ url_for('admin.create_course') }}"
                       class="bg-blue-600 hover:bg-blue-700 text-white font-medium p-4 rounded-lg transition flex items-center justify-center gap-2">
                        <span class="text-xl">â•</span>
                        <span class="text-sm">ìƒˆ ìˆ˜ì—… ìƒì„±</span>
                    </a>
                    <a href="{{ url_for('students.index') }}"
                       class="bg-green-600 hover:bg-green-700 text-white font-medium p-4 rounded-lg transition flex items-center justify-center gap-2">
                        <span class="text-xl">ğŸ‘¨â€ğŸ“</span>
                        <span class="text-sm">í•™ìƒ ë“±ë¡</span>
                    </a>
                    <a href="{{ url_for('admin.payments') }}"
                       class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium p-4 rounded-lg transition flex items-center justify-center gap-2">
                        <span class="text-xl">ğŸ’°</span>
                        <span class="text-sm">ê²°ì œ ë“±ë¡</span>
                    </a>
                    <a href="{{ url_for('admin.parent_link_requests') }}"
                       class="bg-purple-600 hover:bg-purple-700 text-white font-medium p-4 rounded-lg transition flex items-center justify-center gap-2">
                        <span class="text-xl">ğŸ”—</span>
                        <span class="text-sm">í•™ë¶€ëª¨ ìŠ¹ì¸</span>
                        {% if pending_parent_links %}
                        <span class="bg-white text-purple-600 text-xs font-bold px-2 py-1 rounded-full">{{ pending_parent_links }}</span>
                        {% endif %}
                    </a>
                    <a href="{{ url_for('admin.courses') }}"
                       class="bg-gray-600 hover:bg-gray-700 text-white font-medium p-4 rounded-lg transition flex items-center justify-center gap-2">
                        <span class="text-xl">ğŸ“‹</span>
                        <span class="text-sm">ìˆ˜ì—… ê´€ë¦¬</span>
                    </a>
                    <a href="{{ url_for('admin.export_monthly_report') }}"
                       class="bg-red-600 hover:bg-red-700 text-white font-medium p-4 rounded-lg transition flex items-center justify-center gap-2">
                        <span class="text-xl">ğŸ“Š</span>
                        <span class="text-sm">ì›”ê°„ ë¦¬í¬íŠ¸</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- ìµœê·¼ ì¤‘ìš” ì•Œë¦¼ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ”” ìµœê·¼ ì•Œë¦¼</h3>
            <div class="space-y-3">
                {% if recent_parent_requests %}
                    {% for request in recent_parent_requests[:3] %}
                    <a href="{{ url_for('admin.parent_link_request_detail', request_id=request.request_id) }}"
                       class="block p-3 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm">ğŸ‘ª</span>
                            <span class="text-sm font-medium text-gray-800">í•™ë¶€ëª¨ ì—°ê²° ìš”ì²­</span>
                        </div>
                        <p class="text-xs text-gray-600">{{ request.parent_name }} â†’ {{ request.child_name }}</p>
                        <p class="text-xs text-gray-500 mt-1">{{ request.created_at.strftime('%m/%d %H:%M') }}</p>
                    </a>
                    {% endfor %}
                {% endif %}

                {% if recent_makeup_requests %}
                    {% for request in recent_makeup_requests[:2] %}
                    <a href="{{ url_for('admin.makeup_requests') }}"
                       class="block p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm">ğŸ“š</span>
                            <span class="text-sm font-medium text-gray-800">ë³´ê°•ìˆ˜ì—… ì‹ ì²­</span>
                        </div>
                        <p class="text-xs text-gray-600">{{ request.student.name }} ({{ request.student.grade }})</p>
                        <p class="text-xs text-gray-500 mt-1">{{ request.created_at.strftime('%m/%d %H:%M') }}</p>
                    </a>
                    {% endfor %}
                {% endif %}

                {% if not recent_parent_requests and not recent_makeup_requests %}
                <div class="text-center py-8 text-gray-500">
                    <p class="text-sm">âœ¨ ì²˜ë¦¬í•  ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ì°¨íŠ¸ 1: í•™ìƒ ìˆ˜ ì¦ê° ì¶”ì´
const studentCtx = document.getElementById('studentTrendChart');
if (studentCtx) {
    new Chart(studentCtx, {
        type: 'line',
        data: {
            labels: {{ student_labels|safe }},
            datasets: [{
                label: 'ì‹ ê·œ í•™ìƒ ìˆ˜',
                data: {{ student_data|safe }},
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// ì°¨íŠ¸ 2: ìˆ˜ì—…ë³„ ìˆ˜ê°•ìƒ ë¶„í¬
const enrollmentCtx = document.getElementById('enrollmentChart');
if (enrollmentCtx) {
    new Chart(enrollmentCtx, {
        type: 'bar',
        data: {
            labels: {{ enrollment_labels|safe }},
            datasets: [{
                label: 'ìˆ˜ê°•ìƒ ìˆ˜',
                data: {{ enrollment_data|safe }},
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// ì°¨íŠ¸ 3: ì²¨ì‚­ í˜„í™©
const essayStatusCtx = document.getElementById('essayStatusChart');
if (essayStatusCtx) {
    new Chart(essayStatusCtx, {
        type: 'doughnut',
        data: {
            labels: {{ essay_status_labels|safe }},
            datasets: [{
                data: {{ essay_status_data|safe }},
                backgroundColor: [
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(34, 197, 94, 0.8)'
                ],
                borderColor: [
                    'rgb(251, 191, 36)',
                    'rgb(59, 130, 246)',
                    'rgb(34, 197, 94)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}
</script>
{% endblock %}
