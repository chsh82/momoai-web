{% extends "base.html" %}

{% block title %}í•™ìŠµ ì§„ë„ - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">ë‚´ í•™ìŠµ ì§„ë„</h2>

    <!-- ì „ì²´ ì§„ë„ìœ¨ -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-lg p-8 mb-6 text-white">
        <div class="text-center mb-4">
            <p class="text-xl font-medium mb-2">ì „ì²´ í•™ìŠµ ì§„ë„ìœ¨</p>
            <p class="text-6xl font-bold">{{ overall_progress.total_progress }}%</p>
        </div>
        <div class="w-full bg-white bg-opacity-30 rounded-full h-4">
            <div class="bg-white rounded-full h-4 transition-all duration-500"
                 style="width: {{ overall_progress.total_progress }}%"></div>
        </div>
    </div>

    <!-- ì£¼ìš” ì§€í‘œ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-center">
                <div class="text-blue-600 text-3xl mb-2">ğŸ“š</div>
                <p class="text-sm text-gray-600 mb-1">ìˆ˜ê°• ìˆ˜ì—…</p>
                <p class="text-3xl font-bold text-blue-600">{{ overall_progress.courses_count }}</p>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-center">
                <div class="text-green-600 text-3xl mb-2">âœ…</div>
                <p class="text-sm text-gray-600 mb-1">í‰ê·  ì¶œì„ë¥ </p>
                <p class="text-3xl font-bold text-green-600">{{ overall_progress.avg_attendance_rate }}%</p>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-center">
                <div class="text-purple-600 text-3xl mb-2">ğŸ“</div>
                <p class="text-sm text-gray-600 mb-1">ê³¼ì œ ì™„ë£Œìœ¨</p>
                <p class="text-3xl font-bold text-purple-600">{{ overall_progress.avg_assignment_completion }}%</p>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-center">
                <div class="text-orange-600 text-3xl mb-2">âœï¸</div>
                <p class="text-sm text-gray-600 mb-1">ì´ ì²¨ì‚­ ìˆ˜</p>
                <p class="text-3xl font-bold text-orange-600">{{ overall_progress.total_essays }}</p>
            </div>
        </div>
    </div>

    <!-- ì°¨íŠ¸: ìˆ˜ì—…ë³„ ì§„ë„ìœ¨ -->
    {% if course_progress %}
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">ìˆ˜ì—…ë³„ ì§„ë„ í˜„í™©</h3>
        </div>
        <div class="p-6">
            <canvas id="courseProgressChart" height="100"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- ì°¨íŠ¸: ì£¼ê°„ í™œë™ -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">ì£¼ê°„ í™œë™ ì¶”ì´ (ìµœê·¼ 4ì£¼)</h3>
        </div>
        <div class="p-6">
            <canvas id="weeklyActivityChart" height="80"></canvas>
        </div>
    </div>

    <!-- ê³¼ì œ í˜„í™© -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">ê³¼ì œ í˜„í™©</h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-1">ì „ì²´</p>
                    <p class="text-2xl font-bold text-gray-800">{{ assignment_status.status_counts.total }}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-1">ì™„ë£Œ</p>
                    <p class="text-2xl font-bold text-green-600">{{ assignment_status.status_counts.completed }}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-1">ëŒ€ê¸°</p>
                    <p class="text-2xl font-bold text-yellow-600">{{ assignment_status.status_counts.pending }}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-1">ì§€ê°</p>
                    <p class="text-2xl font-bold text-red-600">{{ assignment_status.status_counts.overdue }}</p>
                </div>
            </div>

            <!-- ê³¼ì œ ëª©ë¡ -->
            {% if assignment_status.assignments %}
            <div class="space-y-3">
                {% for item in assignment_status.assignments[:5] %}
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-medium text-gray-800">{{ item.assignment.title }}</h4>
                                <span class="px-2 py-0.5 text-xs font-medium rounded
                                    {% if item.status == 'graded' %}bg-green-100 text-green-800
                                    {% elif item.status == 'submitted' %}bg-yellow-100 text-yellow-800
                                    {% elif item.status == 'overdue' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if item.status == 'graded' %}ì±„ì ì™„ë£Œ
                                    {% elif item.status == 'submitted' %}ì œì¶œì™„ë£Œ
                                    {% elif item.status == 'overdue' %}ë§ˆê°ë¨
                                    {% else %}ì§„í–‰ì¤‘{% endif %}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">
                                {% if item.assignment.course %}{{ item.assignment.course.course_name }} | {% endif %}
                                ë§ˆê°: {{ item.assignment.due_date.strftime('%m/%d %H:%M') }}
                            </p>
                        </div>
                        <a href="{{ url_for('student.assignment_detail', assignment_id=item.assignment.assignment_id) }}"
                           class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            ë³´ê¸° â†’
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

    <!-- í•™ìŠµ ì„±ê³¼ -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">í•™ìŠµ ì„±ê³¼</h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="border border-gray-200 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-2">í‰ê·  ê³¼ì œ ì ìˆ˜</p>
                    <p class="text-3xl font-bold text-blue-700">{{ performance.avg_assignment_score }}ì </p>
                    <p class="text-xs text-gray-500 mt-1">ì±„ì  ì™„ë£Œ: {{ performance.graded_assignments_count }}ê°œ</p>
                </div>
                <div class="border border-gray-200 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-2">ì²¨ì‚­ ì™„ë£Œ</p>
                    <p class="text-3xl font-bold text-green-700">{{ performance.completed_essays_count }}ê°œ</p>
                    <p class="text-xs text-gray-500 mt-1">ìµœì¢… ì™„ë£Œëœ ì²¨ì‚­</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// ìˆ˜ì—…ë³„ ì§„ë„ìœ¨ ì°¨íŠ¸
{% if course_progress %}
const courseCtx = document.getElementById('courseProgressChart').getContext('2d');
new Chart(courseCtx, {
    type: 'bar',
    data: {
        labels: {{ course_labels|safe }},
        datasets: [
            {
                label: 'ì¶œì„ë¥  (%)',
                data: {{ course_attendance|safe }},
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            },
            {
                label: 'ê³¼ì œ ì™„ë£Œìœ¨ (%)',
                data: {{ course_assignments|safe }},
                backgroundColor: 'rgba(168, 85, 247, 0.7)',
                borderColor: 'rgba(168, 85, 247, 1)',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
{% endif %}

// ì£¼ê°„ í™œë™ ì°¨íŠ¸
const weeklyCtx = document.getElementById('weeklyActivityChart').getContext('2d');
new Chart(weeklyCtx, {
    type: 'line',
    data: {
        labels: {{ weekly_labels|safe }},
        datasets: [
            {
                label: 'ì¶œì„',
                data: {{ weekly_attendance|safe }},
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            },
            {
                label: 'ê³¼ì œ ì œì¶œ',
                data: {{ weekly_assignments|safe }},
                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                borderColor: 'rgba(168, 85, 247, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            },
            {
                label: 'ì²¨ì‚­',
                data: {{ weekly_essays|safe }},
                backgroundColor: 'rgba(251, 191, 36, 0.1)',
                borderColor: 'rgba(251, 191, 36, 1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}
{% endblock %}
