{% extends "base.html" %}

{% block title %}ν…μ¤νΈ μ‘μ‹ - λ…μ„ λ…Όμ  MBTI{% endblock %}

{% block page_title %}π“ MBTI ν…μ¤νΈ{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">λ…μ„λ…Όμ  μ„±ν–¥ κ²€μ‚¬</span>
{% endblock %}


{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header with Progress -->
    <div class="sticky top-0 bg-white z-10 py-4 mb-6 border-b border-gray-200">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-2xl font-bold text-gray-800">π“ λ…μ„ λ…Όμ  MBTI μκ°€ν‰κ°€</h2>
            <button onclick="confirmExit()" class="text-gray-600 hover:text-gray-800">
                μ·¨μ†
            </button>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex-1">
                <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-purple-500 to-indigo-600 transition-all duration-300"
                         style="width: 0%"></div>
                </div>
            </div>
            <div class="text-sm font-medium text-gray-600">
                <span id="progressText">0</span> / 50
            </div>
        </div>
    </div>

    <form id="mbtiForm" method="POST" action="{{ url_for('student.submit_reading_mbti', test_id=test.test_id) }}">
        {{ form.hidden_tag() if form else '' }}

        <!-- Part 1: μ λ€ν‰κ°€ μ§λ¬Έ (45λ¬Έν•­) -->
        <div class="mb-12">
            <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-2">Part 1: μκ°€ν‰κ°€ (45λ¬Έν•­)</h3>
                {% if test.version == 'elementary' %}
                <p class="text-purple-100">
                    κ° λ¬Έν•­μ„ μ½κ³  ν•΄λ‹Ήν•λ” μ μλ¥Ό κ³¨λΌλ΄μ”!
                </p>
                <div class="grid grid-cols-5 gap-2 mt-4 text-sm">
                    <div class="text-center">1μ <br>μ „ν€ μ•„λ‹μ•Ό</div>
                    <div class="text-center">2μ <br>μ•„λ‹μ•Ό</div>
                    <div class="text-center">3μ <br>λ³΄ν†µμ΄μ•Ό</div>
                    <div class="text-center">4μ <br>κ·Έλ</div>
                    <div class="text-center">5μ <br>μ™„μ „ κ·Έλ!</div>
                </div>
                {% else %}
                <p class="text-purple-100">
                    κ° λ¬Έν•­μ„ μ½κ³  μμ‹ μ—κ² ν•΄λ‹Ήν•λ” μ •λ„λ¥Ό 1~5μ μΌλ΅ μ„ νƒν•μ„Έμ”.
                </p>
                <div class="grid grid-cols-5 gap-2 mt-4 text-sm">
                    <div class="text-center">1μ <br>μ „ν€ μ•„λ‹λ‹¤</div>
                    <div class="text-center">2μ <br>μ•„λ‹λ‹¤</div>
                    <div class="text-center">3μ <br>λ³΄ν†µμ΄λ‹¤</div>
                    <div class="text-center">4μ <br>κ·Έλ ‡λ‹¤</div>
                    <div class="text-center">5μ <br>λ§¤μ° κ·Έλ ‡λ‹¤</div>
                </div>
                {% endif %}
            </div>

            <!-- λ…ν•΄ μμ—­ (15λ¬Έν•­) -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-2xl">π“–</span>
                    λ…ν•΄ μμ—­ (1-15λ²)
                </h4>
                <div class="space-y-4">
                    {% for question in absolute_questions[:15] %}
                    <div class="border-b border-gray-200 pb-4 last:border-0">
                        <div class="font-medium text-gray-800 mb-3">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="flex gap-2 justify-center">
                            {% for value in range(1, 6) %}
                            <label class="flex-1 relative">
                                <input type="radio" name="q{{ question.order }}" value="{{ value }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-3 text-center cursor-pointer hover:border-purple-400 transition">
                                    <div class="text-xl font-bold">{{ value }}</div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- λ°ν‘/ν† λ΅  μμ—­ (15λ¬Έν•­) -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-2xl">π’¬</span>
                    λ°ν‘/ν† λ΅  μμ—­ (16-30λ²)
                </h4>
                <div class="space-y-4">
                    {% for question in absolute_questions[15:30] %}
                    <div class="border-b border-gray-200 pb-4 last:border-0">
                        <div class="font-medium text-gray-800 mb-3">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="flex gap-2 justify-center">
                            {% for value in range(1, 6) %}
                            <label class="flex-1 relative">
                                <input type="radio" name="q{{ question.order }}" value="{{ value }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-3 text-center cursor-pointer hover:border-purple-400 transition">
                                    <div class="text-xl font-bold">{{ value }}</div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- μ“°κΈ° μμ—­ (15λ¬Έν•­) -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span class="text-2xl">βοΈ</span>
                    μ“°κΈ° μμ—­ (31-45λ²)
                </h4>
                <div class="space-y-4">
                    {% for question in absolute_questions[30:45] %}
                    <div class="border-b border-gray-200 pb-4 last:border-0">
                        <div class="font-medium text-gray-800 mb-3">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="flex gap-2 justify-center">
                            {% for value in range(1, 6) %}
                            <label class="flex-1 relative">
                                <input type="radio" name="q{{ question.order }}" value="{{ value }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-3 text-center cursor-pointer hover:border-purple-400 transition">
                                    <div class="text-xl font-bold">{{ value }}</div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Part 2: λΉ„κµ μ„ νƒ μ§λ¬Έ (5λ¬Έν•­) -->
        <div class="mb-32">
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-2">Part 2: μ°μ„ μμ„ μ„ νƒ (5λ¬Έν•­)</h3>
                <p class="text-indigo-100">
                    κ° μ§λ¬Έμ—μ„ μμ‹ μ—κ² κ°€μ¥ μ λ§λ” ν•λ‚λ¥Ό μ„ νƒν•μ„Έμ”.
                </p>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="space-y-6">
                    {% for question in comparison_questions %}
                    {% set question_num = loop.index %}
                    <div class="border-b border-gray-200 pb-6 last:border-0">
                        <div class="font-bold text-gray-800 mb-4 text-lg">
                            {{ question.order }}. {{ question.text }}
                        </div>
                        <div class="space-y-2">
                            {% for option in question.options %}
                            <label class="block relative">
                                <input type="radio" name="comp{{ question_num }}" value="{{ option.v }}"
                                       class="peer absolute opacity-0 pointer-events-none" required onchange="updateProgress()">
                                <div class="peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600
                                            bg-white border-2 border-gray-300 text-gray-700
                                            rounded-lg p-4 cursor-pointer hover:border-indigo-400 transition">
                                    {{ option.t }}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-4 shadow-lg z-50">
            <div class="max-w-5xl mx-auto px-4 flex gap-4">
                <button type="button" onclick="confirmExit()"
                        class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-4 rounded-lg transition">
                    μ·¨μ†
                </button>
                <button type="submit" id="submitBtn"
                        class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700
                               text-white font-bold py-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submitText">κ²°κ³Ό ν™•μΈν•κΈ° π―</span>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// μ§„ν–‰λ¥  μ—…λ°μ΄νΈ
function updateProgress() {
    const totalQuestions = 50;
    let answeredCount = 0;

    // 45κ° μ λ€ν‰κ°€ λ¬Έν•­
    for (let i = 1; i <= 45; i++) {
        const radios = document.getElementsByName(`q${i}`);
        for (let radio of radios) {
            if (radio.checked) {
                answeredCount++;
                break;
            }
        }
    }

    // 5κ° λΉ„κµ λ¬Έν•­
    for (let i = 1; i <= 5; i++) {
        const radios = document.getElementsByName(`comp${i}`);
        for (let radio of radios) {
            if (radio.checked) {
                answeredCount++;
                break;
            }
        }
    }

    const percentage = (answeredCount / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressText').textContent = answeredCount;

    // μ μ¶ λ²„νΌ ν™μ„±ν™”/λΉ„ν™μ„±ν™”
    const submitBtn = document.getElementById('submitBtn');
    if (answeredCount === totalQuestions) {
        submitBtn.disabled = false;
        document.getElementById('submitText').textContent = 'β… κ²°κ³Ό ν™•μΈν•κΈ° (μ™„λ£!)';
    } else {
        submitBtn.disabled = true;
        document.getElementById('submitText').textContent = `λ‹µλ³€ μ§„ν–‰ μ¤‘... (${answeredCount}/50)`;
    }
}

// λ‚κ°€κΈ° ν™•μΈ
function confirmExit() {
    if (confirm('μ •λ§ λ‚κ°€μ‹κ² μµλ‹κΉ? μ§€κΈκΉμ§€ μ…λ ¥ν• λ‹µλ³€μ€ μ €μ¥λμ§€ μ•μµλ‹λ‹¤.')) {
        window.location.href = '{{ url_for("student.reading_mbti") }}';
    }
}

// νΌ μ μ¶ μ‹ ν™•μΈ
document.getElementById('mbtiForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn.disabled) {
        e.preventDefault();
        alert('λ¨λ“  μ§λ¬Έμ— λ‹µλ³€ν•΄μ£Όμ„Έμ”.');
        return;
    }

    submitBtn.disabled = true;
    document.getElementById('submitText').textContent = 'κ²°κ³Ό κ³„μ‚° μ¤‘...';
});

// νμ΄μ§€ λ΅λ“ μ‹ μ§„ν–‰λ¥  μ΄κΈ°ν™”
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
});

// νμ΄μ§€ λ– λ‚  λ• κ²½κ³ 
window.addEventListener('beforeunload', function(e) {
    const answeredCount = parseInt(document.getElementById('progressText').textContent);
    if (answeredCount > 0 && answeredCount < 50) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}
