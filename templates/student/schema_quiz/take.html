{% extends "base.html" %}

{% block title %}ìŠ¤í‚¤ë§ˆí€´ì¦ˆ í’€ì´ - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Progress -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">
                {% if session.subject == 'social' %}ğŸŒ ì‚¬íšŒ{% else %}ğŸ”¬ ê³¼í•™{% endif %}
            </span>
            <span class="text-sm font-medium {% if session.subject == 'social' %}text-amber-600{% else %}text-blue-600{% endif %}">
                {{ current_index + 1 }} / {{ total_count }}
            </span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="{% if session.subject == 'social' %}bg-amber-600{% else %}bg-blue-600{% endif %} h-3 rounded-full transition-all duration-300"
                 style="width: {{ ((current_index + 1) / total_count * 100)|round }}%"></div>
        </div>
    </div>

    <!-- Question Card -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
        <div class="mb-6">
            <span class="inline-block px-3 py-1 {% if session.subject == 'social' %}bg-amber-100 text-amber-800{% else %}bg-blue-100 text-blue-800{% endif %} text-sm font-medium rounded-full mb-4">
                ë¬¸ì œ {{ current_index + 1 }}
            </span>
            <div class="bg-gray-50 rounded-lg p-6 mb-4">
                <p class="text-sm text-gray-500 mb-2">ë‹¤ìŒ ì„¤ëª…ì— í•´ë‹¹í•˜ëŠ” ìš©ì–´ëŠ”?</p>
                <h3 class="text-2xl font-bold text-gray-800">{{ quiz.correct_answer }}</h3>
            </div>

            <!-- ì´ˆì„± íŒíŠ¸ -->
            <div class="bg-gradient-to-r {% if session.subject == 'social' %}from-amber-50 to-orange-50 border-amber-200{% else %}from-blue-50 to-purple-50 border-blue-200{% endif %} border-2 rounded-lg p-6 mb-6">
                <p class="text-sm {% if session.subject == 'social' %}text-amber-600{% else %}text-blue-600{% endif %} font-medium mb-2">ğŸ’¡ ì´ˆì„± íŒíŠ¸</p>
                <p class="text-2xl font-mono font-bold text-gray-800 tracking-wider">{{ chosung_hint }}</p>
            </div>
        </div>

        <!-- Answer Input -->
        <form id="quizForm" class="space-y-4">
            <input type="hidden" name="quiz_id" value="{{ quiz.quiz_id }}">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”</label>
                <input type="text"
                       name="answer"
                       id="answerInput"
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-{% if session.subject == 'social' %}amber{% else %}blue{% endif %}-500 focus:ring focus:ring-{% if session.subject == 'social' %}amber{% else %}blue{% endif %}-200 focus:outline-none text-lg"
                       placeholder="ìš©ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       autocomplete="off">
            </div>
        </form>
    </div>

    <!-- Buttons -->
    <div class="flex gap-4">
        <a href="{{ url_for('student.schema_quiz') }}"
           class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-4 rounded-lg text-center transition duration-200">
            í¬ê¸°í•˜ê¸°
        </a>
        <button id="submitBtn"
                class="flex-1 {% if session.subject == 'social' %}bg-amber-600 hover:bg-amber-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white font-bold py-4 rounded-lg transition duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed"
                disabled>
            ë‹¤ìŒ ë¬¸ì œ
        </button>
    </div>
</div>

<!-- Result Modal -->
<div id="resultModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <div id="correctResult" class="hidden text-center">
            <div class="text-6xl mb-4">âœ…</div>
            <h3 class="text-2xl font-bold text-green-600 mb-2">ì •ë‹µì…ë‹ˆë‹¤!</h3>
            <p class="text-gray-600 mb-6">ì˜í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
        </div>
        <div id="incorrectResult" class="hidden text-center">
            <div class="text-6xl mb-4">âŒ</div>
            <h3 class="text-2xl font-bold text-red-600 mb-2">í‹€ë ¸ìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-600 mb-2">ì •ë‹µì€:</p>
            <p class="text-base text-gray-800 font-medium mb-6 px-4" id="correctAnswer"></p>
        </div>
        <button id="nextBtn" class="w-full {% if session.subject == 'social' %}bg-amber-600 hover:bg-amber-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white font-bold py-3 rounded-lg transition duration-200">
            ê³„ì†í•˜ê¸°
        </button>
    </div>
</div>

<script>
const form = document.getElementById('quizForm');
const submitBtn = document.getElementById('submitBtn');
const answerInput = document.getElementById('answerInput');
const resultModal = document.getElementById('resultModal');
const correctResult = document.getElementById('correctResult');
const incorrectResult = document.getElementById('incorrectResult');
const nextBtn = document.getElementById('nextBtn');

// ì…ë ¥ ì‹œ ì œì¶œ ë²„íŠ¼ í™œì„±í™”
answerInput.addEventListener('input', () => {
    submitBtn.disabled = answerInput.value.trim().length === 0;
});

// ì—”í„°í‚¤ë¡œë„ ì œì¶œ ê°€ëŠ¥
answerInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !submitBtn.disabled) {
        submitBtn.click();
    }
});

// ë‹µì•ˆ ì œì¶œ
submitBtn.addEventListener('click', async () => {
    const formData = new FormData(form);
    const answer = formData.get('answer').trim();

    if (!answer) {
        alert('ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    submitBtn.disabled = true;
    answerInput.disabled = true;

    try {
        const response = await fetch('{{ url_for("student.schema_quiz_submit", session_id=session.session_id) }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            resultModal.classList.remove('hidden');

            if (result.is_correct) {
                correctResult.classList.remove('hidden');
                incorrectResult.classList.add('hidden');
            } else {
                incorrectResult.classList.remove('hidden');
                correctResult.classList.add('hidden');
                document.getElementById('correctAnswer').textContent = '{{ quiz.term }}';
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        submitBtn.disabled = false;
        answerInput.disabled = false;
    }
});

// ë‹¤ìŒ ë¬¸ì œë¡œ
nextBtn.addEventListener('click', () => {
    const nextIndex = {{ current_index + 1 }};
    const totalCount = {{ total_count }};

    if (nextIndex >= totalCount) {
        window.location.href = '{{ url_for("student.schema_quiz_result", session_id=session.session_id) }}';
    } else {
        window.location.href = '{{ url_for("student.schema_quiz_take", session_id=session.session_id) }}?q=' + nextIndex;
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
answerInput.focus();
</script>
{% endblock %}
