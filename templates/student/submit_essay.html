{% extends "base.html" %}

{% block title %}ê¸€ì“°ê¸° ì œì¶œ - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('student.index') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ëŒ€ì‹œë³´ë“œë¡œ
        </a>
        <h2 class="text-3xl font-bold text-gray-800">ê¸€ì“°ê¸° ì œì¶œ</h2>
        <p class="text-gray-600 mt-2">ì œì¶œí•˜ë©´ ë‹´ë‹¹ ê°•ì‚¬ì—ê²Œ ìë™ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</p>
    </div>

    <!-- ê¸€ì“°ê¸° ì œì¶œ í¼ -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <form method="POST" action="{{ url_for('student.submit_essay') }}" enctype="multipart/form-data" onsubmit="return validateForm()">
                {% if enrolled_teachers|length > 1 %}
                <div class="mb-6">
                    <label for="teacher_id" class="block text-sm font-medium text-gray-700 mb-2">
                        ë‹´ë‹¹ ê°•ì‚¬ ì„ íƒ
                    </label>
                    <select id="teacher_id" name="teacher_id"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for teacher in enrolled_teachers %}
                        <option value="{{ teacher.user_id }}"
                            {% if teacher.user_id == default_teacher_id %}selected{% endif %}>
                            {{ teacher.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-xs text-gray-500">ê¸°ë³¸ê°’: ê°€ì¥ ì˜¤ë˜ ìˆ˜ê°•í•œ ê°•ì‚¬</p>
                </div>
                {% elif enrolled_teachers|length == 1 %}
                <input type="hidden" name="teacher_id" value="{{ enrolled_teachers[0].user_id }}">
                {% elif default_teacher_id %}
                <input type="hidden" name="teacher_id" value="{{ default_teacher_id }}">
                {% endif %}

                <div class="mb-6">
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        ì œëª© <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           id="title"
                           name="title"
                           required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ì²¨ì‚­ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <!-- íŒŒì¼ ì²¨ë¶€ -->
                <div class="mb-6">
                    <label for="attachments" class="block text-sm font-medium text-gray-700 mb-2">
                        ì²¨ë¶€ íŒŒì¼ (ì„ íƒì‚¬í•­, ìµœëŒ€ 10ê°œ)
                    </label>
                    <input type="file"
                           id="attachments"
                           name="attachments"
                           multiple
                           accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.hwp,.txt"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                           onchange="updateFileList(this)">
                    <div id="fileList" class="mt-3 space-y-2"></div>
                    <p class="mt-2 text-sm text-gray-500">
                        ğŸ’¡ ì´ë¯¸ì§€, PDF, ì›Œë“œ, í•œê¸€ íŒŒì¼ ë“±ì„ í•œ ë²ˆì— ìµœëŒ€ 10ê°œê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ê° íŒŒì¼ ìµœëŒ€ 16MB)
                    </p>
                </div>

                <script>
                function updateFileList(input) {
                    const fileList = document.getElementById('fileList');
                    fileList.innerHTML = '';

                    if (input.files.length > 10) {
                        alert('ìµœëŒ€ 10ê°œì˜ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        input.value = '';
                        return;
                    }

                    if (input.files.length > 0) {
                        const heading = document.createElement('p');
                        heading.className = 'text-sm font-medium text-gray-700';
                        heading.textContent = `ì„ íƒëœ íŒŒì¼ (${input.files.length}ê°œ):`;
                        fileList.appendChild(heading);

                        for (let i = 0; i < input.files.length; i++) {
                            const file = input.files[i];
                            const fileSize = (file.size / 1024 / 1024).toFixed(2);

                            if (file.size > 16 * 1024 * 1024) {
                                alert(`${file.name}ì˜ í¬ê¸°ê°€ 16MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                                input.value = '';
                                fileList.innerHTML = '';
                                return;
                            }

                            const fileItem = document.createElement('div');
                            fileItem.className = 'flex items-center gap-2 text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded';
                            fileItem.innerHTML = `
                                <span class="text-blue-600">ğŸ“</span>
                                <span class="flex-1">${file.name}</span>
                                <span class="text-gray-400">(${fileSize} MB)</span>
                            `;
                            fileList.appendChild(fileItem);
                        }
                    }
                }

                function validateForm() {
                    const title = document.getElementById('title').value.trim();
                    const content = document.getElementById('content').value.trim();
                    const attachments = document.getElementById('attachments').files;

                    // ì œëª©ì€ í•„ìˆ˜
                    if (!title) {
                        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return false;
                    }

                    // ë³¸ë¬¸ ë˜ëŠ” ì²¨ë¶€íŒŒì¼ ì¤‘ í•˜ë‚˜ëŠ” ìˆì–´ì•¼ í•¨
                    if (!content && attachments.length === 0) {
                        alert('ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.');
                        return false;
                    }

                    return true;
                }
                </script>

                <div class="mb-6">
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                        ë³¸ë¬¸ <span class="text-gray-400 text-xs">(ì²¨ë¶€íŒŒì¼ì´ ìˆìœ¼ë©´ ì„ íƒì‚¬í•­)</span>
                    </label>
                    <textarea id="content"
                              name="content"
                              rows="20"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"
                              placeholder="ì²¨ì‚­ë°›ì„ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    <p class="mt-2 text-sm text-gray-500">
                        ğŸ’¡ íŒ: ë³¸ë¬¸ ë‚´ìš©ì´ ì—†ì–´ë„ ì²¨ë¶€íŒŒì¼ë§Œìœ¼ë¡œ ê¸€ì“°ê¸° ì œì¶œì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">ğŸ’¡</span>
                        <div>
                            <h4 class="font-medium text-blue-900 mb-1">ê¸€ì“°ê¸° ì œì¶œ ì•ˆë‚´</h4>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>â€¢ ì œì¶œí•˜ë©´ ë‹´ë‹¹ ê°•ì‚¬ì—ê²Œ ìë™ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤</li>
                                <li>â€¢ ê°•ì‚¬ê°€ ì²¨ì‚­ì„ ì™„ë£Œí•˜ë©´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                                <li>â€¢ ì œì¶œ í›„ ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° ê°•ì‚¬ì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                        ì œì¶œí•˜ê¸°
                    </button>
                    <a href="{{ url_for('student.index') }}"
                       class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 rounded-lg transition duration-200 text-center">
                        ì·¨ì†Œ
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- ì œì¶œ ì´ë ¥ -->
    {% if recent_essays %}
    <div class="mt-8 bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-800">ğŸ“‹ ì´ì „ ì œì¶œ ì´ë ¥ (ìµœê·¼ 10ê±´)</h3>
            <a href="{{ url_for('student.my_essays') }}"
               class="text-sm text-blue-600 hover:text-blue-800 font-medium">ì „ì²´ ë³´ê¸° â†’</a>
        </div>
        <div class="divide-y divide-gray-100">
            {% for essay in recent_essays %}
            <a href="{{ url_for('student.view_essay', essay_id=essay.essay_id) }}"
               class="flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition-colors duration-150">
                <div class="flex items-center gap-3 min-w-0">
                    <!-- ìƒíƒœ ì•„ì´ì½˜ -->
                    <div class="flex-shrink-0">
                        {% if essay.status == 'completed' %}
                        <span class="inline-flex items-center justify-center w-8 h-8 bg-green-100 rounded-full text-green-700 text-sm">âœ“</span>
                        {% elif essay.status == 'in_progress' %}
                        <span class="inline-flex items-center justify-center w-8 h-8 bg-yellow-100 rounded-full text-yellow-700 text-sm">â³</span>
                        {% else %}
                        <span class="inline-flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full text-gray-500 text-sm">â—‹</span>
                        {% endif %}
                    </div>
                    <div class="min-w-0">
                        <p class="font-medium text-gray-800 truncate">{{ essay.title }}</p>
                        <p class="text-xs text-gray-400 mt-0.5">{{ essay.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </div>
                <div class="flex-shrink-0 ml-4">
                    {% if essay.status == 'completed' %}
                    <span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded-full">ì²¨ì‚­ ì™„ë£Œ</span>
                    {% elif essay.status == 'in_progress' %}
                    <span class="text-xs font-medium text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full">ê²€í†  ì¤‘</span>
                    {% else %}
                    <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">ëŒ€ê¸° ì¤‘</span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
