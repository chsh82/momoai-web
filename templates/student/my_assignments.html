{% extends "base.html" %}

{% block title %}ê³¼ì œ ë³´ê¸° - MOMOAI v4.0{% endblock %}

{% block page_title %}ğŸ“‹ ê³¼ì œ ë³´ê¸°{% endblock %}
{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ë“±ë¡ëœ ê³¼ì œ ë° ìˆ˜ì—… ê³µì§€</span>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <!-- í†µê³„ ì¹´ë“œ -->
    {% set not_started = assignment_data | selectattr('status', 'equalto', 'not_started') | list %}
    {% set submitted   = assignment_data | selectattr('status', 'in', ['submitted', 'graded']) | list %}
    {% set graded      = assignment_data | selectattr('status', 'equalto', 'graded') | list %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-blue-500">
            <p class="text-sm text-gray-500 mb-1">ì „ì²´ ê³¼ì œ</p>
            <p class="text-3xl font-bold text-blue-600">{{ assignment_data | length }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-red-400">
            <p class="text-sm text-gray-500 mb-1">ë¯¸ì œì¶œ</p>
            <p class="text-3xl font-bold text-red-500">{{ not_started | length }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-yellow-400">
            <p class="text-sm text-gray-500 mb-1">ì œì¶œ ì™„ë£Œ</p>
            <p class="text-3xl font-bold text-yellow-600">{{ submitted | length }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-green-500">
            <p class="text-sm text-gray-500 mb-1">ì±„ì  ì™„ë£Œ</p>
            <p class="text-3xl font-bold text-green-600">{{ graded | length }}</p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ì„¹ì…˜ 1: ì •ì‹ ê³¼ì œ (Assignment ëª¨ë¸)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            ğŸ“Œ ë“±ë¡ëœ ê³¼ì œ
            <span class="text-sm font-normal text-gray-500">ê°•ì‚¬ê°€ ì¶œì œí•œ ì •ì‹ ê³¼ì œ</span>
        </h3>

        {% if assignment_data %}
        <div class="space-y-3">
            {% for data in assignment_data %}
            {% set a = data.assignment %}
            {% set sub = data.submission %}
            {% set status = data.status %}

            <div class="bg-white rounded-lg shadow hover:shadow-md transition-shadow duration-200
                {% if status == 'graded' %}border-l-4 border-green-400
                {% elif status in ['submitted', 'draft'] %}border-l-4 border-yellow-400
                {% elif a.is_overdue %}border-l-4 border-red-400
                {% else %}border-l-4 border-blue-400{% endif %}">

                <div class="p-5">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <!-- ë°°ì§€ í–‰ -->
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <!-- ìƒíƒœ ë°°ì§€ -->
                                {% if status == 'graded' %}
                                <span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-0.5 rounded-full">âœ… ì±„ì  ì™„ë£Œ</span>
                                {% elif status in ['submitted', 'draft'] %}
                                <span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-0.5 rounded-full">â³ ì±„ì  ëŒ€ê¸°</span>
                                {% elif a.is_overdue %}
                                <span class="bg-red-100 text-red-800 text-xs font-semibold px-2 py-0.5 rounded-full">âš ï¸ ë§ˆê°ë¨</span>
                                {% elif a.days_until_due <= 1 %}
                                <span class="bg-orange-100 text-orange-800 text-xs font-semibold px-2 py-0.5 rounded-full">ğŸ”¥ ì˜¤ëŠ˜ ë§ˆê°</span>
                                {% elif a.days_until_due <= 3 %}
                                <span class="bg-orange-100 text-orange-800 text-xs font-semibold px-2 py-0.5 rounded-full">{{ a.days_until_due }}ì¼ ë‚¨ìŒ</span>
                                {% else %}
                                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded-full">ğŸ“‹ ë¯¸ì œì¶œ</span>
                                {% endif %}

                                <!-- ê³¼ì œ ìœ í˜• -->
                                <span class="bg-gray-100 text-gray-700 text-xs px-2 py-0.5 rounded-full">
                                    {% if a.assignment_type == 'essay' %}ë…¼ìˆ 
                                    {% elif a.assignment_type == 'reading' %}ë…ì„œ
                                    {% elif a.assignment_type == 'quiz' %}í€´ì¦ˆ
                                    {% else %}í”„ë¡œì íŠ¸{% endif %}
                                </span>

                                <!-- ê°œë³„ ì§€ì • -->
                                {% if a.target_student_id %}
                                <span class="bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded-full">ğŸ‘¤ ê°œë³„ ê³¼ì œ</span>
                                {% endif %}
                            </div>

                            <!-- ì œëª© -->
                            <h4 class="font-semibold text-gray-900 text-base mb-1">{{ a.title }}</h4>

                            <!-- ë©”íƒ€ ì •ë³´ -->
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500">
                                <span>ğŸ“… ë§ˆê°: {{ a.due_date.strftime('%Y-%m-%d %H:%M') }}</span>
                                <span>ğŸ’¯ ë°°ì : {{ a.max_score }}ì </span>
                                {% if a.course %}<span>ğŸ“š {{ a.course.course_name }}</span>{% endif %}
                            </div>

                            <!-- ì±„ì  ê²°ê³¼ (ì±„ì  ì™„ë£Œ ì‹œ) -->
                            {% if status == 'graded' and sub %}
                            <div class="mt-3 flex items-center gap-3 bg-green-50 rounded-lg px-4 py-2">
                                <span class="text-2xl font-bold text-green-700">{{ sub.score }}</span>
                                <span class="text-sm text-green-600">/ {{ a.max_score }}ì </span>
                                {% if sub.feedback %}
                                <span class="text-sm text-gray-600 ml-2 truncate">ğŸ’¬ {{ sub.feedback[:60] }}{% if sub.feedback|length > 60 %}...{% endif %}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- ë²„íŠ¼ -->
                        <div class="flex-shrink-0">
                            <a href="{{ url_for('student.assignment_detail', assignment_id=a.assignment_id) }}"
                               class="inline-block px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200
                               {% if status == 'graded' %}bg-green-600 hover:bg-green-700 text-white
                               {% elif status in ['submitted', 'draft'] %}bg-yellow-500 hover:bg-yellow-600 text-white
                               {% elif a.is_overdue and not a.late_submission_allowed %}bg-gray-400 text-white cursor-not-allowed
                               {% else %}bg-blue-600 hover:bg-blue-700 text-white{% endif %}">
                                {% if status == 'graded' %}ê²°ê³¼ ë³´ê¸°
                                {% elif status in ['submitted', 'draft'] %}ì œì¶œ ë‚´ìš© ë³´ê¸°
                                {% elif a.is_overdue %}ì§€ê° ì œì¶œ
                                {% else %}ì œì¶œí•˜ê¸°{% endif %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow p-10 text-center text-gray-400">
            <div class="text-5xl mb-3">ğŸ“­</div>
            <p class="text-base font-medium">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="text-sm mt-1">ê°•ì‚¬ê°€ ê³¼ì œë¥¼ ì¶œì œí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ì„¹ì…˜ 2: ìˆ˜ì—… ê³µì§€ / ê³¼ì œ ë©”ì‹œì§€ (ì•Œë¦¼)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div>
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            ğŸ“¢ ìˆ˜ì—… ê³µì§€ ë° ê³¼ì œ ë©”ì‹œì§€
            <span class="text-sm font-normal text-gray-500">ê°•ì‚¬ê°€ ë³´ë‚¸ ë©”ì‹œì§€</span>
        </h3>

        {% if notifications %}
        {% set hw_count  = notifications | selectattr('notification_type', 'equalto', 'homework_assignment') | list | length %}
        {% set ann_count = notifications | selectattr('notification_type', 'equalto', 'class_announcement')  | list | length %}
        <p class="text-sm text-gray-500 mb-3">ê³¼ì œ ê³µì§€ {{ hw_count }}ê±´ Â· ìˆ˜ì—… ê³µì§€ {{ ann_count }}ê±´</p>

        <div class="space-y-4">
            {% for n in notifications %}
            <div class="bg-white rounded-lg shadow hover:shadow-md transition-shadow duration-200"
                 id="notif-{{ n.notification_id }}">
                <div class="p-5">
                    <div class="flex items-start gap-4">
                        <!-- ì•„ì´ì½˜ -->
                        <div class="flex-shrink-0 w-11 h-11 rounded-full flex items-center justify-center text-xl
                            {% if n.related_entity_type == 'student' %}bg-orange-100{% else %}bg-blue-100{% endif %}">
                            {% if n.related_entity_type == 'student' %}ğŸ‘¤{% else %}ğŸ“£{% endif %}
                        </div>

                        <!-- ë‚´ìš© -->
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-center gap-2 mb-1">
                                {% if n.related_entity_type == 'student' %}
                                <span class="bg-orange-100 text-orange-700 text-xs font-semibold px-2 py-0.5 rounded-full">ê°œë³„</span>
                                {% else %}
                                <span class="bg-blue-100 text-blue-700 text-xs font-semibold px-2 py-0.5 rounded-full">ì „ì²´</span>
                                {% endif %}
                                {% if n.notification_type == 'class_announcement' %}
                                <span class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-0.5 rounded-full">ê³µì§€</span>
                                {% else %}
                                <span class="bg-purple-100 text-purple-700 text-xs font-semibold px-2 py-0.5 rounded-full">ê³¼ì œ</span>
                                {% endif %}
                                <span class="text-xs text-gray-400">{{ n.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                {% if n.replies %}
                                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">ğŸ’¬ {{ n.replies|length }}</span>
                                {% endif %}
                            </div>
                            <p class="font-semibold text-gray-800 mb-1">{{ n.title }}</p>
                            <p class="text-gray-600 text-sm whitespace-pre-wrap leading-relaxed">{{ n.message }}</p>
                        </div>
                    </div>

                    <!-- ë‹µê¸€ ì„¹ì…˜ -->
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <!-- ê¸°ì¡´ ë‹µê¸€ -->
                        {% if n.replies %}
                        <div class="space-y-2 mb-3">
                            {% for reply in n.replies | sort(attribute='created_at') %}
                            <div class="flex gap-2 {% if reply.author_id == n.related_user_id %}justify-end{% endif %}">
                                {% if reply.author_id != n.related_user_id %}
                                <div class="flex-shrink-0 w-7 h-7 bg-blue-100 rounded-full flex items-center justify-center text-xs">ğŸ§‘</div>
                                <div class="max-w-lg">
                                    <div class="bg-blue-50 rounded-lg px-3 py-2 text-sm text-gray-800 whitespace-pre-wrap">{{ reply.content }}</div>
                                    <p class="text-xs text-gray-400 mt-0.5">{{ reply.author.name }} Â· {{ reply.created_at.strftime('%m/%d %H:%M') }}</p>
                                </div>
                                {% else %}
                                <div class="max-w-lg">
                                    <div class="bg-green-50 rounded-lg px-3 py-2 text-sm text-gray-800 whitespace-pre-wrap">{{ reply.content }}</div>
                                    <p class="text-xs text-gray-400 mt-0.5 text-right">ê°•ì‚¬ {{ reply.author.name }} Â· {{ reply.created_at.strftime('%m/%d %H:%M') }}</p>
                                </div>
                                <div class="flex-shrink-0 w-7 h-7 bg-green-100 rounded-full flex items-center justify-center text-xs">ğŸ‘¨â€ğŸ«</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- ë‹µê¸€ ì‘ì„± -->
                        <button onclick="toggleReplyForm('{{ n.notification_id }}')"
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                            âœï¸ ë‹µê¸€ ë‹¬ê¸°
                        </button>
                        <div id="reply-form-{{ n.notification_id }}" class="hidden mt-2">
                            <form method="POST"
                                  action="{{ url_for('student.reply_to_homework', notification_id=n.notification_id) }}">
                                <textarea name="content" rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                                          placeholder="ê°•ì‚¬ë‹˜ê»˜ ë‹µê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." required></textarea>
                                <div class="flex justify-end gap-2 mt-1.5">
                                    <button type="button" onclick="toggleReplyForm('{{ n.notification_id }}')"
                                            class="px-3 py-1.5 text-xs text-gray-600 bg-gray-100 hover:bg-gray-200 rounded transition">ì·¨ì†Œ</button>
                                    <button type="submit"
                                            class="px-3 py-1.5 text-xs text-white bg-blue-600 hover:bg-blue-700 rounded transition">ë“±ë¡</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow p-10 text-center text-gray-400">
            <div class="text-5xl mb-3">ğŸ“­</div>
            <p class="text-base font-medium">ë°›ì€ ê³µì§€ë‚˜ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        {% endif %}
    </div>

</div>

<script>
function toggleReplyForm(id) {
    document.getElementById('reply-form-' + id).classList.toggle('hidden');
}
</script>
{% endblock %}
