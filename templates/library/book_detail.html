{% extends "base.html" %}

{% block title %}{{ book.title }} - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">{{ book.title }}</h2>
        <div class="flex items-center gap-3 flex-wrap">
            <p class="text-xl text-gray-600">{{ book.author }}</p>
            {% if book.is_curriculum %}
            <span class="px-3 py-1 bg-blue-600 text-white text-sm font-bold rounded-full shadow-sm">ìˆ˜ì—…ë„ì„œ</span>
            {% endif %}
            {% if book.is_recommended %}
            <span class="px-3 py-1 bg-green-600 text-white text-sm font-bold rounded-full shadow-sm">ì¶”ì²œë„ì„œ</span>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
        <!-- Book Cover -->
        <div class="md:col-span-1">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="bg-gray-100 aspect-[3/4] flex items-center justify-center">
                    {% if book.cover_image %}
                    <img src="{{ book.cover_image }}"
                         alt="{{ book.title }}"
                         class="w-full h-full object-cover">
                    {% else %}
                    <span class="text-8xl">ğŸ“•</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Book Info -->
        <div class="md:col-span-2">
            <!-- í‰ì  ì¹´ë“œ -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">â­ í•™ìƒ í‰ì </h3>
                {% if book.avg_score %}
                <div class="flex items-center gap-8 mb-2">
                    <!-- ì¢…í•© ë³„ì  -->
                    <div class="text-center">
                        <div class="text-4xl font-bold text-yellow-500">{{ book.avg_score }}</div>
                        <div class="flex justify-center gap-0.5 my-1">
                            {% set full_stars = book.avg_score | round | int %}
                            {% for i in range(1, 6) %}
                                <span class="{% if i <= full_stars %}text-yellow-400{% else %}text-gray-300{% endif %} text-xl">â˜…</span>
                            {% endfor %}
                        </div>
                        <div class="text-xs text-gray-500">{{ book.rating_count }}ëª… ì°¸ì—¬</div>
                    </div>
                    <!-- ì„¸ë¶€ ì ìˆ˜ -->
                    <div class="flex-1 space-y-2">
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-600 w-16">ì¬ë¯¸</span>
                            <div class="flex gap-0.5">
                                {% set fun_full = book.avg_fun_score | round | int %}
                                {% for i in range(1, 6) %}
                                    <span class="{% if i <= fun_full %}text-yellow-400{% else %}text-gray-300{% endif %} text-base">â˜…</span>
                                {% endfor %}
                            </div>
                            <span class="text-sm font-medium text-gray-700">{{ book.avg_fun_score }}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-600 w-16">ìœ ìµí•¨</span>
                            <div class="flex gap-0.5">
                                {% set use_full = book.avg_usefulness_score | round | int %}
                                {% for i in range(1, 6) %}
                                    <span class="{% if i <= use_full %}text-yellow-400{% else %}text-gray-300{% endif %} text-base">â˜…</span>
                                {% endfor %}
                            </div>
                            <span class="text-sm font-medium text-gray-700">{{ book.avg_usefulness_score }}</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-400 text-sm mb-3">ì•„ì§ í‰ì ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ í‰ì ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                {% endif %}

                <!-- í•™ìƒ í‰ì  ì…ë ¥ í¼ -->
                {% if current_user.role == 'student' %}
                <div class="mt-4 pt-4 border-t border-gray-100" id="ratingSection">
                    <p class="text-sm font-semibold text-gray-700 mb-3">
                        {% if my_rating %}ë‚´ í‰ì  ìˆ˜ì •{% else %}í‰ì  ë‚¨ê¸°ê¸°{% endif %}
                    </p>
                    <div class="space-y-3">
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600 w-16">ì¬ë¯¸</span>
                            <div class="flex gap-1" id="funStars">
                                {% for i in range(1, 6) %}
                                <button type="button" onclick="setFunScore({{ i }})"
                                        class="star-btn text-2xl transition {% if my_rating and i <= my_rating.fun_score %}text-yellow-400{% else %}text-gray-300{% endif %}"
                                        data-score="{{ i }}">â˜…</button>
                                {% endfor %}
                            </div>
                            <span class="text-sm text-gray-500" id="funLabel">{% if my_rating %}{{ my_rating.fun_score }}ì {% else %}ì„ íƒ{% endif %}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600 w-16">ìœ ìµí•¨</span>
                            <div class="flex gap-1" id="useStars">
                                {% for i in range(1, 6) %}
                                <button type="button" onclick="setUseScore({{ i }})"
                                        class="star-btn text-2xl transition {% if my_rating and i <= my_rating.usefulness_score %}text-yellow-400{% else %}text-gray-300{% endif %}"
                                        data-score="{{ i }}">â˜…</button>
                                {% endfor %}
                            </div>
                            <span class="text-sm text-gray-500" id="useLabel">{% if my_rating %}{{ my_rating.usefulness_score }}ì {% else %}ì„ íƒ{% endif %}</span>
                        </div>
                    </div>
                    <button onclick="submitRating()"
                            class="mt-3 px-5 py-2 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium rounded-lg transition">
                        í‰ì  ë“±ë¡
                    </button>
                    <p id="ratingMsg" class="text-xs mt-2 hidden"></p>
                </div>
                {% endif %}
            </div>

            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ë„ì„œ ì •ë³´</h3>
                <div class="space-y-3">
                    <div class="flex">
                        <label class="font-semibold text-gray-700 w-24">ì €ì:</label>
                        <span class="text-gray-600">{{ book.author }}</span>
                    </div>
                    {% if book.publisher %}
                    <div class="flex">
                        <label class="font-semibold text-gray-700 w-24">ì¶œíŒì‚¬:</label>
                        <span class="text-gray-600">{{ book.publisher }}</span>
                    </div>
                    {% endif %}
                    {% if book.published_date %}
                    <div class="flex">
                        <label class="font-semibold text-gray-700 w-24">ì¶œíŒì¼:</label>
                        <span class="text-gray-600">{{ book.published_date }}</span>
                    </div>
                    {% endif %}
                    {% if book.isbn %}
                    <div class="flex">
                        <label class="font-semibold text-gray-700 w-24">ISBN:</label>
                        <span class="text-gray-600">{{ book.isbn }}</span>
                    </div>
                    {% endif %}
                    {% if book.category %}
                    <div class="flex">
                        <label class="font-semibold text-gray-700 w-24">ë¶„ë¥˜:</label>
                        <span class="text-gray-600">{{ book.category }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Book Description -->
            {% if book.description %}
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ì±… ì†Œê°œ</h3>
                <div class="text-gray-600 whitespace-pre-wrap leading-relaxed">
                    {{ book.description }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recommendation Reason -->
    {% if book.recommendation_reason %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <h3 class="text-xl font-bold text-blue-800 mb-3">ğŸ’¡ ì¶”ì²œ ì´ìœ </h3>
        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">{{ book.recommendation_reason }}</p>
    </div>
    {% endif %}

    <!-- Admin Edit Button -->
    {% if current_user.role == 'admin' %}
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">ê´€ë¦¬ì ì „ìš©</span>
            <div class="space-x-2">
                <a href="{{ url_for('library.edit_book', book_id=book.book_id) }}"
                   class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                    ìˆ˜ì •
                </a>
                <button onclick="if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { document.getElementById('deleteForm').submit(); }"
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                    ì‚­ì œ
                </button>
            </div>
        </div>
        <form id="deleteForm"
              action="{{ url_for('library.delete_book', book_id=book.book_id) }}"
              method="POST"
              class="hidden">
        </form>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="flex justify-center space-x-4">
        <a href="{{ url_for('library.books') }}"
           class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition duration-200">
            â† ëª©ë¡ìœ¼ë¡œ
        </a>
    </div>
</div>

{% if current_user.role == 'student' %}
<script>
var funScore = {{ my_rating.fun_score if my_rating else 0 }};
var useScore = {{ my_rating.usefulness_score if my_rating else 0 }};

function setFunScore(score) {
    funScore = score;
    document.getElementById('funLabel').textContent = score + 'ì ';
    document.querySelectorAll('#funStars .star-btn').forEach(btn => {
        btn.classList.toggle('text-yellow-400', parseInt(btn.dataset.score) <= score);
        btn.classList.toggle('text-gray-300', parseInt(btn.dataset.score) > score);
    });
}
function setUseScore(score) {
    useScore = score;
    document.getElementById('useLabel').textContent = score + 'ì ';
    document.querySelectorAll('#useStars .star-btn').forEach(btn => {
        btn.classList.toggle('text-yellow-400', parseInt(btn.dataset.score) <= score);
        btn.classList.toggle('text-gray-300', parseInt(btn.dataset.score) > score);
    });
}

// í˜¸ë²„ íš¨ê³¼
document.querySelectorAll('#funStars .star-btn').forEach(btn => {
    btn.addEventListener('mouseenter', () => {
        const hovered = parseInt(btn.dataset.score);
        document.querySelectorAll('#funStars .star-btn').forEach(b => {
            b.classList.toggle('text-yellow-300', parseInt(b.dataset.score) <= hovered);
        });
    });
    btn.addEventListener('mouseleave', () => {
        setFunScore(funScore);
    });
});
document.querySelectorAll('#useStars .star-btn').forEach(btn => {
    btn.addEventListener('mouseenter', () => {
        const hovered = parseInt(btn.dataset.score);
        document.querySelectorAll('#useStars .star-btn').forEach(b => {
            b.classList.toggle('text-yellow-300', parseInt(b.dataset.score) <= hovered);
        });
    });
    btn.addEventListener('mouseleave', () => {
        setUseScore(useScore);
    });
});

function submitRating() {
    if (!funScore || !useScore) {
        alert('ì¬ë¯¸ì™€ ìœ ìµí•¨ ì ìˆ˜ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    const csrf = document.querySelector('input[name="csrf_token"]');
    fetch('{{ url_for("library.rate_book", book_id=book.book_id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf ? csrf.value : ''
        },
        body: JSON.stringify({ fun_score: funScore, usefulness_score: useScore })
    })
    .then(r => r.json())
    .then(data => {
        const msg = document.getElementById('ratingMsg');
        msg.classList.remove('hidden', 'text-red-500', 'text-green-600');
        if (data.success) {
            msg.textContent = 'âœ… ' + data.message + ' (í‰ê· : â˜…' + (data.avg_score || '-') + ')';
            msg.classList.add('text-green-600');
            // í˜ì´ì§€ ìƒë‹¨ í‰ì  ì„¹ì…˜ ì—…ë°ì´íŠ¸
            setTimeout(() => location.reload(), 1200);
        } else {
            msg.textContent = 'âŒ ' + data.message;
            msg.classList.add('text-red-500');
        }
        msg.classList.remove('hidden');
    })
    .catch(() => {
        alert('í‰ì  ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}
</script>
{% endif %}
{% endblock %}
