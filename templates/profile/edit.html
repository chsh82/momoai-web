{% extends "base.html" %}

{% block title %}í”„ë¡œí•„ ìˆ˜ì • - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('profile.index') }}" class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°
        </a>
        <h2 class="text-3xl font-bold text-gray-800">í”„ë¡œí•„ ìˆ˜ì •</h2>
        <p class="text-gray-600 mt-1">ê¸°ë³¸ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <form method="POST" action="{{ url_for('profile.edit') }}" enctype="multipart/form-data">
            {{ form.hidden_tag() }}

            <div class="space-y-6">
                <!-- ì´ë¦„ -->
                <div>
                    {{ form.name.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.name(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" + (" border-red-500" if form.name.errors else "")) }}
                    {% if form.name.errors %}
                        {% for error in form.name.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- ì´ë©”ì¼ -->
                <div>
                    {{ form.email.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.email(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" + (" border-red-500" if form.email.errors else ""), type="email") }}
                    {% if form.email.errors %}
                        {% for error in form.email.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- ì „í™”ë²ˆí˜¸ -->
                <div>
                    {{ form.phone.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.phone(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder="010-1234-5678") }}
                    {% if form.phone.errors %}
                        {% for error in form.phone.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- ê±°ì£¼ êµ­ê°€/ë„ì‹œ (í•™ë¶€ëª¨, í•™ìƒ ê³µí†µ) -->
                {% if current_user.role in ['student', 'parent'] %}
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">ğŸŒ ê±°ì£¼ ì •ë³´ <span class="text-sm font-normal text-gray-500">(ì„ íƒì‚¬í•­)</span></h3>

                    <!-- êµ­ê°€ íƒ­ -->
                    <div class="mb-3">
                        <p class="text-xs text-gray-500 mb-2">êµ­ê°€ ì„ íƒ</p>
                        <div class="flex flex-wrap gap-2" id="countryTabs">
                            {% set countries = ['ëŒ€í•œë¯¼êµ­','ë¯¸êµ­','ìºë‚˜ë‹¤','í˜¸ì£¼','ì˜êµ­','ë…ì¼','í”„ë‘ìŠ¤','ì¼ë³¸','ì¤‘êµ­','ì‹±ê°€í¬ë¥´','í™ì½©','ë‰´ì§ˆëœë“œ','ë„¤ëœë€ë“œ','ìŠ¤ìœ„ìŠ¤','ìŠ¤ì›¨ë´','ì•„ëì—ë¯¸ë¦¬íŠ¸','íƒœêµ­','ë² íŠ¸ë‚¨','ì¸ë„ë„¤ì‹œì•„','í•„ë¦¬í•€','ë§ë ˆì´ì‹œì•„','ë¸Œë¼ì§ˆ','ì§ì ‘ì…ë ¥'] %}
                            {% for c in countries %}
                            <button type="button" onclick="selectCountry('{{ c }}')"
                                    class="country-tab px-3 py-1.5 rounded-full text-sm border transition duration-150
                                           {% if (form.country.data == c) or (not form.country.data and c == 'ëŒ€í•œë¯¼êµ­') %}bg-blue-600 text-white border-blue-600{% else %}bg-white text-gray-600 border-gray-300 hover:border-blue-400{% endif %}">
                                {{ c }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- ë„ì‹œ íƒ­ -->
                    <div id="citySection" class="mb-3">
                        <p class="text-xs text-gray-500 mb-2">ë„ì‹œ ì„ íƒ <span class="text-gray-400">(í•´ë‹¹ ì—†ìœ¼ë©´ êµ­ê°€ë§Œ ì„ íƒ)</span></p>
                        <div class="flex flex-wrap gap-2" id="cityTabs"></div>
                    </div>

                    <!-- ì§ì ‘ ì…ë ¥ -->
                    <div id="customCountrySection" class="mb-3 hidden">
                        <input type="text" id="customCountryInput"
                               placeholder="êµ­ê°€ëª… ì§ì ‘ ì…ë ¥ (ì˜ˆ: ìš°ì¦ˆë² í‚¤ìŠ¤íƒ„)"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- ì„ íƒ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="locationPreview" class="text-sm text-blue-700 font-medium mt-2"></div>

                    <!-- ì‹¤ì œ ì €ì¥ hidden inputs -->
                    {{ form.country(id="countryInput", class="hidden") }}
                    {{ form.city(id="cityInput", class="hidden") }}
                </div>
                {% endif %}

                {% if current_user.role == 'student' %}
                <!-- í•™ìƒ ì „ìš© í•„ë“œ -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">ğŸ“š í•™ìƒ ì •ë³´</h3>

                    <!-- í•™ë…„ -->
                    <div class="mb-4">
                        {{ form.grade.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.grade(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                        {% if form.grade.errors %}
                            {% for error in form.grade.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <!-- í•™êµ -->
                    <div class="mb-4">
                        {{ form.school.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.school(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
                                       list="schoolList",
                                       placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”",
                                       autocomplete="off") }}
                        <datalist id="schoolList">
                            <option value="ì„œìš¸ì´ˆë“±í•™êµ">
                            <option value="ì„œìš¸ì¤‘í•™êµ">
                            <option value="ì„œìš¸ê³ ë“±í•™êµ">
                            <option value="ê°•ë‚¨ì´ˆë“±í•™êµ">
                            <option value="ê°•ë‚¨ì¤‘í•™êµ">
                            <option value="ê°•ë‚¨ê³ ë“±í•™êµ">
                            <option value="ëª©ë™ì´ˆë“±í•™êµ">
                            <option value="ëª©ë™ì¤‘í•™êµ">
                            <option value="ëª©ë™ê³ ë“±í•™êµ">
                            <option value="ë¶„ë‹¹ì´ˆë“±í•™êµ">
                            <option value="ë¶„ë‹¹ì¤‘í•™êµ">
                            <option value="ë¶„ë‹¹ê³ ë“±í•™êµ">
                            <option value="ì¼ì‚°ì´ˆë“±í•™êµ">
                            <option value="ì¼ì‚°ì¤‘í•™êµ">
                            <option value="ì¼ì‚°ê³ ë“±í•™êµ">
                            <option value="ê´‘êµì´ˆë“±í•™êµ">
                            <option value="ê´‘êµì¤‘í•™êµ">
                            <option value="ê´‘êµê³ ë“±í•™êµ">
                            <option value="í‰ì´Œì´ˆë“±í•™êµ">
                            <option value="í‰ì´Œì¤‘í•™êµ">
                            <option value="í‰ì´Œê³ ë“±í•™êµ">
                        </datalist>
                        <p class="text-xs text-gray-500 mt-1">ëª©ë¡ì— ì—†ìœ¼ë©´ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</p>
                        {% if form.school.errors %}
                            {% for error in form.school.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <!-- ìƒë…„ì›”ì¼ -->
                    <div class="mb-4">
                        {{ form.birth_date.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.birth_date(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                        <p class="text-xs text-gray-500 mt-1">ì˜ˆ: 2010-03-15</p>
                        {% if form.birth_date.errors %}
                            {% for error in form.birth_date.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ (í•™ë¶€ëª¨ ì œì™¸) -->
                {% if current_user.role != 'parent' %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í”„ë¡œí•„ ì´ë¯¸ì§€</label>
                    {% if current_user.profile_image_path %}
                    <div class="mb-4">
                        <img src="{{ url_for('profile.profile_image', user_id=current_user.user_id) }}"
                             alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
                             class="w-32 h-32 rounded-full object-cover border-4 border-gray-200">
                    </div>
                    {% endif %}
                    <input type="file"
                           name="profile_image"
                           accept="image/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="mt-2 text-sm text-gray-500">
                        JPG, PNG, GIF í˜•ì‹ (ìµœëŒ€ 5MB)
                    </p>
                </div>
                {% endif %}

                <!-- ì •ë³´ ë°•ìŠ¤ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <div class="text-blue-600 text-xl mr-3">â„¹ï¸</div>
                        <div class="text-sm text-blue-800">
                            <p class="font-medium mb-1">í”„ë¡œí•„ ìˆ˜ì • ì•ˆë‚´</p>
                            <ul class="list-disc list-inside space-y-1 text-blue-700">
                                <li>ì´ë©”ì¼ ì£¼ì†ŒëŠ” ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ë©ë‹ˆë‹¤</li>
                                <li>ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>
                                <li>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì€ ë³„ë„ ë©”ë‰´ë¥¼ ì´ìš©í•˜ì„¸ìš”</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex gap-3 pt-4">
                    {{ form.submit(class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200") }}
                    <a href="{{ url_for('profile.index') }}"
                       class="flex-1 text-center bg-gray-400 hover:bg-gray-500 text-white font-medium py-3 rounded-lg transition duration-200">
                        ì·¨ì†Œ
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

{% if current_user.role in ['student', 'parent'] %}
<script>
const CITY_DATA = {
    'ëŒ€í•œë¯¼êµ­': ['ì„œìš¸','ë¶€ì‚°','ì¸ì²œ','ëŒ€ì „','ëŒ€êµ¬','ê´‘ì£¼','ìˆ˜ì›','ì„±ë‚¨','ê³ ì–‘','ìš©ì¸','ì°½ì›','ì œì£¼'],
    'ë¯¸êµ­': ['ë‰´ìš•','ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤','ì‹œì¹´ê³ ','ìƒŒí”„ë€ì‹œìŠ¤ì½”','ì›Œì‹±í„´DC','ì‹œì• í‹€','ëŒˆëŸ¬ìŠ¤','ì• í‹€ëœíƒ€','ë³´ìŠ¤í„´','í•˜ì™€ì´'],
    'ìºë‚˜ë‹¤': ['í† ë¡ í† ','ë°´ì¿ ë²„','ìº˜ê±°ë¦¬','ëª¬íŠ¸ë¦¬ì˜¬','ì˜¤íƒ€ì™€'],
    'í˜¸ì£¼': ['ì‹œë“œë‹ˆ','ë©œë²„ë¥¸','ë¸Œë¦¬ì¦ˆë²ˆ','í¼ìŠ¤','ì• ë“¤ë ˆì´ë“œ'],
    'ì˜êµ­': ['ëŸ°ë˜','ë§¨ì²´ìŠ¤í„°','ë²„ë°ì—„','ì—ë“ ë²„ëŸ¬'],
    'ë…ì¼': ['í”„ë‘í¬í‘¸ë¥´íŠ¸','ë² ë¥¼ë¦°','í•¨ë¶€ë¥´í¬','ë®Œí—¨','ë’¤ì…€ë„ë¥´í”„'],
    'í”„ë‘ìŠ¤': ['íŒŒë¦¬','ë¦¬ì˜¹','ë§ˆë¥´ì„¸ìœ '],
    'ì¼ë³¸': ['ë„ì¿„','ì˜¤ì‚¬ì¹´','ë‚˜ê³ ì•¼','í›„ì¿ ì˜¤ì¹´','ì‚¿í¬ë¡œ'],
    'ì¤‘êµ­': ['ë² ì´ì§•','ìƒí•˜ì´','ê´‘ì €ìš°','ì„ ì „','ì¹­ë‹¤ì˜¤'],
    'ì‹±ê°€í¬ë¥´': [], 'í™ì½©': [],
    'ë‰´ì§ˆëœë“œ': ['ì˜¤í´ëœë“œ','ì›°ë§í„´','í¬ë¼ì´ìŠ¤íŠ¸ì²˜ì¹˜'],
    'ë„¤ëœë€ë“œ': ['ì•”ìŠ¤í…Œë¥´ë‹´','ë¡œí…Œë¥´ë‹´'],
    'ìŠ¤ìœ„ìŠ¤': ['ì·¨ë¦¬íˆ','ì œë„¤ë°”','ë² ë¥¸'],
    'ìŠ¤ì›¨ë´': ['ìŠ¤í†¡í™€ë¦„','ì˜ˆí…Œë³´ë¦¬'],
    'ì•„ëì—ë¯¸ë¦¬íŠ¸': ['ë‘ë°”ì´','ì•„ë¶€ë‹¤ë¹„'],
    'íƒœêµ­': ['ë°©ì½•','ì¹˜ì•™ë§ˆì´'],
    'ë² íŠ¸ë‚¨': ['í˜¸ì¹˜ë¯¼','í•˜ë…¸ì´'],
    'ì¸ë„ë„¤ì‹œì•„': ['ìì¹´ë¥´íƒ€','ë°œë¦¬'],
    'í•„ë¦¬í•€': ['ë§ˆë‹ë¼','ì„¸ë¶€'],
    'ë§ë ˆì´ì‹œì•„': ['ì¿ ì•Œë¼ë£¸í‘¸ë¥´','í˜ë‚­'],
    'ë¸Œë¼ì§ˆ': ['ìƒíŒŒìš¸ë£¨','ë¦¬ìš°ë°ìë„¤ì´ë£¨'],
    'ì§ì ‘ì…ë ¥': []
};

function selectCountry(country) {
    document.querySelectorAll('.country-tab').forEach(btn => {
        btn.classList.remove('bg-blue-600','text-white','border-blue-600');
        btn.classList.add('bg-white','text-gray-600','border-gray-300');
    });
    event.target.classList.add('bg-blue-600','text-white','border-blue-600');
    event.target.classList.remove('bg-white','text-gray-600','border-gray-300');

    const customSection = document.getElementById('customCountrySection');
    if (country === 'ì§ì ‘ì…ë ¥') {
        customSection.classList.remove('hidden');
        document.getElementById('citySection').classList.add('hidden');
        document.getElementById('countryInput').value = '';
        document.getElementById('cityInput').value = '';
        updatePreview(); return;
    }
    customSection.classList.add('hidden');

    const cities = CITY_DATA[country] || [];
    const cityTabs = document.getElementById('cityTabs');
    const citySection = document.getElementById('citySection');
    document.getElementById('countryInput').value = country;
    document.getElementById('cityInput').value = '';

    if (cities.length === 0) {
        citySection.classList.add('hidden');
        cityTabs.innerHTML = '';
    } else {
        citySection.classList.remove('hidden');
        cityTabs.innerHTML = cities.map(city =>
            `<button type="button" onclick="selectCity('${city}')"
                     class="city-tab px-3 py-1.5 rounded-full text-sm border bg-white text-gray-600 border-gray-300 hover:border-blue-400 transition duration-150">
                ${city}
             </button>`
        ).join('');
    }
    updatePreview();
}

function selectCity(city) {
    document.querySelectorAll('.city-tab').forEach(btn => {
        btn.classList.remove('bg-blue-600','text-white','border-blue-600');
        btn.classList.add('bg-white','text-gray-600','border-gray-300');
    });
    event.target.classList.add('bg-blue-600','text-white','border-blue-600');
    event.target.classList.remove('bg-white','text-gray-600','border-gray-300');
    document.getElementById('cityInput').value = city;
    updatePreview();
}

function updatePreview() {
    const country = document.getElementById('countryInput').value;
    const city = document.getElementById('cityInput').value;
    const preview = document.getElementById('locationPreview');
    if (!country) {
        const custom = document.getElementById('customCountryInput').value;
        preview.textContent = custom ? 'ğŸ“ ' + custom : '';
    } else if (city) {
        preview.textContent = 'ğŸ“ ' + country + ' Â· ' + city;
    } else {
        preview.textContent = 'ğŸ“ ' + country;
    }
}

document.getElementById('customCountryInput')?.addEventListener('input', function() {
    document.getElementById('countryInput').value = this.value;
    document.getElementById('cityInput').value = '';
    updatePreview();
});

window.addEventListener('DOMContentLoaded', function() {
    let initCountry = document.getElementById('countryInput').value || 'ëŒ€í•œë¯¼êµ­';
    let initCity = document.getElementById('cityInput').value || '';

    if (initCountry === 'ëŒ€í•œë¯¼êµ­' && !initCity) {
        initCity = 'ì„œìš¸';
        document.getElementById('cityInput').value = 'ì„œìš¸';
    }
    if (!document.getElementById('countryInput').value) {
        document.getElementById('countryInput').value = 'ëŒ€í•œë¯¼êµ­';
    }

    document.querySelectorAll('.country-tab').forEach(btn => {
        if (btn.textContent.trim() === initCountry) {
            btn.classList.add('bg-blue-600','text-white','border-blue-600');
            btn.classList.remove('bg-white','text-gray-600','border-gray-300');
        }
    });

    if (initCountry && initCountry !== 'ì§ì ‘ì…ë ¥') {
        const cities = CITY_DATA[initCountry] || [];
        const cityTabs = document.getElementById('cityTabs');
        const citySection = document.getElementById('citySection');
        if (cities.length > 0) {
            citySection.classList.remove('hidden');
            cityTabs.innerHTML = cities.map(city =>
                `<button type="button" onclick="selectCity('${city}')"
                         class="city-tab px-3 py-1.5 rounded-full text-sm border transition duration-150
                                ${city === initCity ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300 hover:border-blue-400'}">
                    ${city}
                 </button>`
            ).join('');
        } else {
            citySection.classList.add('hidden');
        }
    }
    updatePreview();
});
</script>
{% endif %}
{% endblock %}
