{% extends "base.html" %}

{% block title %}{{ post.title }} - í•˜í¬ë‹ˆìŠ¤{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('harkness.board_detail', board_id=board.board_id) }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† {{ board.title }}
        </a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border border-red-300{% elif category == 'success' %}bg-green-100 text-green-700 border border-green-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ê²Œì‹œê¸€ í—¤ë” -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-8 py-6 border-b border-gray-200">
            <div class="flex items-center gap-2 mb-3">
                {% if post.is_notice %}
                <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded">ê³µì§€</span>
                {% endif %}
                <h1 class="text-2xl font-bold text-gray-800">{{ post.title }}</h1>
            </div>
            <div class="flex items-center justify-between text-sm text-gray-600">
                <div class="flex items-center gap-4">
                    <span>ğŸ‘¤ {{ post.author.name }}</span>
                    <span>ğŸ“… {{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    <span>ğŸ‘ï¸ {{ post.view_count }}</span>
                </div>
                {% if post.author_id == current_user.user_id or current_user.is_admin %}
                <div class="flex gap-2">
                    <a href="{{ url_for('harkness.edit_post', board_id=board.board_id, post_id=post.post_id) }}"
                       class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded transition duration-200">
                        ìˆ˜ì •
                    </a>
                    <form method="POST" action="{{ url_for('harkness.delete_post', board_id=board.board_id, post_id=post.post_id) }}"
                          onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                          class="inline">
                        <button type="submit"
                                class="bg-red-600 hover:bg-red-700 text-white text-sm px-4 py-2 rounded transition duration-200">
                            ì‚­ì œ
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        {% if post.content %}
        <!-- ì¶”ê°€ ë‚´ìš© -->
        <div class="px-8 py-4 bg-gray-50 border-b border-gray-200">
            <p class="text-sm text-gray-500 mb-1 font-medium">ğŸ“ ì¶”ê°€ ë‚´ìš©</p>
            <div class="text-gray-700 whitespace-pre-wrap">{{ post.content }}</div>
        </div>
        {% endif %}
    </div>

    <!-- ì§ˆë¬¸ ì„¹ì…˜ë“¤ -->
    {% set questions = [
        {'num': 1, 'text': post.question1, 'intent': post.question1_intent,
         'color': 'blue', 'comments': q1_comments, 'likes': q1_likes, 'liked': q1_liked},
        {'num': 2, 'text': post.question2, 'intent': post.question2_intent,
         'color': 'green', 'comments': q2_comments, 'likes': q2_likes, 'liked': q2_liked},
        {'num': 3, 'text': post.question3, 'intent': post.question3_intent,
         'color': 'orange', 'comments': q3_comments, 'likes': q3_likes, 'liked': q3_liked}
    ] %}

    {% for q in questions %}
    {% if q.text %}
    <div class="bg-white rounded-lg shadow mb-6 border-l-4
        {% if q.color == 'blue' %}border-blue-500
        {% elif q.color == 'green' %}border-green-500
        {% else %}border-orange-500{% endif %}">

        <!-- ì§ˆë¬¸ í—¤ë” -->
        <div class="px-8 py-5 border-b border-gray-100">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-white text-sm font-bold px-3 py-1 rounded-full
                            {% if q.color == 'blue' %}bg-blue-500
                            {% elif q.color == 'green' %}bg-green-500
                            {% else %}bg-orange-500{% endif %}">
                            ì§ˆë¬¸ {{ q.num }}
                        </span>
                    </div>
                    <p class="text-gray-800 text-lg font-medium whitespace-pre-wrap">{{ q.text }}</p>
                </div>
                <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                <button onclick="toggleQuestionLike({{ q.num }})"
                        id="qLikeBtn{{ q.num }}"
                        class="flex-shrink-0 ml-4 flex items-center gap-1 px-4 py-2 rounded-lg transition duration-200
                            {% if q.liked %}bg-pink-100 text-pink-600{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
                    <span class="text-lg">â¤ï¸</span>
                    <span id="qLikeCount{{ q.num }}">{{ q.likes }}</span>
                </button>
            </div>

            {% if q.intent %}
            <!-- ì˜ˆìƒ ë‹µë³€ ë° ì˜ë„ -->
            <div class="mt-4 p-4 rounded-lg text-sm
                {% if q.color == 'blue' %}bg-blue-50 text-blue-800
                {% elif q.color == 'green' %}bg-green-50 text-green-800
                {% else %}bg-orange-50 text-orange-800{% endif %}">
                <p class="font-semibold mb-1">ğŸ’¡ ì˜ˆìƒ ë‹µë³€ ë° ì§ˆë¬¸ì˜ ì˜ë„</p>
                <p class="whitespace-pre-wrap">{{ q.intent }}</p>
            </div>
            {% endif %}
        </div>

        <!-- ëŒ“ê¸€ ì˜ì—­ -->
        <div class="px-8 py-5">
            <h4 class="text-sm font-semibold text-gray-600 mb-4">
                ğŸ’¬ ì´ ì§ˆë¬¸ì— ëŒ€í•œ ëŒ“ê¸€ ({{ q.comments | length }})
            </h4>

            <!-- ëŒ“ê¸€ ì‘ì„± -->
            <form class="q-comment-form mb-5" data-question="{{ q.num }}">
                <div class="flex gap-3">
                    <textarea rows="2"
                              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2
                                {% if q.color == 'blue' %}focus:ring-blue-400
                                {% elif q.color == 'green' %}focus:ring-green-400
                                {% else %}focus:ring-orange-400{% endif %}
                                text-sm"
                              placeholder="ì§ˆë¬¸ {{ q.num }}ì— ëŒ€í•œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."
                              required></textarea>
                    <button type="submit"
                            class="px-4 py-2 text-white text-sm font-medium rounded-lg transition duration-200 self-end
                                {% if q.color == 'blue' %}bg-blue-600 hover:bg-blue-700
                                {% elif q.color == 'green' %}bg-green-600 hover:bg-green-700
                                {% else %}bg-orange-500 hover:bg-orange-600{% endif %}">
                        ë“±ë¡
                    </button>
                </div>
            </form>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div id="qComments{{ q.num }}" class="space-y-3">
                {% if q.comments %}
                    {% for comment in q.comments %}
                    <div class="flex gap-3" id="comment-{{ comment.comment_id }}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0
                            {% if q.color == 'blue' %}bg-blue-500
                            {% elif q.color == 'green' %}bg-green-500
                            {% else %}bg-orange-500{% endif %}">
                            {{ comment.author.name[0] if comment.author else '?' }}
                        </div>
                        <div class="flex-1 bg-gray-50 rounded-lg px-4 py-3">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-semibold text-gray-800">{{ comment.author.name if comment.author else '(ì‚­ì œë¨)' }}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-gray-500">{{ comment.created_at.strftime('%m/%d %H:%M') }}</span>
                                    {% if comment.author_id == current_user.user_id or current_user.is_admin %}
                                    <button onclick="deleteComment('{{ comment.comment_id }}')"
                                            class="text-xs text-red-500 hover:text-red-700">ì‚­ì œ</button>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ comment.content }}</p>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-sm text-gray-400 text-center py-4">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì˜ê²¬ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}

    <!-- ì „ì²´ ëŒ“ê¸€ ì˜ì—­ -->
    <div class="bg-white rounded-lg shadow p-8">
        <h3 class="text-xl font-bold text-gray-800 mb-6">
            ğŸ’¬ ì „ì²´ ëŒ“ê¸€ ({{ comments|length }})
            <span class="text-sm font-normal text-gray-500 ml-1">â€” ê²Œì‹œê¸€ ì „ì²´ì— ëŒ€í•œ ëŒ“ê¸€</span>
        </h3>

        <!-- ëŒ“ê¸€ ì‘ì„± -->
        <form id="commentForm" class="mb-8">
            <textarea id="commentContent"
                      rows="4"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"
                      placeholder="ì „ì²´ ê²Œì‹œê¸€ì— ëŒ€í•œ ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                      required></textarea>
            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition duration-200">
                ëŒ“ê¸€ ì‘ì„±
            </button>
        </form>

        <!-- ëŒ“ê¸€ ëª©ë¡ -->
        <div id="commentList" class="space-y-4">
            {% if comments %}
                {% for comment in comments %}
                <div class="space-y-2" id="comment-{{ comment.comment_id }}">
                    <div class="border-l-4 border-blue-500 pl-4 py-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="font-semibold text-gray-800">{{ comment.author.name }}</span>
                                <span class="text-xs text-gray-500">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleReplyForm('{{ comment.comment_id }}')"
                                        class="text-blue-600 hover:text-blue-800 text-sm">
                                    ë‹µê¸€
                                </button>
                                {% if comment.author_id == current_user.user_id or current_user.is_admin %}
                                <button onclick="deleteComment('{{ comment.comment_id }}')"
                                        class="text-red-600 hover:text-red-800 text-sm">
                                    ì‚­ì œ
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap">{{ comment.content }}</p>

                        <!-- ë‹µê¸€ ì‘ì„± í¼ -->
                        <div id="replyForm-{{ comment.comment_id }}" class="hidden mt-3">
                            <textarea id="replyContent-{{ comment.comment_id }}"
                                      rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                      placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <div class="flex gap-2 mt-2">
                                <button onclick="submitReply('{{ comment.comment_id }}')"
                                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-1 rounded transition duration-200">
                                    ë‹µê¸€ ì‘ì„±
                                </button>
                                <button onclick="toggleReplyForm('{{ comment.comment_id }}')"
                                        class="bg-gray-300 hover:bg-gray-400 text-gray-700 text-sm px-4 py-1 rounded transition duration-200">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </div>

                    {% if comment.replies.count() > 0 %}
                    <div class="ml-8 space-y-2" id="replies-{{ comment.comment_id }}">
                        {% for reply in comment.replies.all() %}
                        <div class="border-l-4 border-gray-300 pl-4 py-2" id="comment-{{ reply.comment_id }}">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-gray-600">â†³</span>
                                    <span class="font-semibold text-gray-800">{{ reply.author.name }}</span>
                                    <span class="text-xs text-gray-500">{{ reply.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                {% if reply.author_id == current_user.user_id or current_user.is_admin %}
                                <button onclick="deleteComment('{{ reply.comment_id }}')"
                                        class="text-red-600 hover:text-red-800 text-sm">
                                    ì‚­ì œ
                                </button>
                                {% endif %}
                            </div>
                            <p class="text-gray-700 whitespace-pre-wrap text-sm">{{ reply.content }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="text-center text-gray-500 py-8">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
const postId = '{{ post.post_id }}';
const boardId = '{{ board.board_id }}';

// ì§ˆë¬¸ë³„ ì¢‹ì•„ìš” í† ê¸€
function toggleQuestionLike(qNum) {
    fetch(`/harkness/posts/${postId}/questions/${qNum}/like`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById(`qLikeBtn${qNum}`);
            const count = document.getElementById(`qLikeCount${qNum}`);
            count.textContent = data.like_count;
            if (data.liked) {
                btn.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                btn.classList.add('bg-pink-100', 'text-pink-600');
            } else {
                btn.classList.remove('bg-pink-100', 'text-pink-600');
                btn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
            }
        }
    });
}

// ì§ˆë¬¸ë³„ ëŒ“ê¸€ ì‘ì„±
document.querySelectorAll('.q-comment-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const qNum = this.dataset.question;
        const textarea = this.querySelector('textarea');
        const content = textarea.value.trim();
        if (!content) return;

        const formData = new FormData();
        formData.append('content', content);
        formData.append('question_number', qNum);

        fetch(`/harkness/boards/${boardId}/posts/${postId}/comments`, {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                textarea.value = '';
                const container = document.getElementById(`qComments${qNum}`);
                // ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
                const emptyMsg = container.querySelector('p.text-center');
                if (emptyMsg) emptyMsg.remove();

                const colors = {1: 'blue', 2: 'green', 3: 'orange'};
                const color = colors[qNum];
                const bgColors = {blue: 'bg-blue-500', green: 'bg-green-500', orange: 'bg-orange-500'};
                const initials = data.comment.author_name.charAt(0);

                const html = `
                    <div class="flex gap-3" id="comment-${data.comment.comment_id}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0 ${bgColors[color]}">
                            ${initials}
                        </div>
                        <div class="flex-1 bg-gray-50 rounded-lg px-4 py-3">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-semibold text-gray-800">${data.comment.author_name}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-gray-500">${data.comment.created_at}</span>
                                    <button onclick="deleteComment('${data.comment.comment_id}')" class="text-xs text-red-500 hover:text-red-700">ì‚­ì œ</button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">${data.comment.content}</p>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            } else {
                alert(data.message);
            }
        });
    });
});

// ì „ì²´ ëŒ“ê¸€ ì‘ì„±
document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('commentContent').value.trim();
    if (!content) return;

    const formData = new FormData();
    formData.append('content', content);

    fetch(`/harkness/boards/${boardId}/posts/${postId}/comments`, {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('commentContent').value = '';
            location.reload();
        } else {
            alert(data.message);
        }
    });
});

// ë‹µê¸€ í¼ í† ê¸€
function toggleReplyForm(commentId) {
    const replyForm = document.getElementById(`replyForm-${commentId}`);
    if (replyForm.classList.contains('hidden')) {
        replyForm.classList.remove('hidden');
        document.getElementById(`replyContent-${commentId}`).focus();
    } else {
        replyForm.classList.add('hidden');
        document.getElementById(`replyContent-${commentId}`).value = '';
    }
}

// ë‹µê¸€ ì‘ì„±
function submitReply(parentCommentId) {
    const content = document.getElementById(`replyContent-${parentCommentId}`).value.trim();
    if (!content) { alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    const formData = new FormData();
    formData.append('content', content);
    formData.append('parent_comment_id', parentCommentId);

    fetch(`/harkness/boards/${boardId}/posts/${postId}/comments`, {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { location.reload(); }
        else { alert(data.message); }
    });
}

// ëŒ“ê¸€ ì‚­ì œ
function deleteComment(commentId) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch(`/harkness/comments/${commentId}/delete`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { location.reload(); }
        else { alert(data.message); }
    });
}
</script>
{% endblock %}
