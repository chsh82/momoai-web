<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MOMOAI v4.0{% endblock %}</title>

    <!-- Google Fonts: Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Alpine.js with Collapse plugin -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- ëª¨ëª¨ì˜ ì±…ì¥ ë””ìì¸ ì‹œìŠ¤í…œ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sidebar-link {
            transition: all 0.2s;
        }
        .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: #60A5FA;
        }
        .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left-color: #60A5FA;
            font-weight: 700;
            color: #1A2744;
            text-shadow: none;
        }
        .sidebar-link-sub {
            transition: all 0.2s;
            color: rgba(255, 255, 255, 0.8);
        }
        .sidebar-link-sub:hover {
            transform: translateX(4px);
            color: white;
            background-color: rgba(255, 255, 255, 0.08);
        }
        /* ì„œë¸Œë©”ë‰´ ì•¡í‹°ë¸Œ ìƒíƒœ - ëª¨ë“  ì—­í•  í†µì¼ (ìµœìš°ì„ ) */
        a.sidebar-link-sub.text-blue-600,
        a.sidebar-link-sub.text-green-600,
        a.sidebar-link-sub.text-purple-600,
        a.sidebar-link-sub.text-pink-600,
        a.sidebar-link-sub.text-yellow-600,
        a.sidebar-link-sub.bg-blue-50,
        a.sidebar-link-sub.bg-green-50,
        a.sidebar-link-sub.bg-purple-50,
        a.sidebar-link-sub.bg-pink-50,
        a.sidebar-link-sub.bg-yellow-50 {
            background-color: rgba(255, 255, 255, 0.15) !important;
            color: white !important;
            font-weight: 600 !important;
        }

        /* Tailwind bg-*-50 í´ë˜ìŠ¤ ì™„ì „ ë¬´ë ¥í™” */
        a.sidebar-link-sub[class*="bg-"][class*="-50"] {
            background-color: rgba(255, 255, 255, 0.15) !important;
        }

        /* Tailwind text-*-600 í´ë˜ìŠ¤ ì™„ì „ ë¬´ë ¥í™” */
        a.sidebar-link-sub[class*="text-"][class*="-600"] {
            color: white !important;
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50">
    {% if current_user.is_authenticated %}
    <!-- Authenticated Layout with Sidebar -->
    <div class="flex h-screen">
        <!-- Sidebar with Navy Gradient -->
        <aside class="w-64 sidebar-navy shadow-xl flex flex-col text-white">
            <div class="p-6 border-b border-white border-opacity-20">
                <h1 class="text-2xl font-bold text-white">ğŸ“š ëª¨ëª¨ì˜ ì±…ì¥</h1>
                <p class="text-xs text-white text-opacity-70 mt-1">v4.0 AI ë…¼ìˆ  ì²¨ì‚­</p>
            </div>

            <!-- ê³ ì • ë©”ì¸ ë©”ë‰´ -->
            <nav class="p-4 border-b border-white border-opacity-20">
                <div class="space-y-1">
                    <a href="{{ url_for('notifications.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'notifications' in request.endpoint %}bg-white bg-opacity-15 text-white border-blue-400{% endif %}">
                        <span class="text-xl relative inline-block">
                            ğŸ””
                            <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center"></span>
                        </span>
                        <span>ì•Œë¦¼</span>
                    </a>

                    {% if current_user.role == 'admin' %}
                    <!-- ê´€ë¦¬ì ì „ìš© ê³µí†µ ë©”ë‰´: ì œê±°ë¨ (ì—­í• ë³„ í¬í„¸ ì‚¬ìš©) -->
                    {% endif %}

                    {% if current_user.role in ['admin', 'teacher'] %}
                    <!-- ê´€ë¦¬ì/ê°•ì‚¬ ê³µí†µ ë©”ë‰´ -->
                    <a href="{{ url_for('library.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'library' in request.endpoint %}active{% endif %}">
                        <span class="text-xl">ğŸ“–</span>
                        <span>í•™ìŠµ ìë£Œì‹¤</span>
                    </a>

                    <a href="{{ url_for('community.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'community' in request.endpoint %}active{% endif %}">
                        <span class="text-xl">ğŸ’¬</span>
                        <span>ì»¤ë®¤ë‹ˆí‹°</span>
                    </a>
                    {% endif %}
                </div>
            </nav>

            <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í¬í„¸ ë©”ë‰´ -->
            <div class="flex-1 overflow-y-auto p-4" id="scrollable-menu">
                {% if current_user.has_permission_level(2) %}
                <div class="mt-6 pt-6 border-t border-white border-opacity-20" x-data="{
                    academic: true,
                    members: true,
                    learning: true,
                    zoom: true,
                    communication: true,
                    finance: true,
                    content: true
                }">
                    <div class="text-xs font-medium text-white text-opacity-60 px-4 mb-2 text-uppercase tracking-wide">ê´€ë¦¬ì</div>

                    <!-- ëŒ€ì‹œë³´ë“œ -->
                    <a href="{{ url_for('admin.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint == 'admin.index' %}active{% endif %}">
                        <span class="text-xl">ğŸ“Š</span>
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                    </a>

                    <!-- 1. í•™ì‚¬ ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="academic = !academic"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“š</span>
                                <span class="font-medium">í•™ì‚¬ ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': academic }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="academic" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('admin.courses') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'admin.courses' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ìˆ˜ì—… ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.all_schedule') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint == 'admin.all_schedule' %}text-blue-600 bg-blue-50{% endif %}">
                                ì „ì²´ ìˆ˜ì—…í˜„í™©
                            </a>
                            <a href="{{ url_for('teacher.attendance_list') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint == 'teacher.attendance_list' %}text-blue-600 bg-blue-50{% endif %}">
                                ì¶œì„ ì²´í¬
                            </a>
                            <a href="{{ url_for('admin.attendance_status') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint == 'admin.attendance_status' %}text-blue-600 bg-blue-50{% endif %}">
                                ì „ì²´ ì¶œì„í˜„í™©
                            </a>
                            <a href="{{ url_for('admin.makeup_requests') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'admin.makeup' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ë³´ê°•ìˆ˜ì—… ê´€ë¦¬
                            </a>
                        </div>
                    </div>

                    <!-- 2. íšŒì› ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="members = !members"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ‘¥</span>
                                <span class="font-medium">íšŒì› ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': members }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="members" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('students.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'students' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                í•™ìƒ ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.staff_list') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'admin.staff' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ê°•ì‚¬ ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.parent_link_requests') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'admin.parent_link' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                í•™ë¶€ëª¨ ì—°ê²° ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.consultations') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'admin.consultation' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ìƒë‹´ ë‚´ìš© ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.student_profiles') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'admin.student_profile' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ğŸ“‹ í•™ìƒ í”„ë¡œí•„
                            </a>
                            <a href="{{ url_for('admin.student_risk_analysis') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'admin.student_risk_analysis' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ğŸ¤– í•™ìƒ ìœ„í—˜ë„ ë¶„ì„
                            </a>
                        </div>
                    </div>

                    <!-- 3. í•™ìŠµ ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="learning = !learning"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">âœï¸</span>
                                <span class="font-medium">í•™ìŠµ ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': learning }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="learning" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('essays.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'essays' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ê³¼ì œ/ì²¨ì‚­ ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.teaching_materials') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'admin.teaching_material' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                í•™ìŠµ êµì¬
                            </a>
                            <a href="{{ url_for('admin.videos') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'admin.video' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                í•™ìŠµ ë™ì˜ìƒ
                            </a>
                            <a href="{{ url_for('teacher.reading_mbti') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'reading_mbti' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ë…ì„œ ë…¼ìˆ  MBTI
                            </a>
                        </div>
                    </div>

                    <!-- 4. ì˜¨ë¼ì¸ ê°•ì˜ì‹¤ -->
                    <div class="mt-2">
                        <button @click="zoom = !zoom"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ¥</span>
                                <span class="font-medium">ì˜¨ë¼ì¸ ê°•ì˜ì‹¤</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': zoom }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="zoom" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('admin.zoom_links') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-indigo-600 hover:bg-indigo-50 rounded transition {% if request.endpoint == 'admin.zoom_links' or request.endpoint == 'admin.edit_zoom_link' %}text-indigo-600 bg-indigo-50{% endif %}">
                                ì¤Œ ë§í¬ ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.zoom_access_logs') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-indigo-600 hover:bg-indigo-50 rounded transition {% if request.endpoint == 'admin.zoom_access_logs' %}text-indigo-600 bg-indigo-50{% endif %}">
                                ì ‘ì† ë¡œê·¸
                            </a>
                        </div>
                    </div>

                    <!-- 5. ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ -->
                    <div class="mt-2">
                        <button @click="communication = !communication"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ’¬</span>
                                <span class="font-medium">ì»¤ë®¤ë‹ˆì¼€ì´ì…˜</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': communication }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="communication" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('admin.announcements') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'admin.announcement' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                ê³µì§€ì‚¬í•­ ê´€ë¦¬
                            </a>
                            <a href="{{ url_for('admin.messages') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'admin.message' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                ë¬¸ì ë°œì†¡
                            </a>
                            <a href="{{ url_for('notifications.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'notifications' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                ì•Œë¦¼ í˜„í™©
                            </a>
                        </div>
                    </div>

                    <!-- 6. ì¬ë¬´ ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="finance = !finance"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ’°</span>
                                <span class="font-medium">ì¬ë¬´ ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': finance }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="finance" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('admin.payments') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-orange-600 hover:bg-orange-50 rounded transition {% if request.endpoint and 'admin.payment' in request.endpoint %}text-orange-600 bg-orange-50{% endif %}">
                                ìˆ˜ë‚© ê´€ë¦¬
                            </a>
                        </div>
                    </div>

                    <!-- 7. ì½˜í…ì¸  ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="content = !content"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“–</span>
                                <span class="font-medium">ì½˜í…ì¸  ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': content }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="content" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('books.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-pink-600 hover:bg-pink-50 rounded transition {% if request.endpoint and 'books' in request.endpoint %}text-pink-600 bg-pink-50{% endif %}">
                                ë„ì„œ ì •ë³´
                            </a>
                            <a href="{{ url_for('library.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-pink-600 hover:bg-pink-50 rounded transition {% if request.endpoint and 'library.index' in request.endpoint %}text-pink-600 bg-pink-50{% endif %}">
                                í•™ìŠµ ìë£Œì‹¤
                            </a>
                            <a href="{{ url_for('library.create_hall_of_fame') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-pink-600 hover:bg-pink-50 rounded transition {% if request.endpoint and 'library.hall_of_fame' in request.endpoint %}text-pink-600 bg-pink-50{% endif %}">
                                ëª…ì˜ˆì˜ ì „ë‹¹
                            </a>
                            <a href="{{ url_for('library.create_admission_info') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-pink-600 hover:bg-pink-50 rounded transition {% if request.endpoint and 'library.admission_info' in request.endpoint %}text-pink-600 bg-pink-50{% endif %}">
                                ì…ì‹œì •ë³´
                            </a>
                        </div>
                    </div>

                    <!-- 8. ì»¤ë®¤ë‹ˆí‹° -->
                    <a href="{{ url_for('community.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'community' in request.endpoint %}active{% endif %} mt-2">
                        <span class="text-xl">ğŸ’­</span>
                        <span>ì»¤ë®¤ë‹ˆí‹°</span>
                    </a>
                </div>
                {% endif %}

                {% if current_user.role in ['teacher', 'admin'] %}
                <div class="mt-6 pt-6 border-t border-white border-opacity-20" x-data="{
                    courses: true,
                    students: true,
                    assignments: true,
                    evaluation: true,
                    communication: true
                }">
                    <div class="text-xs font-medium text-white text-opacity-60 px-4 mb-2 text-uppercase tracking-wide">ê°•ì‚¬</div>

                    {% if current_user.role == 'admin' %}
                    <!-- ëŒ€ì‹œë³´ë“œ (ê´€ë¦¬ì ì „ìš©) -->
                    <a href="{{ url_for('teacher.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint == 'teacher.index' %}active{% endif %}">
                        <span class="text-xl">ğŸ </span>
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                    </a>
                    {% endif %}

                    <!-- 1. ë‚´ ìˆ˜ì—… -->
                    <div class="mt-2">
                        <button @click="courses = !courses"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“š</span>
                                <span class="font-medium">ë‚´ ìˆ˜ì—…</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': courses }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="courses" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('teacher.courses') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint == 'teacher.courses' %}text-blue-600 bg-blue-50{% endif %}">
                                ìˆ˜ì—… ëª©ë¡
                            </a>
                            <a href="{{ url_for('teacher.schedule') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint == 'teacher.schedule' %}text-blue-600 bg-blue-50{% endif %}">
                                ì£¼ê°„ ì‹œê°„í‘œ
                            </a>
                            <a href="{{ url_for('teacher.attendance_list') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint == 'teacher.attendance_list' %}text-blue-600 bg-blue-50{% endif %}">
                                ì¶œì„ ì²´í¬
                            </a>
                            <a href="{{ url_for('teacher.class_messages') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint == 'teacher.class_messages' %}text-blue-600 bg-blue-50{% endif %}">
                                ìˆ˜ì—… ê³µì§€/ê³¼ì œ
                            </a>
                        </div>
                    </div>

                    <!-- 2. í•™ìƒ ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="students = !students"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ‘¥</span>
                                <span class="font-medium">í•™ìƒ ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': students }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="students" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('teacher.students') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint == 'teacher.students' %}text-green-600 bg-green-50{% endif %}">
                                ë‚´ í•™ìƒ ëª©ë¡
                            </a>
                            <a href="{{ url_for('teacher.create_feedback') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'teacher.feedback' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                í”¼ë“œë°± ì‘ì„±
                            </a>
                            <a href="{{ url_for('teacher.consultations') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'consultation' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ìƒë‹´ ì‘ì„±
                            </a>
                        </div>
                    </div>

                    <!-- 3. ê³¼ì œ ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="assignments = !assignments"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">âœï¸</span>
                                <span class="font-medium">ê³¼ì œ ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': assignments }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="assignments" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('teacher.assignments') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'teacher.assignment' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ê³¼ì œ ì¶œì œ/ì²¨ì‚­
                            </a>
                            <a href="{{ url_for('essays.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'essays.index' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                {% if current_user.role == 'parent' %}ì²¨ì‚­ ë³´ê¸°{% else %}ì²¨ì‚­ ê´€ë¦¬{% endif %}
                            </a>
                            <a href="{{ url_for('essays.ocr_index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'essays.ocr' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                OCR ì¸ì‹
                            </a>
                            <a href="{{ url_for('essays.direct_correction') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'essays.direct_correction' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ëª¨ëª¨ì•„ì´ ì²¨ì‚­
                            </a>
                        </div>
                    </div>

                    <!-- 4. í‰ê°€ ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="evaluation = !evaluation"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“Š</span>
                                <span class="font-medium">í‰ê°€ ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': evaluation }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="evaluation" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('teacher.reading_mbti') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'reading_mbti' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ğŸ§  ë…ì„œ ë…¼ìˆ  MBTI
                            </a>
                            <a href="{{ url_for('teacher.ace_weekly') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'ace_weekly' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ğŸ“ ì£¼ê°„ í‰ê°€
                            </a>
                            <a href="{{ url_for('teacher.ace_evaluation') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'ace_evaluation' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                â­ ACE í‰ê°€
                            </a>
                        </div>
                    </div>

                    <!-- 5. í•™ìŠµ ìë£Œ -->
                    <a href="{{ url_for('teacher.materials') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'teacher.material' in request.endpoint %}active{% endif %} mt-2">
                        <span class="text-xl">ğŸ“</span>
                        <span>í•™ìŠµ ìë£Œ</span>
                    </a>

                    <!-- 6. ê²Œì‹œíŒ -->
                    <div class="mt-2">
                        <button @click="communication = !communication"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ’¬</span>
                                <span class="font-medium">ê²Œì‹œíŒ</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': communication }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="communication" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('teacher.announcements') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'teacher.announcement' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                ê³µì§€ì‚¬í•­
                            </a>
                            <a href="{{ url_for('teacher.class_board') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint == 'teacher.class_board' %}text-yellow-600 bg-yellow-50{% endif %}">
                                í´ë˜ìŠ¤ ê²Œì‹œíŒ
                            </a>
                            <a href="{{ url_for('teacher.board') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint == 'teacher.board' %}text-yellow-600 bg-yellow-50{% endif %}">
                                ê°•ì‚¬ ê²Œì‹œíŒ
                            </a>
                            <a href="{{ url_for('harkness.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'harkness' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                í•˜í¬ë‹ˆìŠ¤ ê²Œì‹œíŒ
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if current_user.role in ['parent', 'admin'] %}
                <div class="mt-6 pt-6 border-t border-white border-opacity-20" x-data="{
                    children: true,
                    learning: true,
                    evaluation: true,
                    makeup: true,
                    payment: true,
                    communication: true
                }">
                    <div class="text-xs font-medium text-white text-opacity-60 px-4 mb-2 text-uppercase tracking-wide">í•™ë¶€ëª¨</div>

                    {% if current_user.role == 'admin' %}
                    <!-- 1. ëŒ€ì‹œë³´ë“œ (ê´€ë¦¬ì ì „ìš©) -->
                    <a href="{{ url_for('parent.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'parent.index' in request.endpoint %}active{% endif %}">
                        <span class="text-xl">ğŸ </span>
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                    </a>
                    {% endif %}

                    <!-- 1-1. ì‹ ê·œ ë“±ë¡ ì„¤ë¬¸ -->
                    <a href="{{ url_for('parent.registration_survey') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white bg-gradient-to-r from-green-500 to-green-600 rounded-lg border-l-4 border-green-700 shadow-sm hover:shadow-md transition {% if request.endpoint and 'parent.registration' in request.endpoint %}ring-2 ring-green-300{% endif %} {% if current_user.role == 'admin' %}mt-2{% endif %}">
                        <span class="text-xl">ğŸ†•</span>
                        <span class="font-semibold">ì‹ ê·œ ë“±ë¡ ì„¤ë¬¸</span>
                    </a>

                    <!-- 2. ìë…€ ê´€ë¦¬ -->
                    <div class="mt-2">
                        <button @click="children = !children"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
                                <span class="font-medium">ìë…€ ê´€ë¦¬</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': children }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="children" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('parent.children') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'parent.children' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ë‚´ ìë…€
                            </a>
                            <a href="{{ url_for('parent.link_requests') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'parent.link' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ìë…€ ì—°ê²°
                            </a>
                        </div>
                    </div>

                    <!-- 3. í•™ìŠµ í˜„í™© -->
                    <div class="mt-2">
                        <button @click="learning = !learning"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“š</span>
                                <span class="font-medium">í•™ìŠµ í˜„í™©</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': learning }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="learning" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('parent.attendance_index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'parent.attendance' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ì¶œê²° í˜„í™©
                            </a>
                            <a href="{{ url_for('parent.essays_index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'parent.essays' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ê³¼ì œ ë° ì²¨ì‚­
                            </a>
                            <a href="{{ url_for('parent.materials_list') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'parent.material' in request.endpoint or request.endpoint and 'parent.child_material' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                í•™ìŠµ êµì¬
                            </a>
                            <a href="{{ url_for('parent.videos_list') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'parent.video' in request.endpoint or request.endpoint and 'parent.child_video' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                í•™ìŠµ ë™ì˜ìƒ
                            </a>
                            <a href="{{ url_for('parent.consultations_index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint and 'parent.consultation' in request.endpoint %}text-green-600 bg-green-50{% endif %}">
                                ìƒë‹´ ê¸°ë¡
                            </a>
                        </div>
                    </div>

                    <!-- 4. í‰ê°€ ì •ë³´ -->
                    <div class="mt-2">
                        <button @click="evaluation = !evaluation"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“Š</span>
                                <span class="font-medium">í‰ê°€ ì •ë³´</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': evaluation }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="evaluation" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('parent.reading_mbti') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'reading_mbti' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ğŸ§  ë…ì„œ ë…¼ìˆ  MBTI
                            </a>
                            <a href="{{ url_for('parent.weekly_evaluation') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'parent.weekly_evaluation' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ğŸ“ ì£¼ê°„ í‰ê°€
                            </a>
                            <a href="{{ url_for('parent.ace_evaluation') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'parent.ace_evaluation' in request.endpoint or request.endpoint and 'parent.child_ace_evaluation' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                â­ ACE ë¶„ê¸° í‰ê°€
                            </a>
                        </div>
                    </div>

                    <!-- 5. ë³´ê°•ìˆ˜ì—… -->
                    <a href="{{ url_for('parent.makeup_classes_index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'parent.makeup' in request.endpoint %}active{% endif %} mt-2">
                        <span class="text-xl">ğŸ”„</span>
                        <span>ë³´ê°•ìˆ˜ì—…</span>
                    </a>

                    <!-- 6. ìˆ˜ë‚© ê´€ë¦¬ -->
                    <a href="{{ url_for('parent.all_payments') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'parent.all_payments' in request.endpoint %}active{% endif %} mt-2">
                        <span class="text-xl">ğŸ’°</span>
                        <span>ìˆ˜ë‚© ê´€ë¦¬</span>
                    </a>

                    <!-- 7. ê²Œì‹œíŒ -->
                    <div class="mt-2">
                        <button @click="communication = !communication"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ’¬</span>
                                <span class="font-medium">ê²Œì‹œíŒ</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': communication }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="communication" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('parent.announcements') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'parent.announcement' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                ê³µì§€ì‚¬í•­
                            </a>
                            <a href="{{ url_for('parent.all_feedback') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'parent.all_feedback' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                ì„ ìƒë‹˜ í”¼ë“œë°±
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if current_user.role in ['student', 'admin'] %}
                <div class="mt-6 pt-6 border-t border-white border-opacity-20" x-data="{
                    courses: true,
                    learning: true,
                    tests: true,
                    evaluation: true,
                    makeup: true,
                    communication: true
                }">
                    <div class="text-xs font-medium text-white text-opacity-60 px-4 mb-2 text-uppercase tracking-wide">í•™ìƒ</div>

                    {% if current_user.role == 'admin' %}
                    <!-- 1. ëŒ€ì‹œë³´ë“œ (ê´€ë¦¬ì ì „ìš©) -->
                    <a href="{{ url_for('student.index') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent {% if request.endpoint and 'student.index' in request.endpoint %}active{% endif %}">
                        <span class="text-xl">ğŸ </span>
                        <span>ëŒ€ì‹œë³´ë“œ</span>
                    </a>
                    {% endif %}

                    <!-- 2. ë‚´ ìˆ˜ì—… -->
                    <div class="mt-2">
                        <button @click="courses = !courses"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“š</span>
                                <span class="font-medium">ë‚´ ìˆ˜ì—…</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': courses }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="courses" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('student.courses') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'student.courses' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ìˆ˜ì—… ëª©ë¡
                            </a>
                            <a href="{{ url_for('student.attendance') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'student.attendance' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                ì¶œê²° í˜„í™©
                            </a>
                            <a href="{{ url_for('student.class_board') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-blue-600 hover:bg-blue-50 rounded transition {% if request.endpoint and 'student.class_board' in request.endpoint %}text-blue-600 bg-blue-50{% endif %}">
                                í´ë˜ìŠ¤ ê²Œì‹œíŒ
                            </a>
                        </div>
                    </div>

                    <!-- 3. í•™ìŠµ í™œë™ -->
                    <div class="mt-2">
                        <button @click="learning = !learning"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">âœï¸</span>
                                <span class="font-medium">í•™ìŠµ í™œë™</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': learning }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="learning" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('student.submit_essay') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'student.submit_essay' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ê³¼ì œ ì œì¶œ
                            </a>
                            <a href="{{ url_for('student.my_essays') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'student.my_essays' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                ë‚´ ì²¨ì‚­
                            </a>
                            <a href="{{ url_for('student.teaching_materials') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'student.teaching_material' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                í•™ìŠµ êµì¬
                            </a>
                            <a href="{{ url_for('student.teaching_videos') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'student.teaching_video' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                í•™ìŠµ ë™ì˜ìƒ
                            </a>
                            <a href="{{ url_for('student.progress') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-purple-600 hover:bg-purple-50 rounded transition {% if request.endpoint and 'student.progress' in request.endpoint %}text-purple-600 bg-purple-50{% endif %}">
                                í•™ìŠµ ì§„ë„
                            </a>
                        </div>
                    </div>

                    <!-- 4. í…ŒìŠ¤íŠ¸ -->
                    <div class="mt-2">
                        <button @click="tests = !tests"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“</span>
                                <span class="font-medium">í…ŒìŠ¤íŠ¸</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': tests }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="tests" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('student.reading_mbti') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-indigo-600 hover:bg-indigo-50 rounded transition {% if request.endpoint and 'reading_mbti' in request.endpoint %}text-indigo-600 bg-indigo-50{% endif %}">
                                ë…ì„œë…¼ìˆ  MBTI
                            </a>
                            <!-- ì–´íœ˜í€´ì¦ˆ & ìŠ¤í‚¤ë§ˆí€´ì¦ˆ - ì„ì‹œ ë¹„í™œì„±í™”
                            <a href="{{ url_for('student.vocabulary_quiz') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-indigo-600 hover:bg-indigo-50 rounded transition {% if request.endpoint and 'vocabulary_quiz' in request.endpoint %}text-indigo-600 bg-indigo-50{% endif %}">
                                ì–´íœ˜í€´ì¦ˆ
                            </a>
                            <a href="{{ url_for('student.schema_quiz') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-indigo-600 hover:bg-indigo-50 rounded transition {% if request.endpoint and 'schema_quiz' in request.endpoint %}text-indigo-600 bg-indigo-50{% endif %}">
                                ìŠ¤í‚¤ë§ˆí€´ì¦ˆ
                            </a>
                            -->
                        </div>
                    </div>

                    <!-- 5. í‰ê°€ ì •ë³´ -->
                    <div class="mt-2">
                        <button @click="evaluation = !evaluation"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ“Š</span>
                                <span class="font-medium">í‰ê°€ ì •ë³´</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': evaluation }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="evaluation" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('student.reading_mbti') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-indigo-600 hover:bg-indigo-50 rounded transition {% if request.endpoint and 'reading_mbti' in request.endpoint %}text-indigo-600 bg-indigo-50{% endif %}">
                                ğŸ§  ë…ì„œ ë…¼ìˆ  MBTI
                            </a>
                            <a href="{{ url_for('student.weekly_evaluation') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-indigo-600 hover:bg-indigo-50 rounded transition {% if request.endpoint and 'student.weekly_evaluation' in request.endpoint %}text-indigo-600 bg-indigo-50{% endif %}">
                                ğŸ“ ì£¼ê°„ í‰ê°€
                            </a>
                        </div>
                    </div>

                    <!-- 6. ë³´ê°•ìˆ˜ì—… -->
                    <div class="mt-2">
                        <button @click="makeup = !makeup"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ”„</span>
                                <span class="font-medium">ë³´ê°•ìˆ˜ì—…</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': makeup }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="makeup" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('student.makeup_classes') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint == 'student.makeup_classes' %}text-green-600 bg-green-50{% endif %}">
                                ì‹ ì²­í•˜ê¸°
                            </a>
                            <a href="{{ url_for('student.makeup_classes_history') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-green-600 hover:bg-green-50 rounded transition {% if request.endpoint == 'student.makeup_classes_history' %}text-green-600 bg-green-50{% endif %}">
                                ì‹ ì²­ ë‚´ì—­
                            </a>
                        </div>
                    </div>

                    <!-- 7. ê²Œì‹œíŒ -->
                    <div class="mt-2">
                        <button @click="communication = !communication"
                                class="w-full flex items-center justify-between px-4 py-3 text-white text-opacity-80 hover:bg-white hover:bg-opacity-10 rounded-lg transition">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ğŸ’¬</span>
                                <span class="font-medium">ê²Œì‹œíŒ</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="{ 'rotate-180': communication }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div x-show="communication" x-collapse class="ml-8 mt-1 space-y-1">
                            <a href="{{ url_for('student.announcements') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'student.announcements' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                ê³µì§€ì‚¬í•­
                            </a>
                            <a href="{{ url_for('harkness.index') }}"
                               class="sidebar-link-sub flex items-center gap-2 px-4 py-2 text-sm text-white text-opacity-70 hover:text-white hover:text-opacity-100 hover:bg-opacity-8 hover:text-yellow-600 hover:bg-yellow-50 rounded transition {% if request.endpoint and 'harkness' in request.endpoint %}text-yellow-600 bg-yellow-50{% endif %}">
                                í•˜í¬ë‹ˆìŠ¤ ê²Œì‹œíŒ
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if current_user.role in ['admin', 'teacher'] %}
                <div class="mt-6 pt-6 border-t border-white border-opacity-20">
                    <div class="text-xs font-medium text-white text-opacity-60 px-4 mb-2 text-uppercase tracking-wide">ë¹ ë¥¸ ì‘ì—…</div>
                    <a href="{{ url_for('essays.new') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent">
                        <span class="text-xl">âœï¸</span>
                        <span>ìƒˆ ì²¨ì‚­ ì‹œì‘</span>
                    </a>

                    <a href="{{ url_for('students.new') }}"
                       class="sidebar-link flex items-center gap-3 px-4 py-3 text-white text-opacity-80 hover:text-white hover:bg-white hover:bg-opacity-10 rounded-lg border-l-4 border-transparent">
                        <span class="text-xl">â•</span>
                        <span>í•™ìƒ ì¶”ê°€</span>
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="p-4 border-t border-white border-opacity-20">
                <div class="flex items-center gap-3 mb-3">
                    <a href="{{ url_for('profile.index') }}" class="w-10 h-10 bg-blue-400 bg-opacity-30 text-white rounded-full flex items-center justify-center font-bold hover:bg-opacity-40 transition duration-200">
                        {{ current_user.name[0] }}
                    </a>
                    <div class="flex-1 min-w-0">
                        <a href="{{ url_for('profile.index') }}" class="font-medium text-white truncate hover:text-blue-300 transition duration-200">{{ current_user.name }}</a>
                        <div class="text-xs text-white text-opacity-60 truncate">{{ current_user.email }}</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <a href="{{ url_for('profile.index') }}"
                       class="flex-1 text-center bg-white bg-opacity-10 hover:bg-opacity-20 text-white py-2 rounded-button transition duration-200 text-sm font-medium">
                        í”„ë¡œí•„
                    </a>
                    <a href="{{ url_for('auth.logout') }}"
                       class="flex-1 text-center bg-white bg-opacity-10 hover:bg-opacity-20 text-white py-2 rounded-button transition duration-200 text-sm font-medium">
                        ë¡œê·¸ì•„ì›ƒ
                    </a>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="header-navy px-6 py-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <h2 class="text-header text-white">
                            {% block page_title %}ëŒ€ì‹œë³´ë“œ{% endblock %}
                        </h2>
                        {% block page_subtitle %}{% endblock %}
                    </div>
                    <div class="flex items-center gap-4">
                        {% block header_actions %}
                        <a href="{{ url_for('search.index') }}"
                           class="flex items-center gap-2 px-4 py-2 text-white text-opacity-80 hover:text-white rounded-button hover:bg-white hover:bg-opacity-10 transition duration-200">
                            <span class="text-xl">ğŸ”</span>
                            <span class="text-sm font-medium">ê²€ìƒ‰</span>
                        </a>
                        {% endblock %}
                        <div class="text-sm text-white text-opacity-70">
                            {{ now().strftime('%Yë…„ %mì›” %dì¼') }}
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
    {% else %}
    <!-- Unauthenticated Layout -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">ğŸ¤– MOMOAI v4.0</h1>
                    <p class="text-blue-100 mt-2">AI ê¸°ë°˜ ë…¼ìˆ  ìë™ ì²¨ì‚­ ì‹œìŠ¤í…œ</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-100">Powered by Claude Opus 4.5</p>
                    <p class="text-xs text-blue-200 mt-1">18ê°œ ì§€í‘œ Â· ë²„ì „ ê´€ë¦¬</p>
                </div>
            </div>
        </div>

        <div>
    {% endif %}
                {% block content %}{% endblock %}
    {% if current_user.is_authenticated %}
            </main>
        </div>
    </div>
    {% else %}
        </div>

        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>Â© 2026 MOMOAI. All rights reserved.</p>
        </div>
    </div>
    {% endif %}

    {% block scripts %}{% endblock %}

    {% if current_user.is_authenticated %}
    <!-- íŒì—… ê³µì§€ì‚¬í•­ ëª¨ë‹¬ -->
    <div id="announcementPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-3xl">ğŸ“¢</span>
                        <h3 id="popupTitle" class="text-2xl font-bold text-gray-800"></h3>
                        <span id="popupBadge" class="px-2 py-1 text-xs font-medium rounded"></span>
                    </div>
                    <button onclick="closeAnnouncementPopup()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="popupContent" class="prose max-w-none mb-6 text-gray-800 leading-relaxed whitespace-pre-wrap"></div>
                <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                    <span id="popupAuthor"></span>
                    <span id="popupDate"></span>
                </div>
                <div class="flex gap-2">
                    <button onclick="closeAnnouncementPopup()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition duration-200">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ì‚¬ì´ë“œë°” ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ ë° ë³µì›
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('scrollable-menu');
        if (!sidebar) {
            console.log('Scrollable menu not found');
            return;
        }

        // Alpine.js ì´ˆê¸°í™” í›„ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
        function restoreScrollPosition() {
            const savedScrollPos = sessionStorage.getItem('sidebarScrollPos');
            if (savedScrollPos) {
                sidebar.scrollTop = parseInt(savedScrollPos);
                console.log('Restored scroll position:', savedScrollPos);
            }
        }

        // ì¦‰ì‹œ ë³µì› ì‹œë„
        restoreScrollPosition();

        // Alpine.js ë¡œë“œ í›„ì—ë„ ë³µì› (ë‹¤ì¤‘ ì‹œë„)
        setTimeout(restoreScrollPosition, 100);
        setTimeout(restoreScrollPosition, 300);

        // Alpine ì´ë²¤íŠ¸ê°€ ìˆë‹¤ë©´ ê·¸ í›„ì—ë„ ë³µì›
        document.addEventListener('alpine:initialized', restoreScrollPosition);

        // ìŠ¤í¬ë¡¤ ì‹œ ìœ„ì¹˜ ì €ì¥
        let scrollTimeout;
        sidebar.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(function() {
                sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
                console.log('Saved scroll position:', sidebar.scrollTop);
            }, 100);
        });

        // ë§í¬ í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¦‰ì‹œ ì €ì¥
        sidebar.addEventListener('click', function(e) {
            if (e.target.closest('a')) {
                sessionStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
                console.log('Saved on click:', sidebar.scrollTop);
            }
        });
    });

    // ì•Œë¦¼ ë±ƒì§€ ì—…ë°ì´íŠ¸
    function updateNotificationBadge() {
        fetch('/notifications/api/unread-count')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (data.unread_count > 0) {
                        badge.textContent = data.unread_count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            })
            .catch(error => console.error('Error fetching notification count:', error));
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ í™•ì¸
    updateNotificationBadge();

    // 30ì´ˆë§ˆë‹¤ ì•Œë¦¼ í™•ì¸
    setInterval(updateNotificationBadge, 30000);

    // íŒì—… ê³µì§€ì‚¬í•­ ê´€ë ¨
    let currentPopupAnnouncements = [];
    let currentPopupIndex = 0;

    function loadPopupAnnouncements() {
        fetch('/api/popup-announcements')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.announcements && data.announcements.length > 0) {
                    currentPopupAnnouncements = data.announcements;
                    currentPopupIndex = 0;
                    showCurrentPopup();
                }
            })
            .catch(error => console.error('Error loading popup announcements:', error));
    }

    function showCurrentPopup() {
        if (currentPopupIndex >= currentPopupAnnouncements.length) {
            return;
        }

        const announcement = currentPopupAnnouncements[currentPopupIndex];

        // ëª¨ë‹¬ ë‚´ìš© ì±„ìš°ê¸°
        document.getElementById('popupTitle').textContent = announcement.title;
        document.getElementById('popupContent').textContent = announcement.content;
        document.getElementById('popupAuthor').textContent = 'ì‘ì„±ì: ' + (announcement.author || 'ê´€ë¦¬ì');
        document.getElementById('popupDate').textContent = 'ì‘ì„±ì¼: ' + announcement.created_at;

        // ë°°ì§€ ì„¤ì •
        const badge = document.getElementById('popupBadge');
        let badgeClass = 'bg-blue-100 text-blue-800';
        let badgeText = 'ì¼ë°˜';

        if (announcement.announcement_type === 'urgent') {
            badgeClass = 'bg-red-100 text-red-800';
            badgeText = 'ê¸´ê¸‰';
        } else if (announcement.announcement_type === 'event') {
            badgeClass = 'bg-purple-100 text-purple-800';
            badgeText = 'í–‰ì‚¬';
        } else if (announcement.announcement_type === 'system') {
            badgeClass = 'bg-gray-100 text-gray-800';
            badgeText = 'ì‹œìŠ¤í…œ';
        }

        badge.className = 'px-2 py-1 text-xs font-medium rounded ' + badgeClass;
        badge.textContent = badgeText;

        // ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('announcementPopup').classList.remove('hidden');
    }

    function closeAnnouncementPopup() {
        const announcement = currentPopupAnnouncements[currentPopupIndex];

        // ì½ìŒ ì²˜ë¦¬
        fetch(`/api/announcements/${announcement.announcement_id}/mark-read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            // ë‹¤ìŒ íŒì—…ìœ¼ë¡œ ì´ë™
            currentPopupIndex++;
            if (currentPopupIndex < currentPopupAnnouncements.length) {
                showCurrentPopup();
            } else {
                // ëª¨ë“  íŒì—…ì„ ë‹«ìŒ
                document.getElementById('announcementPopup').classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error marking announcement as read:', error);
            // ì—ëŸ¬ê°€ ë‚˜ë„ ë‹¤ìŒ íŒì—…ìœ¼ë¡œ
            currentPopupIndex++;
            if (currentPopupIndex < currentPopupAnnouncements.length) {
                showCurrentPopup();
            } else {
                document.getElementById('announcementPopup').classList.add('hidden');
            }
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒì—… ê³µì§€ í™•ì¸ (3ì´ˆ í›„)
    setTimeout(loadPopupAnnouncements, 3000);

    // ì„œë¸Œë©”ë‰´ í™œì„± ìƒíƒœ ìƒ‰ìƒ ê°•ì œ ì ìš© (ëª¨ë“  ì—­í• )
    document.addEventListener('DOMContentLoaded', function() {
        function forceSubmenuColors() {
            // ëª¨ë“  ì„œë¸Œë©”ë‰´ ë§í¬ì—ì„œ í™œì„± ìƒíƒœ ì°¾ê¸°
            const activeSubmenus = document.querySelectorAll('a.sidebar-link-sub[class*="text-"][class*="-600"]');
            activeSubmenus.forEach(function(link) {
                // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ê°•ì œ ì ìš©
                link.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
                link.style.color = 'white';
                link.style.fontWeight = '600';
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì ìš©
        forceSubmenuColors();

        // Alpine.js ì´ˆê¸°í™” í›„ì—ë„ ì ìš©
        setTimeout(forceSubmenuColors, 100);
        setTimeout(forceSubmenuColors, 300);
        document.addEventListener('alpine:initialized', forceSubmenuColors);
    });
    </script>
    {% endif %}
</body>
</html>
