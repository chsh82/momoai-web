{% extends "base.html" %}

{% block title %}ê³¼ì œì—ì„œ OCR - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('essays.view_submission', essay_id=essay.essay_id) }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ê³¼ì œë¡œ ëŒì•„ê°€ê¸°
        </a>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">ê³¼ì œì—ì„œ OCR ì¸ì‹</h2>
        <div class="flex items-center gap-3 text-sm text-gray-600">
            <span>ğŸ‘¤ {{ student.name }}</span>
            <span>ğŸ“ {{ essay.title or 'ì œëª© ì—†ìŒ' }}</span>
        </div>
    </div>

    <!-- ì•ˆë‚´ -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
        <div class="flex items-start gap-3">
            <span class="text-3xl">ğŸ’¡</span>
            <div>
                <h4 class="font-medium text-blue-900 mb-2">ê³¼ì œ ì²¨ë¶€ íŒŒì¼ì—ì„œ OCR</h4>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>â€¢ í•™ìƒì´ ì œì¶œí•œ ê³¼ì œì˜ ì´ë¯¸ì§€ íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤</li>
                    <li>â€¢ ì—¬ëŸ¬ íŒŒì¼ì„ ë™ì‹œì— ì„ íƒí•˜ì—¬ ì¼ê´„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    <li>â€¢ ê° íŒŒì¼ì˜ ì¶”ì¶œëœ í…ìŠ¤íŠ¸ëŠ” OCR íˆìŠ¤í† ë¦¬ì— ê°œë³„ ì €ì¥ë©ë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800">ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ({{ image_attachments|length }}ê°œ)</h3>
            <button type="button" onclick="toggleSelectAll()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                ì „ì²´ ì„ íƒ/í•´ì œ
            </button>
        </div>
        <div class="p-6">
            <form method="POST" action="{{ url_for('essays.ocr_from_essay', essay_id=essay.essay_id) }}" onsubmit="return validateAndShowProcessing()">
                <div class="space-y-3 mb-6">
                    {% for file_index, filename, filepath in image_attachments %}
                    <label class="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-400 cursor-pointer transition duration-200 file-item">
                        <input type="checkbox"
                               name="file_indices"
                               value="{{ file_index if file_index is not none else '' }}"
                               class="w-4 h-4 text-blue-600 file-checkbox">
                        <span class="text-2xl">ğŸ–¼ï¸</span>
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">{{ filename }}</p>
                        </div>
                    </label>
                    {% endfor %}
                </div>

                <div class="flex gap-3">
                    <button type="submit"
                            id="submit-button"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                        OCR ì¸ì‹ ì‹œì‘
                    </button>
                    <a href="{{ url_for('essays.view_submission', essay_id=essay.essay_id) }}"
                       class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 rounded-lg transition duration-200 text-center">
                        ì·¨ì†Œ
                    </a>
                </div>
            </form>

            <!-- ì²˜ë¦¬ ì¤‘ ë©”ì‹œì§€ -->
            <div id="processing-message" class="hidden mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-700"></div>
                    <div>
                        <h4 class="font-medium text-yellow-900">OCR ì²˜ë¦¬ ì¤‘...</h4>
                        <p class="text-sm text-yellow-800">ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });
}

function validateAndShowProcessing() {
    const checkboxes = document.querySelectorAll('.file-checkbox:checked');

    if (checkboxes.length === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return false;
    }

    const button = document.getElementById('submit-button');
    const message = document.getElementById('processing-message');
    const messageText = message.querySelector('p');

    button.disabled = true;
    button.classList.add('opacity-50', 'cursor-not-allowed');
    message.classList.remove('hidden');

    // ì„ íƒëœ íŒŒì¼ ìˆ˜ì— ë”°ë¼ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    if (checkboxes.length === 1) {
        messageText.textContent = 'ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì•½ 10~60ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤.';
    } else {
        messageText.textContent = `${checkboxes.length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì™„ë£Œê¹Œì§€ ${checkboxes.length * 30}~${checkboxes.length * 60}ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.`;
    }

    return true;
}
</script>
{% endblock %}
