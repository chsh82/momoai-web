{% extends "base.html" %}

{% block title %}ì´ë¯¸ì§€ ì—…ë¡œë“œ - OCR ì¸ì‹ - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('essays.ocr_index') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† OCR ë©”ì¸ìœ¼ë¡œ
        </a>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
        <p class="text-gray-600">ì´ë¯¸ì§€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤ (ìµœëŒ€ 10ì¥)</p>
    </div>

    <!-- ì•ˆë‚´ ì¹´ë“œ -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
        <div class="flex items-start gap-3">
            <span class="text-3xl">ğŸ’¡</span>
            <div>
                <h4 class="font-medium text-blue-900 mb-2">OCR ì‚¬ìš© ì•ˆë‚´</h4>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>â€¢ ì§€ì› í˜•ì‹: JPG, PNG, BMP, TIFF, GIF, WEBP, PDF</li>
                    <li>â€¢ í•œ ë²ˆì— ìµœëŒ€ <strong>10ì¥</strong>ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                    <li>â€¢ ì´ë¯¸ì§€ê°€ ì„ ëª…í• ìˆ˜ë¡ ì¸ì‹ë¥ ì´ ë†’ì•„ì§‘ë‹ˆë‹¤</li>
                    <li>â€¢ ì¥ë‹¹ ì•½ 5~15ì´ˆ ì†Œìš” (10ì¥ ì‹œ ìµœëŒ€ 2ë¶„)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ì—…ë¡œë“œ í¼ -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">ì´ë¯¸ì§€ ì„ íƒ</h3>
        </div>
        <div class="p-6">
            <form method="POST" action="{{ url_for('essays.ocr_upload') }}" enctype="multipart/form-data"
                  id="uploadForm" onsubmit="return handleSubmit()">
                <!-- íŒŒì¼ ì„ íƒ ì˜ì—­ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ì´ë¯¸ì§€ íŒŒì¼ <span class="text-red-500">*</span>
                        <span class="text-gray-400 font-normal">(ìµœëŒ€ 10ì¥, ì¥ë‹¹ ìµœëŒ€ 16MB)</span>
                    </label>
                    <!-- ë“œë˜ê·¸ì•¤ë“œë¡­ ì˜ì—­ -->
                    <div id="dropZone"
                         class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors duration-200"
                         onclick="document.getElementById('images').click()"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event)">
                        <div id="dropText">
                            <div class="text-4xl mb-3">ğŸ“</div>
                            <p class="text-gray-600 font-medium">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                            <p class="text-sm text-gray-400 mt-1">JPG, PNG, PDF ë“± Â· ìµœëŒ€ 10ì¥</p>
                        </div>
                    </div>
                    <input type="file"
                           id="images"
                           name="images"
                           multiple
                           accept="image/*,.pdf"
                           class="hidden"
                           onchange="handleFileSelect(this.files)">
                </div>

                <!-- ì„ íƒëœ íŒŒì¼ ëª©ë¡ -->
                <div id="fileList" class="hidden mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-medium text-gray-700">
                            ì„ íƒëœ íŒŒì¼ <span id="fileCount" class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                        </h4>
                        <button type="button" onclick="clearFiles()"
                                class="text-xs text-red-500 hover:text-red-700">ì „ì²´ ì·¨ì†Œ</button>
                    </div>
                    <!-- ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ -->
                    <div id="previewGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3"></div>
                    <!-- 10ì¥ ì´ˆê³¼ ê²½ê³  -->
                    <div id="limitWarning" class="hidden mt-3 bg-red-50 border border-red-200 rounded-lg px-4 py-2 text-sm text-red-700">
                        âš ï¸ ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì²˜ìŒ 10ì¥ë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex gap-3">
                    <button type="submit"
                            id="submitBtn"
                            disabled
                            class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium py-3 rounded-lg transition duration-200">
                        ğŸ“¸ OCR ì¸ì‹ ì‹œì‘
                    </button>
                    <a href="{{ url_for('essays.ocr_index') }}"
                       class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 rounded-lg transition duration-200 text-center">
                        ì·¨ì†Œ
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì²˜ë¦¬ ì¤‘ ì˜¤ë²„ë ˆì´ (processing.html ìŠ¤íƒ€ì¼) -->
<div id="processingOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 overflow-y-auto">
    <div class="max-w-2xl mx-auto px-4 py-12">
        <!-- Header -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-white mb-2">OCR ì¸ì‹ ì§„í–‰ ì¤‘</h2>
            <p class="text-gray-300" id="progressText">ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- Main Card -->
        <div class="bg-white rounded-lg shadow-lg p-12 text-center">
            <!-- Spinner -->
            <div class="flex justify-center mb-6">
                <div class="ocr-spinner"></div>
            </div>

            <!-- Status -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2" id="statusText">Gemini AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h3>
                <p class="text-gray-600 text-sm">ì˜ˆìƒ ì†Œìš” ì‹œê°„: ì¥ë‹¹ 5~15ì´ˆ</p>
            </div>

            <!-- Progress Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-left mb-6">
                <div class="text-sm text-blue-800 space-y-2">
                    <div class="flex items-center">
                        <span class="text-blue-600 mr-2">âœ“</span>
                        <span>ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì „ì²˜ë¦¬</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-blue-600 mr-2">âœ“</span>
                        <span>Gemini AI ë¬¸ì ì¸ì‹ (OCR)</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-blue-600 mr-2">âœ“</span>
                        <span>ì›ë¬¸ í…ìŠ¤íŠ¸ ì¶”ì¶œ</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-blue-600 mr-2">âœ“</span>
                        <span>ë§ì¶¤ë²• êµì • ë° ìœ¤ë¬¸</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-blue-600 mr-2">âœ“</span>
                        <span>ì‚¬ê³ ë ¥ ë¶„ì„ ë° ìš”ì•½</span>
                    </div>
                </div>
            </div>

            <!-- File Info Grid -->
            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-6">
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700">ì´ íŒŒì¼ ìˆ˜</div>
                    <div id="totalCount">-</div>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <div class="font-medium text-gray-700">ì²˜ë¦¬ ë°©ì‹</div>
                    <div>âœ¨ Gemini AI</div>
                </div>
                <div class="bg-gray-50 p-3 rounded col-span-2">
                    <div class="font-medium text-gray-700">ê²½ê³¼ ì‹œê°„</div>
                    <div id="elapsedTime">0ì´ˆ</div>
                </div>
            </div>

            <!-- Wait Message -->
            <p class="text-gray-500 text-sm">
                ì´ í˜ì´ì§€ë¥¼ ë‹«ì§€ ë§ˆì„¸ìš”. ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>

<style>
.ocr-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
let selectedFiles = [];

function handleFileSelect(files) {
    const newFiles = Array.from(files);
    // ì¤‘ë³µ ì œê±° (ê°™ì€ ì´ë¦„)
    newFiles.forEach(f => {
        if (!selectedFiles.find(sf => sf.name === f.name && sf.size === f.size)) {
            selectedFiles.push(f);
        }
    });
    renderPreviews();
}

function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('dropZone').classList.add('border-blue-400', 'bg-blue-50');
}

function handleDragLeave(e) {
    document.getElementById('dropZone').classList.remove('border-blue-400', 'bg-blue-50');
}

function handleDrop(e) {
    e.preventDefault();
    handleDragLeave(e);
    handleFileSelect(e.dataTransfer.files);
}

function renderPreviews() {
    const grid = document.getElementById('previewGrid');
    const fileListDiv = document.getElementById('fileList');
    const countBadge = document.getElementById('fileCount');
    const submitBtn = document.getElementById('submitBtn');
    const limitWarning = document.getElementById('limitWarning');

    grid.innerHTML = '';

    if (selectedFiles.length === 0) {
        fileListDiv.classList.add('hidden');
        submitBtn.disabled = true;
        return;
    }

    fileListDiv.classList.remove('hidden');
    countBadge.textContent = selectedFiles.length;
    submitBtn.disabled = false;
    limitWarning.classList.toggle('hidden', selectedFiles.length <= 10);

    const displayFiles = selectedFiles.slice(0, 10);
    displayFiles.forEach((file, idx) => {
        const div = document.createElement('div');
        div.className = 'relative group';

        const isPdf = file.name.toLowerCase().endsWith('.pdf');
        if (isPdf) {
            div.innerHTML = `
                <div class="w-full aspect-square bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center p-2">
                    <span class="text-3xl mb-1">ğŸ“•</span>
                    <p class="text-xs text-gray-600 text-center truncate w-full px-1">${file.name}</p>
                </div>
                <button type="button" onclick="removeFile(${idx})"
                        class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-5 h-5 text-xs font-bold hidden group-hover:flex items-center justify-center">Ã—</button>
                <span class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-1 rounded">${idx+1}</span>
            `;
        } else {
            const url = URL.createObjectURL(file);
            div.innerHTML = `
                <div class="w-full aspect-square bg-gray-100 border border-gray-200 rounded-lg overflow-hidden">
                    <img src="${url}" alt="${file.name}" class="w-full h-full object-cover">
                </div>
                <button type="button" onclick="removeFile(${idx})"
                        class="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full w-5 h-5 text-xs font-bold hidden group-hover:flex items-center justify-center">Ã—</button>
                <span class="absolute bottom-1 left-1 bg-black bg-opacity-50 text-white text-xs px-1 rounded">${idx+1}</span>
            `;
        }
        grid.appendChild(div);
    });

    // ë“œë¡­ì¡´ ì—…ë°ì´íŠ¸
    document.getElementById('dropText').innerHTML = `
        <div class="text-2xl mb-1">âœ…</div>
        <p class="text-blue-700 font-medium">${selectedFiles.length}ì¥ ì„ íƒë¨</p>
        <p class="text-sm text-gray-400 mt-1">í´ë¦­í•˜ì—¬ íŒŒì¼ ì¶”ê°€</p>
    `;

    // íŒŒì¼ input ë™ê¸°í™”
    syncFilesToInput();
}

function removeFile(idx) {
    selectedFiles.splice(idx, 1);
    renderPreviews();
}

function clearFiles() {
    selectedFiles = [];
    document.getElementById('images').value = '';
    renderPreviews();
    document.getElementById('dropText').innerHTML = `
        <div class="text-4xl mb-3">ğŸ“</div>
        <p class="text-gray-600 font-medium">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</p>
        <p class="text-sm text-gray-400 mt-1">JPG, PNG, PDF ë“± Â· ìµœëŒ€ 10ì¥</p>
    `;
}

function syncFilesToInput() {
    // DataTransferë¥¼ ì´ìš©í•´ file inputê³¼ selectedFiles ë™ê¸°í™”
    const dt = new DataTransfer();
    selectedFiles.slice(0, 10).forEach(f => dt.items.add(f));
    document.getElementById('images').files = dt.files;
}

function handleSubmit() {
    if (selectedFiles.length === 0) return false;

    const count = Math.min(selectedFiles.length, 10);
    document.getElementById('progressText').textContent =
        `${count}ì¥ ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
    document.getElementById('totalCount').textContent = count + 'ì¥';
    document.getElementById('processingOverlay').classList.remove('hidden');

    let seconds = 0;
    setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        document.getElementById('elapsedTime').textContent =
            m > 0 ? `${m}ë¶„ ${s}ì´ˆ` : `${s}ì´ˆ`;
    }, 1000);

    return true;
}
</script>
{% endblock %}
