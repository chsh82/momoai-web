{% extends "base.html" %}

{% block title %}첨삭 진행 중 - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">첨삭 진행 중</h2>
        <p class="text-gray-600">{{ student.name }} 학생의 논술문을 분석하고 있습니다...</p>
    </div>

    <!-- Processing Animation -->
    <div class="bg-white rounded-lg shadow-lg p-12 text-center">
        <!-- Spinner -->
        <div class="flex justify-center mb-6">
            <div class="spinner"></div>
        </div>

        <!-- Status -->
        <div class="mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="statusText">AI가 논술문을 분석 중입니다...</h3>
            <p class="text-gray-600 text-sm">예상 소요 시간: 2-5분</p>
        </div>

        <!-- Progress Info -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-left mb-6">
            <div class="text-sm text-blue-800 space-y-2">
                <div class="flex items-center">
                    <span class="text-blue-600 mr-2">✓</span>
                    <span>논술문 분석 및 구조 파악</span>
                </div>
                <div class="flex items-center">
                    <span class="text-blue-600 mr-2">✓</span>
                    <span>윤문 완성본 작성</span>
                </div>
                <div class="flex items-center">
                    <span class="text-blue-600 mr-2">✓</span>
                    <span>18개 지표 점수 산출</span>
                </div>
                <div class="flex items-center">
                    <span class="text-blue-600 mr-2">✓</span>
                    <span>내용 첨삭 및 피드백 생성</span>
                </div>
                <div class="flex items-center">
                    <span class="text-blue-600 mr-2">✓</span>
                    <span>종합 제언 작성</span>
                </div>
            </div>
        </div>

        <!-- Student Info -->
        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-6">
            <div class="bg-gray-50 p-3 rounded">
                <div class="font-medium text-gray-700">학생</div>
                <div>{{ student.name }}</div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
                <div class="font-medium text-gray-700">학년</div>
                <div>{{ student.grade }}</div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
                <div class="font-medium text-gray-700">시작 시간</div>
                <div>{{ essay.created_at.strftime('%H:%M:%S') }}</div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
                <div class="font-medium text-gray-700">버전</div>
                <div>v{{ essay.current_version }}</div>
            </div>
        </div>

        <!-- Wait Message -->
        <p class="text-gray-500 text-sm">
            이 페이지를 닫지 마세요. 완료되면 자동으로 결과 페이지로 이동합니다.
        </p>
    </div>

    <!-- Back Link -->
    <div class="text-center mt-6">
        <a href="{{ url_for('essays.index') }}" class="text-gray-600 hover:text-gray-800">
            ← 첨삭 목록으로 돌아가기
        </a>
    </div>
</div>

<style>
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// Auto-refresh to check status
const essayId = '{{ essay.essay_id }}';
let checkCount = 0;
const maxChecks = 180; // 3분 × 60초 / 1초 = 180 checks (5분)
let regenerationStarted = false;

function checkStatus() {
    checkCount++;

    fetch(`/essays/api/status/${essayId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Status:', data.status);

            if (data.status === 'reviewing' || data.status === 'completed') {
                // 완료됨 - 결과 페이지로 이동
                document.getElementById('statusText').textContent = '첨삭이 완료되었습니다!';
                setTimeout(() => {
                    window.location.href = `/essays/result/${essayId}`;
                }, 1000);
            } else if (data.status === 'failed') {
                // 실패
                document.getElementById('statusText').textContent = '첨삭 중 오류가 발생했습니다.';
                document.getElementById('statusText').classList.add('text-red-600');
                setTimeout(() => {
                    window.location.href = '/essays';
                }, 3000);
            } else if (checkCount >= maxChecks) {
                // 타임아웃
                document.getElementById('statusText').textContent = '처리 시간이 초과되었습니다. 새로고침 후 다시 확인해주세요.';
                document.getElementById('statusText').classList.add('text-orange-600');
            } else {
                // 계속 진행 중
                setTimeout(checkStatus, 2000); // 2초마다 체크
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
            if (checkCount < maxChecks) {
                setTimeout(checkStatus, 2000);
            }
        });
}

function startRegeneration() {
    console.log('Starting regeneration...');
    document.getElementById('statusText').textContent = '첨삭을 재생성하는 중입니다...';

    fetch(`/essays/api/regenerate/${essayId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Regeneration response:', data);
        if (data.success) {
            // 재생성 완료 - 상태 체크 시작
            regenerationStarted = true;
            setTimeout(checkStatus, 1000);
        } else {
            // 에러
            document.getElementById('statusText').textContent = '재생성 중 오류가 발생했습니다: ' + (data.error || '알 수 없는 오류');
            document.getElementById('statusText').classList.add('text-red-600');
        }
    })
    .catch(error => {
        console.error('Error during regeneration:', error);
        document.getElementById('statusText').textContent = '재생성 중 오류가 발생했습니다.';
        document.getElementById('statusText').classList.add('text-red-600');
    });
}

// 페이지 로드 시 재생성이 필요한지 확인
const urlParams = new URLSearchParams(window.location.search);
const isRegenerate = urlParams.get('regenerate') === 'true';

console.log('Page loaded. isRegenerate:', isRegenerate);
console.log('URL params:', window.location.search);

// 재생성 요청이면 API 호출, 아니면 일반 상태 체크
if (isRegenerate) {
    console.log('Starting regeneration...');
    setTimeout(startRegeneration, 500);
} else {
    console.log('Starting status check...');
    setTimeout(checkStatus, 2000);
}
</script>
{% endblock %}
