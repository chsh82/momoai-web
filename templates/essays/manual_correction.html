{% extends "base.html" %}

{% block title %}ìˆ˜ë™ ì²¨ì‚­ - {{ essay.title or student.name }} - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('essays.view_submission', essay_id=essay.essay_id) }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ì›ë¬¸ ë³´ê¸°ë¡œ
        </a>
        <div class="flex items-start justify-between">
            <div>
                <h2 class="text-3xl font-bold text-gray-800 mb-1">âœï¸ ìˆ˜ë™ ì²¨ì‚­</h2>
                <div class="flex items-center gap-3 text-sm text-gray-600">
                    <span>ğŸ‘¤ {{ student.name }}</span>
                    <span>ğŸ“ {{ student.grade }}</span>
                    <span>ğŸ“… {{ essay.created_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}</span>
                    {% if essay.title %}
                    <span class="font-medium text-gray-800">ã€Œ{{ essay.title }}ã€</span>
                    {% endif %}
                </div>
            </div>
            <span class="px-3 py-1 text-sm font-medium rounded
                {% if essay.status == 'completed' and essay.is_finalized %}bg-green-100 text-green-800
                {% elif essay.status == 'reviewing' %}bg-blue-100 text-blue-800
                {% elif essay.status == 'processing' %}bg-yellow-100 text-yellow-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if essay.status == 'completed' and essay.is_finalized %}âœ… ì™„ë£Œ
                {% elif essay.status == 'reviewing' %}ğŸ“ ê²€í†  ì¤‘
                {% elif essay.status == 'processing' %}â³ ì²˜ë¦¬ ì¤‘
                {% else %}ğŸ“„ ì œì¶œë¨{% endif %}
            </span>
        </div>
    </div>

    <form method="POST" action="{{ url_for('essays.manual_correction', essay_id=essay.essay_id) }}">
        <!-- 2-column layout: original essay (left) + correction editor (right) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

            <!-- ì™¼ìª½: ì›ë¬¸ -->
            <div class="bg-white rounded-lg shadow flex flex-col" style="max-height: 80vh;">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex-shrink-0">
                    <h3 class="text-lg font-bold text-gray-800">ğŸ“„ ì›ë¬¸</h3>
                    <p class="text-xs text-gray-500 mt-0.5">í•™ìƒì´ ì œì¶œí•œ ë‚´ìš© (ì½ê¸° ì „ìš©)</p>
                </div>
                <div class="p-6 overflow-y-auto flex-1">
                    {% if essay.original_text %}
                    <div class="whitespace-pre-wrap text-gray-700 leading-relaxed text-sm font-['Noto_Sans_KR']">{{ essay.original_text }}</div>
                    {% else %}
                    <div class="text-center py-12 text-gray-400">
                        <p class="text-4xl mb-3">ğŸ“</p>
                        <p>ë³¸ë¬¸ ì—†ìŒ (ì²¨ë¶€íŒŒì¼ë§Œ ì œì¶œ)</p>
                        <a href="{{ url_for('essays.view_submission', essay_id=essay.essay_id) }}"
                           class="mt-3 inline-block text-blue-600 hover:text-blue-800 text-sm font-medium">
                            ì²¨ë¶€íŒŒì¼ í™•ì¸í•˜ê¸° â†’
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì²¨ì‚­ ì—ë””í„° -->
            <div class="bg-white rounded-lg shadow flex flex-col" style="max-height: 80vh;">
                <div class="px-6 py-4 border-b border-gray-200 bg-green-50 flex-shrink-0">
                    <h3 class="text-lg font-bold text-green-800">âœï¸ ì²¨ì‚­ ë‚´ìš© ì‘ì„±</h3>
                    <p class="text-xs text-green-600 mt-0.5">
                        ì¼ë°˜ í…ìŠ¤íŠ¸ ë˜ëŠ” HTML í˜•ì‹ìœ¼ë¡œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤
                    </p>
                </div>
                <div class="p-6 flex-1 flex flex-col">
                    <textarea
                        id="correction_content"
                        name="correction_content"
                        class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 font-mono text-sm resize-none"
                        placeholder="ì²¨ì‚­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.&#10;&#10;â€¢ ì¼ë°˜ í…ìŠ¤íŠ¸: ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ë©´ ì¤„ë°”ê¿ˆì´ ìœ ì§€ë©ë‹ˆë‹¤&#10;â€¢ HTML: &lt;p&gt;, &lt;strong&gt;, &lt;span style=&quot;color:red&quot;&gt; ë“± ì‚¬ìš© ê°€ëŠ¥"
                        style="min-height: 400px;"
                    >{{ existing_content }}</textarea>

                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-gray-500" id="charCount">0ì</span>
                        <button type="button" onclick="clearContent()"
                                class="text-xs text-red-500 hover:text-red-700">
                            ë‚´ìš© ì§€ìš°ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì ìˆ˜ ì…ë ¥ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š í‰ê°€ ì ìˆ˜ (ì„ íƒì‚¬í•­)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="total_score" class="block text-sm font-medium text-gray-700 mb-2">
                        ì´ì  <span class="text-gray-400 text-xs">(0~100)</span>
                    </label>
                    <input type="number"
                           id="total_score"
                           name="total_score"
                           min="0" max="100" step="0.5"
                           value="{{ existing_score }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ì˜ˆ: 85">
                </div>
                <div>
                    <label for="final_grade" class="block text-sm font-medium text-gray-700 mb-2">
                        ë“±ê¸‰
                    </label>
                    <select id="final_grade" name="final_grade"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ë“±ê¸‰ ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                        <option value="S" {% if existing_grade == 'S' %}selected{% endif %}>S (ìµœìš°ìˆ˜)</option>
                        <option value="A+" {% if existing_grade == 'A+' %}selected{% endif %}>A+</option>
                        <option value="A" {% if existing_grade == 'A' %}selected{% endif %}>A</option>
                        <option value="A-" {% if existing_grade == 'A-' %}selected{% endif %}>A-</option>
                        <option value="B+" {% if existing_grade == 'B+' %}selected{% endif %}>B+</option>
                        <option value="B" {% if existing_grade == 'B' %}selected{% endif %}>B</option>
                        <option value="B-" {% if existing_grade == 'B-' %}selected{% endif %}>B-</option>
                        <option value="C+" {% if existing_grade == 'C+' %}selected{% endif %}>C+</option>
                        <option value="C" {% if existing_grade == 'C' %}selected{% endif %}>C</option>
                        <option value="C-" {% if existing_grade == 'C-' %}selected{% endif %}>C-</option>
                        <option value="D" {% if existing_grade == 'D' %}selected{% endif %}>D</option>
                        <option value="F" {% if existing_grade == 'F' %}selected{% endif %}>F</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ì•ˆë‚´ ë°•ìŠ¤ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h4 class="font-medium text-blue-900 mb-2">ğŸ’¡ ì €ì¥ ì•ˆë‚´</h4>
            <ul class="text-sm text-blue-800 space-y-1">
                <li>â€¢ <strong>ì €ì¥ (ê²€í†  ì¤‘)</strong>: ì²¨ì‚­ ë‚´ìš©ì„ ì €ì¥í•˜ë˜ í•™ìƒì—ê²Œ ì•„ì§ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²°ê³¼ í˜ì´ì§€ì—ì„œ ìˆ˜ì • í›„ ì™„ë£Œ ì²˜ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                <li>â€¢ <strong>ì €ì¥ í›„ ë°”ë¡œ ì™„ë£Œ</strong>: ì €ì¥ê³¼ ë™ì‹œì— ìµœì¢… ì™„ë£Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. í•™ìƒì´ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>â€¢ ê¸°ì¡´ AI ì²¨ì‚­ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš° ìˆ˜ë™ ì²¨ì‚­ìœ¼ë¡œ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.</li>
            </ul>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="flex gap-3">
            <button type="submit" name="action" value="save"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                ğŸ’¾ ì €ì¥ (ê²€í†  ì¤‘)
            </button>
            <button type="submit" name="action" value="finalize"
                    onclick="return confirm('ì €ì¥ í›„ ë°”ë¡œ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•™ìƒì´ ì²¨ì‚­ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.')"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 rounded-lg transition duration-200">
                âœ… ì €ì¥ í›„ ë°”ë¡œ ì™„ë£Œ
            </button>
            <a href="{{ url_for('essays.view_submission', essay_id=essay.essay_id) }}"
               class="px-8 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 rounded-lg transition duration-200 text-center">
                ì·¨ì†Œ
            </a>
        </div>
    </form>
</div>

<script>
const textarea = document.getElementById('correction_content');
const charCount = document.getElementById('charCount');

function updateCharCount() {
    charCount.textContent = textarea.value.length.toLocaleString() + 'ì';
}

function clearContent() {
    if (textarea.value && !confirm('ì…ë ¥í•œ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    textarea.value = '';
    updateCharCount();
}

textarea.addEventListener('input', updateCharCount);
updateCharCount();
</script>
{% endblock %}
