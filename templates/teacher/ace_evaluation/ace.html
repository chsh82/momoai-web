{% extends "base.html" %}

{% block title %}ğŸ† ACE ë¶„ê¸° í‰ê°€{% endblock %}

{% block page_title %}ğŸ† ACE ë¶„ê¸° í‰ê°€{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">3ê°œì›” ë‹¨ìœ„ ì¢…í•© ì—­ëŸ‰ í‰ê°€</span>
{% endblock %}

{% block extra_css %}
<!-- ACE evaluation button styles are in style.css -->
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- ACE ë¶„ê¸° í‰ê°€ ì…ë ¥ í¼ -->
    <div class="card-momo mb-4">
        <h3 class="text-card-title mb-4">ğŸ† ACE ë¶„ê¸° í‰ê°€ ì…ë ¥</h3>

        <form method="POST" action="{{ url_for('teacher.ace_quarterly') }}" id="aceForm">
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- í•™ìƒ ì„ íƒ -->
                <div class="form-group">
                    <label class="text-label">í•™ìƒ</label>
                    <select name="student_id" class="select-momo w-full" required>
                        <option value="">í•™ìƒ ì„ íƒ</option>
                        {% for student in students %}
                        <option value="{{ student.student_id }}" {{ 'selected' if selected_student_id and student.student_id == selected_student_id else '' }}>
                            {{ student.name }} ({{ student.grade }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ì—°ë„ -->
                <div class="form-group">
                    <label class="text-label">ì—°ë„</label>
                    <input type="number" name="year" class="input-momo w-full"
                           value="{{ current_year }}" min="2020" max="2030" required>
                </div>

                <!-- ë¶„ê¸° -->
                <div class="form-group col-span-2">
                    <label class="text-label">ë¶„ê¸°</label>
                    <select name="quarter" class="select-momo w-full" required>
                        {% for quarter in quarters %}
                        <option value="{{ quarter }}">{{ quarter }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- ACE 5ê°œ ì¶• í‰ê°€ -->
            {% for axis in ace_axes %}
            {% set axis_index = loop.index0 %}
            <div class="mb-6">
                <!-- ì¶• ì œëª© -->
                <div class="flex items-center gap-3 mb-3 pb-2 border-b-2" style="border-color: {{ axis.color }}20;">
                    <div style="width: 4px; height: 24px; border-radius: 2px; background: {{ axis.color }};"></div>
                    <span class="text-base font-bold">{{ axis.name }}</span>
                    <span class="text-xs text-gray-500 ml-auto mono">
                        <span id="axis-{{ axis_index }}-score">9</span>/15
                    </span>
                </div>

                <!-- 3ê°œ í•­ëª© í‰ê°€ -->
                {% for item in axis['items'] %}
                <div class="grade-row">
                    <div class="grade-label">
                        <strong>{{ item.name }}</strong><br>
                        <span style="font-size: 11px; color: var(--text3);">{{ item.desc }}</span>
                    </div>
                    <div class="grade-btns">
                        {% for grade_label in grade_labels %}
                        {% set grade_idx = loop.index0 %}
                        <button type="button"
                                class="grade-btn {{ 'active g-mid' if grade_label == 'ì¤‘' else '' }}"
                                data-axis="{{ axis_index }}"
                                data-item="{{ item.name }}"
                                data-grade="{{ grade_label }}"
                                data-grade-idx="{{ grade_idx }}"
                                onclick="selectGrade(this, event)">
                            {{ grade_label }}
                        </button>
                        {% endfor %}
                        <input type="hidden" name="score_{{ item.name }}" value="ì¤‘">
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}

            <!-- ì¢…í•© ì½”ë©˜íŠ¸ -->
            <div class="form-group mb-4">
                <label class="text-label">ì¢…í•© ì½”ë©˜íŠ¸</label>
                <textarea name="comment" class="input-momo w-full"
                          rows="4"
                          placeholder="í•™ìƒ ì „ë°˜ì  ì—­ëŸ‰ í‰ê°€, ì„±ì¥ ë°©í–¥, ê°•ì  ë° ë³´ì™„ì  ë“±ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>

            <!-- ì´ì  ë° ì €ì¥ ë²„íŠ¼ -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <div>
                    <span class="text-sm text-gray-600">ì´ì </span>
                    <span class="mono text-3xl font-bold mx-2" id="total-score">45</span>
                    <span class="text-sm text-gray-500">/ 75</span>
                </div>
                <div class="flex gap-3">
                    <a href="{{ url_for('teacher.ace_evaluation') }}" class="btn btn-outline">
                        <span>â† ëŒì•„ê°€ê¸°</span>
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <span>ğŸ’¾ ACE í‰ê°€ ì €ì¥</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- ACE í‰ê°€ ì´ë ¥ -->
    {% if ace_evals %}
    <div class="card-momo">
        <h3 class="text-card-title mb-4">ğŸ“‹ ACE í‰ê°€ ì´ë ¥ (ìµœê·¼ 20ê°œ)</h3>

        <div class="overflow-x-auto">
            <table class="table-momo w-full">
                <thead>
                    <tr>
                        <th>í•™ìƒ</th>
                        <th>ì—°ë„</th>
                        <th>ë¶„ê¸°</th>
                        <th>ì´ì </th>
                        <th>ì¶•ë³„ í‰ê· </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for eval in ace_evals %}
                    <tr>
                        <td class="font-semibold">
                            {{ eval.student.name if eval.student else '?' }}
                        </td>
                        <td>{{ eval.year }}</td>
                        <td>{{ eval.quarter[:3] }}</td>
                        <td class="mono font-bold">{{ eval.get_total_score() }}/75</td>
                        <td class="text-sm">
                            {% for axis in ace_axes %}
                            <span style="color: {{ axis.color }}; font-weight: 600;">
                                {{ axis.name[:2] }} {{ "%.1f"|format(eval.get_axis_average(axis.item_names)) }}
                            </span>{{ ' Â· ' if not loop.last else '' }}
                            {% endfor %}
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <a href="{{ url_for('teacher.ace_report', student_id=eval.student_id, quarter_idx=loop.index0) }}"
                                   class="btn btn-sm btn-outline"
                                   target="_blank"
                                   title="ë¦¬í¬íŠ¸ ì¶œë ¥">
                                    ğŸ–¨ ë¦¬í¬íŠ¸
                                </a>
                                <form method="POST" action="{{ url_for('teacher.ace_quarterly_delete', eval_id=eval.id) }}"
                                      onsubmit="return confirm('ì´ í‰ê°€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                      style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">ì‚­ì œ</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card-momo">
        <div class="text-center py-12 text-gray-500">
            <p class="text-base mb-2">ì•„ì§ ì‘ì„±í•œ ACE í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-sm">ìœ„ í¼ì—ì„œ ì²« ë²ˆì§¸ í‰ê°€ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
        </div>
    </div>
    {% endif %}

</div>

<script>
const GRADE_SCORES = {'íŠ¹': 5, 'ìƒ': 4, 'ì¤‘': 3, 'í•˜': 2, 'ì €': 1};
const GRADE_CLASSES = ['g-top', 'g-high', 'g-mid', 'g-low', 'g-bottom'];

function selectGrade(button, event) {
    event.preventDefault();
    event.stopPropagation();

    const axis = button.dataset.axis;
    const itemName = button.dataset.item;
    const grade = button.dataset.grade;
    const gradeIdx = parseInt(button.dataset.gradeIdx);

    console.log('ğŸ¯ Selecting grade:', grade, 'for item:', itemName);

    // ìƒ‰ìƒ ë§¤í•‘
    const colorMap = {
        0: { bg: '#10B981', border: '#059669', name: 'g-top' },     // íŠ¹ - ì´ˆë¡
        1: { bg: '#3B82F6', border: '#2563EB', name: 'g-high' },    // ìƒ - íŒŒë‘
        2: { bg: '#F59E0B', border: '#D97706', name: 'g-mid' },     // ì¤‘ - ì˜¤ë Œì§€
        3: { bg: '#F97316', border: '#EA580C', name: 'g-low' },     // í•˜ - ì£¼í™©
        4: { bg: '#EF4444', border: '#DC2626', name: 'g-bottom' }   // ì € - ë¹¨ê°•
    };

    // ê°™ì€ í•­ëª©ì˜ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ì´ˆê¸°í™”
    const itemButtons = document.querySelectorAll(`button[data-item="${itemName}"]`);
    itemButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('g-top', 'g-high', 'g-mid', 'g-low', 'g-bottom');
        // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        btn.style.backgroundColor = '';
        btn.style.border = '';
        btn.style.color = '';
        btn.style.transform = '';
        btn.style.boxShadow = '';
        btn.style.fontWeight = '';
    });

    // í˜„ì¬ ë²„íŠ¼ì— í´ë˜ìŠ¤ ì¶”ê°€
    const gradeClass = GRADE_CLASSES[gradeIdx];
    button.classList.add('active');
    button.classList.add(gradeClass);

    // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì§ì ‘ ìƒ‰ìƒ ì ìš© (í™•ì‹¤í•œ ì‹œê°ì  í”¼ë“œë°±)
    const color = colorMap[gradeIdx];
    button.style.backgroundColor = color.bg;
    button.style.border = `2px solid ${color.border}`;
    button.style.color = '#fff';
    button.style.fontWeight = '900';
    button.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';

    // ì‹œê°ì  í”¼ë“œë°± (ì• ë‹ˆë©”ì´ì…˜)
    button.style.transform = 'scale(1.15)';
    setTimeout(() => {
        button.style.transform = 'scale(1.08)';
    }, 100);

    console.log('âœ… Button classes:', Array.from(button.classList));
    console.log('âœ… Applied color:', color.bg);

    // hidden input ì—…ë°ì´íŠ¸
    const hiddenInput = document.querySelector(`input[name="score_${itemName}"]`);
    if (hiddenInput) {
        hiddenInput.value = grade;
        console.log('âœ… Updated input:', hiddenInput.name, '=', grade);
    } else {
        console.error('âŒ Hidden input not found for:', itemName);
    }

    // ì¶•ë³„ ì ìˆ˜ ë° ì´ì  ì—…ë°ì´íŠ¸
    updateScores();
}

function updateScores() {
    // ëª¨ë“  hidden inputsì—ì„œ ì ìˆ˜ ìˆ˜ì§‘
    const scoreInputs = document.querySelectorAll('input[type="hidden"][name^="score_"]');
    let totalScore = 0;

    // ì¶•ë³„ ì ìˆ˜ ê³„ì‚° (5ê°œ ì¶•)
    const axisScores = [0, 0, 0, 0, 0];
    const axisCounts = [0, 0, 0, 0, 0];

    scoreInputs.forEach(input => {
        const itemName = input.name.replace('score_', '');
        const grade = input.value;
        const score = GRADE_SCORES[grade] || 3;
        totalScore += score;

        // ì¶• ì°¾ê¸° (data-axis ì†ì„± ì‚¬ìš©)
        const button = document.querySelector(`button[data-item="${itemName}"].active`);
        if (button) {
            const axisIdx = parseInt(button.dataset.axis);
            axisScores[axisIdx] += score;
            axisCounts[axisIdx]++;
        }
    });

    // ì´ì  í‘œì‹œ
    document.getElementById('total-score').textContent = totalScore;

    // ì¶•ë³„ ì ìˆ˜ í‘œì‹œ
    axisScores.forEach((score, idx) => {
        const el = document.getElementById(`axis-${idx}-score`);
        if (el) {
            el.textContent = score;
        }
    });
}

// ì´ˆê¸°í™” í•¨ìˆ˜
function initializeForm() {
    console.log('Initializing ACE evaluation form...');

    // ëª¨ë“  'ì¤‘' ë²„íŠ¼ì— active í´ë˜ìŠ¤ê°€ ì œëŒ€ë¡œ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸
    let initializedCount = 0;
    document.querySelectorAll('.grade-btn').forEach(btn => {
        if (btn.dataset.grade === 'ì¤‘') {
            // 'ì¤‘' ë²„íŠ¼ì— activeì™€ ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ê°€
            if (!btn.classList.contains('active')) {
                btn.classList.add('active');
            }
            if (!btn.classList.contains('g-mid')) {
                btn.classList.add('g-mid');
            }
            // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ìƒ‰ìƒ ì ìš© (ì¤‘ = ì˜¤ë Œì§€)
            btn.style.backgroundColor = '#F59E0B';
            btn.style.border = '2px solid #D97706';
            btn.style.color = '#fff';
            btn.style.fontWeight = '900';
            btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
            btn.style.transform = 'scale(1.08)';
            initializedCount++;
        }
    });

    console.log(`âœ… Initialized ${initializedCount} default grade buttons with inline styles`);

    // ì´ˆê¸° ì ìˆ˜ ê³„ì‚°
    updateScores();
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
});
</script>

{% endblock %}
