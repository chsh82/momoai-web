{% extends "base.html" %}

{% block title %}ğŸ“ ì£¼ì°¨ í‰ê°€ ìˆ˜ì •{% endblock %}

{% block page_title %}ğŸ“ ì£¼ì°¨ í‰ê°€ ìˆ˜ì •{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">í‰ê°€ ì •ë³´ ìˆ˜ì •</span>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- ì£¼ì°¨ í‰ê°€ ìˆ˜ì • í¼ -->
    <div class="card-momo mb-4">
        <h3 class="text-card-title mb-4">ğŸ“ ì£¼ì°¨ í‰ê°€ ìˆ˜ì •</h3>

        <form method="POST" action="{{ url_for('teacher.ace_weekly_edit', eval_id=eval.id) }}">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <!-- í•™ìƒ (ì½ê¸° ì „ìš©) -->
                <div class="form-group">
                    <label class="text-label">í•™ìƒ</label>
                    <input type="text" class="input-momo w-full bg-gray-100"
                           value="{{ eval.student.name }} ({{ eval.student.grade }})"
                           readonly>
                </div>

                <!-- í‰ê°€ ë‚ ì§œ -->
                <div class="form-group">
                    <label class="text-label">í‰ê°€ ë‚ ì§œ</label>
                    <input type="date" name="eval_date" class="input-momo w-full"
                           value="{{ eval.eval_date.strftime('%Y-%m-%d') }}" required>
                </div>

                <!-- ì£¼ì°¨ -->
                <div class="form-group">
                    <label class="text-label">ì£¼ì°¨</label>
                    <input type="number" name="week_number" class="input-momo w-full"
                           min="1" value="{{ eval.week_number }}" required>
                </div>

                <!-- ìˆ˜ì—… ë„ì„œ -->
                <div class="form-group">
                    <label class="text-label">ìˆ˜ì—… ë„ì„œ</label>
                    <input type="text" name="book_title" class="input-momo w-full"
                           value="{{ eval.book_title or '' }}" placeholder="ì˜ˆ: ì–´ë¦°ì™•ì">
                </div>

                <!-- ìˆ˜ì—… ìœ í˜• -->
                <div class="form-group">
                    <label class="text-label">ìˆ˜ì—… ìœ í˜•</label>
                    <select name="class_type" class="select-momo w-full" required>
                        {% for class_type in class_types %}
                        <option value="{{ class_type }}" {{ 'selected' if eval.class_type == class_type else '' }}>
                            {{ class_type }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ì²¨ì‚­ ì ìˆ˜ -->
                <div class="form-group">
                    <label class="text-label">ì²¨ì‚­ ì ìˆ˜ (100ì  ë§Œì )</label>
                    <input type="number" name="score" class="input-momo w-full"
                           min="0" max="100" value="{{ eval.score }}" required>
                </div>

                <!-- ë“±ê¸‰ -->
                <div class="form-group">
                    <label class="text-label">ë“±ê¸‰</label>
                    <select name="grade" class="select-momo w-full" required>
                        {% for grade in weekly_grades %}
                        <option value="{{ grade }}" {{ 'selected' if eval.grade == grade else '' }}>
                            {{ grade }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- ë³„ì  í‰ê°€ -->
            <div class="bg-blue-50 rounded-lg p-6 mb-4">
                <h4 class="text-lg font-bold text-gray-800 mb-4">â­ ë³„ì  í‰ê°€ (5ì  ë§Œì )</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ì°¸ì—¬ë„ -->
                    <div class="form-group">
                        <label class="text-label mb-3">ì°¸ì—¬ë„</label>
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1" id="participation-stars">
                                <span class="star cursor-pointer text-3xl" data-score="1" onclick="setRating('participation', 1)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="2" onclick="setRating('participation', 2)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="3" onclick="setRating('participation', 3)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="4" onclick="setRating('participation', 4)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="5" onclick="setRating('participation', 5)">â˜†</span>
                            </div>
                            <span id="participation-score-text" class="text-lg font-bold text-blue-600 ml-2">{{ eval.participation_score }}ì </span>
                        </div>
                        <input type="hidden" name="participation_score" id="participation-score" value="{{ eval.participation_score }}">
                    </div>

                    <!-- ì´í•´ë„ -->
                    <div class="form-group">
                        <label class="text-label mb-3">ì´í•´ë„</label>
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1" id="understanding-stars">
                                <span class="star cursor-pointer text-3xl" data-score="1" onclick="setRating('understanding', 1)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="2" onclick="setRating('understanding', 2)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="3" onclick="setRating('understanding', 3)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="4" onclick="setRating('understanding', 4)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="5" onclick="setRating('understanding', 5)">â˜†</span>
                            </div>
                            <span id="understanding-score-text" class="text-lg font-bold text-blue-600 ml-2">{{ eval.understanding_score }}ì </span>
                        </div>
                        <input type="hidden" name="understanding_score" id="understanding-score" value="{{ eval.understanding_score }}">
                    </div>
                </div>
            </div>

            <!-- ê°•ì‚¬ ì½”ë©˜íŠ¸ -->
            <div class="form-group mb-4">
                <label class="text-label">ê°•ì‚¬ ì½”ë©˜íŠ¸</label>

                <!-- ë¹ ë¥¸ ì„ íƒ -->
                <div class="mb-2">
                    <label class="text-sm text-gray-600 mb-1 block">ë¹ ë¥¸ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                    <select id="comment-select" class="select-momo w-full" onchange="fillComment()">
                        <option value="">-- ì½”ë©˜íŠ¸ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥ --</option>
                        {% for comment in teacher_comments %}
                        <option value="{{ comment }}">{{ comment }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ì§ì ‘ ì…ë ¥ -->
                <textarea name="comment" id="comment-textarea" class="input-momo w-full"
                          rows="4"
                          placeholder="ìœ„ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”...">{{ eval.comment or '' }}</textarea>
                <p class="text-sm text-gray-500 mt-1">ğŸ’¡ ìœ„ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥/ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <a href="{{ url_for('teacher.ace_weekly') }}" class="btn btn-outline">
                    <span>â† ì·¨ì†Œ</span>
                </a>
                <button type="submit" class="btn btn-primary">
                    <span>ğŸ’¾ ìˆ˜ì • ì™„ë£Œ</span>
                </button>
            </div>
        </form>
    </div>

</div>

<script>
// ë³„ì  í‰ê°€ ì„¤ì •
function setRating(type, score) {
    const input = document.getElementById(type + '-score');
    const text = document.getElementById(type + '-score-text');
    const starsContainer = document.getElementById(type + '-stars');
    const stars = starsContainer.querySelectorAll('.star');

    // ì ìˆ˜ ì €ì¥
    input.value = score;
    text.textContent = score + 'ì ';

    // ë³„ í‘œì‹œ ì—…ë°ì´íŠ¸
    stars.forEach((star, index) => {
        if (index < score) {
            star.textContent = 'â˜…';
            star.style.color = '#F59E0B'; // ë…¸ë€ìƒ‰
        } else {
            star.textContent = 'â˜†';
            star.style.color = '#D1D5DB'; // íšŒìƒ‰
        }
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ë³„ì ìœ¼ë¡œ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    const participationScore = {{ eval.participation_score }};
    const understandingScore = {{ eval.understanding_score }};

    setRating('participation', participationScore);
    setRating('understanding', understandingScore);
});

// ë³„ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë¯¸ë¦¬ë³´ê¸°
document.addEventListener('DOMContentLoaded', function() {
    ['participation', 'understanding'].forEach(type => {
        const starsContainer = document.getElementById(type + '-stars');
        const stars = starsContainer.querySelectorAll('.star');

        stars.forEach((star, index) => {
            star.addEventListener('mouseenter', function() {
                const score = index + 1;
                stars.forEach((s, i) => {
                    if (i < score) {
                        s.textContent = 'â˜…';
                        s.style.color = '#FBBF24'; // ë°ì€ ë…¸ë€ìƒ‰
                    } else {
                        s.textContent = 'â˜†';
                        s.style.color = '#D1D5DB';
                    }
                });
            });
        });

        starsContainer.addEventListener('mouseleave', function() {
            const currentScore = parseInt(document.getElementById(type + '-score').value);
            setRating(type, currentScore);
        });
    });
});

// ì½”ë©˜íŠ¸ ì„ íƒ ì‹œ textareaì— ìë™ ì…ë ¥
function fillComment() {
    const select = document.getElementById('comment-select');
    const textarea = document.getElementById('comment-textarea');
    const selectedComment = select.value;

    if (selectedComment) {
        textarea.value = selectedComment;
        // ì„ íƒ í›„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        select.selectedIndex = 0;
    }
}
</script>

{% endblock %}
