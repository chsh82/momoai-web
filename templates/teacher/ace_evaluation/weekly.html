{% extends "base.html" %}

{% block title %}ğŸ“ ì£¼ì°¨ í‰ê°€{% endblock %}

{% block page_title %}ğŸ“ ì£¼ì°¨ í‰ê°€{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ì£¼ê°„ ì²¨ì‚­ í”¼ë“œë°± ì…ë ¥</span>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- ìƒë‹¨ ë²„íŠ¼ -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">ì£¼ì°¨ í‰ê°€ ê´€ë¦¬</h2>
        <a href="{{ url_for('teacher.ace_weekly_dashboard') }}" class="btn btn-primary">
            ğŸ“Š ì „ì²´ ëŒ€ì‹œë³´ë“œ
        </a>
    </div>

    <!-- ì£¼ì°¨ í‰ê°€ ì…ë ¥ í¼ -->
    <div class="card-momo mb-4">
        <h3 class="text-card-title mb-4">ğŸ“ ì£¼ì°¨ í‰ê°€ ì…ë ¥</h3>

        <form method="POST" action="{{ url_for('teacher.ace_weekly') }}">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <!-- í•™ìƒ ì„ íƒ -->
                <div class="form-group">
                    <label class="text-label">í•™ìƒ</label>
                    <select name="student_id" id="student-select" class="select-momo w-full" required onchange="autoFillStudent()">
                        <option value="">í•™ìƒ ì„ íƒ</option>
                        {% for student in students %}
                        <option value="{{ student.student_id }}"
                                data-grade="{{ student.grade }}"
                                data-school="{{ student.school or '' }}">
                            {{ student.name }} ({{ student.grade }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- í‰ê°€ ë‚ ì§œ -->
                <div class="form-group">
                    <label class="text-label">í‰ê°€ ë‚ ì§œ</label>
                    <input type="date" name="eval_date" class="input-momo w-full"
                           value="{{ today.strftime('%Y-%m-%d') }}" required>
                </div>

                <!-- ì£¼ì°¨ -->
                <div class="form-group">
                    <label class="text-label">ì£¼ì°¨</label>
                    <input type="number" name="week_number" class="input-momo w-full"
                           min="1" value="1" placeholder="1" required>
                </div>

                <!-- ìˆ˜ì—… ë„ì„œ -->
                <div class="form-group">
                    <label class="text-label">ìˆ˜ì—… ë„ì„œ</label>
                    <input type="text" name="book_title" class="input-momo w-full"
                           placeholder="ì˜ˆ: ì–´ë¦°ì™•ì">
                </div>

                <!-- ìˆ˜ì—… ìœ í˜• -->
                <div class="form-group">
                    <label class="text-label">ìˆ˜ì—… ìœ í˜•</label>
                    <select name="class_type" class="select-momo w-full" required>
                        {% for class_type in class_types %}
                        <option value="{{ class_type }}">{{ class_type }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ì²¨ì‚­ ì ìˆ˜ -->
                <div class="form-group">
                    <label class="text-label">ì²¨ì‚­ ì ìˆ˜ (100ì  ë§Œì )</label>
                    <input type="number" name="score" class="input-momo w-full"
                           min="0" max="100" value="70" required>
                </div>

                <!-- ë“±ê¸‰ -->
                <div class="form-group">
                    <label class="text-label">ë“±ê¸‰</label>
                    <select name="grade" class="select-momo w-full" required>
                        {% for grade in weekly_grades %}
                        <option value="{{ grade }}" {{ 'selected' if grade == 'B0' else '' }}>{{ grade }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- ë³„ì  í‰ê°€ -->
            <div class="bg-blue-50 rounded-lg p-6 mb-4">
                <h4 class="text-lg font-bold text-gray-800 mb-4">â­ ë³„ì  í‰ê°€ (5ì  ë§Œì )</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ì°¸ì—¬ë„ -->
                    <div class="form-group">
                        <label class="text-label mb-3">ì°¸ì—¬ë„</label>
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1" id="participation-stars">
                                <span class="star cursor-pointer text-3xl" data-score="1" onclick="setRating('participation', 1)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="2" onclick="setRating('participation', 2)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="3" onclick="setRating('participation', 3)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="4" onclick="setRating('participation', 4)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="5" onclick="setRating('participation', 5)">â˜†</span>
                            </div>
                            <span id="participation-score-text" class="text-lg font-bold text-blue-600 ml-2">3ì </span>
                        </div>
                        <input type="hidden" name="participation_score" id="participation-score" value="3">
                    </div>

                    <!-- ì´í•´ë„ -->
                    <div class="form-group">
                        <label class="text-label mb-3">ì´í•´ë„</label>
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1" id="understanding-stars">
                                <span class="star cursor-pointer text-3xl" data-score="1" onclick="setRating('understanding', 1)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="2" onclick="setRating('understanding', 2)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="3" onclick="setRating('understanding', 3)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="4" onclick="setRating('understanding', 4)">â˜†</span>
                                <span class="star cursor-pointer text-3xl" data-score="5" onclick="setRating('understanding', 5)">â˜†</span>
                            </div>
                            <span id="understanding-score-text" class="text-lg font-bold text-blue-600 ml-2">3ì </span>
                        </div>
                        <input type="hidden" name="understanding_score" id="understanding-score" value="3">
                    </div>
                </div>
            </div>

            <!-- ê°•ì‚¬ ì½”ë©˜íŠ¸ -->
            <div class="form-group mb-4">
                <label class="text-label">ê°•ì‚¬ ì½”ë©˜íŠ¸</label>

                <!-- ë¹ ë¥¸ ì„ íƒ -->
                <div class="mb-2">
                    <label class="text-sm text-gray-600 mb-1 block">ë¹ ë¥¸ ì„ íƒ (ì„ íƒì‚¬í•­)</label>
                    <select id="comment-select" class="select-momo w-full" onchange="fillComment()">
                        <option value="">-- ì½”ë©˜íŠ¸ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥ --</option>
                        {% for comment in teacher_comments %}
                        <option value="{{ comment }}">{{ comment }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ì§ì ‘ ì…ë ¥ -->
                <textarea name="comment" id="comment-textarea" class="input-momo w-full"
                          rows="4"
                          placeholder="ìœ„ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                <p class="text-sm text-gray-500 mt-1">ğŸ’¡ ìœ„ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥/ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <a href="{{ url_for('teacher.ace_evaluation') }}" class="btn btn-outline">
                    <span>â† ëŒì•„ê°€ê¸°</span>
                </a>
                <button type="submit" class="btn btn-primary">
                    <span>ğŸ’¾ í‰ê°€ ì €ì¥</span>
                </button>
            </div>
        </form>
    </div>

    <!-- ì£¼ì°¨ í‰ê°€ ì´ë ¥ -->
    {% if weekly_evals %}
    <div class="card-momo">
        <h3 class="text-card-title mb-4">ğŸ“‹ ì£¼ì°¨ í‰ê°€ ì´ë ¥ (ìµœê·¼ 20ê°œ)</h3>

        <div class="overflow-x-auto">
            <table class="table-momo w-full">
                <thead>
                    <tr>
                        <th>í•™ìƒ</th>
                        <th>ë‚ ì§œ</th>
                        <th>ì£¼ì°¨</th>
                        <th>ë„ì„œ</th>
                        <th>ìœ í˜•</th>
                        <th>ì ìˆ˜</th>
                        <th>ë“±ê¸‰</th>
                        <th>ì°¸ì—¬ë„</th>
                        <th>ì´í•´ë„</th>
                        <th>ì½”ë©˜íŠ¸</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for eval in weekly_evals %}
                    <tr>
                        <td class="font-semibold">
                            {{ eval.student.name if eval.student else '?' }}
                        </td>
                        <td>{{ eval.eval_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ eval.week_number }}ì£¼</td>
                        <td>{{ eval.book_title or '-' }}</td>
                        <td>{{ eval.class_type or '-' }}</td>
                        <td class="mono font-bold" style="color: {{ '#10B981' if eval.score >= 80 else '#F59E0B' if eval.score >= 60 else '#EF4444' }}">
                            {{ eval.score }}
                        </td>
                        <td>
                            <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3B82F6;">
                                {{ eval.grade }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="text-yellow-500">{% for i in range(eval.participation_score or 3) %}â˜…{% endfor %}{% for i in range(5 - (eval.participation_score or 3)) %}â˜†{% endfor %}</span>
                            <div class="text-xs text-gray-600">{{ eval.participation_score or 3 }}ì </div>
                        </td>
                        <td class="text-center">
                            <span class="text-yellow-500">{% for i in range(eval.understanding_score or 3) %}â˜…{% endfor %}{% for i in range(5 - (eval.understanding_score or 3)) %}â˜†{% endfor %}</span>
                            <div class="text-xs text-gray-600">{{ eval.understanding_score or 3 }}ì </div>
                        </td>
                        <td class="text-sm text-gray-600 max-w-xs">
                            <div class="truncate" title="{{ eval.comment or '' }}">
                                {{ eval.comment or '-' }}
                            </div>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <a href="{{ url_for('teacher.ace_weekly_edit', eval_id=eval.id) }}"
                                   class="px-3 py-1.5 text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 rounded transition duration-200">
                                    ìˆ˜ì •
                                </a>
                                <form method="POST" action="{{ url_for('teacher.ace_weekly_delete', eval_id=eval.id) }}"
                                      onsubmit="return confirm('ì´ í‰ê°€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                      style="display: inline;">
                                    <button type="submit"
                                            class="px-3 py-1.5 text-sm font-medium text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 rounded transition duration-200">
                                        ì‚­ì œ
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card-momo">
        <div class="text-center py-12 text-gray-500">
            <p class="text-base mb-2">ì•„ì§ ì‘ì„±í•œ ì£¼ì°¨ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-sm">ìœ„ í¼ì—ì„œ ì²« ë²ˆì§¸ í‰ê°€ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
        </div>
    </div>
    {% endif %}

</div>

<script>
// í•™ìƒ ì„ íƒ ì‹œ ìë™ ì…ë ¥ (ì¶”í›„ í™•ì¥ ê°€ëŠ¥)
function autoFillStudent() {
    const select = document.getElementById('student-select');
    const option = select.options[select.selectedIndex];
    // í•„ìš”ì‹œ ë‹¤ë¥¸ í•„ë“œ ìë™ ì…ë ¥ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
}

// ì½”ë©˜íŠ¸ ì„ íƒ ì‹œ textareaì— ìë™ ì…ë ¥
function fillComment() {
    const select = document.getElementById('comment-select');
    const textarea = document.getElementById('comment-textarea');
    const selectedComment = select.value;

    if (selectedComment) {
        textarea.value = selectedComment;
        // ì„ íƒ í›„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        select.selectedIndex = 0;
    }
}

// ë³„ì  í‰ê°€ ì„¤ì •
function setRating(type, score) {
    const input = document.getElementById(type + '-score');
    const text = document.getElementById(type + '-score-text');
    const starsContainer = document.getElementById(type + '-stars');
    const stars = starsContainer.querySelectorAll('.star');

    // ì ìˆ˜ ì €ì¥
    input.value = score;
    text.textContent = score + 'ì ';

    // ë³„ í‘œì‹œ ì—…ë°ì´íŠ¸
    stars.forEach((star, index) => {
        if (index < score) {
            star.textContent = 'â˜…';
            star.style.color = '#F59E0B'; // ë…¸ë€ìƒ‰
        } else {
            star.textContent = 'â˜†';
            star.style.color = '#D1D5DB'; // íšŒìƒ‰
        }
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ê°’ 3ì ìœ¼ë¡œ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    setRating('participation', 3);
    setRating('understanding', 3);
});

// ë³„ì— ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë¯¸ë¦¬ë³´ê¸°
document.addEventListener('DOMContentLoaded', function() {
    ['participation', 'understanding'].forEach(type => {
        const starsContainer = document.getElementById(type + '-stars');
        const stars = starsContainer.querySelectorAll('.star');

        stars.forEach((star, index) => {
            star.addEventListener('mouseenter', function() {
                const score = index + 1;
                stars.forEach((s, i) => {
                    if (i < score) {
                        s.textContent = 'â˜…';
                        s.style.color = '#FBBF24'; // ë°ì€ ë…¸ë€ìƒ‰
                    } else {
                        s.textContent = 'â˜†';
                        s.style.color = '#D1D5DB';
                    }
                });
            });
        });

        starsContainer.addEventListener('mouseleave', function() {
            const currentScore = parseInt(document.getElementById(type + '-score').value);
            setRating(type, currentScore);
        });
    });
});
</script>

{% endblock %}
