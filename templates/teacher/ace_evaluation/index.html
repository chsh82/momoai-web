{% extends "base.html" %}

{% block title %}â­ ACE í‰ê°€ ì‹œìŠ¤í…œ{% endblock %}

{% block page_title %}â­ ACE í‰ê°€ ì‹œìŠ¤í…œ{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">í•™ìƒ ì—­ëŸ‰ í‰ê°€ ë° ì„±ì¥ ì¶”ì </span>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
.chart-wrap { position: relative; width: 100%; height: 280px; }
.chart-wrap.short { height: 220px; }
.empty-state { text-align: center; padding: 60px 20px; color: var(--text3); }
.empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text2); }
/* Student card hover styles are in style.css */
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    {% if not students %}
    <!-- í•™ìƒì´ ì—†ëŠ” ê²½ìš° -->
    <div class="card-momo">
        <div class="empty-state">
            <h3>ë‹´ë‹¹ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ìˆ˜ì—…ì— í•™ìƒì„ ë“±ë¡í•˜ë©´ ACE í‰ê°€ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    {% else %}

    <!-- í•™ìƒ ì„ íƒ -->
    <div class="card-momo mb-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-card-title">ğŸ‘©â€ğŸ“ í‰ê°€ ëŒ€ìƒ í•™ìƒ ì„ íƒ</h3>
            <div class="flex gap-3">
                <a href="{{ url_for('teacher.ace_weekly') }}" class="btn btn-outline btn-sm">
                    <span>ğŸ“</span>
                    <span>ì£¼ì°¨ í‰ê°€</span>
                </a>
                <a href="{{ url_for('teacher.ace_quarterly') }}" class="btn btn-outline btn-sm">
                    <span>ğŸ†</span>
                    <span>ACE ë¶„ê¸°í‰ê°€</span>
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
            {% for student in students %}
            <div class="card-momo-sm student-card-selectable {{ 'selected' if selected_student and selected_student.student_id == student.student_id else '' }}"
                 onclick="window.location.href='{{ url_for('teacher.ace_quarterly', student_id=student.student_id) }}'">
                <div class="font-bold text-base">{{ student.name }}</div>
                <div class="text-sm text-gray-500 mt-1">{{ student.grade }}</div>

                {% set student_weekly_count = student.weekly_evaluations|length if student.weekly_evaluations else 0 %}
                {% set student_ace_count = student.ace_evaluations|length if student.ace_evaluations else 0 %}

                <div class="flex gap-2 mt-2 flex-wrap">
                    {% if student_weekly_count > 0 %}
                    <span class="badge badge-blue">ì£¼ì°¨í‰ê°€ {{ student_weekly_count }}ê±´</span>
                    {% endif %}
                    {% if student_ace_count > 0 %}
                    <span class="badge badge-purple">ACE {{ student_ace_count }}ê±´</span>
                    {% endif %}
                    {% if student_weekly_count == 0 and student_ace_count == 0 %}
                    <span class="badge" style="background: var(--light); color: var(--text3);">í‰ê°€ ì—†ìŒ</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {% if selected_student %}
    <!-- ì„ íƒëœ í•™ìƒì˜ ëŒ€ì‹œë³´ë“œ -->

    <!-- í•™ìƒ ì •ë³´ ì¹´ë“œ -->
    <div class="card-momo mb-4">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div>
                <div class="text-2xl font-extrabold">{{ selected_student.name }}</div>
                <div class="text-sm text-gray-500 mt-1">
                    {{ selected_student.grade }} Â· {{ selected_student.school or 'í•™êµ ë¯¸ë“±ë¡' }}
                </div>
            </div>

            <div class="flex gap-4">
                <div class="bg-light rounded-xl px-6 py-3 text-center">
                    <div class="text-xs text-gray-500 mb-1">ì£¼ì°¨ í‰ê°€</div>
                    <div class="text-2xl font-bold text-blue mono">{{ weekly_evals|length }}<span class="text-sm text-gray-500">ê±´</span></div>
                </div>
                <div class="bg-light rounded-xl px-6 py-3 text-center">
                    <div class="text-xs text-gray-500 mb-1">ACE í‰ê°€</div>
                    <div class="text-2xl font-bold text-purple mono">{{ ace_evals|length }}<span class="text-sm text-gray-500">ê±´</span></div>
                </div>
                {% if weekly_evals %}
                {% set latest_weekly = weekly_evals[0] %}
                <div class="bg-light rounded-xl px-6 py-3 text-center">
                    <div class="text-xs text-gray-500 mb-1">ìµœê·¼ ì ìˆ˜</div>
                    <div class="text-2xl font-bold mono" style="color: {{ '#10B981' if latest_weekly.score >= 80 else '#F59E0B' if latest_weekly.score >= 60 else '#EF4444' }}">{{ latest_weekly.score }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    {% if weekly_evals or ace_evals %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <!-- ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„  -->
        {% if weekly_evals %}
        <div class="card-momo">
            <h3 class="text-base font-bold mb-1">ğŸ“ˆ ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„ </h3>
            <p class="text-xs text-gray-500 mb-3">ì²¨ì‚­ ì ìˆ˜ ì¶”ì´</p>
            <div class="chart-wrap">
                <canvas id="growthChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- ACE ì—­ëŸ‰ ë¶„ì„ -->
        {% if ace_evals %}
        <div class="card-momo">
            <h3 class="text-base font-bold mb-1">ğŸ¯ ACE ì—­ëŸ‰ ë¶„ì„</h3>
            <p class="text-xs text-gray-500 mb-3">ìµœì‹  ë¶„ê¸° ê¸°ì¤€</p>
            <div class="chart-wrap">
                <canvas id="aceRadar"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ìµœê·¼ ì£¼ì°¨ í‰ê°€ -->
    {% if weekly_evals %}
    <div class="card-momo mb-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-card-title">ğŸ“ ìµœê·¼ ì£¼ì°¨ í‰ê°€</h3>
            <a href="{{ url_for('teacher.ace_report', student_id=selected_student.student_id) }}"
               class="btn btn-outline btn-sm" target="_blank">
                <span>ğŸ–¨</span>
                <span>ë¦¬í¬íŠ¸ ì¶œë ¥</span>
            </a>
        </div>

        <table class="table-momo w-full">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ì£¼ì°¨</th>
                    <th>ë„ì„œ</th>
                    <th>ìœ í˜•</th>
                    <th>ì ìˆ˜</th>
                    <th>ë“±ê¸‰</th>
                    <th>ì½”ë©˜íŠ¸</th>
                </tr>
            </thead>
            <tbody>
                {% for eval in weekly_evals[:10] %}
                <tr>
                    <td>{{ eval.eval_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ eval.week_number }}ì£¼ì°¨</td>
                    <td>{{ eval.book_title or '-' }}</td>
                    <td>{{ eval.class_type or '-' }}</td>
                    <td class="mono font-bold" style="color: {{ '#10B981' if eval.score >= 80 else '#F59E0B' if eval.score >= 60 else '#EF4444' }}">{{ eval.score }}</td>
                    <td>
                        <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3B82F6;">{{ eval.grade }}</span>
                    </td>
                    <td class="text-sm text-gray-600 max-w-xs truncate">{{ eval.comment or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- ACE ë¶„ê¸° í‰ê°€ ì´ë ¥ -->
    {% if ace_evals %}
    <div class="card-momo">
        <h3 class="text-card-title mb-4">ğŸ’¬ ACE ë¶„ê¸° í‰ê°€ ì½”ë©˜íŠ¸</h3>

        <div class="timeline">
            {% for eval in ace_evals|reverse %}
            <div class="timeline-item">
                <div class="timeline-qtr">
                    {{ eval.quarter }}
                    <span class="timeline-year">{{ eval.year }} Â· {{ eval.teacher.name if eval.teacher else 'ê°•ì‚¬' }}</span>
                </div>
                <div class="timeline-comment">{{ eval.comment or 'ì½”ë©˜íŠ¸ ì—†ìŒ' }}</div>
                <div class="timeline-scores">
                    ì´ì  {{ eval.get_total_score() }}/75 Â·
                    {% for axis in ace_axes %}
                    <span style="color: {{ axis.color }}; font-weight: 600;">
                        {{ axis.name[:2] }} {{ "%.1f"|format(eval.get_axis_average(axis.item_names)) }}
                    </span>{{ ' Â· ' if not loop.last else '' }}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- í•™ìƒì„ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš° -->
    <div class="card-momo">
        <div class="empty-state">
            <h3>í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</h3>
            <p>ìœ„ì˜ í•™ìƒ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ í‰ê°€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
    {% endif %}

    {% endif %}

</div>

{% if selected_student and (weekly_evals or ace_evals) %}
<script>
// ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„  ì°¨íŠ¸
{% if weekly_evals %}
const growthCtx = document.getElementById('growthChart');
if (growthCtx) {
    new Chart(growthCtx, {
        type: 'line',
        data: {
            labels: [{% for eval in weekly_evals|reverse %}'{{ eval.week_number }}ì£¼ì°¨'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [{
                label: 'ì²¨ì‚­ ì ìˆ˜',
                data: [{% for eval in weekly_evals|reverse %}{{ eval.score }}{{ ',' if not loop.last else '' }}{% endfor %}],
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#3B82F6',
                pointBorderWidth: 2.5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.raw + 'ì ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    grid: { color: '#F1F5F9' }
                },
                x: { grid: { display: false } }
            }
        }
    });
}
{% endif %}

// ACE ì—­ëŸ‰ ë ˆì´ë” ì°¨íŠ¸
{% if ace_evals %}
{% set latest_ace = ace_evals[0] %}
const aceCtx = document.getElementById('aceRadar');
if (aceCtx) {
    new Chart(aceCtx, {
        type: 'radar',
        data: {
            labels: [{% for axis in ace_axes %}'{{ axis.name }}'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [{
                label: '{{ latest_ace.year }} {{ latest_ace.quarter }}',
                data: [{% for axis in ace_axes %}{{ "%.1f"|format(latest_ace.get_axis_average(axis.item_names)) }}{{ ',' if not loop.last else '' }}{% endfor %}],
                backgroundColor: 'rgba(59, 130, 246, 0.15)',
                borderColor: '#3B82F6',
                borderWidth: 2.5,
                pointBackgroundColor: '#3B82F6',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                r: {
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        font: { size: 10 },
                        backdropColor: 'transparent'
                    },
                    grid: { color: '#E2E8F0' },
                    pointLabels: {
                        font: { size: 11, family: 'Noto Sans KR' }
                    }
                }
            }
        }
    });
}
{% endif %}
</script>
{% endif %}

{% endblock %}
