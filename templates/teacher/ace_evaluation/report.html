{% extends "base.html" %}

{% block title %}ğŸ“„ í•™ë¶€ëª¨ ë¦¬í¬íŠ¸ - {{ student.name }}{% endblock %}

{% block page_title %}ğŸ“„ í•™ë¶€ëª¨ ë¦¬í¬íŠ¸{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">{{ student.name }} í•™ìƒ ì—­ëŸ‰ í‰ê°€ ë¦¬í¬íŠ¸</span>
{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
.chart-wrap { position: relative; width: 100%; height: 280px; }
.chart-wrap.short { height: 220px; }
.print-btn-container { position: fixed; top: 90px; right: 20px; z-index: 50; }

@media print {
    .no-print, .print-btn-container, .header-navy, .sidebar-navy {
        display: none !important;
    }
    .main { padding: 0; }
    body { background: white; }
    .card-momo { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
    .chart-wrap { height: 240px !important; }
}

</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- ì¸ì‡„ ë²„íŠ¼ (í™”ë©´ì—ë§Œ í‘œì‹œ) -->
    <div class="print-btn-container no-print">
        <button onclick="window.print()" class="btn btn-primary shadow-lg">
            <span>ğŸ–¨</span>
            <span>í”„ë¦°íŠ¸</span>
        </button>
    </div>

    <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
    <div class="card-momo mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="text-center py-6">
            <div class="text-sm opacity-90 mb-2">ëª¨ëª¨ì˜ ì±…ì¥</div>
            <div class="text-3xl font-extrabold mb-1">í•™ìƒ í•™ìŠµ ì—­ëŸ‰ ë¦¬í¬íŠ¸</div>
            <div class="text-sm opacity-80">ACE Evaluation Report</div>
        </div>
    </div>

    <!-- í•™ìƒ ê¸°ë³¸ ì •ë³´ -->
    <div class="card-momo mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- í•™ìƒ ì •ë³´ ì¹´ë“œ -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border-2 border-blue-100">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xl font-bold shadow-lg">
                        {{ student.name[0] }}
                    </div>
                    <div>
                        <div class="text-xs text-blue-600 font-semibold mb-1">STUDENT</div>
                        <div class="text-xl font-extrabold text-gray-800">{{ student.name }}</div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center py-2 border-b border-blue-200">
                        <span class="text-sm text-gray-600 font-medium">í•™ë…„</span>
                        <span class="text-sm font-bold text-gray-800">{{ student.grade }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-sm text-gray-600 font-medium">í•™êµ</span>
                        <span class="text-sm font-bold text-gray-800">{{ student.school or 'ë¯¸ë“±ë¡' }}</span>
                    </div>
                </div>
            </div>

            <!-- í‰ê°€ ì •ë³´ ì¹´ë“œ -->
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-5 border-2 border-purple-100">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ“Š</span>
                    <div>
                        <div class="text-xs text-purple-600 font-semibold mb-1">EVALUATION</div>
                        <div class="text-lg font-extrabold text-gray-800">í‰ê°€ ì •ë³´</div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center py-2 border-b border-purple-200">
                        <span class="text-sm text-gray-600 font-medium">ë‹´ë‹¹ ê°•ì‚¬</span>
                        <span class="text-sm font-bold text-gray-800">{{ student.teacher.name if student.teacher else 'ë¯¸ë°°ì •' }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-purple-200">
                        <span class="text-sm text-gray-600 font-medium">ë°œí–‰ì¼</span>
                        <span class="text-sm font-bold text-gray-800">{{ report_date.strftime('%Yë…„ %mì›” %dì¼') }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-sm text-gray-600 font-medium">í‰ê°€ ê¸°ê°„</span>
                        <span class="text-sm font-bold text-gray-800">
                            {% if ace_evals %}
                            {{ ace_evals[0].year }} {{ ace_evals[0].quarter[:3] }} ~ {{ ace_evals[-1].year }} {{ ace_evals[-1].quarter[:3] }}
                            {% else %}
                            -
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¶„ê¸° ì„ íƒ (ACE í‰ê°€ê°€ ìˆëŠ” ê²½ìš°ë§Œ) -->
    {% if ace_evals %}
    <div class="card-momo mb-4 no-print">
        <div class="flex items-center gap-4">
            <label for="quarterSelect" class="text-sm font-bold text-gray-700 whitespace-nowrap">ğŸ“… ë¶„ê¸° ì„ íƒ</label>
            <select id="quarterSelect"
                    class="select-momo flex-1"
                    onchange="window.location.href='{{ url_for('teacher.ace_report', student_id=student.student_id) }}?quarter_idx=' + this.value"
                    style="max-width: 300px;">
                {% for eval in ace_evals %}
                <option value="{{ loop.index0 }}" {{ 'selected' if loop.index0 == selected_quarter_idx else '' }}>
                    {{ eval.year }}ë…„ {{ eval.quarter }} (ì´ì : {{ eval.get_total_score() }}/75)
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% endif %}

    <!-- ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„  -->
    {% if weekly_evals %}
    <div class="card-momo mb-4">
        <h3 class="text-base font-bold mb-1">ğŸ“ˆ ì£¼ì°¨ë³„ ì²¨ì‚­ ì ìˆ˜ ì¶”ì´</h3>
        <p class="text-xs text-gray-500 mb-3">ìµœê·¼ {{ weekly_evals|length }}ì£¼ ê¸°ë¡</p>

        <div class="chart-wrap short">
            <canvas id="growthChart"></canvas>
        </div>

        <table class="table-momo w-full mt-4">
            <thead>
                <tr>
                    <th>ì£¼ì°¨</th>
                    <th>ë„ì„œ</th>
                    <th>ì ìˆ˜</th>
                    <th>ë“±ê¸‰</th>
                    <th>ê°•ì‚¬ ì½”ë©˜íŠ¸</th>
                </tr>
            </thead>
            <tbody>
                {% for eval in weekly_evals|reverse %}
                <tr>
                    <td>{{ eval.week_number }}ì£¼</td>
                    <td>{{ eval.book_title or '-' }}</td>
                    <td class="mono font-bold" style="color: {{ '#10B981' if eval.score >= 80 else '#F59E0B' if eval.score >= 60 else '#EF4444' }}">
                        {{ eval.score }}
                    </td>
                    <td>
                        <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3B82F6;">
                            {{ eval.grade }}
                        </span>
                    </td>
                    <td class="text-sm text-gray-600">{{ eval.comment or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- ACE ë¶„ê¸° í‰ê°€ -->
    {% if selected_ace %}
    <div class="card-momo mb-4">
        <h3 class="text-base font-bold mb-1">ğŸ† ACE ë¶„ê¸° í‰ê°€ â€” {{ selected_ace.year }} {{ selected_ace.quarter }}</h3>
        <p class="text-xs text-gray-500 mb-3">5ê°œ ì¶• 15ê°œ í•­ëª© í‰ê°€ ê²°ê³¼</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- ë ˆì´ë” ì°¨íŠ¸ -->
            <div>
                <div class="chart-wrap">
                    <canvas id="aceRadar"></canvas>
                </div>
            </div>

            <!-- í•­ëª©ë³„ ì ìˆ˜ í…Œì´ë¸” -->
            <div>
                <table class="table-momo w-full">
                    <thead>
                        <tr>
                            <th>í‰ê°€ ì¶•</th>
                            <th>í•­ëª©</th>
                            <th>ë“±ê¸‰</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for axis in ace_axes %}
                        {% for item in axis['items'] %}
                        <tr>
                            {% if loop.index0 == 0 %}
                            <td rowspan="{{ axis['items']|length }}" class="font-bold" style="color: {{ axis.color }}; vertical-align: middle;">
                                {{ axis.name }}
                            </td>
                            {% endif %}
                            <td>{{ item.name }}</td>
                            <td>
                                {% set grade = selected_ace.scores.get(item.name, 'ì¤‘') %}
                                <span class="badge" style="background: {{ '#ECFDF5' if grade == 'íŠ¹' else '#EFF6FF' if grade == 'ìƒ' else '#FFFBEB' if grade == 'ì¤‘' else '#FFF7ED' if grade == 'í•˜' else '#FEF2F2' }};
                                                       color: {{ '#059669' if grade == 'íŠ¹' else '#2563EB' if grade == 'ìƒ' else '#D97706' if grade == 'ì¤‘' else '#EA580C' if grade == 'í•˜' else '#DC2626' }};">
                                    {{ grade }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ì¢…í•© ì˜ê²¬ -->
        {% if selected_ace.comment %}
        <div class="mt-4 p-4 bg-light rounded-xl text-sm text-gray-700">
            <strong>ì¢…í•© ì˜ê²¬:</strong> {{ selected_ace.comment }}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ë¶„ê¸°ë³„ ê¸€ì“°ê¸° ì„±ì  ì¶”ì´ -->
    {% if weekly_evals and ace_evals %}
    <div class="card-momo mb-4">
        <h3 class="text-base font-bold mb-1">âœï¸ ë¶„ê¸°ë³„ ê¸€ì“°ê¸° ì„±ì  ì¶”ì´</h3>
        <p class="text-xs text-gray-500 mb-3">í‰ê°€ ê¸°ê°„ ë‚´ ì£¼ì°¨ë³„ ê¸€ì“°ê¸° ì ìˆ˜ ë³€í™”</p>

        <div style="position: relative; width: 100%; height: 320px;">
            <canvas id="quarterlyWritingChart"></canvas>
        </div>

        <!-- ë¶„ê¸°ë³„ í‰ê·  ì ìˆ˜ ìš”ì•½ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
            {% for eval in ace_evals %}
            <div class="text-center p-3 rounded-lg" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);">
                <div class="text-xs text-gray-600 mb-1">{{ eval.year }} {{ eval.quarter[:3] }}</div>
                <div class="text-2xl font-bold text-purple-600 mono" id="avg-score-{{ loop.index0 }}">-</div>
                <div class="text-xs text-gray-500">í‰ê· </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- ACE ë¶„ê¸°ë³„ ë¹„êµ (2ê°œ ì´ìƒì¼ ë•Œ) -->
    {% if ace_evals|length >= 2 %}
    <div class="card-momo mb-4">
        <h3 class="text-base font-bold mb-1">ğŸ“Š ë¶„ê¸°ë³„ ì„±ì¥ ë¹„êµ (ë ˆì´ë”)</h3>
        <p class="text-xs text-gray-500 mb-3">ACE í‰ê°€ ë¶„ê¸° ê°„ ë¹„êµ</p>

        <div class="chart-wrap short">
            <canvas id="aceOverlay"></canvas>
        </div>
    </div>

    <!-- ì˜ì—­ë³„ ë¶„ê¸° ì„±ì¥ ì¶”ì´ (ë§‰ëŒ€ê·¸ë˜í”„) -->
    <div class="card-momo mb-4">
        <h3 class="text-base font-bold mb-1">ğŸ“Š ì˜ì—­ë³„ ë¶„ê¸° ì„±ì¥ ì¶”ì´</h3>
        <p class="text-xs text-gray-500 mb-3">5ê°œ ì˜ì—­ì˜ ë¶„ê¸°ë³„ ì ìˆ˜ ë³€í™”</p>

        <div style="position: relative; width: 100%; height: 380px;">
            <canvas id="axisGrowthBar"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- ë¶„ê¸°ë³„ ê°•ì‚¬ ì½”ë©˜íŠ¸ ì´ë ¥ -->
    {% if ace_evals %}
    <div class="card-momo mb-4">
        <h3 class="text-base font-bold mb-1">ğŸ’¬ ë¶„ê¸°ë³„ ê°•ì‚¬ ì½”ë©˜íŠ¸ ì´ë ¥</h3>
        <p class="text-xs text-gray-500 mb-3">ë¶„ê¸°ë³„ ì¢…í•© í‰ê°€ ë° ì„±ì¥ ê¸°ë¡</p>

        <div class="timeline">
            {% for eval in ace_evals|reverse %}
            <div class="timeline-item">
                <div class="timeline-qtr">
                    {{ eval.quarter }}
                    <span class="timeline-year">{{ eval.year }} Â· {{ eval.teacher.name if eval.teacher else 'ê°•ì‚¬' }}</span>
                </div>
                <div class="timeline-comment">{{ eval.comment or 'ì½”ë©˜íŠ¸ ì—†ìŒ' }}</div>
                <div class="timeline-scores">
                    {% for axis in ace_axes %}
                    <span style="color: {{ axis.color }}; font-weight: 600;">
                        {{ axis.name[:2] }}
                    </span>
                    {{ "%.1f"|format(eval.get_axis_average(axis.item_names)) }}{{ ' Â· ' if not loop.last else '' }}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- í‘¸í„° -->
    <div class="text-center py-5 text-xs text-gray-500">
        ë³¸ ë¦¬í¬íŠ¸ëŠ” ëª¨ëª¨ì˜ ì±…ì¥ì—ì„œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
    </div>

</div>

<script>
// ì£¼ì°¨ë³„ ì„±ì¥ ê³¡ì„ 
{% if weekly_evals %}
const growthCtx = document.getElementById('growthChart');
if (growthCtx) {
    new Chart(growthCtx, {
        type: 'line',
        data: {
            labels: [{% for eval in weekly_evals %}'{{ eval.week_number }}ì£¼'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [{
                label: 'ì ìˆ˜',
                data: [{% for eval in weekly_evals %}{{ eval.score }}{{ ',' if not loop.last else '' }}{% endfor %}],
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#3B82F6',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { min: 0, max: 100, grid: { color: '#F1F5F9' } },
                x: { grid: { display: false } }
            }
        }
    });
}
{% endif %}

// ACE ë ˆì´ë” ì°¨íŠ¸
{% if selected_ace %}
const aceCtx = document.getElementById('aceRadar');
if (aceCtx) {
    new Chart(aceCtx, {
        type: 'radar',
        data: {
            labels: [{% for axis in ace_axes %}'{{ axis.name }}'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [{
                data: [{% for axis in ace_axes %}{{ "%.1f"|format(selected_ace.get_axis_average(axis.item_names)) }}{{ ',' if not loop.last else '' }}{% endfor %}],
                backgroundColor: 'rgba(59, 130, 246, 0.12)',
                borderColor: '#3B82F6',
                borderWidth: 2.5,
                pointBackgroundColor: '#3B82F6',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                r: {
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        font: { size: 10 },
                        backdropColor: 'transparent'
                    },
                    grid: { color: '#E2E8F0' },
                    pointLabels: { font: { size: 11 } }
                }
            }
        }
    });
}
{% endif %}

// ë¶„ê¸°ë³„ ë¹„êµ (ì˜¤ë²„ë ˆì´ ë ˆì´ë”)
{% if ace_evals|length >= 2 %}
const overlayCtx = document.getElementById('aceOverlay');
if (overlayCtx) {
    const OVERLAY_COLORS = ['rgba(59,130,246,0.5)', 'rgba(16,185,129,0.5)', 'rgba(139,92,246,0.5)', 'rgba(245,158,11,0.5)'];
    new Chart(overlayCtx, {
        type: 'radar',
        data: {
            labels: [{% for axis in ace_axes %}'{{ axis.name }}'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [
                {% for eval in ace_evals %}
                {
                    label: '{{ eval.year }} {{ eval.quarter[:3] }}',
                    data: [{% for axis in ace_axes %}{{ "%.1f"|format(eval.get_axis_average(axis.item_names)) }}{{ ',' if not loop.last else '' }}{% endfor %}],
                    backgroundColor: OVERLAY_COLORS[{{ loop.index0 }} % 4].replace('0.5', '0.08'),
                    borderColor: OVERLAY_COLORS[{{ loop.index0 }} % 4],
                    borderWidth: 2.5,
                    pointRadius: 4,
                    pointBackgroundColor: OVERLAY_COLORS[{{ loop.index0 }} % 4].replace('0.5', '1')
                }{{ ',' if not loop.last else '' }}
                {% endfor %}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        font: { size: 11, family: 'Noto Sans KR' },
                        usePointStyle: true
                    }
                }
            },
            scales: {
                r: {
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        font: { size: 10 },
                        backdropColor: 'transparent'
                    },
                    grid: { color: '#E2E8F0' },
                    pointLabels: { font: { size: 11 } }
                }
            }
        }
    });
}

// ì˜ì—­ë³„ ë¶„ê¸° ì„±ì¥ ì¶”ì´ (ë§‰ëŒ€ê·¸ë˜í”„) - ì˜ì—­ë³„ë¡œ ë¶„ê¸° ë°ì´í„° í‘œì‹œ
const barCtx = document.getElementById('axisGrowthBar');
if (barCtx) {
    const quarterColors = ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(236, 72, 153, 0.8)'];

    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: [{% for axis in ace_axes %}'{{ axis.name }}'{{ ',' if not loop.last else '' }}{% endfor %}],
            datasets: [
                {% for eval in ace_evals %}
                {
                    label: '{{ eval.year }} {{ eval.quarter[:3] }}',
                    data: [{% for axis in ace_axes %}{{ "%.1f"|format(eval.get_axis_average(axis.item_names)) }}{{ ',' if not loop.last else '' }}{% endfor %}],
                    backgroundColor: quarterColors[{{ loop.index0 }} % quarterColors.length],
                    borderColor: quarterColors[{{ loop.index0 }} % quarterColors.length].replace('0.8', '1'),
                    borderWidth: 1,
                    borderRadius: 6,
                    barThickness: 28
                }{{ ',' if not loop.last else '' }}
                {% endfor %}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { size: 12, family: 'Noto Sans KR', weight: '600' },
                        usePointStyle: true,
                        padding: 18,
                        boxWidth: 12,
                        boxHeight: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + 'ì ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 0.5,
                        font: { size: 12 }
                    },
                    grid: {
                        color: '#E2E8F0',
                        lineWidth: 1
                    },
                    title: {
                        display: true,
                        text: 'ì ìˆ˜ (0-5)',
                        font: { size: 13, weight: 'bold', family: 'Noto Sans KR' },
                        padding: { top: 10, bottom: 10 }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 12, weight: '600', family: 'Noto Sans KR' }
                    },
                    title: {
                        display: true,
                        text: 'ACE 5ê°œ ì˜ì—­',
                        font: { size: 13, weight: 'bold', family: 'Noto Sans KR' },
                        padding: { top: 10, bottom: 5 }
                    }
                }
            }
        }
    });
}

// ë¶„ê¸°ë³„ ê¸€ì“°ê¸° ì„±ì  ì¶”ì´
{% if weekly_evals and ace_evals %}
const quarterlyWritingCtx = document.getElementById('quarterlyWritingChart');
if (quarterlyWritingCtx) {
    // ë¶„ê¸° ì •ë³´ íŒŒì‹±
    const quarterMap = {
        '1ë¶„ê¸° (12~2ì›”)': { start: 12, end: 2 },
        '2ë¶„ê¸° (3~5ì›”)': { start: 3, end: 5 },
        '3ë¶„ê¸° (6~8ì›”)': { start: 6, end: 8 },
        '4ë¶„ê¸° (9~11ì›”)': { start: 9, end: 11 }
    };

    // ì£¼ì°¨ í‰ê°€ë¥¼ ë¶„ê¸°ë³„ë¡œ ê·¸ë£¹í™”
    const weeklyByQuarter = {};
    const quarterColors = ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(245, 158, 11, 0.8)'];

    {% for eval in ace_evals %}
    const quarter{{ loop.index0 }} = '{{ eval.year }} {{ eval.quarter }}';
    const year{{ loop.index0 }} = {{ eval.year }};
    const qInfo{{ loop.index0 }} = quarterMap['{{ eval.quarter }}'];
    weeklyByQuarter[quarter{{ loop.index0 }}] = [];

    {% for weekly in weekly_evals %}
    const evalDate{{ loop.index0 }}_{{ loop.parent.loop.index0 }} = new Date('{{ weekly.eval_date.strftime("%Y-%m-%d") }}');
    const evalMonth = evalDate{{ loop.index0 }}_{{ loop.parent.loop.index0 }}.getMonth() + 1;
    const evalYear = evalDate{{ loop.index0 }}_{{ loop.parent.loop.index0 }}.getFullYear();

    if (evalYear === year{{ loop.parent.loop.index0 }}) {
        if ((qInfo{{ loop.parent.loop.index0 }}.start <= qInfo{{ loop.parent.loop.index0 }}.end && evalMonth >= qInfo{{ loop.parent.loop.index0 }}.start && evalMonth <= qInfo{{ loop.parent.loop.index0 }}.end) ||
            (qInfo{{ loop.parent.loop.index0 }}.start > qInfo{{ loop.parent.loop.index0 }}.end && (evalMonth >= qInfo{{ loop.parent.loop.index0 }}.start || evalMonth <= qInfo{{ loop.parent.loop.index0 }}.end))) {
            weeklyByQuarter[quarter{{ loop.parent.loop.index0 }}].push({
                week: {{ weekly.week_number }},
                score: {{ weekly.score }},
                date: '{{ weekly.eval_date.strftime("%m/%d") }}'
            });
        }
    }
    {% endfor %}
    {% endfor %}

    // ì°¨íŠ¸ ë°ì´í„°ì…‹ ìƒì„±
    const datasets = [];
    let datasetIndex = 0;
    for (const [quarter, data] of Object.entries(weeklyByQuarter)) {
        if (data.length > 0) {
            // í‰ê·  ê³„ì‚°
            const avg = data.reduce((sum, d) => sum + d.score, 0) / data.length;
            const avgEl = document.getElementById('avg-score-' + datasetIndex);
            if (avgEl) avgEl.textContent = avg.toFixed(1);

            datasets.push({
                label: quarter,
                data: data.map(d => d.score),
                borderColor: quarterColors[datasetIndex % quarterColors.length],
                backgroundColor: quarterColors[datasetIndex % quarterColors.length].replace('0.8', '0.1'),
                fill: false,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: '#fff',
                pointBorderColor: quarterColors[datasetIndex % quarterColors.length],
                pointBorderWidth: 2.5,
                borderWidth: 3
            });
        }
        datasetIndex++;
    }

    // ì°¨íŠ¸ ìƒì„±
    new Chart(quarterlyWritingCtx, {
        type: 'line',
        data: {
            labels: Array.from({length: Math.max(...Object.values(weeklyByQuarter).map(d => d.length))}, (_, i) => `${i + 1}ì£¼ì°¨`),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { size: 12, family: 'Noto Sans KR', weight: '600' },
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + 'ì ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    ticks: {
                        stepSize: 10,
                        font: { size: 11 }
                    },
                    grid: { color: '#E2E8F0' },
                    title: {
                        display: true,
                        text: 'ì ìˆ˜ (0-100)',
                        font: { size: 12, weight: 'bold', family: 'Noto Sans KR' }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: {
                        font: { size: 11 }
                    },
                    title: {
                        display: true,
                        text: 'ì£¼ì°¨',
                        font: { size: 12, weight: 'bold', family: 'Noto Sans KR' }
                    }
                }
            }
        }
    });
}
{% endif %}
{% endif %}
</script>

{% endblock %}
