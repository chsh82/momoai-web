{% extends "base.html" %}

{% block title %}ì£¼ê°„í‰ê°€ ì „ì²´ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block page_title %}ğŸ“Š ì£¼ê°„í‰ê°€ ì „ì²´ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ì „ì²´ í•™ìƒ ë¹„êµ ë¶„ì„</span>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">

    <!-- ìƒë‹¨ ë²„íŠ¼ -->
    <div class="flex justify-between items-center mb-6">
        <a href="{{ url_for('teacher.ace_weekly') }}" class="btn btn-outline">
            â† ì£¼ê°„ í‰ê°€ë¡œ
        </a>
        <h2 class="text-2xl font-bold text-gray-800">ì£¼ê°„í‰ê°€ ì „ì²´ ëŒ€ì‹œë³´ë“œ</h2>
        <div></div>
    </div>

    {% if student_stats %}
    <!-- í•™ìƒ ì„ íƒ ì¹´ë“œ -->
    <div class="card-momo mb-6">
        <h3 class="text-card-title mb-4">ğŸ‘©â€ğŸ“ í•™ìƒ ì„ íƒ (ê°œë³„ ë¦¬í¬íŠ¸ ë³´ê¸°)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
            {% for stat in student_stats %}
            <div class="card-momo-sm student-card-selectable"
                 onclick="window.location.href='{{ url_for('teacher.ace_weekly_report', student_id=stat.student.student_id) }}'">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                        {{ stat.student.name[0] }}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-base">{{ stat.student.name }}</div>
                        <div class="text-sm text-gray-500">{{ stat.student.grade }}</div>
                    </div>
                </div>

                <div class="flex gap-2 mt-2 flex-wrap">
                    {% if stat.eval_count > 0 %}
                    <span class="badge badge-blue">í‰ê°€ {{ stat.eval_count }}ê±´</span>
                    {% endif %}
                    {% if stat.avg_score %}
                    <span class="badge badge-green">í‰ê·  {{ stat.avg_score }}ì </span>
                    {% endif %}
                    {% if stat.growth_rate != 0 %}
                    <span class="badge {{ 'badge-purple' if stat.growth_rate > 0 else 'badge-red' }}">
                        {{ stat.growth_rate }}%
                        {% if stat.growth_rate > 0 %}â†‘{% else %}â†“{% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        <p class="text-sm text-gray-500 mt-4 text-center">ğŸ’¡ í•™ìƒ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ê°œë³„ ë¦¬í¬íŠ¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤</p>
    </div>
    <!-- ì „ì²´ í†µê³„ ìš”ì•½ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card-momo text-center">
            <div class="text-3xl mb-2">ğŸ‘¥</div>
            <div class="text-3xl font-bold text-blue-600">{{ student_stats|length }}</div>
            <div class="text-sm text-gray-600 mt-1">ë‹´ë‹¹ í•™ìƒ ìˆ˜</div>
        </div>

        <div class="card-momo text-center">
            <div class="text-3xl mb-2">ğŸ“</div>
            <div class="text-3xl font-bold text-green-600">
                {{ (student_stats|sum(attribute='eval_count'))|int }}
            </div>
            <div class="text-sm text-gray-600 mt-1">ì´ í‰ê°€ íšŸìˆ˜</div>
        </div>

        <div class="card-momo text-center">
            <div class="text-3xl mb-2">ğŸ“ˆ</div>
            <div class="text-3xl font-bold text-purple-600">
                {{ "%.1f"|format((student_stats|sum(attribute='avg_score') / student_stats|length)) }}
            </div>
            <div class="text-sm text-gray-600 mt-1">ì „ì²´ í‰ê·  ì ìˆ˜</div>
        </div>
    </div>

    <!-- í•™ìƒë³„ í‰ê·  ì ìˆ˜ ë¹„êµ -->
    <div class="card-momo mb-6">
        <h3 class="text-card-title mb-4">ğŸ“Š í•™ìƒë³„ í‰ê·  ì ìˆ˜ ë¹„êµ</h3>
        <div style="height: 400px;">
            <canvas id="scoreComparisonChart"></canvas>
        </div>
    </div>

    <!-- ì°¸ì—¬ë„/ì´í•´ë„ ë¹„êµ -->
    <div class="card-momo mb-6">
        <h3 class="text-card-title mb-4">â­ í•™ìƒë³„ ì°¸ì—¬ë„/ì´í•´ë„ í‰ê· </h3>
        <div style="height: 400px;">
            <canvas id="ratingComparisonChart"></canvas>
        </div>
    </div>

    <!-- ì„±ì¥ë¥  ìˆœìœ„ -->
    <div class="card-momo mb-6">
        <h3 class="text-card-title mb-4">ğŸ† ìµœê·¼ ì„±ì¥ë¥  ìˆœìœ„ (Top 10)</h3>
        <div class="overflow-x-auto">
            <table class="table-momo w-full">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>í•™ìƒëª…</th>
                        <th>í•™ë…„</th>
                        <th>í‰ê°€ íšŸìˆ˜</th>
                        <th>í‰ê·  ì ìˆ˜</th>
                        <th>í‰ê·  ì°¸ì—¬ë„</th>
                        <th>í‰ê·  ì´í•´ë„</th>
                        <th>ì„±ì¥ë¥ </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in student_stats[:10] %}
                    <tr>
                        <td class="font-bold text-lg">
                            {% if loop.index == 1 %}ğŸ¥‡
                            {% elif loop.index == 2 %}ğŸ¥ˆ
                            {% elif loop.index == 3 %}ğŸ¥‰
                            {% else %}{{ loop.index }}{% endif %}
                        </td>
                        <td class="font-semibold">{{ stat.student.name }}</td>
                        <td>{{ stat.student.grade }}</td>
                        <td>{{ stat.eval_count }}íšŒ</td>
                        <td class="font-bold" style="color: {{ '#10B981' if stat.avg_score >= 80 else '#F59E0B' if stat.avg_score >= 60 else '#EF4444' }}">
                            {{ stat.avg_score }}ì 
                        </td>
                        <td class="text-center">
                            <span class="text-yellow-500">
                                {% for i in range(stat.avg_participation|int) %}â˜…{% endfor %}
                                {% for i in range(5 - (stat.avg_participation|int)) %}â˜†{% endfor %}
                            </span>
                            <span class="text-xs text-gray-600 ml-1">{{ stat.avg_participation }}</span>
                        </td>
                        <td class="text-center">
                            <span class="text-yellow-500">
                                {% for i in range(stat.avg_understanding|int) %}â˜…{% endfor %}
                                {% for i in range(5 - (stat.avg_understanding|int)) %}â˜†{% endfor %}
                            </span>
                            <span class="text-xs text-gray-600 ml-1">{{ stat.avg_understanding }}</span>
                        </td>
                        <td class="font-bold {{ 'text-green-600' if stat.growth_rate > 0 else 'text-red-600' if stat.growth_rate < 0 else 'text-gray-600' }}">
                            {{ stat.growth_rate }}%
                            {% if stat.growth_rate > 0 %}â†‘
                            {% elif stat.growth_rate < 0 %}â†“
                            {% else %}â†’{% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('teacher.ace_weekly_report', student_id=stat.student.student_id) }}"
                               class="btn btn-sm btn-primary">
                                ìƒì„¸ë³´ê¸°
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ì „ì²´ í•™ìƒ ëª©ë¡ -->
    <div class="card-momo">
        <h3 class="text-card-title mb-4">ğŸ“‹ ì „ì²´ í•™ìƒ ëª©ë¡</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for stat in student_stats %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition duration-200">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-lg">
                        {{ stat.student.name[0] }}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">{{ stat.student.name }}</h4>
                        <p class="text-sm text-gray-600">{{ stat.student.grade }}</p>
                    </div>
                </div>

                <div class="space-y-1 text-sm mb-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">í‰ê°€ íšŸìˆ˜:</span>
                        <span class="font-semibold">{{ stat.eval_count }}íšŒ</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">í‰ê·  ì ìˆ˜:</span>
                        <span class="font-semibold">{{ stat.avg_score }}ì </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">ì„±ì¥ë¥ :</span>
                        <span class="font-semibold {{ 'text-green-600' if stat.growth_rate > 0 else 'text-red-600' if stat.growth_rate < 0 else 'text-gray-600' }}">
                            {{ stat.growth_rate }}%
                        </span>
                    </div>
                </div>

                <a href="{{ url_for('teacher.ace_weekly_report', student_id=stat.student.student_id) }}"
                   class="btn btn-sm btn-primary w-full">
                    ğŸ“Š ë¦¬í¬íŠ¸ ë³´ê¸°
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    {% else %}
    <div class="card-momo text-center py-12">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <p class="text-gray-600 text-lg">ì•„ì§ í‰ê°€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}

</div>

<script>
{% if student_stats %}
// ë°ì´í„° ì¤€ë¹„
const studentNames = [{% for stat in student_stats %}'{{ stat.student.name }}'{{ ',' if not loop.last else '' }}{% endfor %}];
const avgScores = [{% for stat in student_stats %}{{ stat.avg_score }}{{ ',' if not loop.last else '' }}{% endfor %}];
const avgParticipation = [{% for stat in student_stats %}{{ stat.avg_participation }}{{ ',' if not loop.last else '' }}{% endfor %}];
const avgUnderstanding = [{% for stat in student_stats %}{{ stat.avg_understanding }}{{ ',' if not loop.last else '' }}{% endfor %}];

// í•™ìƒë³„ í‰ê·  ì ìˆ˜ ë¹„êµ
const scoreCompCtx = document.getElementById('scoreComparisonChart').getContext('2d');
new Chart(scoreCompCtx, {
    type: 'bar',
    data: {
        labels: studentNames,
        datasets: [{
            label: 'í‰ê·  ì ìˆ˜',
            data: avgScores,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: '#3B82F6',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: 'ì ìˆ˜'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// ì°¸ì—¬ë„/ì´í•´ë„ ë¹„êµ
const ratingCompCtx = document.getElementById('ratingComparisonChart').getContext('2d');
new Chart(ratingCompCtx, {
    type: 'bar',
    data: {
        labels: studentNames,
        datasets: [
            {
                label: 'ì°¸ì—¬ë„',
                data: avgParticipation,
                backgroundColor: 'rgba(245, 158, 11, 0.6)',
                borderColor: '#F59E0B',
                borderWidth: 2
            },
            {
                label: 'ì´í•´ë„',
                data: avgUnderstanding,
                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                borderColor: '#8B5CF6',
                borderWidth: 2
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 5,
                ticks: {
                    stepSize: 1
                },
                title: {
                    display: true,
                    text: 'ë³„ì '
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            }
        }
    }
});
{% endif %}
</script>

{% endblock %}
