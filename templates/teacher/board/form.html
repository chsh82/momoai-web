{% extends "base.html" %}

{% block title %}{% if board %}ê¸€ ìˆ˜ì •{% else %}ê¸€ ì‘ì„±{% endif %} - ê°•ì‚¬ ê²Œì‹œíŒ{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% if board %}{{ url_for('teacher.board_detail', board_id=board.board_id) }}{% else %}{{ url_for('teacher.board') }}{% endif %}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† {% if board %}ë’¤ë¡œê°€ê¸°{% else %}ëª©ë¡ìœ¼ë¡œ{% endif %}
        </a>
        <h2 class="text-3xl font-bold text-gray-800">
            {% if board %}âœï¸ ê¸€ ìˆ˜ì •{% else %}âœï¸ ê¸€ ì‘ì„±{% endif %}
        </h2>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700 border border-red-300{% elif category == 'success' %}bg-green-100 text-green-700 border border-green-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Form -->
    <form method="POST" enctype="multipart/form-data" class="bg-white rounded-lg shadow p-8">
        <!-- ì œëª© -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                ì œëª© <span class="text-red-500">*</span>
            </label>
            <input type="text"
                   name="title"
                   value="{% if board %}{{ board.title }}{% endif %}"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                   required>
        </div>

        <!-- ê³µì§€ì‚¬í•­ ì—¬ë¶€ (ê´€ë¦¬ìë§Œ) -->
        {% if current_user.is_admin %}
        <div class="mb-6">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox"
                       name="is_notice"
                       {% if board and board.is_notice %}checked{% endif %}
                       class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                <span class="text-sm font-medium text-gray-700">ê³µì§€ì‚¬í•­ìœ¼ë¡œ ë“±ë¡</span>
            </label>
        </div>
        {% endif %}

        <!-- ë‚´ìš© -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                ë‚´ìš© <span class="text-red-500">*</span>
            </label>
            <div class="border border-gray-300 rounded-lg overflow-hidden">
                <!-- ì—ë””í„° íˆ´ë°” -->
                <div class="bg-gray-50 border-b border-gray-300 px-4 py-2 flex gap-2">
                    <button type="button" onclick="execCommand('bold')" class="px-3 py-1 hover:bg-gray-200 rounded transition" title="êµµê²Œ">
                        <strong>B</strong>
                    </button>
                    <button type="button" onclick="execCommand('italic')" class="px-3 py-1 hover:bg-gray-200 rounded transition" title="ê¸°ìš¸ì„">
                        <em>I</em>
                    </button>
                    <button type="button" onclick="execCommand('underline')" class="px-3 py-1 hover:bg-gray-200 rounded transition" title="ë°‘ì¤„">
                        <u>U</u>
                    </button>
                    <div class="border-l border-gray-300 mx-2"></div>
                    <button type="button" onclick="execCommand('insertUnorderedList')" class="px-3 py-1 hover:bg-gray-200 rounded transition" title="ê¸€ë¨¸ë¦¬ ê¸°í˜¸">
                        â‹¯
                    </button>
                    <button type="button" onclick="execCommand('insertOrderedList')" class="px-3 py-1 hover:bg-gray-200 rounded transition" title="ë²ˆí˜¸ ë§¤ê¸°ê¸°">
                        1.
                    </button>
                    <div class="border-l border-gray-300 mx-2"></div>
                    <button type="button" onclick="insertImage()" class="px-3 py-1 hover:bg-gray-200 rounded transition" title="ì´ë¯¸ì§€ ì‚½ì…">
                        ğŸ–¼ï¸
                    </button>
                    <span class="text-xs text-gray-500 ml-auto self-center">Ctrl+Vë¡œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥</span>
                </div>

                <!-- ì—ë””í„° -->
                <div id="editor"
                     contenteditable="true"
                     class="px-4 py-3 min-h-[400px] focus:outline-none prose max-w-none"
                     placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. ì´ë¯¸ì§€ëŠ” Ctrl+Vë¡œ ë¶™ì—¬ë„£ê±°ë‚˜ ë“œë˜ê·¸ì•¤ë“œë¡­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">{% if board %}{{ board.content | safe }}{% endif %}</div>

                <!-- Hidden field to store HTML content -->
                <input type="hidden" name="content" id="content">
            </div>
            <p class="text-xs text-gray-500 mt-2">
                ğŸ’¡ ì´ë¯¸ì§€ë¥¼ ë³µì‚¬(Ctrl+C)í•œ í›„ ì—ë””í„°ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ë©´ ìë™ìœ¼ë¡œ ì—…ë¡œë“œë©ë‹ˆë‹¤.
            </p>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                ì²¨ë¶€íŒŒì¼ (ìµœëŒ€ 10ê°œ)
            </label>

            {% if board and board.attachments.count() > 0 %}
            <!-- ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm font-medium text-gray-700 mb-3">í˜„ì¬ ì²¨ë¶€íŒŒì¼</p>
                <div class="space-y-2">
                    {% for attachment in board.attachments %}
                    <label class="flex items-center gap-3 p-2 hover:bg-gray-100 rounded cursor-pointer">
                        <input type="checkbox" name="delete_attachments" value="{{ attachment.attachment_id }}" class="w-4 h-4">
                        <span class="text-sm text-gray-700">{{ attachment.original_filename }}</span>
                        <span class="text-xs text-gray-500">({{ (attachment.file_size / 1024) | round(1) }} KB)</span>
                        <span class="text-xs text-red-500 ml-auto">ì²´í¬í•˜ë©´ ì‚­ì œë¨</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- ìƒˆ íŒŒì¼ ì„ íƒ -->
            <input type="file"
                   name="attachments"
                   multiple
                   accept="*/*"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                   onchange="updateFileList(this)">
            <p class="text-xs text-gray-500 mt-2" id="fileListInfo">
                ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ 10ê°œ, íŒŒì¼ë‹¹ ìµœëŒ€ 32MB)
            </p>
        </div>

        <!-- ì•ˆë‚´ì‚¬í•­ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <div class="text-blue-600 text-xl mr-3">â„¹ï¸</div>
                <div class="text-sm text-blue-800">
                    <p class="font-medium mb-1">ì‘ì„± ì•ˆë‚´</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>ì´ë¯¸ì§€ëŠ” í´ë¦½ë³´ë“œì—ì„œ ì§ì ‘ ë¶™ì—¬ë„£ê¸°(Ctrl+V) ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>ì´ë¯¸ì§€ íŒŒì¼ì„ ì—ë””í„°ì— ë“œë˜ê·¸ì•¤ë“œë¡­í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤</li>
                        <li>ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 10ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>ì‘ì„±í•œ ê¸€ì€ ëª¨ë“  ê°•ì‚¬ì™€ ê´€ë¦¬ìê°€ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="flex gap-3">
            <button type="submit"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                {% if board %}ìˆ˜ì •í•˜ê¸°{% else %}ë“±ë¡í•˜ê¸°{% endif %}
            </button>
            <a href="{% if board %}{{ url_for('teacher.board_detail', board_id=board.board_id) }}{% else %}{{ url_for('teacher.board') }}{% endif %}"
               class="flex-1 text-center bg-gray-400 hover:bg-gray-500 text-white font-medium py-3 rounded-lg transition duration-200">
                ì·¨ì†Œ
            </a>
        </div>
    </form>
</div>

<!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ hidden input -->
<input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">

<script>
// ì—ë””í„° placeholder ì²˜ë¦¬
const editor = document.getElementById('editor');
editor.addEventListener('focus', function() {
    if (this.textContent.trim() === '') {
        this.textContent = '';
    }
});

// í¼ ì œì¶œ ì‹œ ì—ë””í„° ë‚´ìš©ì„ hidden fieldì— ë³µì‚¬
document.querySelector('form').addEventListener('submit', function(e) {
    const content = editor.innerHTML.trim();
    if (!content || content === '<br>') {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        e.preventDefault();
        return;
    }
    document.getElementById('content').value = content;
});

// ì—ë””í„° ëª…ë ¹ ì‹¤í–‰
function execCommand(command) {
    document.execCommand(command, false, null);
    editor.focus();
}

// ì´ë¯¸ì§€ ì‚½ì… ë²„íŠ¼
function insertImage() {
    document.getElementById('imageInput').click();
}

// íŒŒì¼ ì„ íƒ ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
function handleImageSelect(input) {
    if (input.files && input.files[0]) {
        uploadImage(input.files[0]);
    }
}

// í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸
editor.addEventListener('paste', function(e) {
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;

    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            const blob = items[i].getAsFile();
            uploadImage(blob);
            return;
        }
    }
});

// ë“œë˜ê·¸ì•¤ë“œë¡­
editor.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.backgroundColor = '#f0f9ff';
});

editor.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.backgroundColor = '';
});

editor.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.backgroundColor = '';

    const files = e.dataTransfer.files;
    for (let i = 0; i < files.length; i++) {
        if (files[i].type.indexOf('image') !== -1) {
            uploadImage(files[i]);
        }
    }
});

// ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜
function uploadImage(file) {
    const formData = new FormData();
    formData.append('image', file);

    // ë¡œë”© í‘œì‹œ
    const loadingSpan = document.createElement('span');
    loadingSpan.textContent = 'ğŸ”„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...';
    loadingSpan.className = 'text-blue-600';
    document.execCommand('insertHTML', false, loadingSpan.outerHTML);

    fetch('{{ url_for("teacher.board_upload_image") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© í…ìŠ¤íŠ¸ ì œê±°
        const loadingElements = editor.querySelectorAll('span');
        loadingElements.forEach(el => {
            if (el.textContent.includes('ì—…ë¡œë“œ ì¤‘')) {
                el.remove();
            }
        });

        if (data.success) {
            // ì´ë¯¸ì§€ ì‚½ì…
            const img = `<img src="${data.url}" alt="uploaded image" style="max-width: 100%; height: auto; margin: 10px 0;">`;
            document.execCommand('insertHTML', false, img);
        } else {
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        console.error(error);
    });
}

// íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
function updateFileList(input) {
    const files = input.files;
    const info = document.getElementById('fileListInfo');

    if (files.length === 0) {
        info.textContent = 'ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (ìµœëŒ€ 10ê°œ, íŒŒì¼ë‹¹ ìµœëŒ€ 32MB)';
        info.className = 'text-xs text-gray-500 mt-2';
    } else if (files.length > 10) {
        info.textContent = `âš ï¸ íŒŒì¼ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. (${files.length}ê°œ ì„ íƒë¨, ìµœëŒ€ 10ê°œ)`;
        info.className = 'text-xs text-red-600 mt-2';
    } else {
        const fileNames = Array.from(files).map(f => f.name).join(', ');
        info.textContent = `âœ… ${files.length}ê°œ íŒŒì¼ ì„ íƒë¨: ${fileNames.length > 100 ? fileNames.substring(0, 100) + '...' : fileNames}`;
        info.className = 'text-xs text-green-600 mt-2';
    }
}
</script>

<style>
#editor:empty:before {
    content: attr(placeholder);
    color: #9ca3af;
}

#editor img {
    max-width: 100%;
    height: auto;
    margin: 10px 0;
    border-radius: 8px;
}

#editor:focus {
    outline: none;
}
</style>
{% endblock %}
