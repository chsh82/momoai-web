{% extends "base.html" %}

{% block title %}{{ assignment.title }} - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('teacher.assignments') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ê³¼ì œ ëª©ë¡ìœ¼ë¡œ
        </a>
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">{{ assignment.title }}</h2>
                {% if assignment.target_student %}
                <span class="inline-flex items-center gap-1 mt-1 text-sm text-orange-700 bg-orange-100 px-2.5 py-0.5 rounded-full">
                    ğŸ‘¤ ê°œë³„ ê³¼ì œ â€” {{ assignment.target_student.name }} ({{ assignment.target_student.grade }})
                </span>
                {% endif %}
            </div>
            <form method="POST" action="{{ url_for('teacher.delete_assignment', assignment_id=assignment.assignment_id) }}"
                  onsubmit="return confirm('ì •ë§ ì´ ê³¼ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                  class="inline flex-shrink-0">
                <button type="submit"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded transition duration-200">
                    ì‚­ì œ
                </button>
            </form>
        </div>
    </div>

    <!-- í†µê³„ -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-center">
                <div class="text-blue-600 text-2xl mb-1">ğŸ‘¥</div>
                <p class="text-sm text-gray-600">ëŒ€ìƒ í•™ìƒ</p>
                <p class="text-2xl font-bold text-blue-600">{{ total_students }}ëª…</p>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-center">
                <div class="text-green-600 text-2xl mb-1">ğŸ“¬</div>
                <p class="text-sm text-gray-600">ì œì¶œ ì™„ë£Œ</p>
                <p class="text-2xl font-bold text-green-600">{{ submitted_count }}ëª…</p>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-center">
                <div class="text-purple-600 text-2xl mb-1">âœ…</div>
                <p class="text-sm text-gray-600">ì±„ì  ì™„ë£Œ</p>
                <p class="text-2xl font-bold text-purple-600">{{ graded_count }}ëª…</p>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-center">
                <div class="text-orange-600 text-2xl mb-1">ğŸ“Š</div>
                <p class="text-sm text-gray-600">ì œì¶œë¥ </p>
                <p class="text-2xl font-bold text-orange-600">{{ assignment.submission_rate }}%</p>
            </div>
        </div>
    </div>

    <!-- ê³¼ì œ ì •ë³´ -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ê³¼ì œ ì •ë³´</h3>
        <div class="grid grid-cols-2 gap-6">
            <div>
                <p class="text-sm text-gray-600 mb-1">ìˆ˜ì—…</p>
                <p class="font-medium text-gray-800">{{ assignment.course.course_name if assignment.course else 'ì „ì²´ í•™ìƒ' }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600 mb-1">ê³¼ì œ ìœ í˜•</p>
                <p class="font-medium text-gray-800">
                    {% if assignment.assignment_type == 'essay' %}ë…¼ìˆ /ì‘ë¬¸
                    {% elif assignment.assignment_type == 'reading' %}ë…ì„œ/ë…í›„ê°
                    {% elif assignment.assignment_type == 'quiz' %}í€´ì¦ˆ/ì‹œí—˜
                    {% else %}í”„ë¡œì íŠ¸{% endif %}
                </p>
            </div>
            <div>
                <p class="text-sm text-gray-600 mb-1">ë‚œì´ë„</p>
                <p class="font-medium text-gray-800">
                    {% if assignment.difficulty == 'easy' %}ì‰¬ì›€
                    {% elif assignment.difficulty == 'hard' %}ì–´ë ¤ì›€
                    {% else %}ë³´í†µ{% endif %}
                </p>
            </div>
            <div>
                <p class="text-sm text-gray-600 mb-1">ë°°ì </p>
                <p class="font-medium text-gray-800">{{ assignment.max_score }}ì </p>
            </div>
            <div>
                <p class="text-sm text-gray-600 mb-1">ë§ˆê°ì¼</p>
                <p class="font-medium text-gray-800">{{ assignment.due_date.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600 mb-1">ìƒíƒœ</p>
                <p class="font-medium {% if assignment.is_overdue %}text-red-600{% else %}text-green-600{% endif %}">
                    {% if assignment.is_overdue %}ë§ˆê°ë¨{% else %}ì§„í–‰ ì¤‘ ({{ assignment.days_until_due }}ì¼ ë‚¨ìŒ){% endif %}
                </p>
            </div>
        </div>
        <div class="mt-4">
            <p class="text-sm text-gray-600 mb-2">ê³¼ì œ ì„¤ëª…</p>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-gray-700 whitespace-pre-wrap">{{ assignment.description }}</p>
            </div>
        </div>
    </div>

    <!-- ì œì¶œë¬¼ ëª©ë¡ -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800">ì œì¶œë¬¼ ëª©ë¡</h3>
            {% if submissions %}
            <span class="text-sm text-gray-500">ì´ {{ submissions|length }}ê±´</span>
            {% endif %}
        </div>
        <div class="divide-y divide-gray-100">
            {% if submissions %}
                {% for submission in submissions %}
                <div class="p-5 hover:bg-gray-50 transition-colors duration-150">
                    <!-- í•™ìƒ ì •ë³´ + ìƒíƒœ í—¤ë” -->
                    <div class="flex items-start justify-between gap-4 mb-3">
                        <div class="flex items-center gap-3 flex-wrap">
                            <h4 class="text-base font-semibold text-gray-800">{{ submission.student.name }}</h4>
                            <span class="text-xs text-gray-500">{{ submission.student.grade }}</span>

                            <!-- ìƒíƒœ ë°°ì§€ -->
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full
                                {% if submission.status == 'draft' %}bg-gray-100 text-gray-700
                                {% elif submission.status == 'submitted' %}bg-yellow-100 text-yellow-800
                                {% elif submission.status == 'graded' %}bg-green-100 text-green-800
                                {% endif %}">
                                {% if submission.status == 'draft' %}ë¯¸ì œì¶œ
                                {% elif submission.status == 'submitted' %}ì±„ì  ëŒ€ê¸°
                                {% elif submission.status == 'graded' %}ì±„ì  ì™„ë£Œ
                                {% endif %}
                            </span>

                            {% if submission.is_late %}
                            <span class="px-2 py-0.5 text-xs font-medium bg-red-100 text-red-700 rounded-full">
                                ì§€ê° ì œì¶œ
                            </span>
                            {% endif %}

                            {% if submission.is_graded %}
                            <span class="px-2.5 py-0.5 text-sm font-bold bg-blue-50 text-blue-700 rounded-full border border-blue-200">
                                {{ submission.score }}/{{ assignment.max_score }}ì 
                            </span>
                            {% endif %}
                        </div>

                        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                        <div class="flex items-center gap-2 flex-shrink-0">
                            {% if submission.is_submitted %}
                            <!-- ë‚´ìš© í¼ì¹˜ê¸° ë²„íŠ¼ (í…ìŠ¤íŠ¸ ì œì¶œì´ ìˆëŠ” ê²½ìš°) -->
                            {% if submission.content %}
                            <button onclick="toggleContent('sub-{{ submission.submission_id }}')"
                                    class="text-xs text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-2.5 py-1.5 rounded transition">
                                ë‚´ìš© ë³´ê¸°
                            </button>
                            {% endif %}
                            {% if not submission.is_graded %}
                            <a href="{{ url_for('teacher.grade_submission', assignment_id=assignment.assignment_id, submission_id=submission.submission_id) }}"
                               class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded transition duration-200">
                                ì±„ì í•˜ê¸°
                            </a>
                            {% else %}
                            <a href="{{ url_for('teacher.grade_submission', assignment_id=assignment.assignment_id, submission_id=submission.submission_id) }}"
                               class="bg-gray-500 hover:bg-gray-600 text-white text-xs font-medium px-3 py-1.5 rounded transition duration-200">
                                ë‹¤ì‹œ ì±„ì 
                            </a>
                            {% endif %}
                            {% else %}
                            <span class="text-gray-400 text-sm">ë¯¸ì œì¶œ</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- ì œì¶œ/ì±„ì  ì‹œê° -->
                    <div class="flex flex-wrap gap-x-4 gap-y-0.5 text-xs text-gray-400 mb-3">
                        {% if submission.submitted_at %}
                        <span>ì œì¶œ: {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% endif %}
                        {% if submission.is_graded %}
                        <span>ì±„ì : {{ submission.graded_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% endif %}
                        {% if submission.file_name %}
                        <span class="flex items-center gap-1">
                            ğŸ“ {{ submission.file_name }}
                            <a href="{{ url_for('teacher.download_submission_file', submission_id=submission.submission_id) }}"
                               class="text-blue-500 hover:text-blue-700 underline ml-1">ë‹¤ìš´ë¡œë“œ</a>
                        </span>
                        {% endif %}
                    </div>

                    <!-- ì œì¶œ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (í•­ìƒ í‘œì‹œ) -->
                    {% if submission.content and submission.is_submitted %}
                    <div class="bg-gray-50 rounded-lg px-4 py-3 text-sm text-gray-700 leading-relaxed">
                        <p class="line-clamp-3 whitespace-pre-wrap" id="preview-{{ submission.submission_id }}">{{ submission.content }}</p>
                        <!-- ì „ì²´ ë‚´ìš© (í¼ì¹˜ê¸° ì‹œ) -->
                        <div id="sub-{{ submission.submission_id }}" class="hidden mt-1">
                            <p class="whitespace-pre-wrap">{{ submission.content }}</p>
                        </div>
                        {% if submission.content|length > 200 %}
                        <button onclick="toggleContent('sub-{{ submission.submission_id }}', 'preview-{{ submission.submission_id }}')"
                                class="mt-2 text-xs text-blue-600 hover:text-blue-800 font-medium">
                            ì „ì²´ ë³´ê¸° â–¼
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- ì±„ì  í”¼ë“œë°± (ì±„ì  ì™„ë£Œ ì‹œ) -->
                    {% if submission.is_graded and submission.feedback %}
                    <div class="mt-3 bg-green-50 border border-green-200 rounded-lg px-4 py-3">
                        <p class="text-xs font-semibold text-green-700 mb-1">ğŸ’¬ í”¼ë“œë°±</p>
                        <p class="text-sm text-green-800 whitespace-pre-wrap">{{ submission.feedback[:200] }}{% if submission.feedback|length > 200 %}...{% endif %}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <p class="text-gray-500 text-center py-12">ì œì¶œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleContent(fullId, previewId) {
    const fullEl = document.getElementById(fullId);
    const previewEl = previewId ? document.getElementById(previewId) : null;
    const btn = event.target;

    if (fullEl.classList.contains('hidden')) {
        fullEl.classList.remove('hidden');
        if (previewEl) previewEl.classList.add('hidden');
        if (btn) btn.textContent = 'ì ‘ê¸° â–²';
    } else {
        fullEl.classList.add('hidden');
        if (previewEl) previewEl.classList.remove('hidden');
        if (btn) btn.textContent = 'ì „ì²´ ë³´ê¸° â–¼';
    }
}
</script>
{% endblock %}
