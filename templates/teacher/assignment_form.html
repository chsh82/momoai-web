{% extends "base.html" %}

{% block title %}과제 등록 - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('teacher.assignments') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            ← 과제 목록으로
        </a>
        <h2 class="text-3xl font-bold text-gray-800">새 과제 등록</h2>
    </div>

    <!-- 수업별 학생 데이터 (JS용) -->
    <script>
    const courseStudents = {{ course_students_json | safe }};
    </script>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow p-8">
        <form method="POST" action="">
            <!-- 과제 제목 -->
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">
                    과제 제목 <span class="text-red-600">*</span>
                </label>
                <input type="text" name="title" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="예: 환경보호 주제 논술문 작성">
            </div>

            <!-- 과제 설명 -->
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">
                    과제 설명 <span class="text-red-600">*</span>
                </label>
                <textarea name="description" required rows="6"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="과제 내용, 요구사항, 평가 기준 등을 상세히 입력하세요."></textarea>
            </div>

            <!-- 수업 선택 -->
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">수업 (선택)</label>
                <select name="course_id" id="courseSelect"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="updateStudentList(this.value)">
                    <option value="">-- 수업 선택 (전체 학생) --</option>
                    {% for course in courses %}
                    <option value="{{ course.course_id }}">{{ course.course_name }}</option>
                    {% endfor %}
                </select>
                <p class="text-gray-500 text-xs mt-1">수업을 선택하면 해당 수업 학생들에게만 과제가 할당됩니다.</p>
            </div>

            <!-- 개별 학생 선택 (수업 선택 시 표시) -->
            <div class="mb-6" id="studentSelectWrap" style="display:none;">
                <label class="block text-gray-700 font-medium mb-2">
                    개별 학생 지정
                    <span class="text-sm text-gray-400 font-normal ml-1">(선택 안 하면 수업 전체 학생에게 출제)</span>
                </label>
                <select name="target_student_id" id="studentSelect"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- 전체 학생 (개별 지정 안 함) --</option>
                </select>
                <p class="text-gray-500 text-xs mt-1">특정 학생에게만 과제를 출제하려면 선택하세요.</p>
            </div>

            <!-- 과제 유형 & 난이도 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">과제 유형</label>
                    <select name="assignment_type"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="essay">논술/작문</option>
                        <option value="reading">독서/독후감</option>
                        <option value="quiz">퀴즈/시험</option>
                        <option value="project">프로젝트</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">난이도</label>
                    <select name="difficulty"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="easy">쉬움</option>
                        <option value="medium" selected>보통</option>
                        <option value="hard">어려움</option>
                    </select>
                </div>
            </div>

            <!-- 배점 & 마감일 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">배점 <span class="text-red-600">*</span></label>
                    <input type="number" name="max_score" required value="100" min="1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">마감일시 <span class="text-red-600">*</span></label>
                    <input type="datetime-local" name="due_date" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- 제출 방식 -->
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">제출 방식</label>
                <select name="submission_type"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="text">텍스트 입력</option>
                    <option value="file">파일 업로드</option>
                    <option value="both">텍스트 + 파일</option>
                </select>
            </div>

            <!-- 지각 제출 옵션 -->
            <div class="mb-6">
                <div class="flex items-center gap-4 mb-3">
                    <label class="flex items-center">
                        <input type="checkbox" name="late_submission_allowed" checked
                               class="mr-2">
                        <span class="text-gray-700">지각 제출 허용</span>
                    </label>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-2">지각 제출 감점 비율 (%)</label>
                    <input type="number" name="late_penalty_percent" value="10" min="0" max="100"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-gray-500 text-xs mt-1">마감일 이후 제출 시 해당 비율만큼 감점됩니다.</p>
                </div>
            </div>

            <!-- 버튼 -->
            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-3 rounded-lg transition duration-200">
                    과제 등록
                </button>
                <a href="{{ url_for('teacher.assignments') }}"
                   class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium px-6 py-3 rounded-lg transition duration-200 text-center">
                    취소
                </a>
            </div>
        </form>
    </div>
</div>

<script>
function updateStudentList(courseId) {
    const wrap = document.getElementById('studentSelectWrap');
    const select = document.getElementById('studentSelect');

    if (!courseId) {
        wrap.style.display = 'none';
        return;
    }

    const students = courseStudents[courseId] || [];
    // 기존 옵션 초기화 (첫 번째 "전체" 옵션 유지)
    select.innerHTML = '<option value="">-- 전체 학생 (개별 지정 안 함) --</option>';

    students.forEach(function(s) {
        const opt = document.createElement('option');
        opt.value = s.student_id;
        opt.textContent = s.name + ' (' + s.grade + ')';
        select.appendChild(opt);
    });

    wrap.style.display = students.length > 0 ? 'block' : 'none';
}
</script>
{% endblock %}
