{% extends "base.html" %}

{% block title %}ì¶œì„ ì²´í¬ - {{ course.course_name }} - MOMOAI v4.0{% endblock %}

{% block page_title %}âœ… ì¶œì„ ì²´í¬{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ìˆ˜ì—… ì¶œì„ ì…ë ¥</span>
{% endblock %}


{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('teacher.course_detail', course_id=course.course_id) }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† ìˆ˜ì—… ìƒì„¸ë¡œ
        </a>
        <h2 class="text-3xl font-bold text-gray-800">ì¶œì„ ì²´í¬</h2>
    </div>

    <!-- ì„¸ì…˜ ì •ë³´ -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">{{ course.course_name }}</h3>
                <div class="space-y-2 text-sm">
                    <p><span class="text-gray-600">ìˆ˜ì—… ì½”ë“œ:</span> <span class="font-medium">{{ course.course_code }}</span></p>
                    <p><span class="text-gray-600">ì„¸ì…˜ ë²ˆí˜¸:</span> <span class="font-medium">ì„¸ì…˜ {{ session.session_number }}</span></p>
                    <p><span class="text-gray-600">ë‚ ì§œ:</span> <span class="font-medium">{{ session.session_date.strftime('%Yë…„ %mì›” %dì¼ (%A)')|replace('Monday', 'ì›”ìš”ì¼')|replace('Tuesday', 'í™”ìš”ì¼')|replace('Wednesday', 'ìˆ˜ìš”ì¼')|replace('Thursday', 'ëª©ìš”ì¼')|replace('Friday', 'ê¸ˆìš”ì¼')|replace('Saturday', 'í† ìš”ì¼')|replace('Sunday', 'ì¼ìš”ì¼') }}</span></p>
                    <p><span class="text-gray-600">ì‹œê°„:</span>
                        <span class="font-medium">
                            {% if session.start_time %}{{ session.start_time.strftime('%H:%M') }}{% endif %}
                            {% if session.end_time %} - {{ session.end_time.strftime('%H:%M') }}{% endif %}
                        </span>
                    </p>
                </div>
            </div>

            <div>
                <h4 class="font-medium text-gray-800 mb-3">ì¶œì„ í˜„í™©</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <p class="text-xs text-gray-600 mb-1">ì¶œì„</p>
                        <p class="text-2xl font-bold text-green-600" id="presentCount">{{ attendance_records|selectattr('status', 'equalto', 'present')|list|length }}</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-xs text-gray-600 mb-1">ì§€ê°</p>
                        <p class="text-2xl font-bold text-yellow-600" id="lateCount">{{ attendance_records|selectattr('status', 'equalto', 'late')|list|length }}</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-xs text-gray-600 mb-1">ê²°ì„</p>
                        <p class="text-2xl font-bold text-red-600" id="absentCount">{{ attendance_records|selectattr('status', 'equalto', 'absent')|list|length }}</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-xs text-gray-600 mb-1">ì¸ì •ê²°ì„</p>
                        <p class="text-2xl font-bold text-blue-600" id="excusedCount">{{ attendance_records|selectattr('status', 'equalto', 'excused')|list|length }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¶œì„ ì²´í¬ ë¦¬ìŠ¤íŠ¸ -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800">ì¶œì„ë¶€ ({{ attendance_records|length }}ëª…)</h3>
            <div class="flex gap-2">
                <button onclick="markAll('present')"
                        class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-3 py-1 rounded transition duration-200">
                    ì „ì²´ ì¶œì„
                </button>
                <button onclick="markAll('absent')"
                        class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium px-3 py-1 rounded transition duration-200">
                    ì „ì²´ ê²°ì„
                </button>
            </div>
        </div>
        <div class="p-6">
            {% if attendance_records %}
            <div class="space-y-3">
                {% for attendance in attendance_records %}
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition duration-200"
                     id="attendance-{{ attendance.attendance_id }}"
                     data-attendance-id="{{ attendance.attendance_id }}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 flex-1">
                            <!-- í•™ìƒ ì •ë³´ -->
                            <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">
                                {{ attendance.student.name[0] }}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-medium text-gray-800">{{ attendance.student.name }}</h4>
                                    {% if attendance.student.tier %}
                                    <span class="px-2 py-1 text-xs font-medium rounded
                                        {% if attendance.student.tier == 'A' %}bg-red-100 text-red-800
                                        {% elif attendance.student.tier == 'B' %}bg-blue-100 text-blue-800
                                        {% elif attendance.student.tier == 'C' %}bg-green-100 text-green-800
                                        {% elif attendance.student.tier == 'VIP' %}bg-purple-100 text-purple-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ attendance.student.tier }}
                                    </span>
                                    {% endif %}
                                </div>
                                <p class="text-sm text-gray-600">{{ attendance.student.grade }}</p>
                            </div>
                        </div>

                        <!-- ì¶œì„ ìƒíƒœ ë²„íŠ¼ -->
                        <div class="flex gap-2">
                            <button onclick="updateAttendance('{{ attendance.attendance_id }}', 'present')"
                                    class="attendance-btn px-4 py-2 rounded font-medium transition duration-200
                                    {% if attendance.status == 'present' %}bg-green-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
                                    data-status="present">
                                âœ“ ì¶œì„
                            </button>
                            <button onclick="updateAttendance('{{ attendance.attendance_id }}', 'late')"
                                    class="attendance-btn px-4 py-2 rounded font-medium transition duration-200
                                    {% if attendance.status == 'late' %}bg-yellow-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
                                    data-status="late">
                                â° ì§€ê°
                            </button>
                            <button onclick="updateAttendance('{{ attendance.attendance_id }}', 'absent')"
                                    class="attendance-btn px-4 py-2 rounded font-medium transition duration-200
                                    {% if attendance.status == 'absent' %}bg-red-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
                                    data-status="absent">
                                âœ— ê²°ì„
                            </button>
                            <button onclick="updateAttendance('{{ attendance.attendance_id }}', 'excused')"
                                    class="attendance-btn px-4 py-2 rounded font-medium transition duration-200
                                    {% if attendance.status == 'excused' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
                                    data-status="excused">
                                ğŸ“ ì¸ì •
                            </button>
                        </div>
                    </div>

                    <!-- ë©”ëª¨ (ì„ íƒì‚¬í•­) -->
                    <div class="mt-3 hidden" id="notes-{{ attendance.attendance_id }}">
                        <input type="text"
                               placeholder="ë©”ëª¨ (ì„ íƒì‚¬í•­)"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onchange="saveNotes('{{ attendance.attendance_id }}', this.value)"
                               value="{{ attendance.notes or '' }}">
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

    <!-- ìˆ˜ì—… ë©”ëª¨ -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-800">ìˆ˜ì—… ë©”ëª¨</h3>
        </div>
        <div class="p-6">
            <form method="POST" action="{{ url_for('teacher.complete_session', session_id=session.session_id) }}" id="completeForm">
                <div class="space-y-4">
                    <div>
                        {{ note_form.topic.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ note_form.topic(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder="ì˜ˆ: íŒŒì´ì¬ ê¸°ì´ˆ - ë³€ìˆ˜ì™€ ìë£Œí˜•") }}
                    </div>

                    <div>
                        {{ note_form.description.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ note_form.description(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder="ì˜¤ëŠ˜ ìˆ˜ì—… ë‚´ìš©, ê³¼ì œ, íŠ¹ì´ì‚¬í•­ ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”...") }}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ì™„ë£Œ ë²„íŠ¼ -->
    <div class="flex gap-3">
        <button onclick="completeAttendance()"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-4 rounded-lg transition duration-200 text-lg">
            ì¶œì„ ì²´í¬ ì™„ë£Œ
        </button>
        <a href="{{ url_for('teacher.course_detail', course_id=course.course_id) }}"
           class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-medium py-4 rounded-lg transition duration-200 text-center text-lg">
            ë‚˜ì¤‘ì— í•˜ê¸°
        </a>
    </div>
</div>

<script>
// ì¶œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateAttendance(attendanceId, status) {
    fetch(`/teacher/api/attendance/${attendanceId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const container = document.getElementById(`attendance-${attendanceId}`);
            const buttons = container.querySelectorAll('.attendance-btn');

            buttons.forEach(btn => {
                const btnStatus = btn.getAttribute('data-status');
                if (btnStatus === status) {
                    // ì„ íƒëœ ë²„íŠ¼
                    btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    if (status === 'present') {
                        btn.classList.add('bg-green-600', 'text-white');
                    } else if (status === 'late') {
                        btn.classList.add('bg-yellow-600', 'text-white');
                    } else if (status === 'absent') {
                        btn.classList.add('bg-red-600', 'text-white');
                    } else if (status === 'excused') {
                        btn.classList.add('bg-blue-600', 'text-white');
                    }
                } else {
                    // ì„ íƒë˜ì§€ ì•Šì€ ë²„íŠ¼
                    btn.classList.remove('bg-green-600', 'bg-yellow-600', 'bg-red-600', 'bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                }
            });

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStatistics();
        } else {
            alert(data.message || 'ì¶œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì¶œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë©”ëª¨ ì €ì¥
function saveNotes(attendanceId, notes) {
    fetch(`/teacher/api/attendance/${attendanceId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ notes: notes })
    });
}

// ì „ì²´ ì¶œì„/ê²°ì„ ì²˜ë¦¬
function markAll(status) {
    if (!confirm(`ì „ì²´ í•™ìƒì„ "${status === 'present' ? 'ì¶œì„' : 'ê²°ì„'}" ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    const attendanceItems = document.querySelectorAll('[data-attendance-id]');
    attendanceItems.forEach(item => {
        const attendanceId = item.getAttribute('data-attendance-id');
        updateAttendance(attendanceId, status);
    });
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStatistics() {
    const attendanceItems = document.querySelectorAll('[data-attendance-id]');
    let presentCount = 0;
    let lateCount = 0;
    let absentCount = 0;
    let excusedCount = 0;

    attendanceItems.forEach(item => {
        const buttons = item.querySelectorAll('.attendance-btn');
        buttons.forEach(btn => {
            if (btn.classList.contains('bg-green-600')) presentCount++;
            else if (btn.classList.contains('bg-yellow-600')) lateCount++;
            else if (btn.classList.contains('bg-red-600')) absentCount++;
            else if (btn.classList.contains('bg-blue-600')) excusedCount++;
        });
    });

    document.getElementById('presentCount').textContent = presentCount;
    document.getElementById('lateCount').textContent = lateCount;
    document.getElementById('absentCount').textContent = absentCount;
    document.getElementById('excusedCount').textContent = excusedCount;
}

// ì¶œì„ ì²´í¬ ì™„ë£Œ
function completeAttendance() {
    if (!confirm('ì¶œì„ ì²´í¬ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    document.getElementById('completeForm').submit();
}
</script>
{% endblock %}
