{% extends "base.html" %}

{% block title %}ì¶œì„ ì²´í¬ - MOMOAI v4.0{% endblock %}

{% block page_title %}âœ… ì¶œê²° ê´€ë¦¬{% endblock %}

{% block page_subtitle %}
<span class="text-sm text-white text-opacity-70 ml-3">ìˆ˜ì—…ë³„ ì¶œì„ í˜„í™©</span>
{% endblock %}


{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-800">âœ“ ì¶œì„ ì²´í¬</h2>
        <p class="text-gray-600 mt-2">ìˆ˜ì—… ì„¸ì…˜ì„ ì„ íƒí•˜ì—¬ ì¶œì„ì„ ì²´í¬í•˜ì„¸ìš”</p>
    </div>

    <!-- ê²€ìƒ‰ í•„í„° -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">ğŸ” ì§€ë‚œ ìˆ˜ì—… ê²€ìƒ‰</h3>
            {% if search_mode %}
            <a href="{{ url_for('teacher.attendance_list') }}"
               class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                â† ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ
            </a>
            {% endif %}
        </div>
        <form method="GET" action="" class="space-y-4">
            <input type="hidden" name="search" value="1">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- ë‚ ì§œ ë²”ìœ„ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‹œì‘ì¼</label>
                    <input type="date" name="date_from" value="{{ date_from }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ë£Œì¼</label>
                    <input type="date" name="date_to" value="{{ date_to }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- ìˆ˜ì—… ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ì—…</label>
                    <select name="course_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ìˆ˜ì—…</option>
                        {% for course in courses %}
                        <option value="{{ course.course_id }}" {% if course_filter == course.course_id %}selected{% endif %}>
                            {{ course.course_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ê°•ì‚¬ ì„ íƒ (ê´€ë¦¬ìë§Œ) -->
                {% if current_user.is_admin and teachers %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê°•ì‚¬</label>
                    <select name="teacher_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ê°•ì‚¬</option>
                        {% for teacher in teachers %}
                        <option value="{{ teacher.user_id }}" {% if teacher_filter == teacher.user_id %}selected{% endif %}>
                            {{ teacher.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <!-- ìƒíƒœ í•„í„° -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>ì˜ˆì •</option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>ì™„ë£Œ</option>
                        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>ì·¨ì†Œ</option>
                    </select>
                </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="flex gap-3">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2 rounded-lg transition duration-200">
                    ğŸ” ê²€ìƒ‰
                </button>
                <a href="{{ url_for('teacher.attendance_list') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2 rounded-lg transition duration-200">
                    ì´ˆê¸°í™”
                </a>
            </div>
        </form>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
    {% if search_mode %}
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200 bg-purple-50">
            <h3 class="text-xl font-bold text-purple-900">ğŸ” ê²€ìƒ‰ ê²°ê³¼ ({{ search_sessions|length }}ê°œ)</h3>
            <p class="text-sm text-purple-700 mt-1">ìµœê·¼ 50ê°œ ì„¸ì…˜ê¹Œì§€ í‘œì‹œ</p>
        </div>
        <div class="p-6">
            {% if search_sessions %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ë‚ ì§œ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ìˆ˜ì—…ëª…</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ê°•ì‚¬</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ì‹œê°„</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">í•™ìƒ ìˆ˜</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ìƒíƒœ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for session in search_sessions %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {{ session.session_date.strftime('%Y-%m-%d') }}
                                <span class="text-xs text-gray-500">
                                    ({{ session.session_date.strftime('%a')|replace('Mon', 'ì›”')|replace('Tue', 'í™”')|replace('Wed', 'ìˆ˜')|replace('Thu', 'ëª©')|replace('Fri', 'ê¸ˆ')|replace('Sat', 'í† ')|replace('Sun', 'ì¼') }})
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm font-medium text-gray-800">{{ session.course.course_name }}</div>
                                <div class="text-xs text-gray-500">ì„¸ì…˜ {{ session.session_number }}</div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {{ session.course.teacher.name if session.course.teacher else 'ë¯¸ë°°ì •' }}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {% if session.start_time %}{{ session.start_time.strftime('%H:%M') }}{% endif %}
                                {% if session.end_time %} - {{ session.end_time.strftime('%H:%M') }}{% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">
                                {{ session.course.enrolled_count }}ëª…
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs font-medium rounded
                                    {% if session.status == 'scheduled' %}bg-blue-100 text-blue-800
                                    {% elif session.status == 'completed' %}bg-green-100 text-green-800
                                    {% elif session.status == 'cancelled' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if session.status == 'scheduled' %}ì˜ˆì •
                                    {% elif session.status == 'completed' %}ì™„ë£Œ
                                    {% elif session.status == 'cancelled' %}ì·¨ì†Œ
                                    {% else %}{{ session.status }}{% endif %}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <a href="{{ url_for('teacher.check_attendance', session_id=session.session_id) }}"
                                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    {% if session.status == 'completed' %}ì¶œì„ í˜„í™©{% else %}ì¶œì„ ì²´í¬{% endif %} â†’
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="text-6xl mb-4">ğŸ”</div>
                <p class="text-gray-500 text-lg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-gray-400 text-sm mt-2">ê²€ìƒ‰ ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}

    <!-- ì˜¤ëŠ˜ ì„¸ì…˜ -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="px-6 py-4 border-b border-gray-200 bg-blue-50">
            <h3 class="text-xl font-bold text-blue-900">ğŸ“… ì˜¤ëŠ˜ ì„¸ì…˜ ({{ today_sessions|length }}ê°œ)</h3>
            <p class="text-sm text-blue-700 mt-1">ì˜¤ëŠ˜ ì§„í–‰ë˜ëŠ” ìˆ˜ì—…</p>
        </div>
        <div class="p-6">
            {% if today_sessions %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for session in today_sessions %}
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-400 hover:shadow-md transition duration-200">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 mb-1">{{ session.course.course_name }}</h4>
                            <p class="text-sm text-gray-600 mb-2">
                                ê°•ì‚¬: {{ session.course.teacher.name if session.course.teacher else 'ë¯¸ë°°ì •' }}
                            </p>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                <div class="flex items-center gap-1">
                                    <span>ğŸ•</span>
                                    <span>
                                        {% if session.start_time %}{{ session.start_time.strftime('%H:%M') }}{% endif %}
                                        {% if session.end_time %} - {{ session.end_time.strftime('%H:%M') }}{% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span>ğŸ‘¥</span>
                                    <span>{{ session.course.enrolled_count }}ëª…</span>
                                </div>
                                {% if session.course.grade %}
                                <div class="flex items-center gap-1">
                                    <span>ğŸ“š</span>
                                    <span>{{ session.course.grade }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <span class="px-3 py-1 text-xs font-medium rounded
                            {% if session.status == 'scheduled' %}bg-blue-100 text-blue-800
                            {% elif session.status == 'completed' %}bg-green-100 text-green-800
                            {% elif session.status == 'cancelled' %}bg-red-100 text-red-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {% if session.status == 'scheduled' %}ì˜ˆì •
                            {% elif session.status == 'completed' %}ì™„ë£Œ
                            {% elif session.status == 'cancelled' %}ì·¨ì†Œ
                            {% else %}{{ session.status }}{% endif %}
                        </span>
                    </div>

                    {% if session.topic %}
                    <p class="text-sm text-gray-700 mb-3 pb-3 border-b">
                        <span class="font-medium">ì£¼ì œ:</span> {{ session.topic }}
                    </p>
                    {% endif %}

                    <a href="{{ url_for('teacher.check_attendance', session_id=session.session_id) }}"
                       class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition duration-200">
                        {% if session.status == 'completed' %}ì¶œì„ í˜„í™© ë³´ê¸°{% else %}ì¶œì„ ì²´í¬í•˜ê¸°{% endif %}
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="text-6xl mb-4">ğŸ“…</div>
                <p class="text-gray-500 text-lg">ì˜¤ëŠ˜ ì˜ˆì •ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ë‹¤ê°€ì˜¤ëŠ” ì„¸ì…˜ -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">ğŸ“† ë‹¤ê°€ì˜¤ëŠ” ì„¸ì…˜ (7ì¼ ì´ë‚´)</h3>
                <p class="text-sm text-gray-600 mt-1">ê³§ ì§„í–‰ë  ìˆ˜ì—…</p>
            </div>
            <div class="p-6">
                {% if upcoming_sessions %}
                <div class="space-y-3">
                    {% for session in upcoming_sessions %}
                    <div class="border border-gray-200 rounded-lg p-3 hover:border-green-400 transition duration-200">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800 text-sm">{{ session.course.course_name }}</h4>
                                <p class="text-xs text-gray-600 mt-1">
                                    ê°•ì‚¬: {{ session.course.teacher.name if session.course.teacher else 'ë¯¸ë°°ì •' }}
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-700">
                                ì„¸ì…˜ {{ session.session_number }}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                            <span>ğŸ“… {{ session.session_date.strftime('%m/%d (%a)')|replace('Mon', 'ì›”')|replace('Tue', 'í™”')|replace('Wed', 'ìˆ˜')|replace('Thu', 'ëª©')|replace('Fri', 'ê¸ˆ')|replace('Sat', 'í† ')|replace('Sun', 'ì¼') }}</span>
                            <span>ğŸ•
                                {% if session.start_time %}{{ session.start_time.strftime('%H:%M') }}{% endif %}
                                {% if session.end_time %} - {{ session.end_time.strftime('%H:%M') }}{% endif %}
                            </span>
                            <span>ğŸ‘¥ {{ session.course.enrolled_count }}ëª…</span>
                        </div>
                        <a href="{{ url_for('teacher.check_attendance', session_id=session.session_id) }}"
                           class="block text-center bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium py-2 rounded transition duration-200">
                            ë¯¸ë¦¬ë³´ê¸°
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <p class="text-gray-500">ë‹¤ê°€ì˜¤ëŠ” ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ìµœê·¼ ì™„ë£Œëœ ì„¸ì…˜ -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">âœ… ìµœê·¼ ì™„ë£Œëœ ì„¸ì…˜</h3>
                <p class="text-sm text-gray-600 mt-1">ì§€ë‚œ 7ì¼ ë™ì•ˆ ì™„ë£Œëœ ìˆ˜ì—…</p>
            </div>
            <div class="p-6">
                {% if recent_sessions %}
                <div class="space-y-3">
                    {% for session in recent_sessions %}
                    <div class="border border-gray-200 rounded-lg p-3 hover:border-green-400 transition duration-200 {% if session.status == 'completed' %}bg-green-50{% endif %}">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800 text-sm">{{ session.course.course_name }}</h4>
                                <p class="text-xs text-gray-600 mt-1">
                                    ê°•ì‚¬: {{ session.course.teacher.name if session.course.teacher else 'ë¯¸ë°°ì •' }}
                                </p>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded bg-green-100 text-green-800">
                                ì™„ë£Œ
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
                            <span>ğŸ“… {{ session.session_date.strftime('%m/%d (%a)')|replace('Mon', 'ì›”')|replace('Tue', 'í™”')|replace('Wed', 'ìˆ˜')|replace('Thu', 'ëª©')|replace('Fri', 'ê¸ˆ')|replace('Sat', 'í† ')|replace('Sun', 'ì¼') }}</span>
                            <span>ğŸ•
                                {% if session.start_time %}{{ session.start_time.strftime('%H:%M') }}{% endif %}
                                {% if session.end_time %} - {{ session.end_time.strftime('%H:%M') }}{% endif %}
                            </span>
                            <span>ğŸ‘¥ {{ session.course.enrolled_count }}ëª…</span>
                        </div>
                        {% if session.topic %}
                        <p class="text-xs text-gray-700 mb-2">
                            <span class="font-medium">ì£¼ì œ:</span> {{ session.topic }}
                        </p>
                        {% endif %}
                        <a href="{{ url_for('teacher.check_attendance', session_id=session.session_id) }}"
                           class="block text-center bg-green-100 hover:bg-green-200 text-green-700 text-xs font-medium py-2 rounded transition duration-200">
                            ì¶œì„ í˜„í™© ë³´ê¸°
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <p class="text-gray-500">ìµœê·¼ ì™„ë£Œëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ì•ˆë‚´ -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 class="font-medium text-blue-900 mb-2">ğŸ’¡ ì¶œì„ ì²´í¬ ì•ˆë‚´</h4>
        <ul class="text-sm text-blue-800 space-y-1">
            <li>â€¢ <strong>ì§€ë‚œ ìˆ˜ì—… ê²€ìƒ‰</strong>: ë‚ ì§œ, ìˆ˜ì—…, ìƒíƒœë¡œ í•„í„°ë§í•˜ì—¬ ê³¼ê±° ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>â€¢ <strong>ì˜¤ëŠ˜ ì„¸ì…˜</strong>: ì˜¤ëŠ˜ ì§„í–‰ë˜ëŠ” ìˆ˜ì—…ì˜ ì¶œì„ì„ ì²´í¬í•˜ì„¸ìš”</li>
            <li>â€¢ <strong>ë‹¤ê°€ì˜¤ëŠ” ì„¸ì…˜</strong>: ë¯¸ë¦¬ ì¶œì„ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>â€¢ <strong>ì™„ë£Œëœ ì„¸ì…˜</strong>: ì´ì „ ì¶œì„ ê¸°ë¡ì„ í™•ì¸í•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>â€¢ ì¶œì„ ìƒíƒœ: <span class="px-2 py-0.5 bg-green-100 text-green-800 rounded text-xs">ì¶œì„</span>
                <span class="px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded text-xs">ì§€ê°</span>
                <span class="px-2 py-0.5 bg-red-100 text-red-800 rounded text-xs">ê²°ì„</span>
                <span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">ì¸ì •ê²°ì„</span></li>
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}
