{% extends "base.html" %}

{% block title %}í”¼ë“œë°± ì‘ì„± - MOMOAI v4.0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <a href="{{ url_for('teacher.students') }}"
           class="text-blue-600 hover:text-blue-800 font-medium mb-2 inline-block">
            â† í•™ìƒ ëª©ë¡ìœ¼ë¡œ
        </a>
        <h2 class="text-3xl font-bold text-gray-800">í•™ë¶€ëª¨ í”¼ë“œë°± ì‘ì„±</h2>
        <p class="text-gray-600 mt-2">í•™ìƒì€ ì´ í”¼ë“œë°±ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- Info Box -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6">
        <div class="flex items-center gap-2">
            <span class="text-lg">â„¹ï¸</span>
            <p class="text-sm text-blue-800">
                <strong>ë¹„ê³µê°œ í”¼ë“œë°±:</strong> í•™ë¶€ëª¨ì—ê²Œë§Œ ì „ë‹¬ë˜ë©° í•™ìƒì€ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <form method="POST" action="" id="feedbackForm">
            {{ form.hidden_tag() }}

            <div class="space-y-6">
                <!-- í•™ìƒ ì„ íƒ -->
                <div>
                    {{ form.student_id.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.student_id(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" + (" border-red-500" if form.student_id.errors else ""), onchange="loadParents(this.value)") }}
                    {% if form.student_id.errors %}
                        {% for error in form.student_id.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- í•™ë¶€ëª¨ ì„ íƒ -->
                <div>
                    {{ form.parent_id.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.parent_id(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" + (" border-red-500" if form.parent_id.errors else ""), id="parentSelect") }}
                    {% if form.parent_id.errors %}
                        {% for error in form.parent_id.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- í”¼ë“œë°± ìœ í˜• -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        {{ form.feedback_type.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.feedback_type(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                    </div>

                    <div>
                        {{ form.priority.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.priority(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500") }}
                    </div>
                </div>

                <!-- ì œëª© -->
                <div>
                    {{ form.title.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.title(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" + (" border-red-500" if form.title.errors else ""), placeholder="ì˜ˆ: ì´ë²ˆ ì£¼ ìˆ˜ì—… í”¼ë“œë°±") }}
                    {% if form.title.errors %}
                        {% for error in form.title.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- ë‚´ìš© -->
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">ë‚´ìš© *</label>
                    <textarea
                        id="content"
                        name="content"
                        rows="10"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical{% if form.content.errors %} border-red-500{% endif %}"
                        placeholder="í•™ìƒì˜ ìˆ˜ì—… ì°¸ì—¬ë„, í•™ìŠµ ì§„ë„, ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ ë“±ì„ ìƒì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”..."
                        required>{{ form.content.data if form.content.data else '' }}</textarea>
                    {% if form.content.errors %}
                        {% for error in form.content.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ error }}</p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- ì•Œë¦¼ ë°œì†¡ ì˜µì…˜ -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">ğŸ“¬ ì¶”ê°€ ì•Œë¦¼ ë°œì†¡</h4>
                    <div class="flex flex-wrap gap-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="send_email" value="1" checked
                                   class="w-4 h-4 text-blue-600 rounded border-gray-300">
                            <span class="text-sm text-gray-700">ğŸ“§ ì´ë©”ì¼ ë°œì†¡</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="send_sms" value="1"
                                   class="w-4 h-4 text-green-600 rounded border-gray-300">
                            <span class="text-sm text-gray-700">ğŸ“± SMS ë°œì†¡</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">ì¸ì•± ì•Œë¦¼ì€ í•­ìƒ ë°œì†¡ë©ë‹ˆë‹¤. ì¶”ê°€ë¡œ ì´ë©”ì¼/SMS ë°œì†¡ ì—¬ë¶€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex gap-3 pt-4">
                    <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                        í”¼ë“œë°± ì „ì†¡
                    </button>
                    <a href="{{ url_for('teacher.students') }}"
                       class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-medium py-3 rounded-lg transition duration-200 text-center">
                        ì·¨ì†Œ
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// í•™ìƒ ì„ íƒ ì‹œ í•™ë¶€ëª¨ ëª©ë¡ ë¡œë“œ
function loadParents(studentId, selectedParentId = null) {
    if (!studentId) {
        document.getElementById('parentSelect').innerHTML = '<option value="">-- ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš” --</option>';
        return;
    }

    fetch(`/teacher/api/students/${studentId}/parents`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const parentSelect = document.getElementById('parentSelect');
                parentSelect.innerHTML = '<option value="">-- í•™ë¶€ëª¨ ì„ íƒ --</option>';

                data.parents.forEach(parent => {
                    const option = document.createElement('option');
                    option.value = parent.user_id;
                    option.textContent = `${parent.name} (${parent.email})`;
                    // ì´ì „ì— ì„ íƒëœ í•™ë¶€ëª¨ê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ
                    if (selectedParentId && parent.user_id === selectedParentId) {
                        option.selected = true;
                    }
                    parentSelect.appendChild(option);
                });

                if (data.parents.length === 0) {
                    parentSelect.innerHTML = '<option value="">-- ë“±ë¡ëœ í•™ë¶€ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤ --</option>';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('í•™ë¶€ëª¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ í•™ë¶€ëª¨ ëª©ë¡ ë³µì›
document.addEventListener('DOMContentLoaded', function() {
    const studentSelect = document.querySelector('select[name="student_id"]');
    const parentSelect = document.getElementById('parentSelect');

    // í•™ìƒì´ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ (í¼ ì œì¶œ ì‹¤íŒ¨ í›„ ì¬ë¡œë“œ ì‹œ)
    if (studentSelect && studentSelect.value) {
        const selectedParentId = parentSelect.value; // ì„ íƒëœ í•™ë¶€ëª¨ ID ì €ì¥
        loadParents(studentSelect.value, selectedParentId);
    }
});
</script>
{% endblock %}
