# 학부모-자녀 연결 시스템 구현 상태

**구현 방식**: 관리자 직접 연결 (복수 연결 가능)
**구현 날짜**: 2026-02-09
**상태**: ✅ 백엔드 완료, 🔄 프론트엔드 진행 중

---

## ✅ 완료된 작업

### 1. 데이터베이스 모델
- ✅ `ParentLinkRequest` 모델 생성
- ✅ 마이그레이션 생성 및 적용 (2bd6c5fc9fc1)
- ✅ 인덱스 설정 (parent_id, student_id, status, created_at)

### 2. 학부모 포털 라우트
**파일**: `app/parent_portal/routes.py`

| 라우트 | 메서드 | 설명 |
|--------|--------|------|
| `/parent/link-child` | GET, POST | 자녀 연결 요청 제출 |
| `/parent/link-requests` | GET | 내 연결 요청 목록 |
| `/parent/link-requests/<id>/cancel` | POST | 요청 취소 |

**기능**:
- ✅ 자녀 정보 입력 (이름, 생년월일, 학년, 학교)
- ✅ 관계 타입 선택 (부, 모, 보호자)
- ✅ 관리자에게 자동 알림 전송
- ✅ 요청 상태 추적 (pending, approved, rejected, cancelled)
- ✅ 연결 요청 취소 기능

### 3. 관리자 포털 라우트
**파일**: `app/admin/routes.py` (1910-2104라인)

| 라우트 | 메서드 | 설명 |
|--------|--------|------|
| `/admin/parent-link-requests` | GET | 연결 요청 목록 |
| `/admin/parent-link-requests/<id>` | GET | 요청 상세 + 학생 검색 |
| `/admin/parent-link-requests/<id>/approve` | POST | 요청 승인 |
| `/admin/parent-link-requests/<id>/reject` | POST | 요청 거절 |
| `/admin/api/students/search` | GET | 학생 검색 API |

**기능**:
- ✅ 상태별 필터링 (pending, approved, rejected, cancelled)
- ✅ 통계 카드 (대기, 승인, 거절, 취소 개수)
- ✅ 학생 이름 자동 검색
- ✅ 학생 선택 및 매칭
- ✅ 승인 시 ParentStudent 관계 자동 생성
- ✅ 복수 학부모 연결 지원 (엄마, 아빠 각각 가능)
- ✅ 이미 연결된 학생 표시
- ✅ 학부모에게 승인/거절 알림 자동 전송
- ✅ 관리자 메모 기능

---

## 🔄 진행 중인 작업

### 4. 템플릿 생성 필요

#### 학부모 포털 템플릿
- [ ] `templates/parent/link_child.html` - 자녀 연결 요청 폼
- [ ] `templates/parent/link_requests.html` - 요청 목록 및 상태

#### 관리자 포털 템플릿
- [ ] `templates/admin/parent_link_requests.html` - 요청 목록
- [ ] `templates/admin/parent_link_request_detail.html` - 상세 + 승인/거절

### 5. 메뉴 항목 추가
- [ ] 학부모 사이드바에 "자녀 연결" 메뉴
- [ ] 관리자 사이드바에 "학부모 연결 관리" 메뉴
- [ ] 대시보드에 대기 중인 요청 수 표시

---

## 📊 시스템 흐름도

```
학부모                          관리자                         시스템
  │                               │                             │
  ├─ 1. 회원가입 (parent role)    │                             │
  │                               │                             │
  ├─ 2. "자녀 연결" 메뉴 클릭     │                             │
  │                               │                             │
  ├─ 3. 자녀 정보 입력            │                             │
  │    - 이름: 김철수             │                             │
  │    - 생년월일: 2015-03-15     │                             │
  │    - 학년: 초등 3학년         │                             │
  │    - 학교: OO초등학교         │                             │
  │    - 관계: 부(父)             │                             │
  │                               │                             │
  ├─ 4. 요청 제출 ─────────────▶  │                             │
  │                               │                             │
  │                               ├─ 5. 알림 수신 ◀──────────── ├─ Notification 생성
  │                               │    "OOO님이 자녀 연결 요청"  │
  │                               │                             │
  │                               ├─ 6. "학부모 연결 관리" 클릭│
  │                               │                             │
  │                               ├─ 7. 요청 목록 확인         │
  │                               │    [대기: 5건]              │
  │                               │                             │
  │                               ├─ 8. 요청 상세 클릭         │
  │                               │                             │
  │                               ├─ 9. 학생 검색              │
  │                               │    입력: "김철수"           │
  │                               │    결과:                    │
  │                               │    - 김철수 (초3, OO초)    │
  │                               │    - 김철수 (초5, XX초)    │
  │                               │                             │
  │                               ├─ 10. 올바른 학생 선택      │
  │                               │                             │
  │                               ├─ 11. "승인" 버튼 클릭 ────▶│
  │                               │                             │
  │                               │                             ├─ ParentStudent 생성
  │                               │                             │   parent_id: OOO
  │                               │                             │   student_id: 김철수
  │                               │                             │   relation_type: parent
  │                               │                             │
  ├─ 12. 알림 수신 ◀──────────────────────────────────────────── ├─ Notification 생성
  │     "김철수 학생과 연결됨!"    │                             │   "연결 승인"
  │                               │                             │
  ├─ 13. 학부모 포털 접속         │                             │
  │                               │                             │
  ├─ 14. 자녀 정보 확인 가능      │                             │
  │     - 출석 현황               │                             │
  │     - 성적                    │                             │
  │     - 과제                    │                             │
  │     - 결제 내역               │                             │
```

---

## 🔐 보안 특징

### 1. 관리자 검증
- ✅ 모든 연결 요청은 관리자 승인 필수
- ✅ 자동 연결 없음 (무단 접근 방지)
- ✅ 관리자가 정확한 학생 매칭

### 2. 복수 연결 지원
- ✅ 1명의 학생에 여러 학부모 연결 가능
- ✅ 부, 모 각각 별도 계정으로 연결
- ✅ 조부모, 보호자도 연결 가능

### 3. 권한 관리
- ✅ `ParentStudent.permission_level` 설정 가능
  - `full`: 모든 정보 열람 + 결제
  - `view_only`: 정보만 열람
- ✅ `relation_type`으로 관계 구분
  - `parent`, `father`, `mother`, `guardian`

### 4. 연결 해제
- ✅ `ParentStudent.is_active` 플래그로 비활성화
- ✅ 물리적 삭제 없이 soft delete
- ✅ 재활성화 가능

### 5. 추적 가능성
- ✅ 모든 연결에 `created_by` 기록
- ✅ 승인/거절 관리자 기록 (`reviewed_by`)
- ✅ 타임스탬프 자동 기록

---

## 📱 UI/UX 설계

### 학부모 포털 - 자녀 연결 페이지

```
┌─────────────────────────────────────────────────┐
│  📋 자녀 연결 요청                               │
├─────────────────────────────────────────────────┤
│                                                 │
│  ℹ️ 자녀와의 연결을 위해 정보를 입력해주세요.    │
│     관리자 검토 후 1-2일 내로 연결됩니다.        │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 자녀 이름 *                              │   │
│  │ [                              ]         │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 생년월일                                 │   │
│  │ [2015-03-15                ]             │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 학년                                     │   │
│  │ [초등 3학년 ▼]                           │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 학교명                                   │   │
│  │ [OO초등학교                ]             │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 관계 *                                   │   │
│  │ ○ 부(父)  ○ 모(母)  ○ 보호자            │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 추가 정보 (선택)                         │   │
│  │ [                              ]         │   │
│  │ [                              ]         │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  [요청 제출]  [취소]                            │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 학부모 포털 - 요청 목록

```
┌─────────────────────────────────────────────────┐
│  📋 자녀 연결 요청 현황                          │
├─────────────────────────────────────────────────┤
│                                                 │
│  통계                                           │
│  ┌──────────┬──────────┬──────────┬──────────┐│
│  │ ⏳ 대기중  │ ✅ 승인됨  │ ❌ 거절됨  │ 🗑️ 취소  ││
│  │    2건    │    3건    │    1건    │    0건   ││
│  └──────────┴──────────┴──────────┴──────────┘│
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 요청 일자    자녀명    상태    액션      │   │
│  ├─────────────────────────────────────────┤   │
│  │ 2026-02-09  김철수    ⏳ 대기중  [취소]  │   │
│  │ 2026-02-08  이영희    ✅ 승인됨   -      │   │
│  │ 2026-02-07  박민수    ✅ 승인됨   -      │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  [+ 새 자녀 연결 요청]                          │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 관리자 포털 - 요청 목록

```
┌─────────────────────────────────────────────────┐
│  👨‍👩‍👧 학부모-자녀 연결 요청 관리                   │
├─────────────────────────────────────────────────┤
│                                                 │
│  필터: [⏳ 대기중 ▼]  [검색: 학부모/자녀 이름]    │
│                                                 │
│  통계                                           │
│  ┌──────────┬──────────┬──────────┬──────────┐│
│  │ ⏳ 대기중  │ ✅ 승인됨  │ ❌ 거절됨  │ 🗑️ 취소  ││
│  │    5건    │   23건    │    2건    │    1건   ││
│  └──────────┴──────────┴──────────┴──────────┘│
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 요청일시    학부모      자녀명    상태   │   │
│  ├─────────────────────────────────────────┤   │
│  │ 02-09 10:23 김영희(母) 김철수  [상세]   │   │
│  │ 02-09 09:15 이철수(父) 이민수  [상세]   │   │
│  │ 02-08 18:30 박순자(母) 박지은  [상세]   │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 관리자 포털 - 요청 상세

```
┌─────────────────────────────────────────────────┐
│  ← 뒤로가기    연결 요청 상세                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  📋 요청 정보                                    │
│  ┌─────────────────────────────────────────┐   │
│  │ 학부모: 김영희 (mother123@email.com)     │   │
│  │ 관계: 모(母)                             │   │
│  │ 요청일: 2026-02-09 10:23:45              │   │
│  │                                          │   │
│  │ 자녀 정보 (학부모가 입력한 정보)          │   │
│  │ - 이름: 김철수                           │   │
│  │ - 생년월일: 2015-03-15                   │   │
│  │ - 학년: 초등 3학년                       │   │
│  │ - 학교: OO초등학교                       │   │
│  │ - 추가정보: (없음)                       │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  🔍 학생 검색 및 매칭                            │
│  ┌─────────────────────────────────────────┐   │
│  │ [김철수________________] [검색]          │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  검색 결과 (2명)                                │
│  ┌─────────────────────────────────────────┐   │
│  │ ○ 김철수 (2015-03-15)                    │   │
│  │   초등 3학년 | OO초등학교                 │   │
│  │   수강과목: 2개 | 학부모: 0명             │   │
│  │                                          │   │
│  │ ○ 김철수 (2014-08-22)                    │   │
│  │   초등 5학년 | XX초등학교                 │   │
│  │   수강과목: 3개 | 학부모: 1명 ✅          │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  관리자 메모 (선택)                             │
│  ┌─────────────────────────────────────────┐   │
│  │ [                              ]         │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  [✅ 승인]  [❌ 거절]  [취소]                   │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 🧪 테스트 시나리오

### Scenario 1: 정상적인 연결 흐름
1. 학부모 "김영희" 회원가입
2. 자녀 연결 요청 (김철수, 2015-03-15, 초3)
3. 관리자 알림 수신
4. 관리자가 학생 검색 → 김철수 선택
5. 승인 → ParentStudent 관계 생성
6. 학부모 알림 수신
7. 학부모 포털에서 자녀 정보 확인 가능

### Scenario 2: 복수 학부모 연결
1. 학부모 "김영희(母)" - 김철수 연결 완료
2. 학부모 "김철호(父)" 회원가입
3. 같은 자녀 "김철수" 연결 요청
4. 관리자 승인 → 2번째 연결 생성
5. 부모 모두 같은 자녀 정보 접근 가능

### Scenario 3: 잘못된 정보 거절
1. 학부모 요청 (자녀명: 이민수, 2016-05-20)
2. 관리자 검색 → 일치하는 학생 없음
3. 거절 (사유: "등록된 학생이 아닙니다")
4. 학부모 알림 수신
5. 학부모가 학원에 문의 후 재요청

### Scenario 4: 요청 취소
1. 학부모 연결 요청 제출
2. 잘못 입력한 것을 발견
3. "취소" 버튼 클릭 → status='cancelled'
4. 새로 요청 제출

---

## 🚀 다음 단계

1. **템플릿 4개 생성** (약 2시간)
   - parent/link_child.html
   - parent/link_requests.html
   - admin/parent_link_requests.html
   - admin/parent_link_request_detail.html

2. **메뉴 항목 추가** (약 30분)
   - 학부모 사이드바
   - 관리자 사이드바
   - 대시보드 위젯

3. **테스트** (약 1시간)
   - 요청 제출
   - 승인/거절
   - 알림 확인
   - 복수 연결 확인

4. **문서화** (약 30분)
   - 관리자 가이드
   - 학부모 가이드

**총 예상 시간: 4시간**

---

## 📝 구현 완료 체크리스트

### 백엔드
- [x] ParentLinkRequest 모델 생성
- [x] 마이그레이션 적용
- [x] 학부모 라우트 3개
- [x] 관리자 라우트 5개
- [x] 알림 통합
- [x] 복수 연결 지원
- [x] 권한 체크

### 프론트엔드
- [ ] 학부모 연결 요청 폼
- [ ] 학부모 요청 목록 페이지
- [ ] 관리자 요청 목록 페이지
- [ ] 관리자 요청 상세 페이지
- [ ] 메뉴 항목 추가
- [ ] 대시보드 위젯

### 테스트
- [ ] 요청 제출 테스트
- [ ] 승인 테스트
- [ ] 거절 테스트
- [ ] 복수 연결 테스트
- [ ] 알림 테스트

---

구현을 계속 진행할까요? 템플릿 생성부터 시작하겠습니다!
