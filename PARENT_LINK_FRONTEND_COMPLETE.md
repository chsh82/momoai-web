# 학부모-자녀 연결 시스템 프론트엔드 구현 완료

## 구현 일시
2026-02-10

## 구현 내용

### 1. 학부모 포털 템플릿 (2개)

#### templates/parent/link_child.html
- **목적**: 학부모가 자녀 연결을 신청하는 폼
- **기능**:
  - 자녀 정보 입력 폼 (이름, 생년월일, 학년, 학교명, 관계, 추가 정보)
  - 안내 메시지 및 주의사항 표시
  - 입력 검증 및 확인 다이얼로그
  - 학년 선택 (초1~고3)
  - 관계 선택 (모, 부, 조모, 조부, 기타)
  - 추가 정보 입력란 (수강 수업, 담당 강사 등)

#### templates/parent/link_requests.html
- **목적**: 학부모의 연결 신청 내역 및 연결된 자녀 목록 조회
- **기능**:
  - 통계 카드 4개 (연결된 자녀, 대기 중, 승인됨, 거절됨)
  - 연결된 자녀 카드 리스트 (이름, 학년, 학교, 수강 수업 수)
  - 신청 내역 테이블 (신청일, 학생 정보, 관계, 상태, 관리)
  - 대기 중 신청 취소 기능
  - 거절된 신청의 사유 확인 모달
  - 승인된 신청에서 자녀 정보로 바로 이동

### 2. 관리자 포털 템플릿 (2개)

#### templates/admin/parent_link_requests.html
- **목적**: 관리자가 모든 학부모 연결 신청을 조회
- **기능**:
  - 통계 카드 5개 (전체, 대기 중, 승인됨, 거절됨, 취소됨)
  - 필터 기능 (상태, 학년, 검색어)
  - 신청 목록 테이블 (신청일, 학부모, 학생 정보, 관계, 상태, 검토자)
  - 각 신청에 대한 검토하기 링크
  - 검토자 및 검토일시 표시

#### templates/admin/parent_link_request_detail.html
- **목적**: 관리자가 개별 신청을 검토하고 승인/거절
- **기능**:
  - 2단 레이아웃 (왼쪽: 정보, 오른쪽: 액션)
  - 신청 상태 카드
  - 학부모 정보 카드 (이름, 이메일, 전화번호, 현재 연결된 자녀 수)
  - 신청한 학생 정보 카드
  - 학생 검색 기능 (AJAX)
    - 학생 이름 또는 학생 코드로 검색
    - 검색 결과 카드 (학생 정보, 활성 상태, 수강 수업 수, 연결된 학부모 수)
    - 학생 선택 기능
  - 승인 폼 (선택된 학생 정보 표시, 승인 메모 입력)
  - 거절 폼 (거절 사유 필수 입력)
  - 매칭된 학생 정보 표시 (승인된 경우)
  - 관리자 메모 표시

### 3. 사이드바 메뉴 추가

#### 학부모 섹션
- **메뉴명**: 🔗 자녀 연결
- **위치**: "내 자녀" 다음
- **라우트**: `url_for('parent.link_requests')`
- **활성화 조건**: `'parent.link' in request.endpoint`

#### 관리자 섹션
- **메뉴명**: 🔗 학부모 연결 관리
- **위치**: "문자 발송" 다음
- **라우트**: `url_for('admin.parent_link_requests')`
- **활성화 조건**: `'admin.parent_link' in request.endpoint`

## 템플릿 디자인 특징

### 공통
- TailwindCSS 사용
- Responsive 디자인 (모바일, 태블릿, 데스크톱)
- 통계 카드 레이아웃
- 상태 배지 (대기 중: 노란색, 승인됨: 초록색, 거절됨: 빨간색, 취소됨: 회색)
- 모달 팝업 (ESC 키 및 배경 클릭으로 닫기)

### 학부모 템플릿
- 친근한 안내 메시지
- 명확한 입력 가이드
- 시각적 피드백 (선택 상태, 로딩 상태)
- 카드 기반 레이아웃

### 관리자 템플릿
- 효율적인 검토 워크플로우
- AJAX 기반 실시간 학생 검색
- 2단 레이아웃으로 정보와 액션 분리
- 상세한 정보 표시 (신청자, 학생, 검토자)

## 백엔드 라우트 연결

### 학부모 포털 라우트 (app/parent_portal/routes.py)
- `GET  /parent/link-child` → 자녀 연결 신청 폼
- `POST /parent/link-child` → 자녀 연결 신청 제출
- `GET  /parent/link-requests` → 연결 내역 조회
- `POST /parent/link-requests/<request_id>/cancel` → 신청 취소

### 관리자 포털 라우트 (app/admin/routes.py)
- `GET  /admin/parent-link-requests` → 전체 신청 목록
- `GET  /admin/parent-link-requests/<request_id>` → 신청 상세 및 검토
- `POST /admin/parent-link-requests/<request_id>/approve` → 신청 승인
- `POST /admin/parent-link-requests/<request_id>/reject` → 신청 거절
- `GET  /admin/api/students/search?q=keyword` → 학생 검색 API

## 주요 JavaScript 기능

### link_child.html
- 폼 제출 시 확인 다이얼로그
- 학생 이름 필수 입력 검증

### link_requests.html
- 거절 사유 모달 표시 함수
- ESC 키 및 배경 클릭으로 모달 닫기

### parent_link_request_detail.html
- AJAX 학생 검색 (`searchStudents()`)
- 학생 선택 함수 (`selectStudent()`)
- 선택된 학생 정보 표시
- 승인 버튼 활성화/비활성화 제어
- 엔터 키로 검색 트리거
- 페이지 로드 시 자동 검색 (학생 이름이 미리 입력된 경우)

## 데이터베이스

### ParentLinkRequest 모델 (이미 생성됨)
- Migration: `2bd6c5fc9fc1_add_parentlinkrequest_model_for_admin_.py`
- 테이블: `parent_link_requests`
- 상태: pending → approved/rejected/cancelled

## 알림 시스템 통합

### 학부모에게 전송되는 알림
1. **신청 승인 시**: "자녀 연결 신청이 승인되었습니다"
2. **신청 거절 시**: "자녀 연결 신청이 거절되었습니다" (사유 포함)

### 관리자에게 전송되는 알림
1. **신청 제출 시**: "새로운 학부모-자녀 연결 신청이 있습니다"

## 시스템 특징

### 복수 학부모 지원
- 한 명의 자녀에 대해 여러 학부모(엄마, 아빠 등)가 연결 가능
- 기존 연결이 있어도 새로운 학부모 추가 가능
- ParentStudent 관계는 중복 체크 후 생성 또는 재활성화

### 안전한 승인 프로세스
- 관리자가 학생 검색으로 정확한 매칭 확인
- 학생 정보 상세 표시 (활성 상태, 수강 수업 수, 기존 연결 수)
- 승인 시 학생 ID 필수 입력
- 거절 시 사유 필수 입력

## 테스트 시나리오

### 학부모 테스트
1. 학부모 로그인
2. 사이드바에서 "자녀 연결" 클릭
3. "새 자녀 연결 신청" 버튼 클릭
4. 자녀 정보 입력 및 제출
5. 연결 내역 페이지에서 신청 상태 확인
6. 대기 중인 신청 취소 테스트
7. 승인 후 자녀 정보 페이지로 이동 테스트

### 관리자 테스트
1. 관리자 로그인
2. 사이드바에서 "학부모 연결 관리" 클릭
3. 신청 목록 확인 (통계, 필터, 검색)
4. "검토하기" 클릭하여 신청 상세 페이지 이동
5. 학생 검색 기능 테스트 (이름, 학생 코드)
6. 학생 선택 및 승인 테스트
7. 거절 사유 입력 및 거절 테스트
8. 승인/거절 후 알림 전송 확인

### 복수 학부모 테스트
1. 같은 자녀에 대해 엄마 계정으로 연결 신청 → 승인
2. 같은 자녀에 대해 아빠 계정으로 연결 신청 → 승인
3. 두 학부모 모두 자녀 정보 접근 가능 확인

## 구현 완료 체크리스트

- [x] ParentLinkRequest 모델 생성 및 마이그레이션
- [x] 학부모 포털 라우트 3개 구현
- [x] 관리자 포털 라우트 5개 구현
- [x] 학생 검색 API 구현
- [x] 학부모 템플릿 2개 생성
- [x] 관리자 템플릿 2개 생성
- [x] 사이드바 메뉴 추가 (학부모, 관리자)
- [x] 알림 시스템 통합
- [x] JavaScript 기능 구현 (검색, 모달, 검증)
- [x] 복수 학부모 지원 로직
- [x] 상태 워크플로우 완성
- [x] 문서화 완료

## 다음 단계

### 선택적 개선 사항
1. **대시보드 위젯**: 학부모 대시보드에 "연결된 자녀 없음" 알림 추가
2. **관리자 대시보드**: "대기 중인 연결 신청" 위젯 추가
3. **이메일 알림**: 승인/거절 시 이메일 발송 (선택)
4. **자동 매칭**: 이름+생년월일로 학생 자동 제안 (선택)
5. **연결 해제**: 학부모가 자녀 연결 해제 요청 기능 (선택)

### 운영 준비
- 프로덕션 테스트
- 사용자 매뉴얼 작성
- 관리자 교육

## 구현 결과
✅ **학부모-자녀 연결 시스템 프론트엔드 구현 완료**

모든 템플릿이 생성되었고, 사이드바 메뉴가 추가되었습니다. 시스템은 다음과 같이 작동합니다:

1. 학부모가 자녀 정보를 입력하여 연결 신청
2. 관리자에게 알림 전송
3. 관리자가 학생 검색으로 정확한 학생 매칭
4. 승인 시 ParentStudent 관계 생성 및 학부모에게 알림
5. 거절 시 사유 전달 및 학부모에게 알림
6. 학부모가 연결된 자녀 정보 접근 가능

복수 학부모 지원으로 엄마, 아빠 등 여러 보호자가 같은 자녀와 연결될 수 있습니다.
